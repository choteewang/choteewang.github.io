<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 正反馈系列:《JavaScript高级程序设计》最佳实践,新兴API · choteewang</title><meta name="description" content="正反馈系列:《JavaScript高级程序设计》最佳实践,新兴API - choteewang@qq.com"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="choteewang"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">CHOTEE'S BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">LIST</a></li><li class="nav-list-item"><a href="https://github.com/choteewang" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">正反馈系列:《JavaScript高级程序设计》最佳实践,新兴API</h1><div class="post-info">2018年1月4日</div><div class="post-content"><h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><h2 id="可维护性"><a href="#可维护性" class="headerlink" title="可维护性"></a>可维护性</h2><h3 id="代码约定"><a href="#代码约定" class="headerlink" title="代码约定"></a>代码约定</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过初始化指定变量类型 </span></span><br><span class="line"><span class="keyword">var</span> found = <span class="literal">false</span>; <span class="comment">//布尔型 </span></span><br><span class="line"><span class="keyword">var</span> count = <span class="number">-1</span>; <span class="comment">//数字 </span></span><br><span class="line"><span class="keyword">var</span> name = <span class="string">""</span>; <span class="comment">//字符串 </span></span><br><span class="line"><span class="keyword">var</span> person = <span class="literal">null</span>; <span class="comment">//对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//用于指定数据类型的匈牙利标记法 </span></span><br><span class="line"><span class="keyword">var</span> bFound; <span class="comment">//布尔型 </span></span><br><span class="line"><span class="keyword">var</span> iCount; <span class="comment">//整数 </span></span><br><span class="line"><span class="keyword">var</span> sName; <span class="comment">//字符串 </span></span><br><span class="line"><span class="keyword">var</span> oPerson; <span class="comment">//对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//用于指定类型的类型注释 </span></span><br><span class="line"><span class="keyword">var</span> found <span class="comment">/*:Boolean*/</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> count <span class="comment">/*:int*/</span> = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">var</span> name <span class="comment">/*:String*/</span> = <span class="string">"Nicholas"</span>;</span><br><span class="line"><span class="keyword">var</span> person <span class="comment">/*:Object*/</span> = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<h3 id="松散耦合"><a href="#松散耦合" class="headerlink" title="松散耦合"></a>松散耦合</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleKeyPress</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  event = EventUtil.getEvent(event);</span><br><span class="line">  <span class="keyword">if</span> (event.keyCode == <span class="number">13</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> target = EventUtil.getTarget(event);</span><br><span class="line">    <span class="keyword">var</span> value = <span class="number">5</span> * <span class="built_in">parseInt</span>(target.value);</span><br><span class="line">    <span class="keyword">if</span> (value &gt; <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="built_in">document</span>.getElementById(<span class="string">"error-msg"</span>).style.display = <span class="string">"block"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 改变为</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateValue</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  value = <span class="number">5</span> * <span class="built_in">parseInt</span>(value);</span><br><span class="line">  <span class="keyword">if</span> (value &gt; <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"error-msg"</span>).style.display = <span class="string">"block"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleKeyPress</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  event = EventUtil.getEvent(event);</span><br><span class="line">  <span class="keyword">if</span> (event.keyCode == <span class="number">13</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> target = EventUtil.getTarget(event);</span><br><span class="line">    validateValue(target.value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="避免与-null-进行比较"><a href="#避免与-null-进行比较" class="headerlink" title="避免与 null 进行比较"></a>避免与 null 进行比较</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sortArray</span>(<span class="params">values</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (values != <span class="literal">null</span>) &#123; <span class="comment">//避免</span></span><br><span class="line">    values.sort(comparator);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sortArray</span>(<span class="params">values</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (values <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123; <span class="comment">// 推荐</span></span><br><span class="line">    values.sort(comparator);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果看到了与 null 比较的代码，尝试使用以下技术替换：</p>
<ul>
<li>如果值应为一个引用类型，使用instanceof操作符检查其构造函数；</li>
<li>如果值应为一个基本类型，使用typeof检查其类型；</li>
<li>如果是希望对象包含某个特定的方法名，则使用typeof操作符确保指定</li>
</ul>
<h3 id="使用常量"><a href="#使用常量" class="headerlink" title="使用常量"></a>使用常量</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!value) &#123;</span><br><span class="line">    alert(<span class="string">"Invalid value!"</span>);</span><br><span class="line">    location.href = <span class="string">"/errors/invalid.php"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换为</span></span><br><span class="line"><span class="keyword">var</span> Constants = &#123;</span><br><span class="line">  INVALID_VALUE_MSG: <span class="string">"Invalid value!"</span>,</span><br><span class="line">  INVALID_VALUE_URL: <span class="string">"/errors/invalid.php"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!value) &#123;</span><br><span class="line">    alert(Constants.INVALID_VALUE_MSG);</span><br><span class="line">    location.href = Constants.INVALID_VALUE_URL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>重复值——任何在多处用到的值都应抽取为一个常量。这就限制了当一个值变了而另一个没变的时候会造成的错误。这也包含了CSS类名。</li>
<li>用户界面字符串——任何用于显示给用户的字符串，都应被抽取出来以方便国际化。</li>
<li>URLs——在Web应用中，资源位置很容易变更，所以推荐用一个公共地方存放所有的URL。</li>
<li>任意可能会更改的值——每当你在用到字面量值的时候，你都要问一下自己这个值在未来是不是会变化。如果答案是“是”，那么这个值就应该被提取出来作为一个常量。</li>
</ul>
<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><h3 id="避免全局查找"><a href="#避免全局查找" class="headerlink" title="避免全局查找"></a>避免全局查找</h3><p>下例中,第一种方法<code>document</code>对象每被引用一次,就会在变量作用域链上层层向上找直到找到<code>document</code>对象,但第二种只需在具备创建一次对<code>document</code>对象的引用,后续无需再进行全局作用域链查找</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateUI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> imgs = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"img"</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = imgs.length; i &lt; len; i++) &#123;</span><br><span class="line">    imgs[i].title = <span class="built_in">document</span>.title + <span class="string">" image "</span> + i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> msg = <span class="built_in">document</span>.getElementById(<span class="string">"msg"</span>);</span><br><span class="line">  msg.innerHTML = <span class="string">"Update complete."</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 改为</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateUI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> doc = <span class="built_in">document</span>;</span><br><span class="line">  <span class="keyword">var</span> imgs = doc.getElementsByTagName(<span class="string">"img"</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = imgs.length; i &lt; len; i++) &#123;</span><br><span class="line">    imgs[i].title = doc.title + <span class="string">" image "</span> + i;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> msg = doc.getElementById(<span class="string">"msg"</span>);</span><br><span class="line">  msg.innerHTML = <span class="string">"Update complete."</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="避免使用with语句"><a href="#避免使用with语句" class="headerlink" title="避免使用with语句"></a>避免使用with语句</h3><p>在性能非常重要的地方必须避免使用<code>with</code>语句。和函数类似，<code>with</code>语句会创建自己的作用域，因此会增加其中执行的代码的作用域链的长度。由于额外的作用域链查找，在<code>with</code>语句中执行的代码肯定会比外面执行的代码要慢。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateBody</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">with</span>(<span class="built_in">document</span>.body) &#123;</span><br><span class="line">    alert(tagName);</span><br><span class="line">    innerHTML = <span class="string">"Hello world!"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//替换为</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateBody</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> body = <span class="built_in">document</span>.body</span><br><span class="line">  alert(body.tagName);</span><br><span class="line">  body.innerHTML = <span class="string">"Hello world!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="选择正确的方法"><a href="#选择正确的方法" class="headerlink" title="选择正确的方法"></a>选择正确的方法</h3><p>使用变量和数组要比访问对象上的属性更有效率，后者是一个<code>O(n)</code>操作。对象上的任何属性查找都要比访问变量或者数组花费更长时间，因为必须在原型链中对拥有该名称的属性进行一次搜索。简而言之，属性查找越多，执行时间就越长。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 效率是O(1)</span></span><br><span class="line"><span class="keyword">var</span> value = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">var</span> sum = <span class="number">10</span> + value;</span><br><span class="line">alert(sum);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> values = [<span class="number">5</span>, <span class="number">10</span>];</span><br><span class="line"><span class="keyword">var</span> sum = values[<span class="number">0</span>] + values[<span class="number">1</span>];</span><br><span class="line">alert(sum);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 效率是O(n) </span></span><br><span class="line"><span class="keyword">var</span> values = &#123;</span><br><span class="line">  first: <span class="number">5</span>,</span><br><span class="line">  second: <span class="number">10</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> sum = values.first + values.second;</span><br><span class="line">alert(sum);</span><br></pre></td></tr></table></figure>
<h3 id="Duff算法"><a href="#Duff算法" class="headerlink" title="Duff算法"></a>Duff算法</h3><p>比for循环一次次与length比较快,以8为运行单位,每次运行8次,这里<code>values</code>是一个数组</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> iterations = <span class="built_in">Math</span>.floor(values.length / <span class="number">8</span>); </span><br><span class="line"><span class="keyword">var</span> leftover = values.length % <span class="number">8</span>; </span><br><span class="line"><span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (leftover &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    process(values[i++]);</span><br><span class="line">  &#125; <span class="keyword">while</span> (--leftover &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  process(values[i++]);</span><br><span class="line">  process(values[i++]);</span><br><span class="line">  process(values[i++]);</span><br><span class="line">  process(values[i++]);</span><br><span class="line">  process(values[i++]);</span><br><span class="line">  process(values[i++]);</span><br><span class="line">  process(values[i++]);</span><br><span class="line">  process(values[i++]);</span><br><span class="line">&#125; <span class="keyword">while</span> (--iterations &gt; <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>小数据集用处不大,大数据集再采用</p>
</blockquote>
<h3 id="优化DOM交互"><a href="#优化DOM交互" class="headerlink" title="优化DOM交互"></a>优化DOM交互</h3><h4 id="最小化现场更新"><a href="#最小化现场更新" class="headerlink" title="最小化现场更新"></a>最小化现场更新</h4><p>一旦你需要访问的DOM部分是已经显示的页面的一部分，那么你就是在进行一个现场更新。之所以叫现场更新，是因为需要立即（现场）对页面对用户的显示进行更新。每一个更改，不管是插入单个字符，还是移除整个片段，都有一个性能惩罚，因为浏览器要重新计算无数尺寸以进行更新。现场更新进行得越多，代码完成执行所花的时间就越长；完成一个操作所需的现场更新越少，代码就越快。</p>
<p>下面这段代码为列表添加了10个项目。添加每个项目时，都有2个现场更新：一个添加<code>&lt;li&gt;</code>元素，另一个给它添加文本节点。这样添加10个项目，这个操作总共要完成20个现场更新。</p>
<p>要修正这个性能瓶颈，需要减少现场更新的数量。一般有2种方法。第一种是将列表从页面上移除，最后进行更新，最后再将列表插回到同样的位置。这个方法不是非常理想，因为在每次页面更新的时候它会不必要的闪烁。第二个方法是使用文档片段来构建DOM结构，接着将其添加到List元素中。这个方式避免了现场更新和页面闪烁问题。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list = <span class="built_in">document</span>.getElementById(<span class="string">"myList"</span>),</span><br><span class="line">  item, i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">  item = <span class="built_in">document</span>.createElement(<span class="string">"li"</span>);</span><br><span class="line">  list.appendChild(item);</span><br><span class="line">  item.appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">"Item "</span> + i));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换为</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> list = <span class="built_in">document</span>.getElementById(<span class="string">"myList"</span>),</span><br><span class="line">  fragment = <span class="built_in">document</span>.createDocumentFragment(),</span><br><span class="line">  item,</span><br><span class="line">  i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">  item = <span class="built_in">document</span>.createElement(<span class="string">"li"</span>);</span><br><span class="line">  fragment.appendChild(item);</span><br><span class="line">  item.appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">"Item "</span> + i));</span><br><span class="line">&#125;</span><br><span class="line">list.appendChild(fragment);</span><br></pre></td></tr></table></figure>
<p>在这个例子中只有一次现场更新，它发生在所有项目都创建好之后。文档片段用作一个临时的占位符，放置新创建的项目。然后使用<code>appendChild()</code>将所有项目添加到列表中。记住，当给<code>appendChild()</code>传入文档片段时，只有片段中的子节点被添加到目标，片段本身不会被添加的。一旦需要更新DOM，请考虑使用文档片段来构建DOM结构，然后再将其添加到现存的文档中。</p>
<h4 id="使用-innerHTML"><a href="#使用-innerHTML" class="headerlink" title="使用 innerHTML"></a>使用 innerHTML</h4><p>有两种在页面上创建DOM节点的方法：使用诸如<code>createElement()</code>和<code>appendChild()</code>之类的DOM方法，以及使用<code>innerHTML</code>。对于小的DOM更改而言，两种方法效率都差不多。然而，<strong>对于大的DOM更改</strong>，使用<code>innerHTML</code>要比使用标准DOM方法创建同样的DOM结构快得多。</p>
<p>当把<code>innerHTML</code>设置为某个值时，后台会创建一个HTML解析器，然后使用内部的DOM调用来创建DOM结构，而非基于JavaScript的DOM调用。由于内部方法是编译好的而非解释执行的，所以执行快得多。</p>
<h1 id="新兴API"><a href="#新兴API" class="headerlink" title="新兴API"></a>新兴API</h1><h2 id="requestAnimationFrame"><a href="#requestAnimationFrame" class="headerlink" title="requestAnimationFrame()"></a>requestAnimationFrame()</h2><p><code>window.requestAnimationFrame(callback) return id</code> 方法接收一个参数，即在下次重绘屏幕前调用的一个函数,返回一个id,用<code>window.cancelAnimationFrame(id)</code>可取消调用.<code>callback</code>也有一个参数<code>timestamp</code>,which indicates the current time (the time returned from <code>performance.now()</code> ) for when requestAnimationFrame() starts to fire callbacks.</p>
<blockquote>
<p>利用上述特性,可以封装一个<code>requestAnimationFrame()</code>的动画函数</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> RAFid;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RAFBundle</span>(<span class="params">callback, interval</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> startTime = <span class="built_in">Date</span>.now()</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">timestamp</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentTime = <span class="built_in">Date</span>.now()</span><br><span class="line">    <span class="keyword">if</span> (currentTime - startTime &gt;= interval) &#123;</span><br><span class="line">      callback()</span><br><span class="line">      startTime = currentTime</span><br><span class="line">    &#125;</span><br><span class="line">    RAFid = <span class="built_in">window</span>.requestAnimationFrame(render)</span><br><span class="line">  &#125;</span><br><span class="line">  render();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 停止绘制</span></span><br><span class="line"><span class="built_in">window</span>.cancelAnimationFrame(RAFid)</span><br></pre></td></tr></table></figure>
<h2 id="File-API"><a href="#File-API" class="headerlink" title="File API"></a>File API</h2><p>File API在表单中的文件输入字段的基础上，又添加了一些直接访问文件信息的接口。HTML5在DOM中为文件输入元素添加了一个<code>element.files</code>属性,它是一个集合。在通过文件输入字段选择了一或多个文件时，<code>element.files</code>集合中将包含一组<code>File</code>对象，每个<code>File</code>对象对应着一个文件。每个File对象都有下列只读属性。</p>
<ul>
<li><code>name</code>：本地文件系统中的文件名。</li>
<li><code>size</code>：文件的字节大小。</li>
<li><code>type</code>：字符串，文件的MIME类型。</li>
<li><code>lastModifiedDate</code>：字符串，文件上一次被修改的时间（只有Chrome实现了这个属性）。</li>
</ul>
<p>举个例子，通过侦听<code>change</code>事件并读取<code>element.files</code>集合就可以知道选择的每个文件的信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;input type="file" multiple id="files-list"&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> filesList = <span class="built_in">document</span>.getElementById(<span class="string">"files-list"</span>);</span><br><span class="line">EventUtil.addHandler(filesList, <span class="string">"change"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> info = <span class="string">""</span>,</span><br><span class="line">    output = <span class="built_in">document</span>.getElementById(<span class="string">"output"</span>),</span><br><span class="line">    files = EventUtil.getTarget(event).files,</span><br><span class="line">    i = <span class="number">0</span>,</span><br><span class="line">    len = files.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">    info += files[i].name + <span class="string">" ("</span> + files[i].type + <span class="string">", "</span> + files[i].size + <span class="string">" bytes)&lt;br&gt;"</span>;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  output.innerHTML = info;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="FileReader-类型"><a href="#FileReader-类型" class="headerlink" title="FileReader 类型"></a>FileReader 类型</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader()</span><br></pre></td></tr></table></figure>
<p><code>FileReader</code>类型实现的是一种异步文件读取机制。可以把<code>FileReader</code>想象成<code>XMLHttpRequest</code>，区别只是它读取的是文件系统，而不是远程服务器。为了读取文件中的数据，<code>FileReader</code>提供了如下几个方法。</p>
<ul>
<li><code>reader.readAsText(file,encoding)</code>：以纯文本形式读取文件，将读取到的文本保存在<code>reader.result</code>属性中。第二个参数用于指定编码类型，是可选的。</li>
<li><code>reader.readAsDataURL(file)</code>：读取文件并将文件以数据URI的形式保存在<code>reader.result</code>属性中。</li>
<li><code>reader.readAsBinaryString(file)</code>：读取文件并将一个字符串保存在<code>reader.result</code>属性中，字符串中的每个字符表示一字节。</li>
<li><code>reader.readAsArrayBuffer(file)</code>：读取文件并将一个包含文件内容的ArrayBuffer保存在<code>reader.result</code>属性中。</li>
</ul>
<p>由于读取过程是异步的，因此<code>FileReader</code>也提供了几个事件。其中最有用的三个事件是<code>progress</code>、<code>error</code>和<code>load</code>，分别表示是否又读取了新数据、是否发生了错误以及是否已经读完了整个文件。</p>
<p>每过50ms左右，就会触发一次<code>progress</code>事件，通过事件对象可以获得与XHR的<code>progress</code>事件类似的属性：<code>lengthComputable</code>(布尔值,表示进度信息是否可见)、<code>loaded</code>(已读取完成数量)和<code>total</code>(总共需读取数量)。另外，尽管可能没有包含全部数据，但每次<code>progress</code>事件中都可以通过<code>FileReader</code>的<code>reader.result</code>属性读取到文件内容。</p>
<p>由于种种原因无法读取文件，就会触发<code>error</code>事件。触发<code>error</code>事件时，相关的信息将保存到<code>FileReader</code>的<code>error</code>属性中。这个属性中将保存一个对象，该对象只有一个属性<code>code</code>，即错误码。这个错误码是<code>1</code>表示未找到文件，是<code>2</code>表示安全性错误，是<code>3</code>表示读取中断，是<code>4</code>表示文件不可读，是<code>5</code>表示编码错误。</p>
<p>文件成功加载后会触发<code>load</code>事件；如果发生了<code>error</code>事件，就不会发生<code>load</code>事件</p>
<p>下面是一个全面的例子:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> filesList = <span class="built_in">document</span>.getElementById(<span class="string">"files-list"</span>);</span><br><span class="line">EventUtil.addHandler(filesList, <span class="string">"change"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> info = <span class="string">""</span>,</span><br><span class="line">    output = <span class="built_in">document</span>.getElementById(<span class="string">"output"</span>),</span><br><span class="line">    progress = <span class="built_in">document</span>.getElementById(<span class="string">"progress"</span>),</span><br><span class="line">    files = EventUtil.getTarget(event).files,</span><br><span class="line">    type = <span class="string">"default"</span>,</span><br><span class="line">    reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/image/</span>.test(files[<span class="number">0</span>].type)) &#123;</span><br><span class="line">    reader.readAsDataURL(files[<span class="number">0</span>]);</span><br><span class="line">    type = <span class="string">"image"</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    reader.readAsText(files[<span class="number">0</span>]);</span><br><span class="line">    type = <span class="string">"text"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  reader.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    output.innerHTML = <span class="string">"Could not read file, error code is "</span> + reader.error.code;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  reader.onprogress = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (event.lengthComputable) &#123;</span><br><span class="line">      progress.innerHTML = event.loaded + <span class="string">"/"</span> + event.total;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  reader.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> html = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"image"</span>:</span><br><span class="line">        html = <span class="string">"&lt;img src=\""</span> + reader.result + <span class="string">"\"&gt;"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"text"</span>:</span><br><span class="line">        html = reader.result;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    output.innerHTML = html;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果想中断读取过程，可以调用 <code>reader.abort()</code>方法，这样就会触发 <code>abort</code> 事件。在触发 <code>load</code>、<code>error</code> 或 <code>abort</code> 事件后，会触发另一个事件 <code>loadend</code>。<code>loadend</code> 事件发生就意味着已经读取完整个文件，或者读取时发生了错误，或者读取过程被中断。</p>
<h3 id="读取部分内容"><a href="#读取部分内容" class="headerlink" title="读取部分内容"></a>读取部分内容</h3><p>我们只想读取文件的一部分而不是全部内容。为此，File对象还支持一个<code>slice()</code>方法，这个方法在Firefox中的实现叫<code>mozSlice()</code>，在Chrome中的实现叫<code>webkitSlice()</code>，Safari的5.1及之前版本不支持这个方法。<code>slice()</code>方法接收两个参数：起始字节,要读取的字节数。这个方法返回一个<code>Blob</code>的实例，<code>Blob</code>是File类型的父类型。</p>
<p>Blob类型有一个<code>size</code>属性和一个<code>type</code>属性，而且它也支持<code>slice()</code>方法，以便进一步切割数据。通过<code>FileReader</code>也可以从<code>Blob</code>中读取数据。下面这个例子只读取文件的32B内容。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blobSlice</span>(<span class="params">blob, startByte, length</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (blob.slice) &#123;</span><br><span class="line">    <span class="keyword">return</span> blob.slice(startByte, length);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (blob.webkitSlice) &#123;</span><br><span class="line">    <span class="keyword">return</span> blob.webkitSlice(startByte, length);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (blob.mozSlice) &#123;</span><br><span class="line">    <span class="keyword">return</span> blob.mozSlice(startByte, length);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> filesList = <span class="built_in">document</span>.getElementById(<span class="string">"files-list"</span>);</span><br><span class="line">EventUtil.addHandler(filesList, <span class="string">"change"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> info = <span class="string">""</span>,</span><br><span class="line">    output = <span class="built_in">document</span>.getElementById(<span class="string">"output"</span>),</span><br><span class="line">    progress = <span class="built_in">document</span>.getElementById(<span class="string">"progress"</span>),</span><br><span class="line">    files = EventUtil.getTarget(event).files,</span><br><span class="line">    reader = <span class="keyword">new</span> FileReader(),</span><br><span class="line">    blob = blobSlice(files[<span class="number">0</span>], <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">  <span class="keyword">if</span> (blob) &#123;</span><br><span class="line">    reader.readAsText(blob);</span><br><span class="line">    reader.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      output.innerHTML = <span class="string">"Could not read file, error code is "</span> + reader.error.code;</span><br><span class="line">    &#125;;</span><br><span class="line">    reader.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      output.innerHTML = reader.result;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    alert(<span class="string">"Your browser doesn' t support slice()."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="对象-URL"><a href="#对象-URL" class="headerlink" title="对象 URL"></a>对象 URL</h3><p>对象URL也被称为<code>blob URL</code>，指的是引用保存在<code>File</code>或<code>Blob</code>中数据的URL。使用对象URL的好处是可以不必把文件内容读取到JavaScript中而直接使用文件内容。为此，只要在需要文件内容的地方提供对象URL即可。要创建对象URL，可以使用<code>window.URL.createObjectURL(blob) return url</code>方法，并传入<code>File</code>或<code>Blob</code>对象。这个方法在Chrome中的实现叫<code>window.webkitURL.createObjectURL()</code>，因此可以通过如下函数来消除命名的差异：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createObjectURL</span>(<span class="params">blob</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.URL) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.URL.createObjectURL(blob);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.webkitURL) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.webkitURL.createObjectURL(blob);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的返回值是一个字符串，指向一块内存的地址。因为这个字符串是URL，所以在DOM中也能使用。例如，以下代码可以在页面中显示一个图像文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> filesList = <span class="built_in">document</span>.getElementById(<span class="string">"files-list"</span>);</span><br><span class="line">EventUtil.addHandler(filesList, <span class="string">"change"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> info = <span class="string">""</span>,</span><br><span class="line">    output = <span class="built_in">document</span>.getElementById(<span class="string">"output"</span>),</span><br><span class="line">    progress = <span class="built_in">document</span>.getElementById(<span class="string">"progress"</span>),</span><br><span class="line">    files = EventUtil.getTarget(event).files,</span><br><span class="line">    reader = <span class="keyword">new</span> FileReader(),</span><br><span class="line">    url = createObjectURL(files[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (url) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/image/</span>.test(files[<span class="number">0</span>].type)) &#123;</span><br><span class="line">      output.innerHTML = <span class="string">"&lt;img src=\""</span> + url + <span class="string">"\"&gt;"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      output.innerHTML = <span class="string">"Not an image."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    output.innerHTML = <span class="string">"Your browser doesn't support object URLs."</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>直接把对象URL放在<code>&lt;img&gt;</code>标签中，就省去了把数据先读到JavaScript中的麻烦。另一方面，<img>标签则会找到相应的内存地址，直接读取数据并将图像显示在页面中。如果不再需要相应的数据，最好释放它占用的内容。但只要有代码在引用对象URL，内存就不会释放。要手工释放内存，可以把对象URL传给<code>window.URL.revokeOjbectURL(url)</code>（在Chrome中是<code>window.webkitURL.revokeObjectURL()</code>）。要兼容这两种方法的实现，可以使用以下函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">revokeObjectURL</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.URL) &#123;</span><br><span class="line">    <span class="built_in">window</span>.URL.revokeObjectURL(url);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.webkitURL) &#123;</span><br><span class="line">    <span class="built_in">window</span>.webkitURL.revokeObjectURL(url);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>页面卸载时会自动释放对象URL占用的内存。不过，为了确保尽可能少地占用内存，最好在不需要某个对象URL时，就马上手工释放其占用的内存。</p>
</blockquote>
<h3 id="读取拖放的文件"><a href="#读取拖放的文件" class="headerlink" title="读取拖放的文件"></a>读取拖放的文件</h3><p>围绕读取文件信息，结合使用HTML5拖放API和文件API，能够创造出令人瞩目的用户界面：在页面上创建了自定义的放置目标之后，你可以从桌面上把文件拖放到该目标。与拖放一张图片或者一个链接类似，从桌面上把文件拖放到浏览器中也会触发<code>drop</code>事件。而且可以在<code>event.dataTransfer.files</code>中读取到被放置的文件，当然此时它是一个<code>File</code>对象，与通过文件输入字段取得的<code>File</code>对象一样。</p>
<p>下面这个例子会将放置到页面中自定义的放置目标中的文件信息显示出来：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> droptarget = <span class="built_in">document</span>.getElementById(<span class="string">"droptarget"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleEvent</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> info = <span class="string">""</span>,</span><br><span class="line">    output = <span class="built_in">document</span>.getElementById(<span class="string">"output"</span>),</span><br><span class="line">    files, i, len;</span><br><span class="line"></span><br><span class="line">  EventUtil.preventDefault(event);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (event.type == <span class="string">"drop"</span>) &#123;</span><br><span class="line">    files = event.dataTransfer.files;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    len = files.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">      info += files[i].name + <span class="string">" ("</span> + files[i].type + <span class="string">", "</span> + files[i].size + <span class="string">" bytes)&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">    output.innerHTML = info;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventUtil.addHandler(droptarget, <span class="string">"dragenter"</span>, handleEvent);</span><br><span class="line">EventUtil.addHandler(droptarget, <span class="string">"dragover"</span>, handleEvent);</span><br><span class="line">EventUtil.addHandler(droptarget, <span class="string">"drop"</span>, handleEvent);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>与之前展示的拖放示例一样，这里也必须取消<code>dragenter</code>、<code>dragover</code>和<code>drop</code>的默认行为。在<code>drop</code>事件中，可以通过<code>event.dataTransfer.files</code>读取文件信息。还有一种利用这个功能的流行做法，即结合<code>XMLHttpRequest</code>和拖放文件来实现上传。</p>
</blockquote>
<h3 id="使用-XHR-上传文件"><a href="#使用-XHR-上传文件" class="headerlink" title="使用 XHR 上传文件"></a>使用 XHR 上传文件</h3><p>通过<code>File API</code>能够访问到文件内容，利用这一点就可以通过XHR直接把文件上传到服务器。当然啦，把文件内容放到<code>xhr.send()</code>方法中，再通过POST请求，的确很容易就能实现上传。但这样做传递的是文件内容，因而服务器端必须收集提交的内容，然后再把它们保存到另一个文件中。</p>
<p>其实，更好的做法是以表单提交的方式来上传文件。这样使用<code>FormData</code>类型就很容易做到了。首先，要创建一个<code>FormData</code>对象，通过它调用<code>formdata.append()</code>方法并传入相应的<code>File</code>对象作为参数。然后，再把<code>FormData</code>对象传递给XHR的<code>xhr.send()</code>方法，结果与通过表单上传一模一样。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> droptarget = <span class="built_in">document</span>.getElementById(<span class="string">"droptarget"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleEvent</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> info = <span class="string">""</span>,</span><br><span class="line">    output = <span class="built_in">document</span>.getElementById(<span class="string">"output"</span>),</span><br><span class="line">    data, xhr, files, i, len;</span><br><span class="line">  EventUtil.preventDefault(event);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (event.type == <span class="string">"drop"</span>) &#123;</span><br><span class="line">    data = <span class="keyword">new</span> FormData();</span><br><span class="line">    files = event.dataTransfer.files;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    len = files.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">      data.append(<span class="string">"file"</span> + i, files[i]);</span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    xhr.open(<span class="string">"post"</span>, <span class="string">"FileAPIExample06Upload.php"</span>, <span class="literal">true</span>);</span><br><span class="line">    xhr.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (xhr.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">        alert(xhr.responseText);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    xhr.send(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventUtil.addHandler(droptarget, <span class="string">"dragenter"</span>, handleEvent);</span><br><span class="line">EventUtil.addHandler(droptarget, <span class="string">"dragover"</span>, handleEvent);</span><br><span class="line">EventUtil.addHandler(droptarget, <span class="string">"drop"</span>, handleEvent);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个例子创建一个<code>FormData</code>对象，与每个文件对应的键分别是<code>file0</code>、<code>file1</code>、<code>file2</code>这样的格式。注意，不用额外写任何代码，这些文件就可以作为表单的值提交。而且，也不必使用<code>FileReader</code>，只要传入<code>File</code>对象即可。</p>
<p>使用<code>FormData</code>上传文件，在服务器端就好像是接收到了常规的表单数据一样，一切按部就班地处理即可。换句话说，如果服务器端使用的是PHP，那么<code>$_FILES</code>数组中就会保存着上传的文件。</p>
</blockquote>
<h2 id="Web计时"><a href="#Web计时" class="headerlink" title="Web计时"></a>Web计时</h2><p>Web计时机制的核心是<code>window.performance</code>对象。对页面的所有度量信息，包括那些规范中已经定义的和将来才能确定的，都包含在这个对象里面。WebTiming规范一开始就为performance对象定义了两个属性。</p>
<h3 id="window-performance-navigation"><a href="#window-performance-navigation" class="headerlink" title="window.performance.navigation"></a>window.performance.navigation</h3><p><code>performance.navigation</code>属性是一个对象，包含着与页面导航有关的多个属性，如下所示</p>
<ul>
<li><code>redirectCount</code>：页面加载前的重定向次数。</li>
<li><code>type</code>：数值常量，表示刚刚发生的导航类型。<ul>
<li><code>performance.navigation.TYPE_NAVIGATE (0)</code>：页面第一次加载。 </li>
<li><code>performance.navigation.TYPE_RELOAD (1)</code>：页面重载过。 </li>
<li><code>performance.navigation.TYPE_BACK_FORWARD (2)</code>：页面是通过“后退”或“前进”按 钮打开的。</li>
</ul>
</li>
</ul>
<h3 id="window-performance-timing"><a href="#window-performance-timing" class="headerlink" title="window.performance.timing"></a>window.performance.timing</h3><p><code>performance.timing</code>属性是一个对象,这个对象的属性都是时间戳（从软件纪元开始经过的毫秒数），不同的事件会产生不同的时间值</p>
<ul>
<li><code>navigationStart</code>：开始导航到当前页面的时间。</li>
<li><code>unloadEventStart</code>：前一个页面的unload事件开始的时间。但只有在前一个页面与当前页面来自同一个域时这个属性才会有值；否则，值为0。</li>
<li><code>unloadEventEnd</code>：前一个页面的unload事件结束的时间。但只有在前一个页面与当前页面来自同一个域时这个属性才会有值；否则，值为0。</li>
<li><code>redirectStart</code>：到当前页面的重定向开始的时间。但只有在重定向的页面来自同一个域时这个属性才会有值；否则，值为0。</li>
<li><code>redirectEnd</code>：到当前页面的重定向结束的时间。但只有在重定向的页面来自同一个域时这个属性才会有值；否则，值为0。</li>
<li><code>fetchStart</code>：开始通过HTTPGET取得页面的时间。</li>
<li><code>domainLookupStart</code>：开始查询当前页面DNS的时间。</li>
<li><code>domainLookupEnd</code>：查询当前页面DNS结束的时间。</li>
<li><code>connectStart</code>：浏览器尝试连接服务器的时间。</li>
<li><code>connectEnd</code>：浏览器成功连接到服务器的时间。</li>
<li><code>secureConnectionStart</code>：浏览器尝试以SSL方式连接服务器的时间。不使用SSL方式连接时，这个属性的值为0。</li>
<li><code>requestStart</code>：浏览器开始请求页面的时间。</li>
<li><code>responseStart</code>：浏览器接收到页面第一字节的时间。</li>
<li><code>responseEnd</code>：浏览器接收到页面所有内容的时间。</li>
<li><code>domLoading</code>：document.readyState变为”loading”的时间。</li>
<li><code>domInteractive</code>：document.readyState变为”interactive”的时间。</li>
<li><code>domContentLoadedEventStart</code>：发生DOMContentLoaded事件的时间。</li>
<li><code>domContentLoadedEventEnd</code>：DOMContentLoaded事件已经发生且执行完所有事件处理程序的时间。</li>
<li><code>domComplete</code>：document.readyState变为”complete”的时间。</li>
<li><code>loadEventStart</code>：发生load事件的时间。</li>
<li><code>loadEventEnd</code>：load事件已经发生且执行完所有事件处理程序的时间。</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2018/01/04/封装拖放对象-自定义事件/" class="next">上一篇</a><a href="/2018/01/27/vue2-5-外卖app/" class="prev">下一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">choteewang@qq.com</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>