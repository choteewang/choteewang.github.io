<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 模拟Vue.js的设计模式实现 (二): 数据代理 & Dep类 · choteewang</title><meta name="description" content="模拟Vue.js的设计模式实现 (二): 数据代理 &amp; Dep类 - choteewang@qq.com"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="choteewang"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">CHOTEE'S BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">LIST</a></li><li class="nav-list-item"><a href="https://github.com/choteewang" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">模拟Vue.js的设计模式实现 (二): 数据代理 & Dep类</h1><div class="post-info">2018年4月3日</div><div class="post-content"><p><a href="https://choteewang.github.io/2018/04/01/my-vue-01/" target="_blank" rel="noopener">上篇博客</a> 详细讲解了<code>双向绑定</code>的原理, 提出了<code>MVVM</code>各自代表部分的抽象含义, 同时还强调了在<code>双向绑定</code>实现过程中对于<code>中间变量</code>的作用域引用的意义, 对于理解<code>Vue</code>的观察者模式, 所有的理论基础已经具备, 从这篇博客开始, 一边理解<code>Vue</code>的核心设计模式, 一边写一个<code>mini Vue</code>出来, 最终实现对数个<code>Vue</code>功能的克隆, 加深我们对代码的认识.</p>
<p>这个小项目的源码的<code>github</code>地址是: <a href="https://github.com/choteewang/my-vue" target="_blank" rel="noopener">https://github.com/choteewang/my-vue</a></p>
<h3 id="模拟场景"><a href="#模拟场景" class="headerlink" title="模拟场景"></a>模拟场景</h3><p>首先, 我们需要模拟<code>Vue</code>的模板, 不妨新建一个<code>index.html</code>, 如下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123;triggerTip&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"inputValue"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;inputValue&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">v-bind:src</span>=<span class="string">"src"</span> <span class="attr">style</span>=<span class="string">"width:300px;height:300px; background-color:#ccc;background-position: center center"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-on:click</span>=<span class="string">"eventHandle"</span>&gt;</span>点击改变data.src的值<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">// 模拟vue的各个模块</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/observer.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/watcher.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/compile.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/index.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意在<code>body</code>标签的底部我们引入了数个<code>js</code>空文件, 这都是需要我们手写完成的<code>js</code>文件, 它们分别代表了从<code>Vue</code>源码中抽离出来的某部分, 封装了各自不同的功能和职责, 我们会将其逐渐完成.</p>
<p>在浏览器中打开刚刚创建完成的<code>index.html</code>文件, 它长这样:</p>
<p><img src="https://i.loli.net/2018/04/22/5adb741f62e22.jpg" alt=""></p>
<p>可以看到, 在没有<code>Vue.js</code>解析的<code>template</code>变的完全没有语义化, 让我们一步步完成它, 让它最终具备和<code>Vue</code>一样功能. 在最后一个引用<code>index.js</code>的<code>script</code>标签下, 我们再建立一个<code>script</code>标签, 在其中写下初始化<code>Vue</code>实例的代码, 是的, 就像使用真实的<code>Vue.js</code>一样, 一模一样.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面的配置项本身也可看作是ViewModel的一部分</span></span><br><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    triggerTip: <span class="string">'waiting for mounted'</span>,</span><br><span class="line">    inputValue: <span class="string">'choteewang'</span>,</span><br><span class="line">    src: <span class="string">'./imgs/react.jpeg'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    eventHandle() &#123;</span><br><span class="line">      <span class="keyword">this</span>.triggerTip = <span class="string">'click function called'</span></span><br><span class="line">      <span class="keyword">this</span>.src = <span class="string">'./imgs/'</span> + (<span class="keyword">this</span>.src.indexOf(<span class="string">'vue'</span>) &gt; <span class="number">0</span> ? <span class="string">'react.jpeg'</span> : <span class="string">'vue.png'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.triggerTip = <span class="string">'mounted function called'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这样, <code>Vue</code>初始化方法就完成了, 结合我们上面写的<code>template</code>, 这个小Demo展示了若干通过<code>插值</code>或<code>Vue特性语法</code><strong>单向</strong>或<strong>双向</strong>绑定<code>data</code>数据的<code>HTML</code>标签, 其中<code>input</code>用<code>v-model指令</code>双向绑定了<code>data</code>属性下的<code>inputValue</code>变量, <code>img</code>用<code>v-bind指令</code>单向绑定了<code>src</code>变量, <code>button</code>用<code>v-on指令</code>绑定了<code>Vue</code>实例初始化时的<code>methods</code>属性下的<code>eventHandle</code>方法, 点击<code>button</code>时可以改变<code>img</code>的<code>src</code>的值, 然后添加<code>imgs</code>文件夹, 放入<code>src</code>要引用的图片文件. 好了, 现在, 整个页面<code>插值</code>, <code>事件</code>, <code>指令</code>一应俱全, 我们现在就开始实现一个<code>mini Vue</code>, 让这一切语法变的有实际含义.</p>
<h3 id="数据代理-data-proxy"><a href="#数据代理-data-proxy" class="headerlink" title="数据代理, data proxy"></a>数据代理, data proxy</h3><p>正式开始<code>mini-Vue</code>的开发, 在之前提到的<code>index.js</code>中, 新建<code>Vue</code>的<code>构造函数</code>和<code>prototype</code>对象, 将初始化<code>Vue</code>实例时我们自己定义的配置对象以参数名<code>option</code>传入, 并将其属性代理到<code>vm</code>上, 在构造函数的结尾调用原型内的<code>init</code>方法</p>
<p><code>init</code>方法做了一件事, 遍历<code>vm</code>对象的<code>data</code>属性(注意这里要调用<code>hasOwnProperty</code>方法确保<code>Object.prototype</code>的属性不会被遍历到), 并继续调用<code>proxyKeys</code>方法,</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.data = options.data</span><br><span class="line">  <span class="keyword">this</span>.el = options.el</span><br><span class="line">  <span class="keyword">this</span>.methods = options.methods</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.init(<span class="keyword">this</span>.data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vue.prototype = &#123;</span><br><span class="line">  init: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> key</span><br><span class="line">    <span class="keyword">for</span>(key <span class="keyword">in</span> data) &#123;</span><br><span class="line">      <span class="keyword">if</span> (data.hasOwnProperty(key)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.proxyKeys(key, data)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Vue</code>中, 可以通过<code>vm.a</code>, <code>vm.b</code>来访问和修改代理到<code>Vue</code>中的属性值, 并且这些数据都是有响应式特性的, 要实现这个功能, 最先做的就是”数据代理”(<code>data proxy</code>). <code>proxyKeys</code>方法就完成了这个功能, 他完成的内容是将实例化<code>vm</code>时定义的<code>data</code>对象中的每个<code>key</code>代理到<code>vm</code>实例上.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype = &#123;</span><br><span class="line">  <span class="comment">// ... 省略init方法</span></span><br><span class="line">  proxyKeys(key, data) &#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, key, &#123;</span><br><span class="line">      configurable: <span class="literal">false</span>,</span><br><span class="line">      enumerable: <span class="literal">true</span>,</span><br><span class="line">      <span class="comment">// 之后所有vm[key]的getter</span></span><br><span class="line">      get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 会转为调用vm.data[key]的getter</span></span><br><span class="line">        <span class="keyword">return</span> self.data[key]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 之后所有vm[key]的setter</span></span><br><span class="line">      set: <span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data[key] === val) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'return'</span>)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'changed'</span>)</span><br><span class="line">          <span class="comment">// 会转为调用vm.data[key]的setter</span></span><br><span class="line">          self.data[key] = val</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;) </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>proxyKeys</code>方法通过<code>Object.defineProperty</code>方法完成<code>data proxy</code>过程. 注意,与上篇所解释的内容不同的是: 这里<code>defineProperty</code>完成的不是双向绑定, 而是数据代理, 即我们之后再访问<code>vm.a</code>(触发<code>vm.a</code>的<code>getter</code>), 实际上访问的是<code>vm.data.a</code>(触发<code>vm.data.a</code>的<code>getter</code>), 我们再修改<code>vm.data.a</code>的值(触发<code>vm.a</code>的<code>setter</code>), 修改的实际是<code>vm.data.a</code>的值(触发<code>vm.data.a</code>的<code>setter</code>). 至于<code>vm.data</code>的属性值为什么又有<code>getter</code>和<code>setter</code>, 后面慢慢剖析</p>
<p>完成上述代码后, 用浏览器打开<code>index.html</code>, 打开控制台手动试一下, 可以看到”数据代理”(<code>data proxy</code>)已经被实现, 如下所示:</p>
<p><img src="https://i.loli.net/2018/04/22/5adb741fbe264.jpg" alt=""></p>
<h3 id="data-proxy-完整代码"><a href="#data-proxy-完整代码" class="headerlink" title="data proxy 完整代码"></a>data proxy 完整代码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123;triggerTip&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"inputValue"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;inputValue&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-on:click</span>=<span class="string">"eventHandle"</span>&gt;</span>触发点击事件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/observer.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/watcher.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/compile.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/index.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">      el: <span class="string">'#app'</span>,</span></span><br><span class="line"><span class="undefined">      data: &#123;</span></span><br><span class="line"><span class="javascript">        triggerTip: <span class="string">''</span>,</span></span><br><span class="line"><span class="javascript">        inputValue: <span class="string">'choteewang'</span></span></span><br><span class="line"><span class="undefined">      &#125;,</span></span><br><span class="line"><span class="undefined">      method: &#123;</span></span><br><span class="line"><span class="undefined">        eventHandle() &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">this</span>.triggerTip = <span class="string">'click function called'</span></span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;,</span></span><br><span class="line"><span class="javascript">      mounted: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">this</span>.triggerTip = <span class="string">'mounted function called'</span></span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.data = options.data</span><br><span class="line">  <span class="keyword">this</span>.el = options.el</span><br><span class="line">  <span class="keyword">this</span>.methods = options.methods</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.init(<span class="keyword">this</span>.data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vue.prototype = &#123;</span><br><span class="line">  init: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 遍历data, 将每个data每个属性的第一层代理到vm实例上</span></span><br><span class="line">    <span class="keyword">var</span> key</span><br><span class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> data) &#123;</span><br><span class="line">      <span class="keyword">if</span> (data.hasOwnProperty(key)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.proxyKeys(key, data)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  proxyKeys(key, data) &#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, key, &#123;</span><br><span class="line">      configurable: <span class="literal">false</span>,</span><br><span class="line">      enumerable: <span class="literal">true</span>,</span><br><span class="line">      <span class="comment">// 之后所有vm[key]的getter</span></span><br><span class="line">      get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 会转为调用vm.data[key]的getter</span></span><br><span class="line">        <span class="keyword">return</span> self.data[key]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 之后所有vm[key]的setter</span></span><br><span class="line">      set: <span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'changed'</span>)</span><br><span class="line">        <span class="comment">// 会转为调用vm.data[key]的setter</span></span><br><span class="line">        self.data[key] = val</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Dep-Denpendency"><a href="#Dep-Denpendency" class="headerlink" title="Dep(Denpendency)"></a>Dep(Denpendency)</h3><p>完成数据代理后, 我们来继续完成<code>Dep</code>类, 在完成这部分前, 你需要具备一些<code>观察者模式</code>的知识, 如果你需要了解, 我有两篇博客专门讲解了观察者模式的思想, 下面放上传送门: </p>
<p><a href="https://choteewang.github.io/2017/12/23/javascript-%E4%B8%8E-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" target="_blank" rel="noopener">javascript 与 “发布/订阅(观察者)模式”</a><br><a href="https://choteewang.github.io/2018/01/04/javascript%E4%B8%8E%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F2/" target="_blank" rel="noopener">javascript 与 ‘发布订阅(观察者)模式’ vol.2 : 自定义事件</a></p>
<p>如果你了解这方面知识, 下面的<code>Dep</code>类, 就显得十分简单, 打开<code>observer.js</code>写入如下代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// observer.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Dep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 每个Dep实例对应一个对应的data[key]依赖</span></span><br><span class="line">  <span class="comment">// 内部维护一个依赖列表subs,每项是一个watcher实例</span></span><br><span class="line">  <span class="comment">// 每个watcher实例都是一个data[key]的依赖项</span></span><br><span class="line">  <span class="comment">// 这些watcher可能是Vue的template中绑定vm.a的位置</span></span><br><span class="line">  <span class="comment">// 此外,也可能是依赖vm.a的位置(比如依赖vm.a的计算属性)</span></span><br><span class="line">  <span class="comment">// vm.a改变时,这些依赖项都要被通知更新(notify)</span></span><br><span class="line">  <span class="keyword">this</span>.subs = []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Dep.prototype = &#123;</span><br><span class="line">  addSub: <span class="function"><span class="keyword">function</span>(<span class="params">watcher</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.subs.push(watcher)</span><br><span class="line">  &#125;,</span><br><span class="line">  notify: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.subs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">watcher</span>) </span>&#123;</span><br><span class="line">      watcher.update()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">Dep.target = <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p><code>Dep</code>可以理解为<code>Dependency(依赖)</code>, 它的实例主要帮我们收集依赖, 并采用了<code>观察者</code>的设计模式, <code>dep</code>实例维护一个<code>subs</code>数组, 这个<code>subs</code>是<code>subscribers(订阅者们)</code>的意思, 用来存放<code>data</code>上某个被<code>Vue</code>代理的数据的所有依赖项. </p>
<p><code>dep</code>实例有<code>addSub</code>方法和<code>notify</code>方法, 前者用来将依赖项添加入<code>subs</code>列表, 后者在数据更新时被调用, 遍历<code>subs</code>列表, 并通知每一个<code>依赖项</code>进行数据更新(<code>notify</code>), 以在下一个<code>事件循环</code>(<code>event loop</code>)中完成<code>重渲染</code>(<code>re-render</code>)</p>
<p><code>subs</code>数组中的每一项都是一个<code>watcher</code>实例, 每个<code>watcher</code>都有一个<code>update</code>(更新)方法, 在<code>dep</code>实例被<code>notify</code>时被调用, 用来进行数据更新.</p>
<p>现在我们还不清楚<code>watcher</code>是什么, 对于<code>dep</code>实例与外界如何交互也一无所知, 也不知道为何在<code>Dep</code>构造函数上有一个静态属性<code>target</code>指向<code>null</code>. 这很正常, <code>Vue</code>的响应式设计是<code>Watcher</code>, <code>Observer</code>, <code>Dep</code>三个类相辅相成共同协作完成的, 之所以先介绍<code>Dep</code>类, 是因为它的代码完全符合<code>观察者模式</code>的经典设计, 从形式上最容易被理解. </p>
<p>下一篇博客, 我们将带着这些问题完成<code>Observer</code>类与<code>Watcher</code>类, 一切脉络就会渐渐清晰.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/04/01/my-vue-01/" class="next">上一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">choteewang@qq.com</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>