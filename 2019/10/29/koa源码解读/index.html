<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Koaæºç è§£è¯» Â· choteewang</title><meta name="description" content="Koaæºç è§£è¯» - choteewang@qq.com"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="choteewang"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">CHOTEE'S BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">LIST</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Koaæºç è§£è¯»</h1><div class="post-info">2019å¹´10æœˆ29æ—¥</div><div class="post-content"><p><code>Koa</code>æ˜¯ä¸€ä¸ªç²¾å·§çš„ <code>Node.js</code> æ¡†æ¶, æºç è´¨é‡æé«˜. å…¶è®¾è®¡å·§å¦™çš„<code>&quot;æ´‹è‘±æ¨¡å‹&quot;</code>ä¸­é—´ä»¶å®ç°ååˆ†ç»å…¸. å€¼å¾—ä»”ç»†ç ”è¯»ä»¥å­¦ä¹ å…¶ä¼˜ç§€çš„è®¾è®¡æ€æƒ³. åœ¨ä¸šä½™æ—¶é—´é‡Œ, æˆ‘é˜…è¯»äº†<code>Koa</code>çš„æºç , ä¸‹é¢æ˜¯æˆ‘çš„ä¸€äº›æ€»ç»“å’Œæ”¶è·.</p>
<h3 id="æºç æ–‡ä»¶"><a href="#æºç æ–‡ä»¶" class="headerlink" title="æºç æ–‡ä»¶"></a>æºç æ–‡ä»¶</h3><p><code>Koa</code>çš„æºç æ–‡ä»¶åœ¨<code>lib</code>æ–‡ä»¶å¤¹ä¸­, è¿˜å¼•ç”¨ä¸€äº›æˆç†Ÿçš„åº“, ä»–ä»¬çš„åˆ†å·¥å¦‚ä¸‹</p>
<blockquote>
<p><code>application.js</code>å†…å«<code>Koa</code>ç±», æ˜¯æ•´ä¸ªæ¡†æ¶çš„å…¥å£<br><code>context.js</code>æ˜¯ctxå¯¹è±¡çš„åŸå‹, ä»£ç†<code>request</code>å’Œ<code>response</code>å¯¹è±¡ä¸Šçš„å±æ€§å’Œæ–¹æ³•<br><code>request.js</code>å¯¼å‡º<code>request</code>çš„åŸå‹å¯¹è±¡<br><code>response.js</code>å¯¼å‡º<code>response</code>çš„åŸå‹å¯¹è±¡<br>å®ç°<code>&quot;æ´‹è‘±æ¨¡å‹&quot;</code>çš„<code>compose</code>å‡½æ•°åœ¨å•ç‹¬çš„npmåŒ…<code>koa-compose</code>ä¸­<br>é¡¹ç›®è¿˜ä¾èµ–äº†<code>node-delegates</code>åº“, ç”¨æ¥ä»£ç†æ–¹æ³•å’Œå±æ€§.</p>
</blockquote>
<h3 id="new-Koa-listen"><a href="#new-Koa-listen" class="headerlink" title="new Koa().listen()"></a>new Koa().listen()</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Emitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.proxy = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// ä¸­é—´ä»¶æ•°ç»„</span></span><br><span class="line">    <span class="keyword">this</span>.middleware = [];</span><br><span class="line">    <span class="keyword">this</span>.subdomainOffset = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">this</span>.env = process.env.NODE_ENV || <span class="string">'development'</span>;</span><br><span class="line">    <span class="comment">// åŸå‹ç»§æ‰¿ context, request, response å, æŒ‚è½½åœ¨appå®ä¾‹ä¸Š</span></span><br><span class="line">    <span class="keyword">this</span>.context = <span class="built_in">Object</span>.create(context);</span><br><span class="line">    <span class="keyword">this</span>.request = <span class="built_in">Object</span>.create(request);</span><br><span class="line">    <span class="keyword">this</span>.response = <span class="built_in">Object</span>.create(response);</span><br><span class="line">    <span class="keyword">if</span> (util.inspect.custom) &#123;</span><br><span class="line">      <span class="keyword">this</span>[util.inspect.custom] = <span class="keyword">this</span>.inspect;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  listen(...args) &#123;</span><br><span class="line">    debug(<span class="string">'listen'</span>);</span><br><span class="line">    <span class="keyword">const</span> server = http.createServer(<span class="keyword">this</span>.callback());</span><br><span class="line">    <span class="keyword">return</span> server.listen(...args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Application</code>å°±æ˜¯<code>Koa</code>ç±», å®ƒç»§æ‰¿è‡ªNodeåŸç”Ÿæ¨¡å—<code>Emitter</code>, å…·å¤‡äº†äº‹ä»¶æœºåˆ¶çš„èƒ½åŠ›. åœ¨<code>new Koa()</code>æ—¶, ç±»å®ä¾‹æŒ‚è½½äº†ä¸­é—´ä»¶æ•°ç»„, ç¯å¢ƒå˜é‡, å¹¶åŸå‹ç»§æ‰¿äº†ä»<code>context</code>, <code>request</code>, <code>response</code>ä¸‰ä¸ªæ¨¡å—å¯¼å‡ºçš„å¯¹è±¡, å°†ç»§æ‰¿åçš„å¯¹è±¡æŒ‚è½½åˆ°<code>app</code>ä¸Š.</p>
<p>åœ¨è°ƒç”¨<code>app.listen</code>æ–¹æ³•æ—¶, å†…éƒ¨è°ƒç”¨NodeåŸç”Ÿçš„<code>http.createServer</code>, å¹¶å°†<code>listen</code>çš„å…¨éƒ¨å‚æ•°é€ä¼ ç»™<code>server.listen</code></p>
<p>è‡³æ­¤, nodeæœåŠ¡åˆå§‹åŒ–å®Œæˆ, <code>http.createServer</code>çš„å›è°ƒç”±<code>this.callback</code>è¿è¡Œæ—¶è¿”å›, è¿™é‡Œæ˜¯ä¸€åˆ‡æ¡†æ¶é€»è¾‘çš„å®é™…å…¥å£.</p>
<h3 id="app-use"><a href="#app-use" class="headerlink" title="app.use()"></a>app.use()</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">use(fn) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'middleware must be a function!'</span>);</span><br><span class="line">  <span class="keyword">if</span> (isGeneratorFunction(fn)) &#123;</span><br><span class="line">    deprecate(<span class="string">'Support for generators will be removed in v3. '</span> +</span><br><span class="line">              <span class="string">'See the documentation for examples of how to convert old middleware '</span> +</span><br><span class="line">              <span class="string">'https://github.com/koajs/koa/blob/master/docs/migration.md'</span>);</span><br><span class="line">    fn = convert(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  debug(<span class="string">'use %s'</span>, fn._name || fn.name || <span class="string">'-'</span>);</span><br><span class="line">  <span class="keyword">this</span>.middleware.push(fn);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>app.use</code>æ–¹æ³•ç”¨äºæ³¨å†Œä¸­é—´ä»¶, <code>&quot;æ´‹è‘±æœºåˆ¶&quot;</code>ä¼šä¿è¯ä¸­é—´ä»¶çš„å¼‚æ­¥æ‰§è¡Œé¡ºåº, è¯¥æ–¹æ³•ä¼šå…ˆæ£€æŸ¥<code>fn</code>æ˜¯å¦æ˜¯ä¸€ä¸ª<code>function</code>, å¦‚æœä¸­é—´ä»¶ä¸æ˜¯<code>async function</code>, è€Œæ˜¯<code>generator function</code>, ä¼šç”¨<code>koa-convert</code>å¯¹æ–¹æ³•è¿›è¡Œè½¬æ¢. </p>
<p>åœ¨æ£€æŸ¥ç»“æŸå, å°†ä¸­é—´ä»¶æ–¹æ³•æ”¾å…¥<code>this.middleware</code>æ•°ç»„, <code>return this</code>ç¡®ä¿é“¾å¼è°ƒç”¨.</p>
<h3 id="this-callback-ç”Ÿæˆ-createServer-æ–¹æ³•çš„å›è°ƒå‡½æ•°"><a href="#this-callback-ç”Ÿæˆ-createServer-æ–¹æ³•çš„å›è°ƒå‡½æ•°" class="headerlink" title="this.callback(): ç”Ÿæˆ createServer æ–¹æ³•çš„å›è°ƒå‡½æ•°"></a>this.callback(): ç”Ÿæˆ createServer æ–¹æ³•çš„å›è°ƒå‡½æ•°</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">callback() &#123;</span><br><span class="line">  <span class="keyword">const</span> fn = compose(<span class="keyword">this</span>.middleware);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.listenerCount(<span class="string">'error'</span>)) <span class="keyword">this</span>.on(<span class="string">'error'</span>, <span class="keyword">this</span>.onerror);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleRequest = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.createContext(req, res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.handleRequest(ctx, fn);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> handleRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>this.callback</code>æ–¹æ³•å…ˆç»„åˆæ‰€æœ‰çš„ä¸­é—´ä»¶(ç»„åˆä¸­é—´ä»¶çš„éƒ¨åˆ†å°†åœ¨ä¸‹èŠ‚é‡ç‚¹åˆ†æ), å†ç”Ÿæˆ<code>http.createServer</code>çš„å›è°ƒ. <code>handleRequest</code>æ–¹æ³•å³<code>http.createServer</code>çš„æœ€å¤–å±‚, è¯¥æ–¹æ³•å†…éƒ¨å…ˆç»„åˆ<code>ctx</code>å¯¹è±¡, ç”¨<code>ctx</code>ä»£ç†NodeåŸç”Ÿçš„<code>request</code>å’Œ<code>response</code>ä¸Šçš„å±æ€§å’Œæ–¹æ³•(<code>ctx</code>çš„æ„é€ è¿‡ç¨‹å°†åœ¨æœ€åä¸€èŠ‚é‡ç‚¹åˆ†æ), å†è°ƒç”¨å®ä¾‹ä¸Šçš„<code>handleRequest</code>æ–¹æ³•.</p>
<h3 id="æ„å»ºæ´‹è‘±æ¨¡å‹-composeæ–¹æ³•è§£è¯»"><a href="#æ„å»ºæ´‹è‘±æ¨¡å‹-composeæ–¹æ³•è§£è¯»" class="headerlink" title="æ„å»ºæ´‹è‘±æ¨¡å‹, composeæ–¹æ³•è§£è¯»"></a>æ„å»ºæ´‹è‘±æ¨¡å‹, composeæ–¹æ³•è§£è¯»</h3><p><img src="https://i.loli.net/2019/07/22/5d355e003651531664.png" alt="æ´‹è‘±æ¨¡å‹"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span> (<span class="params">middleware</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ç±»å‹æ£€æŸ¥</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(middleware)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Middleware stack must be an array!'</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> fn <span class="keyword">of</span> middleware) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Middleware must be composed of functions!'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‚æ•° next è¡¨æ˜åœ¨æ‰§è¡Œå®Œæ‰€æœ‰ä¸­é—´ä»¶å, æ˜¯å¦è¿˜è¦é¢å¤–æ‰§è¡Œä¸€ä¸ªä¸­é—´ä»¶(å…¨å±€åç½®ä¸­é—´ä»¶)</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">context, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// last called middleware #</span></span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">-1</span></span><br><span class="line">    <span class="keyword">return</span> dispatch(<span class="number">0</span>)</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// æ¯æ‰§è¡Œä¸€ä¸ªä¸­é—´ä»¶ i++, indexä¹Ÿ++, i-index=1, ä½†å¦‚æœè¿ç»­è°ƒç”¨ä¸¤æ¬¡await next(), ç¬¬äºŒæ¬¡è°ƒç”¨next()æ—¶iæ²¡å˜(ä¸Šæ¬¡è°ƒç”¨çš„é—­åŒ…ä½œç”¨åŸŸå¼•ç”¨), indexå´++äº†</span></span><br><span class="line">      <span class="keyword">if</span> (i &lt;= index) <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'next() called multiple times'</span>))</span><br><span class="line">      index = i</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åµŒå¥—æ‰§è¡Œä¸­é—´ä»¶</span></span><br><span class="line">      <span class="keyword">let</span> fn = middleware[i]</span><br><span class="line">      <span class="comment">// å¦‚æœæ‰€æœ‰ä¸­é—´ä»¶éƒ½æ‰§è¡Œå®Œäº†, è¿è¡Œä¼ å…¥çš„å…¨å±€åç½®ä¸­é—´ä»¶</span></span><br><span class="line">      <span class="keyword">if</span> (i === middleware.length) fn = next</span><br><span class="line">      <span class="keyword">if</span> (!fn) <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</span><br><span class="line">      <span class="comment">// è¿™é‡Œç”¨try-catchæ˜¯ä¸ºäº†æ•è· fn ä¸æ˜¯asyncæ–¹æ³•, æ˜¯åŒæ­¥æ–¹æ³•çš„æƒ…å†µ</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœfnæ˜¯å¼‚æ­¥çš„async function, é”™è¯¯ä¼šè¢«handleRequestä¸­çš„.catch(onerror)æ•è·</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(fn(context, dispatch.bind(<span class="literal">null</span>, i + <span class="number">1</span>)));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>&quot;æ´‹è‘±æ¨¡å‹&quot;</code>æ˜¯<code>Koa</code>è®¾è®¡æ¨¡å¼çš„ç²¾é«“, <code>koa</code>çš„ä¸­é—´ä»¶å‡½æ•°æ˜¯<code>async function</code>, æ¯ä¸ªä¸­é—´ä»¶å‡½æ•°ç­‰å¾…ä¸‹å±‚ä¸­é—´ä»¶æ‰§è¡Œå®Œæ¯•(<code>await next()</code>)åå†ç»§ç»­æ‰§è¡Œå½“å‰ä¸­é—´ä»¶çš„åç»­é€»è¾‘, è®©æ‰€æœ‰ä¸­é—´ä»¶åƒæ´‹è‘±ä¸€æ ·åµŒå¥—èµ·æ¥.</p>
<p><code>&quot;æ´‹è‘±æ¨¡å‹&quot;</code>æ˜¯é€šè¿‡<code>compose</code>æ–¹æ³•å®ç°çš„. <code>compose</code>æ–¹æ³•éå¸¸ç»å…¸, æ˜¯å¯¹å°¾è§¦å‘è®¾è®¡æ¨¡å¼, å‡½æ•°æŸ¯é‡ŒåŒ–, é—­åŒ…, ä½œç”¨åŸŸ, åŒæ­¥ä¸å¼‚æ­¥é”™è¯¯å¤„ç†çš„ç»¼åˆè¿ç”¨, å€¼å¾—ä»”ç»†ç ”è¯».</p>
<h4 id="compose-å‡½æ•°æŸ¯é‡ŒåŒ–"><a href="#compose-å‡½æ•°æŸ¯é‡ŒåŒ–" class="headerlink" title="compose: å‡½æ•°æŸ¯é‡ŒåŒ–"></a>compose: å‡½æ•°æŸ¯é‡ŒåŒ–</h4><p><code>compose</code>æ–¹æ³•å…ˆæ£€æŸ¥ä¸­é—´ä»¶æ•°ç»„å’Œå…¶æ¯ä¸€é¡¹çš„ç±»å‹, ç„¶åè¿ç”¨å‡½æ•°æŸ¯é‡ŒåŒ–, è¿”å›ä¸€ä¸ªæ¥æ”¶<code>ctx</code>å’Œå…¨å±€åç½®ä¸­é—´ä»¶å‡½æ•°çš„æ–¹æ³•.</p>
<p>è¿™ä¸ªæ–¹æ³•å†…éƒ¨å…ˆåœ¨æœ€ä¸Šå±‚å®šä¹‰ä¸€ä¸ª<code>index</code>ä»£è¡¨å®é™…ä¸­é—´ä»¶çš„æ‰§è¡Œè®¡æ•°, ç„¶åå®šä¹‰<code>dispatch</code>æ–¹æ³•(è¿™é‡Œæœ‰å‡½æ•°æå‡), å¹¶<code>return dispatch(0)</code>, å®é™…ä¸Šä»£è¡¨ä»<code>middleware</code>æ•°ç»„çš„ç¬¬0é¡¹å¼€å§‹æ‰§è¡Œ, <code>dispatch</code>å†…éƒ¨æ‰§è¡Œçš„ä¸­é—´ä»¶å‡½æ•°ä¼šç»§ç»­è°ƒç”¨<code>dispatch(n+1)</code>. å¦‚æ­¤é€’å½’ç›´è‡³æ‰€æœ‰ä¸­é—´ä»¶å‡½æ•°æ‰§è¡Œå®Œæ¯•, å¦‚æœä¼ å…¥äº†å…¨å±€åç½®ä¸­é—´ä»¶(<code>koa-compose</code>æ˜¯ä¸ªå•ç‹¬çš„åŒ…, å…¨å±€åç½®ä¸­é—´ä»¶åœ¨å…¶ä»–åº“çš„ä½¿ç”¨ä¸­å¯ç”¨), ç»§ç»­æ‰§è¡Œå…¨å±€åç½®ä¸­é—´ä»¶, æœ€åå‘å¤–<code>return Promise.resolve()</code>.</p>
<h4 id="compose-å·§ç”¨é—­åŒ…-é¿å…å¤šæ¬¡è°ƒç”¨await-next"><a href="#compose-å·§ç”¨é—­åŒ…-é¿å…å¤šæ¬¡è°ƒç”¨await-next" class="headerlink" title="compose: å·§ç”¨é—­åŒ…, é¿å…å¤šæ¬¡è°ƒç”¨await next()"></a>compose: å·§ç”¨é—­åŒ…, é¿å…å¤šæ¬¡è°ƒç”¨await next()</h4><p>ä¸­é—´ä»¶æ–¹æ³•ä¸­çš„å‚æ•°<code>next</code>å…¶å®å°±æ˜¯<code>dispatch.bind(null, i + 1)</code>, å¦‚æœåœ¨ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ä¸­<strong>å¤šæ¬¡è°ƒç”¨<code>await next()</code>, ç­‰äºæ‰§è¡Œäº†å¤šæ¬¡<code>dispatch.bind(null, i + 1)</code>(æ³¨æ„è¿™é‡Œçš„<code>i</code>æ˜¯å›ºå®šä½œç”¨åŸŸçš„, ä¸ä¼šå˜)</strong>. æ¯æ¬¡è°ƒç”¨<code>dispatch</code>æ–¹æ³•æ—¶, ä¼šåˆ¤æ–­<code>i</code>æ˜¯å¦å¤§äº<code>index</code>, å¦‚æœä¸ç„¶åˆ™æŠ¥é”™. å¹¶å°†<code>i</code>èµ‹å€¼ç»™<code>dispatch</code>ä¸Šå±‚é—­åŒ…ä½œç”¨åŸŸçš„<code>index</code>. </p>
<p>åœ¨è¿™ç§æœºåˆ¶ä¸‹, åœ¨ä¸€ä¸ªä¸­é—´ä»¶æ–¹æ³•ä¸­å¤šæ¬¡æ‰§è¡Œ<code>await next()</code>ä¼šè®©<code>index</code>çš„å€¼æ¯æ¬¡éƒ½+1, ä½†<code>i</code>åˆ™ä¸å˜, ä»è€Œå¯¼è‡´<code>i&lt;=index</code>è€ŒæŠ¥é”™. ä½œè€…ç”¨è¿™ç§æ–¹å¼é˜²æ­¢äº†<code>await next()</code>è¢«è°ƒç”¨å¤šæ¬¡.</p>
<h4 id="compose-å°¾è§¦å‘æ¨¡å¼æ‰§è¡Œä¸­é—´ä»¶-ä¿è¯å¼‚æ­¥æ‰§è¡Œé¡ºåº-å¯ä»¥è·å–ä¸‹çº§ä¸­é—´ä»¶çš„è¿”å›ç»“æœ"><a href="#compose-å°¾è§¦å‘æ¨¡å¼æ‰§è¡Œä¸­é—´ä»¶-ä¿è¯å¼‚æ­¥æ‰§è¡Œé¡ºåº-å¯ä»¥è·å–ä¸‹çº§ä¸­é—´ä»¶çš„è¿”å›ç»“æœ" class="headerlink" title="compose: å°¾è§¦å‘æ¨¡å¼æ‰§è¡Œä¸­é—´ä»¶, ä¿è¯å¼‚æ­¥æ‰§è¡Œé¡ºåº, å¯ä»¥è·å–ä¸‹çº§ä¸­é—´ä»¶çš„è¿”å›ç»“æœ"></a>compose: å°¾è§¦å‘æ¨¡å¼æ‰§è¡Œä¸­é—´ä»¶, ä¿è¯å¼‚æ­¥æ‰§è¡Œé¡ºåº, å¯ä»¥è·å–ä¸‹çº§ä¸­é—´ä»¶çš„è¿”å›ç»“æœ</h4><p>ä¸­é—´ä»¶å‡½æ•°å†…éƒ¨æ‰§è¡Œ<code>await next()</code>å°±æ˜¯æ‰§è¡Œäº†<code>await dispatch.bind(null, i + 1)</code>, <code>dispatch</code>æ–¹æ³•è¿”å›ä¸€ä¸ª<code>promise</code>, å¹¶<code>return</code>äº†ä¸‹å±‚ä¸­é—´ä»¶æ–¹æ³•çš„æ‰§è¡Œç»“æœ<code>fn(ctx, dispatch.bind(null, n + 1))</code>, å¦‚æ­¤è¿™èˆ¬, åœ¨æœ¬å±‚ä¸­é—´ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥æ‹¿åˆ°ä¸‹å±‚ä¸­é—´ä»¶çš„æ‰§è¡Œç»“æœ.</p>
<p><strong>åœ¨<code>async function</code>ä¸­<code>await</code>åçš„é€»è¾‘ä¼šåœ¨<code>await</code>åçš„<code>promise resolved</code>åå†æ‰§è¡Œ</strong>, ç”¨è¿™ç§â€å°¾è§¦å‘+async awaitâ€çš„æ¨¡å¼å®ç°äº†<code>&quot;æ´‹è‘±æ¨¡å‹&quot;</code>, æ‰€æœ‰ä¸­é—´ä»¶çš„é€»è¾‘ä¸€å±‚å¥—ä¸€å±‚, å¼‚æ­¥é¡ºåºæ¸…æ™°æ˜äº†.</p>
<p>ä¸ºäº†å…¼å®¹ä¸­é—´ä»¶å‡½æ•°ä¸æ˜¯<code>async function</code>, åœ¨<code>return</code>ä¸­é—´ä»¶å‡½æ•°è¿”å›å€¼æ—¶ç”¨äº†<code>promise.resolve</code>åŒ…è£¹, ä¿è¯äº†ä¸­é—´ä»¶ä¸­æœ‰åŒæ­¥å‡½æ•°æ—¶çš„å¼‚æ­¥æ‰§è¡Œé¡ºåº.</p>
<h4 id="compose-é”™è¯¯å¤„ç†"><a href="#compose-é”™è¯¯å¤„ç†" class="headerlink" title="compose: é”™è¯¯å¤„ç†"></a>compose: é”™è¯¯å¤„ç†</h4><p>ç”±äºä¸­é—´ä»¶å‡½æ•°è¿”å›<code>promise</code>, <code>dispatch</code>ä¹Ÿè¿”å›<code>promise</code>, åœ¨<code>application.js</code>ä¸­çš„<code>app.handleRequest</code>æ–¹æ³•ä¸­:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .thenå¯ä»¥è·å– dispatch(0) resolvedåçš„æ—¶é—´ç‚¹, handleResponseå¯ä»¥è·å–ä¿®æ”¹åçš„ctx</span></span><br><span class="line"><span class="comment">// .catchå¯ä»¥æ‹¿åˆ°æ‰€æœ‰ä¸­é—´ä»¶åµŒå¥—æ‰§è¡Œæ—¶, async functionäº§ç”Ÿçš„é”™è¯¯.</span></span><br><span class="line">fnMiddleware(ctx).then(handleResponse).catch(onerror)</span><br></pre></td></tr></table></figure>
<p>å¦‚æ³¨é‡Šæ‰€ç¤º, å¤–å±‚è°ƒç”¨<code>compose</code>æ–¹æ³•è¿”å›çš„å‡½æ•°æ—¶, å¯ä»¥è·å–è¿”å›çš„<code>promise</code>çš„é”™è¯¯. ä¸ºä»€ä¹ˆè¿˜è¦åœ¨<code>dispatch</code>ä¸­<code>try-catch</code>? </p>
<p>å¦‚æœå½“å‰ä¸­é—´ä»¶æ–¹æ³•ä¸æ˜¯<code>async function</code>, <code>promise</code>æ— æ³•æ•è·åŒæ­¥æ–¹æ³•ä¸­äº§ç”Ÿçš„é”™è¯¯, æ‰€ä»¥è¿™ä¸ª<code>try-catch</code>æ˜¯ä¸ºäº†å…¼å®¹åŒæ­¥çš„ä¸­é—´ä»¶å†™æ³•çš„é”™è¯¯æ•è·.</p>
<p>ç»¼ä¸Š, æˆ‘ä»¬åˆ†æäº†<code>compose</code>æ–¹æ³•, è¿™ä¸ªæ–¹æ³•æ˜¯<code>Koa</code>è®¾è®¡æ¨¡å¼çš„ç²¾é«“ä¹‹ä¸€, å€¼å¾—åå¤æ¨æ•².</p>
<h3 id="createContext-req-res-ç»„è£…ctx"><a href="#createContext-req-res-ç»„è£…ctx" class="headerlink" title="createContext(req, res), ç»„è£…ctx"></a>createContext(req, res), ç»„è£…ctx</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">createContext(req, res) &#123;</span><br><span class="line">  <span class="keyword">const</span> context = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.context);</span><br><span class="line">  <span class="keyword">const</span> request = context.request = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.request);</span><br><span class="line">  <span class="keyword">const</span> response = context.response = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.response);</span><br><span class="line">  context.app = request.app = response.app = <span class="keyword">this</span>;</span><br><span class="line">  context.req = request.req = response.req = req;</span><br><span class="line">  context.res = request.res = response.res = res;</span><br><span class="line">  request.ctx = response.ctx = context;</span><br><span class="line">  request.response = response;</span><br><span class="line">  response.request = request;</span><br><span class="line">  context.originalUrl = request.originalUrl = req.url;</span><br><span class="line">  context.state = &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>createContext</code>æ–¹æ³•æ¥æ”¶NodeåŸç”Ÿçš„<code>req</code>å’Œ<code>res</code>, å¹¶ä»¥<code>request.js</code>, <code>response.js</code>, <code>context.js</code>ä¸‰ä¸ªæ¨¡å—å¯¼å‡ºçš„å¯¹è±¡ä¸ºåŸå‹å¯¹è±¡, ä½¿ç”¨åŸå‹ç»§æ‰¿åˆ›é€ äº†å¯¹åº”çš„å¯¹è±¡, ç”¨è¿™äº›å¯¹è±¡ç»„è£…äº†<code>ctx</code>å¯¹è±¡å¹¶è¿”å›.</p>
<p>è¿™é‡Œæœ‰ä¸ªå¤§æ¦‚å°è±¡å³å¯, åœ¨æœ€åä¸€èŠ‚çš„è§£æä¸­ä¼šè¯¦ç»†åˆ†ææ­¤å¤„çš„è®¾è®¡æ¨¡å¼.</p>
<h3 id="Application-gt-handleRequest-ctx-fn"><a href="#Application-gt-handleRequest-ctx-fn" class="headerlink" title="Application -&gt; handleRequest(ctx, fn)"></a>Application -&gt; handleRequest(ctx, fn)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">handleRequest(ctx, fnMiddleware) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = ctx.res;</span><br><span class="line">  res.statusCode = <span class="number">404</span>;</span><br><span class="line">  <span class="keyword">const</span> onerror = <span class="function"><span class="params">err</span> =&gt;</span> ctx.onerror(err);</span><br><span class="line">  <span class="keyword">const</span> handleResponse = <span class="function"><span class="params">()</span> =&gt;</span> respond(ctx);</span><br><span class="line">  onFinished(res, onerror);</span><br><span class="line">  <span class="keyword">return</span> fnMiddleware(ctx).then(handleResponse).catch(onerror);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰é¢ä¸¤èŠ‚å›é¡¾äº†<code>compose</code>å’Œ<code>createContext</code>çš„è¿‡ç¨‹, åˆ†åˆ«ç”Ÿæˆäº†<code>this.handleRequest</code>çš„ä¸¤ä¸ªå‚æ•°. </p>
<p><code>handleRequest</code>æ–¹æ³•å…ˆå°†å“åº”çŠ¶æ€è®¾ä¸º<code>404</code>(å¦‚æœå“åº”ç»“æœä¸ä¸º404, ä¼šåœ¨<code>respond</code>æ–¹æ³•ä¸­æ›´æ”¹), å®šä¹‰é”™è¯¯å¤„ç†å‡½æ•°<code>onerror</code>(å†…éƒ¨è°ƒç”¨<code>ctx.onerror</code>, ä¹‹åä¼šè¯¦ç»†è§£è¯»), ç„¶åé€šè¿‡<code>on-finished</code>åº“æ³¨å†Œ<code>onerror</code>æ–¹æ³•, <code>on-Finished</code>åº“ä¼šåœ¨è¯·æ±‚å…³é—­æˆ–å‡ºé”™åè°ƒç”¨<code>onerror</code>æ–¹æ³•, æ‰€ä»¥æ¯æ¬¡è¯·æ±‚å<code>onerror</code>æ–¹æ³•éƒ½ä¼šæ‰§è¡Œ. <code>ctx.onerror</code>æ–¹æ³•ä¸Šæ¥ä¼šåˆ¤æ–­:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">null</span> == err) <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥åªè¦æ²¡æœ‰é”™è¯¯å¯¹è±¡ä¸º<code>null</code>æˆ–è€…<code>undefined</code>, <code>ctx.onerror</code>çš„æ–¹æ³•çš„é€»è¾‘å®é™…ä¸ä¼šæ‰§è¡Œ.</p>
<p>ç»§ç»­æ¥çœ‹<code>handleRequest</code>æ–¹æ³•, é™¤äº†<code>onerror</code>æ–¹æ³•, è¿˜å®šä¹‰äº†<code>handleResponse</code>æ–¹æ³•, å®é™…è°ƒç”¨çš„æ˜¯<code>respond</code>æ–¹æ³•(ä¸‹è¯¦), æœ€åè°ƒç”¨<code>compose</code>ç»„æˆçš„ä¸­é—´ä»¶æ´‹è‘±å‡½æ•°, æŒ‰ç…§<code>&quot;æ´‹è‘±æ¨¡å‹&quot;</code>çš„å¼‚æ­¥é¡ºåºæ‰§è¡Œå¹¶é€æ­¥æ”¹é€ å‚æ•°<code>ctx</code>. <code>fnMiddleware</code>è¿”å›ä¸€ä¸ª<code>promise</code>, è¿™ä¸ª<code>promise</code>ä»£è¡¨æœ€å¤–å±‚ä¸­é—´ä»¶çš„æ‰§è¡ŒçŠ¶æ€, ç”¨<code>respond</code>æ–¹æ³•å¤„ç†å…¶<code>resolved</code>çš„çŠ¶æ€, å¦‚æœä¸­é—´ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯, ç”¨<code>onerror</code>å¤„ç†é”™è¯¯.</p>
<h3 id="respond-åœ¨æ‰€æœ‰ä¸­é—´ä»¶æ‰§è¡Œç»“æŸåå¤„ç†response"><a href="#respond-åœ¨æ‰€æœ‰ä¸­é—´ä»¶æ‰§è¡Œç»“æŸåå¤„ç†response" class="headerlink" title="respond, åœ¨æ‰€æœ‰ä¸­é—´ä»¶æ‰§è¡Œç»“æŸåå¤„ç†response"></a>respond, åœ¨æ‰€æœ‰ä¸­é—´ä»¶æ‰§è¡Œç»“æŸåå¤„ç†response</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">respond</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœåœ¨ä¸šåŠ¡ä»£ç é‡Œæ˜¾ç¤ºçš„è®¾ç½®ç»•è¿‡koaçš„respondå¤„ç†, return</span></span><br><span class="line">  <span class="comment">// allow bypassing koa</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">false</span> === ctx.respond) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœctxè¢«è®¾ç½®ä¸ºä¸å¯å†™, return</span></span><br><span class="line">  <span class="keyword">if</span> (!ctx.writable) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = ctx.res;</span><br><span class="line">  <span class="keyword">let</span> body = ctx.body;</span><br><span class="line">  <span class="keyword">const</span> code = ctx.status;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨statusesåº“ç›‘æµ‹å½“å‰statusæ˜¯å¦ä¸éœ€è¦å¤„ç†å“åº”ä½“, å¦‚æœæ˜¯å°†å“åº”ä½“è®¾ç½®ä¸ºnull, ç›´æ¥ç»“æŸå“åº”</span></span><br><span class="line">  <span class="comment">// ignore body</span></span><br><span class="line">  <span class="keyword">if</span> (statuses.empty[code]) &#123;</span><br><span class="line">    <span class="comment">// strip headers</span></span><br><span class="line">    ctx.body = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> res.end();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯ctxçš„HEADæ–¹æ³•, å¯¹å“åº”å¤´è¿›è¡Œå¤„ç†, å¹¶ç›´æ¥ç»“æŸå“åº”</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'HEAD'</span> == ctx.method) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæœªå‘é€å“åº”å¤´, ä¸”å“åº”ä½“æ˜¯JSON, å¯¹Content-Lengthè¿›è¡Œå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (!res.headersSent &amp;&amp; isJSON(body)) &#123;</span><br><span class="line">      ctx.length = Buffer.byteLength(<span class="built_in">JSON</span>.stringify(body));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.end();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å½“è¿”å›çš„çŠ¶æ€ç è¡¨ç¤ºæœ‰å“åº”ä¸»ä½“ï¼Œä½†å“åº”ä¸»ä½“ä¸ºç©ºæ—¶ï¼Œå°†å“åº”ä¸»ä½“è®¾ç½®ä¸ºå“åº”ä¿¡æ¯æˆ–çŠ¶æ€ç (å…¶å®æ˜¯ä¸€ç§ä½“éªŒå‡çº§)ã€‚</span></span><br><span class="line">  <span class="comment">// status body</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">null</span> == body) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.req.httpVersionMajor &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      body = <span class="built_in">String</span>(code);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      body = ctx.message || <span class="built_in">String</span>(code);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å½“å“åº”å¤´æœªå‘é€æ—¶è®¾ç½®Content-Typeä¸Content-Length(å› ä¸ºres.writeå¯ä»¥å¤šæ¬¡)ï¼š</span></span><br><span class="line">    <span class="keyword">if</span> (!res.headersSent) &#123;</span><br><span class="line">      <span class="comment">// ctx.typeä»£ç†çš„æ˜¯è®¾ç½®Content-typeçš„æ–¹æ³•</span></span><br><span class="line">      <span class="comment">// ctx.lengthä»£ç†çš„æ˜¯è®¾ç½®Content-lengthçš„æ–¹æ³•</span></span><br><span class="line">      ctx.type = <span class="string">'text'</span>;</span><br><span class="line">      ctx.length = Buffer.byteLength(body);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.end(body);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹ä¸åŒå“åº”ä½“è¿›è¡Œå¤„ç†</span></span><br><span class="line">  <span class="comment">// responses</span></span><br><span class="line">  <span class="keyword">if</span> (Buffer.isBuffer(body)) <span class="keyword">return</span> res.end(body);</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> body) <span class="keyword">return</span> res.end(body);</span><br><span class="line">  <span class="keyword">if</span> (body <span class="keyword">instanceof</span> Stream) <span class="keyword">return</span> body.pipe(res);</span><br><span class="line">  body = <span class="built_in">JSON</span>.stringify(body);</span><br><span class="line">  <span class="comment">// å¦‚æœæœªå‘é€å“åº”å¤´</span></span><br><span class="line">  <span class="keyword">if</span> (!res.headersSent) &#123;</span><br><span class="line">    ctx.length = Buffer.byteLength(body);</span><br><span class="line">  &#125;</span><br><span class="line">  res.end(body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>respond</code>æ–¹æ³•æ˜¯åœ¨ä¸­é—´ä»¶å¤„ç†<code>resolved</code>åå¤„ç†<code>response</code>çš„è¿‡ç¨‹. æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–çš„å…·ä½“é€»è¾‘</p>
<p>å¦‚æœåœ¨ä¸­é—´ä»¶å¤„ç†çš„è¿‡ç¨‹ä¸­æ›¾æ˜¾å¼çš„æ³¨æ˜äº†<code>ctx.respond = false</code>, åˆ™ä»£è¡¨éœ€è¦è·³è¿‡<code>koa</code>çš„<code>response</code>å¤„ç†è¿‡ç¨‹, ç›´æ¥<code>return</code></p>
<p>å¦‚æœ<code>ctx</code>æ›¾è¢«è®¾ç½®ä¸ºä¸å¯å†™, <code>return</code></p>
<p>ä¹‹å, ç”¨<code>statuses</code>åº“åˆ¤æ–­å½“å‰çš„<code>status code</code>æ˜¯å¦æ˜¯ä¸éœ€è¦å“åº”ä½“çš„ç±»å‹, å¦‚æœæ˜¯ç›´æ¥å°†å“åº”ä½“ç½®ç©º, å¹¶ç»“æŸå“åº”. </p>
<p>ç»§ç»­å¯¹<code>HEAD</code>æ–¹æ³•åšç‰¹æ®Šå¤„ç†, å¦‚æœå“åº”å¤´å·²å‘é€, å“åº”ä½“æ˜¯<code>JSON</code>, è®¡ç®—å“åº”ä½“é•¿åº¦åç»“æŸå“åº”.</p>
<p>ç„¶åå¤„ç†<code>status</code>å¯ä»¥æœ‰å“åº”ä½“çš„æƒ…å†µï¼Œå½“å“åº”ä½“ä¸ºç©ºæ—¶ï¼Œå°†å“åº”ä½“è®¾ç½®ä¸ºå“åº”ä¿¡æ¯æˆ–çŠ¶æ€ç (å…¶å®æ˜¯ä¸€ç§ä½“éªŒä¼˜åŒ–)ã€‚å¹¶å½“å“åº”å¤´æœªå‘é€æ—¶è®¾ç½®<code>Content-Type</code>ä¸<code>Content-Length</code></p>
<p>æœ€åå¯¹ä¸åŒç±»å‹çš„å“åº”åšå¤„ç†åè¿”å›.</p>
<h3 id="Context-onerror"><a href="#Context-onerror" class="headerlink" title="Context.onerror"></a>Context.onerror</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">onerror(err) &#123;</span><br><span class="line">  <span class="comment">// don't do anything if there is no error.</span></span><br><span class="line">  <span class="comment">// this allows you to pass `this.onerror`</span></span><br><span class="line">  <span class="comment">// to node-style callbacks.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å½“errä¸ºnullæˆ–undefinedæ—¶ç›´æ¥return, å¦åˆ™åˆ›é€ å¼‚å¸¸å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">null</span> == err) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(err <span class="keyword">instanceof</span> <span class="built_in">Error</span>)) err = <span class="keyword">new</span> <span class="built_in">Error</span>(util.format(<span class="string">'non-error thrown: %j'</span>, err));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå“åº”å¤´å·²å‘é€æˆ–å“åº”ä¸å¯å†™(æ— æ³•åœ¨å“åº”ä¸­å†™å…¥é”™è¯¯ä¿¡æ¯), åˆ™é€€å‡ºè¯¥å‡½æ•°</span></span><br><span class="line">  <span class="keyword">let</span> headerSent = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.headerSent || !<span class="keyword">this</span>.writable) &#123;</span><br><span class="line">    headerSent = err.headerSent = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// delegate</span></span><br><span class="line">  <span class="comment">// è§¦å‘appçš„erroräº‹ä»¶, å°†é”™è¯¯æŠ›ç»™å¤–å±‚ä¸šåŠ¡</span></span><br><span class="line">  <span class="keyword">this</span>.app.emit(<span class="string">'error'</span>, err, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// nothing we can do here other</span></span><br><span class="line">  <span class="comment">// than delegate to the app-level</span></span><br><span class="line">  <span class="comment">// handler and log.</span></span><br><span class="line">  <span class="keyword">if</span> (headerSent) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; res &#125; = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// first unset all headers</span></span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å› ä¸ºå‘ç”Ÿäº†é”™è¯¯, å°†æ‰€æœ‰åœ¨ä¸­é—´ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å“åº”å¤´æ¸…ç©º</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> res.getHeaderNames === <span class="string">'function'</span>) &#123;</span><br><span class="line">    res.getHeaderNames().forEach(<span class="function"><span class="params">name</span> =&gt;</span> res.removeHeader(name));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res._headers = &#123;&#125;; <span class="comment">// Node &lt; 7.7</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// then set those specified</span></span><br><span class="line">  <span class="comment">// æ¸…ç©ºresponseå¤´åå°†å¤´è®¾ç½®ä¸ºé”™è¯¯å¤´</span></span><br><span class="line">  <span class="keyword">this</span>.set(err.headers);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// force text/plain</span></span><br><span class="line">  <span class="keyword">this</span>.type = <span class="string">'text'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ENOENT support</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'ENOENT'</span> == err.code) err.status = <span class="number">404</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// default to 500</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'number'</span> != <span class="keyword">typeof</span> err.status || !statuses[err.status]) err.status = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†é”™è¯¯çš„statuså’Œmsgå¹¶è¿”å›</span></span><br><span class="line">  <span class="comment">// respond</span></span><br><span class="line">  <span class="keyword">const</span> code = statuses[err.status];</span><br><span class="line">  <span class="keyword">const</span> msg = err.expose ? err.message : code;</span><br><span class="line">  <span class="keyword">this</span>.status = err.status;</span><br><span class="line">  <span class="keyword">this</span>.length = Buffer.byteLength(msg);</span><br><span class="line">  res.end(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ä¸­é—´ä»¶å¤„ç†å‡½æ•°ç»“æœçš„<code>promise</code>è¢«<code>resolved</code>å, è°ƒç”¨<code>respond</code>æ–¹æ³•å¤„ç†<code>response</code>. å¹¶è¡Œçš„, å¦‚æœ<code>promise</code>è¢«<code>reject</code>, <code>ctx.onerror</code>ç”¨æ¥å¤„ç†ä¸­é—´ä»¶å¤„ç†ç¯èŠ‚ä¸­çš„é”™è¯¯</p>
<p>å½“<code>err</code>æ˜¯<code>null</code>æˆ–<code>undefined</code>æ—¶, ç›´æ¥<code>return</code>, å¦åˆ™åˆ›å»ºä¸€ä¸ªé”™è¯¯å¯¹è±¡.</p>
<p>é¦–å…ˆå°†<code>err</code>æŠ›ç»™ä¸Šå±‚ä¸šåŠ¡çš„<code>error</code>äº‹ä»¶å¤„ç†, å¦‚æœå“åº”å¤´å·²å‘é€æˆ–å“åº”ä¸å¯å†™, é€€å‡ºé”™è¯¯å¤„ç†é€»è¾‘.</p>
<p>ä¹‹åå°†æ‰€æœ‰è¢«è®¾ç½®è¿‡çš„å“åº”å¤´æ¸…ç©ºå¹¶è®¾ç½®é”™è¯¯çš„å“åº”å¤´, è®¾ç½®è¿”å›é”™è¯¯çš„<code>Content-type</code>æ˜¯<code>text</code>, è®¾ç½®é»˜è®¤é”™è¯¯ç ä¸º500, æœ€åå¤„ç†<code>status</code>å’Œ<code>message</code>å¹¶ç»“æŸå“åº”.</p>
<h3 id="Context-Request-Responseæ¨¡å—"><a href="#Context-Request-Responseæ¨¡å—" class="headerlink" title="Context, Request, Responseæ¨¡å—"></a>Context, Request, Responseæ¨¡å—</h3><h4 id="instance-request-ä¸¥è°¨çš„äºŒé‡é˜²æ­¢æ±¡æŸ“é€»è¾‘"><a href="#instance-request-ä¸¥è°¨çš„äºŒé‡é˜²æ­¢æ±¡æŸ“é€»è¾‘" class="headerlink" title="instance/request, ä¸¥è°¨çš„äºŒé‡é˜²æ­¢æ±¡æŸ“é€»è¾‘"></a>instance/request, ä¸¥è°¨çš„äºŒé‡é˜²æ­¢æ±¡æŸ“é€»è¾‘</h4><p>ä¸‹é¢åˆ†æ<code>Context</code>, <code>Request</code>, <code>Response</code>æ¨¡å—çš„è®¾è®¡æ¨¡å¼, å…ˆå›å¿†ä¸‹<code>koa</code>ä¸­ä¸è¿™ä¸‰ä¸ªæ¨¡å—ç›¸å…³çš„ä¸»æµç¨‹æ–¹æ³•:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> context = <span class="built_in">require</span>(<span class="string">'./context'</span>);</span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'./request'</span>);</span><br><span class="line"><span class="keyword">const</span> response = <span class="built_in">require</span>(<span class="string">'./response'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">constructor</span>() &#123;</span><br><span class="line">  <span class="keyword">this</span>.context = <span class="built_in">Object</span>.create(context);</span><br><span class="line">  <span class="keyword">this</span>.request = <span class="built_in">Object</span>.create(request);</span><br><span class="line">  <span class="keyword">this</span>.response = <span class="built_in">Object</span>.create(response);</span><br><span class="line">&#125;</span><br><span class="line">createContext(req, res) &#123;</span><br><span class="line">  <span class="keyword">const</span> context = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.context);</span><br><span class="line">  <span class="keyword">const</span> request = context.request = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.request);</span><br><span class="line">  <span class="keyword">const</span> response = context.response = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.response);</span><br><span class="line">  context.app = request.app = response.app = <span class="keyword">this</span>;</span><br><span class="line">  context.req = request.req = response.req = req;</span><br><span class="line">  context.res = request.res = response.res = res;</span><br><span class="line">  request.ctx = response.ctx = context;</span><br><span class="line">  request.response = response;</span><br><span class="line">  response.request = request;</span><br><span class="line">  context.originalUrl = request.originalUrl = req.url;</span><br><span class="line">  context.state = &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line">callback() &#123;</span><br><span class="line">  <span class="comment">// æ¯ä¸ªåº”ç”¨çš„composeæ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">  <span class="keyword">const</span> fn = compose(<span class="keyword">this</span>.middleware);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.listenerCount(<span class="string">'error'</span>)) <span class="keyword">this</span>.on(<span class="string">'error'</span>, <span class="keyword">this</span>.onerror);</span><br><span class="line">  <span class="comment">// handleRequestæ–¹æ³•æ¯ä¸ªè¯·æ±‚éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">  <span class="keyword">const</span> handleRequest = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.createContext(req, res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.handleRequest(ctx, fn);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> handleRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç„¶, <code>koa</code>å¯¹<code>context</code>, <code>request</code>, <code>response</code>è¿›è¡Œäº†ä¸¤æ¬¡åŸå‹ç»§æ‰¿, ç¬¬ä¸€æ¬¡åœ¨<code>constructor</code>ä¸­, ç¬¬äºŒæ¬¡åœ¨<code>createContext</code>ä¸­. ä¸ºä»€ä¹ˆè¦è¿›è¡Œä¸¤æ¬¡åŸå‹ç»§æ‰¿? </p>
<p><code>createContext</code>æ–¹æ³•æ˜¯åœ¨<code>http.createServer</code>ä¸­æ‰§è¡Œçš„, åœ¨ä¸€ä¸ª<code>Koa</code>åº”ç”¨ä¸­, <code>http.createServer</code>åªä¼šæ‰§è¡Œä¸€æ¬¡, æ‰€ä»¥<code>callback</code>æ–¹æ³•åªä¼šæ‰§è¡Œä¸€æ¬¡, <code>compose</code>æ–¹æ³•æ˜¯ç»„åˆä¸­é—´ä»¶å‡½æ•°çš„è¿‡ç¨‹, ä¹Ÿåªæ‰§è¡Œä¸€æ¬¡. ä½†<code>handleRequest</code>æ–¹æ³•å´æ˜¯æ¯ä¸ªè¯·æ±‚è¿›å…¥æ—¶éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡. å¦‚æ­¤è®¾è®¡, æ¯ä¸ªè¯·æ±‚éƒ½ä¼šç”Ÿæˆè‡ªå·±çš„<code>ctx</code>å¯¹è±¡, æ‰€ä»¥, åœ¨<code>createContext</code>æ–¹æ³•ä¸­è¿›è¡Œç¬¬äºŒæ¬¡åŸå‹ç»§æ‰¿, å¯ä»¥ä¿è¯<code>this.context</code>, <code>this.response</code>, <code>this.request</code>ä¸ä¼šåœ¨è¯·æ±‚é—´è¢«æ±¡æŸ“.</p>
<p>ä¸‹é¢æ¥æ€è€ƒä¸‹ç¬¬ä¸€æ¬¡ç»§æ‰¿çš„æ„ä¹‰, ç”±äº<code>Node</code>çš„<code>require</code>æ–¹æ³•ä¼šç¼“å­˜åŠ è½½çš„å¯¹è±¡, æ‰€ä»¥ç¬¬ä¸€æ¬¡åŸå‹ç»§æ‰¿æ˜¯ä¸ºäº†å¤šæ¬¡<code>new Koa</code>æ—¶, <code>koa</code>å®ä¾‹é—´çš„ä¸‰ç§å¯¹è±¡çš„åŸå‹(<code>require(&quot;./request&quot;)</code>, <code>require(&quot;./response&quot;)</code>, <code>require(&quot;./request&quot;)</code>)ä¸è¢«æ±¡æŸ“. åœ¨ä¸€ä¸ªé¡¹ç›®çš„å¤šä¸ªä¾èµ–åŒ…éƒ½åŒæ—¶ä¾èµ–äº†<code>koa</code>æ—¶, æœ‰å¯èƒ½å‡ºç°è¿™ç§æ±¡æŸ“çš„æƒ…å†µ. è¯»åˆ°è¿™é‡Œæ—¶ä¸ç¦ä½©æœä½œè€…æ€ç»´ä¹‹ä¸¥è°¨.</p>
<h3 id="contextå¯¹è±¡çš„æ„å»ºè¿‡ç¨‹"><a href="#contextå¯¹è±¡çš„æ„å»ºè¿‡ç¨‹" class="headerlink" title="contextå¯¹è±¡çš„æ„å»ºè¿‡ç¨‹"></a>contextå¯¹è±¡çš„æ„å»ºè¿‡ç¨‹</h3><p>æœ€å, æˆ‘ä»¬æ¥åˆ†æä¸‹<code>ctx</code>å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹, <code>koa</code>å¯¹å…¶è¿›è¡Œäº†ä¸¤å±‚ä»£ç†</p>
<h4 id="getter-setter-å®ç°åˆ°åŸç”Ÿreq-resçš„ç¬¬ä¸€å±‚ä»£ç†"><a href="#getter-setter-å®ç°åˆ°åŸç”Ÿreq-resçš„ç¬¬ä¸€å±‚ä»£ç†" class="headerlink" title="getter, setter å®ç°åˆ°åŸç”Ÿreq, resçš„ç¬¬ä¸€å±‚ä»£ç†"></a>getter, setter å®ç°åˆ°åŸç”Ÿreq, resçš„ç¬¬ä¸€å±‚ä»£ç†</h4><p>è¿™é‡Œç”¨<code>request</code>ä¸¾ä¾‹, <code>response</code>å’Œ<code>request</code>çš„å®ç°æ–¹å¼æ¥è¿‘, ä¸å†èµ˜è¿°.</p>
<p><code>request.js</code>æ–‡ä»¶å‘å¤–è¿”å›äº†<code>this.request</code>çš„åŸå‹å¯¹è±¡, å…¶åˆ†åˆ«ç”¨<code>getter</code>å’Œ<code>setter</code>ä»£ç†äº†<code>this.req</code>çš„å±æ€§. åœ¨<code>createContext</code>æ–¹æ³•ä¸­: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createContextæ–¹æ³•ä¸­</span></span><br><span class="line"><span class="keyword">const</span> context = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.context)</span><br><span class="line"><span class="keyword">const</span> request = context.request = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.request)</span><br><span class="line"><span class="keyword">const</span> response = context.response = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.response)</span><br><span class="line">context.req = request.req = response.req = req;</span><br><span class="line">context.res = request.res = response.res = res;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·, <code>req</code>ä»¥å±æ€§çš„å½¢å¼ç»‘å®šåˆ°äº†<code>request</code>å¯¹è±¡ä¸Š, åœ¨<code>request.js</code>ä¸­, ä»¥<code>url</code>å±æ€§ä¸ºä¾‹:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  get url() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.req.url</span><br><span class="line">  &#125; </span><br><span class="line">  set url(val) &#123;</span><br><span class="line">    <span class="keyword">this</span>.req.url = val</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æ­¤, åœ¨è¯»å†™<code>request.url</code>æ—¶, å®é™…ä¼šå¯¹<code>req.url</code>è¿›è¡Œè¯»å†™, ä»¥æ­¤å®Œæˆäº†ç¬¬ä¸€å±‚ä»£ç†.</p>
<h4 id="delegate-ç¬¬äºŒå±‚ä»£ç†"><a href="#delegate-ç¬¬äºŒå±‚ä»£ç†" class="headerlink" title="delegate ç¬¬äºŒå±‚ä»£ç†"></a>delegate ç¬¬äºŒå±‚ä»£ç†</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createContextæ–¹æ³•ä¸­</span></span><br><span class="line"><span class="keyword">const</span> context = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.context);</span><br><span class="line"><span class="keyword">const</span> request = context.request = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.request);</span><br><span class="line"><span class="keyword">const</span> response = context.response = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.response);</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>createContext</code>æ–¹æ³•ä¸­, <code>request</code>å’Œ<code>response</code>å¯¹è±¡å®é™…ç»‘å®šåˆ°äº†<code>context</code>çš„å¯¹åº”å±æ€§ä¸‹, ä½œè€…ä½¿ç”¨äº†<code>delegates</code>åº“è®©<code>context</code>ä»£ç†<code>request</code>å’Œ<code>response</code>ä¸‹çš„å„ç§æ–¹æ³•</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">delegate(proto, <span class="string">'response'</span>)</span><br><span class="line">  .method(<span class="string">'redirect'</span>)</span><br><span class="line">  .access(<span class="string">'status'</span>)</span><br><span class="line">  .getter(<span class="string">'writable'</span>);</span><br><span class="line"></span><br><span class="line">delegate(proto, <span class="string">'request'</span>)</span><br><span class="line">  .method(<span class="string">'accepts'</span>)</span><br><span class="line">  .access(<span class="string">'querystring'</span>)</span><br><span class="line">  .getter(<span class="string">'href'</span>)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹<code>delegates</code>åº“çš„å®ç°:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">Delegator</span>(<span class="params">proto, target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Delegator)) <span class="keyword">return</span> <span class="keyword">new</span> Delegator(proto, target)</span><br><span class="line">  <span class="keyword">this</span>.proto = proto</span><br><span class="line">  <span class="keyword">this</span>.target = target</span><br><span class="line">  <span class="keyword">this</span>.methods = []</span><br><span class="line">  <span class="keyword">this</span>.getters = []</span><br><span class="line">  <span class="keyword">this</span>.setters = []</span><br><span class="line">  <span class="keyword">this</span>.fluents = []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Delegator.prototype.method = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> proto = <span class="keyword">this</span>.proto</span><br><span class="line">  <span class="keyword">var</span> target = <span class="keyword">this</span>.target</span><br><span class="line">  <span class="keyword">this</span>.methods.push(name)</span><br><span class="line">  proto[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[target][name].apply(<span class="keyword">this</span>[target], <span class="built_in">arguments</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Delegator.prototype.access = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.getter(name).setter(name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Delegator.prototype.getter = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> proto = <span class="keyword">this</span>.proto</span><br><span class="line">  <span class="keyword">var</span> target = <span class="keyword">this</span>.target</span><br><span class="line">  <span class="keyword">this</span>.getters.push(name)</span><br><span class="line">  proto.__defineGetter__(name, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[target][name]</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Delegator.prototype.setter = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> proto = <span class="keyword">this</span>.proto</span><br><span class="line">  <span class="keyword">var</span> target = <span class="keyword">this</span>.target</span><br><span class="line">  <span class="keyword">this</span>.setters.push(name)</span><br><span class="line">  proto.__defineSetter__(name, <span class="function"><span class="keyword">function</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[target][name] = val</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Delegator</code>æ„é€ å‡½æ•°ä¼šç¨³å®šçš„è¿”å›ä¸€ä¸ª<code>Delegator</code>å®ä¾‹. <code>method</code>æ–¹æ³•è®©è¢«ä»£ç†å¯¹è±¡å‘½åç©ºé—´ä¸‹çš„æ–¹æ³•ä»¥è¢«ä»£ç†å¯¹è±¡ä¸ºä¸Šä¸‹æ–‡æ‰§è¡Œ. <code>getter</code>å’Œ<code>setter</code>æ–¹æ³•ç”¨äºè¿”å›å’Œè®¾ç½®è¢«ä»£ç†å¯¹è±¡ä¸Šçš„å±æ€§. <code>access</code>æ–¹æ³•ç”¨äºåŒæ—¶æ³¨å†Œ<code>getter</code>å’Œ<code>setter</code>.</p>
<p>ç»è¿‡ç¬¬äºŒé‡ä»£ç†, contextå¯¹è±¡çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="https://i.loli.net/2019/07/22/5d355d71330b888111.png" alt="contextå¯¹è±¡"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>Koa</code>çš„ä»£ç çŸ­å°ç²¾æ‚, å…¶ä¸­è•´å«äº†å¤§é‡å€¼å¾—æ¨æ•²çš„è®¾è®¡å’Œå®ç°. æ˜¯å›´ç»•æˆ‘ä»¬å·¥ä½œçš„å‘¨è¾¹ç”Ÿæ€é“¾ä¸­, æœ€å€¼å¾—ç ”è¯»çš„åº“ä¹‹ä¸€. ä¸ç§¯è·¬æ­¥, æ— ä»¥è‡³åƒé‡Œ, å¸Œæœ›è‡ªå·±å¯ä»¥åœ¨å­¦ä¹ ä¸­ä¸æ–­è¿›æ­¥. </p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/10/22/vue-source-18/" class="next">ä¸Šä¸€ç¯‡</a></div><div class="copyright"><p>Â© 2015 - 2019 <a href="http://yoursite.com">choteewang@qq.com</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>