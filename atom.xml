<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>choteewang</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2017-11-14T00:10:18.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>choteewang@qq.com</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>React Router 4 + Redux 数据流 模拟注册登录</title>
    <link href="http://yoursite.com/2017/11/14/7-React%20Router%204%20+%20Redux%20%E6%95%B0%E6%8D%AE%E6%B5%81%20%E6%A8%A1%E6%8B%9F%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95/"/>
    <id>http://yoursite.com/2017/11/14/7-React Router 4 + Redux 数据流 模拟注册登录/</id>
    <published>2017-11-14T00:03:53.000Z</published>
    <updated>2017-11-14T00:10:18.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="React-Router-4-Redux-数据流-模拟注册登录"><a href="#React-Router-4-Redux-数据流-模拟注册登录" class="headerlink" title="React Router 4 + Redux 数据流 模拟注册登录"></a>React Router 4 + Redux 数据流 模拟注册登录</h1><h2 id="BEFORE"><a href="#BEFORE" class="headerlink" title="BEFORE"></a>BEFORE</h2><p>在Redux学习的三篇学习笔记之后,加上React-Router 4的学习,模拟了一个注册登录+计数器的Redux数据流</p><h2 id="CODE"><a href="#CODE" class="headerlink" title="CODE"></a>CODE</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js Provider,路由,根组件挂载处</span></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;BrowserRouter&gt;</span><br><span class="line">      &#123;<span class="comment">/* Switch:命中第一个路由后不再继续跳转 */</span>&#125;</span><br><span class="line">      &lt;Switch&gt;</span><br><span class="line">        &#123;<span class="comment">/* Route匹配路由跳转路径与组件间的关系,exact开启精确匹配,不再继续向下查找 */</span>&#125;</span><br><span class="line">        &lt;Route path=<span class="string">'/login'</span> exact component=&#123;Auth&#125;&gt;&lt;/Route&gt;</span><br><span class="line">        &lt;Route path=<span class="string">'/dashboard'</span> component=&#123;DashBoard&#125;&gt;&lt;/Route&gt;</span><br><span class="line">        &#123;<span class="comment">/* Redirect发起重定向 */</span>&#125;</span><br><span class="line">        &lt;Redirect to=<span class="string">'/dashboard'</span>&gt;&lt;/Redirect&gt;</span><br><span class="line">      &lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>BrowserRouter&gt;</span><br><span class="line">  &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root'));</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Auth.redux.js</span></span><br><span class="line"><span class="comment">// 权限登录的reducer与action creater</span></span><br><span class="line"><span class="comment">// isAuth代表是否登录</span></span><br><span class="line"><span class="keyword">const</span> LOGIN = <span class="string">'LOGIN'</span></span><br><span class="line"><span class="keyword">const</span> LOGOUT = <span class="string">'LOGOUT'</span></span><br><span class="line"><span class="comment">//reducer</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AuthReducer = <span class="function">(<span class="params">state = &#123; isAuth: <span class="literal">false</span>, user: <span class="string">'choteewang'</span> &#125;, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> LOGIN:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    <span class="keyword">case</span> LOGOUT:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//action creater</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> login = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGIN &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> logout = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGOUT &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//myRedux.js</span></span><br><span class="line"><span class="keyword">const</span> INCREASE = <span class="string">'increase'</span></span><br><span class="line"><span class="keyword">const</span> DECREASE = <span class="string">'decrease'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducer = <span class="function">(<span class="params">state  = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increase'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrease'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: INCREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onDecrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: DECREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncreaseAsync = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      dispatch(onIncrease())</span><br><span class="line">    &#125;,<span class="number">3000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//reducer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; reducer &#125; <span class="keyword">from</span> <span class="string">'./myRedux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthReducer &#125; <span class="keyword">from</span> <span class="string">'./Auth.redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="comment">// 利用combineReducers合并两个Reducer</span></span><br><span class="line"><span class="comment">// 变为store中的state对象包裹2个reducer定义的state小对象的数据结构&#123;counter:&#123;&#125;,AutuReducer:&#123;&#125;&#125;</span></span><br><span class="line"><span class="comment">// 这里要注意改键名,防止之前使用小state的组件访问根组件state时key名发生错误</span></span><br><span class="line"><span class="comment">// 所以最佳实践是reducer要起名要有语义</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> combineReducers(&#123;<span class="attr">counter</span>:reducer, <span class="attr">AuthReducer</span>:AuthReducer&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Auth.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123;login&#125; <span class="keyword">from</span> <span class="string">'./Auth.redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Redirect&#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">  render()&#123;</span><br><span class="line">    <span class="keyword">const</span> redirect = &lt;Redirect to='/dashboard'&gt;&lt;/Redirect&gt;</span><br><span class="line">    <span class="keyword">const</span> login = (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h3&gt;您没登录,请登录&lt;<span class="regexp">/h3&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;this.props.login&#125;&gt;点我模拟登录&lt;/</span>button&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 若登录了,则跳转到dashboard页面,若没登录,显示登录页面</span></span><br><span class="line"><span class="regexp">    return this.props.isAuth ? redirect : login</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Auth = connect(</span></span><br><span class="line"><span class="regexp">  (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">      isAuth:state.AuthReducer.isAuth,</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  &#123;login&#125;</span></span><br><span class="line"><span class="regexp">)(Auth)</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dashboard.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123;login&#125; <span class="keyword">from</span> <span class="string">'./Auth.redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Redirect&#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">  render()&#123;</span><br><span class="line">    <span class="keyword">const</span> redirect = &lt;Redirect to='/dashboard'&gt;&lt;/Redirect&gt;</span><br><span class="line">    <span class="keyword">const</span> login = (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h3&gt;您没登录,请登录&lt;<span class="regexp">/h3&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;this.props.login&#125;&gt;点我模拟登录&lt;/</span>button&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 若登录了,则跳转到dashboard页面,若没登录,显示登录页面</span></span><br><span class="line"><span class="regexp">    return this.props.isAuth ? redirect : login</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Auth = connect(</span></span><br><span class="line"><span class="regexp">  (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">      isAuth:state.AuthReducer.isAuth,</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  &#123;login&#125;</span></span><br><span class="line"><span class="regexp">)(Auth)</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123;login&#125; <span class="keyword">from</span> <span class="string">'./Auth.redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Redirect&#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">  render()&#123;</span><br><span class="line">    <span class="keyword">const</span> redirect = &lt;Redirect to='/dashboard'&gt;&lt;/Redirect&gt;</span><br><span class="line">    <span class="keyword">const</span> login = (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h3&gt;您没登录,请登录&lt;<span class="regexp">/h3&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;this.props.login&#125;&gt;点我模拟登录&lt;/</span>button&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 若登录了,则跳转到dashboard页面,若没登录,显示登录页面</span></span><br><span class="line"><span class="regexp">    return this.props.isAuth ? redirect : login</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Auth = connect(</span></span><br><span class="line"><span class="regexp">  (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">      isAuth:state.AuthReducer.isAuth,</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  &#123;login&#125;</span></span><br><span class="line"><span class="regexp">)(Auth)</span></span><br></pre></td></tr></table></figure><h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="https://i.loli.net/2017/11/14/5a0a34278b587.png" alt="Jietu20171112-085631"></p><p><img src="https://i.loli.net/2017/11/14/5a0a343ce1d95.png" alt="Jietu20171112-085643"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;React-Router-4-Redux-数据流-模拟注册登录&quot;&gt;&lt;a href=&quot;#React-Router-4-Redux-数据流-模拟注册登录&quot; class=&quot;headerlink&quot; title=&quot;React Router 4 + Redux 数据流 模拟注
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redux 5:使用axios 配合redux 实现 异步请求的Redux数据流</title>
    <link href="http://yoursite.com/2017/11/14/%E4%BD%BF%E7%94%A8axios%E9%85%8D%E5%90%88Redux%E5%AE%9E%E7%8E%B0%20%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E5%90%8E%E5%8F%B0%E6%95%B0%E6%8D%AE%E7%9A%84Redux%E6%95%B0%E6%8D%AE%E6%B5%81/"/>
    <id>http://yoursite.com/2017/11/14/使用axios配合Redux实现 异步请求后台数据的Redux数据流/</id>
    <published>2017-11-14T00:02:52.000Z</published>
    <updated>2017-11-14T00:05:58.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前置知识-axios-API"><a href="#前置知识-axios-API" class="headerlink" title="前置知识 axios API"></a>前置知识 axios API</h2><p><a href="https://www.kancloud.cn/yunye/axios/234845" target="_blank" rel="external">axios API</a></p><h2 id="CODE"><a href="#CODE" class="headerlink" title="CODE"></a>CODE</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Express Server Code</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建express服务</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line">app.get(<span class="string">'/data'</span>,(req,res) =&gt; &#123;</span><br><span class="line">  res.json(&#123;<span class="attr">hobby</span>:<span class="string">"basketball"</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3001</span>,() =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'chotee server'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="package-json-配置proxy字段-解决跨域问题"><a href="#package-json-配置proxy字段-解决跨域问题" class="headerlink" title="package.json 配置proxy字段,解决跨域问题"></a>package.json 配置proxy字段,解决跨域问题</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"proxy":"http://localhost:3001"</span><br></pre></td></tr></table></figure><h3 id="Auth-redux-js"><a href="#Auth-redux-js" class="headerlink" title="Auth.redux.js"></a>Auth.redux.js</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 权限登录的AuthReducer与action creater</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="keyword">const</span> LOGIN = <span class="string">'LOGIN'</span></span><br><span class="line"><span class="keyword">const</span> LOGOUT = <span class="string">'LOGOUT'</span></span><br><span class="line"><span class="keyword">const</span> GETUSERDATA = <span class="string">'GETUSERDATA'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//initState</span></span><br><span class="line"><span class="keyword">const</span> initState = &#123;</span><br><span class="line">  name: <span class="string">'choteewang'</span>,</span><br><span class="line">  isAuth: <span class="literal">false</span>,</span><br><span class="line">  hobby: <span class="string">'football'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//reducer</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AuthReducer = <span class="function">(<span class="params">state = initState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> LOGIN:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    <span class="keyword">case</span> LOGOUT:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="keyword">case</span> GETUSERDATA:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">hobby</span>: action.payload &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//action creater</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增支持异步请求的action creater, 返回一个函数,函数参数是store.dispatch与store.getState</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getUserData = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 在return出的函数内进行异步请求</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    axios.get(<span class="string">'/data'</span>).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(res)</span><br><span class="line">      <span class="comment">// res是axios的响应数据,格式见下面图</span></span><br><span class="line">      <span class="keyword">if</span> (res.status === <span class="number">200</span>) &#123;</span><br><span class="line">        dispatch(getuserdataAsync(res.data.hobby))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getuserdataAsync = <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="attr">type</span>: GETUSERDATA, <span class="attr">payload</span>: data&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> login = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGIN &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> logout = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGOUT &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/assets/Jietu20171112-105353.png" alt="Jietu20171112-105353"></p><h3 id="Auth-js-对应路由-login"><a href="#Auth-js-对应路由-login" class="headerlink" title="Auth.js 对应路由/login"></a>Auth.js 对应路由/login</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123; login, getUserData &#125; <span class="keyword">from</span> <span class="string">'./Auth.redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Redirect &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="comment">// 组件mount完成后发起异步请求,这里的getUserData是经过react-thunk中间件处理的action creater</span></span><br><span class="line">    <span class="keyword">this</span>.props.getUserData()</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> redirect = <span class="xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">'/dashboard'</span>&gt;</span><span class="tag">&lt;/<span class="name">Redirect</span>&gt;</span></span></span><br><span class="line">    <span class="keyword">const</span> login = (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;p&gt;&#123;<span class="string">`我叫<span class="subst">$&#123;<span class="keyword">this</span>.props.name&#125;</span>,我的爱好是<span class="subst">$&#123;<span class="keyword">this</span>.props.hobby&#125;</span>`</span>&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">        &lt;h3&gt;您没登录,请登录&lt;/</span>h3&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="keyword">this</span>.props.login&#125;&gt;点我模拟登录&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 若登录了,则跳转到dashboard页面,若没登录,显示登录页面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.isAuth ? redirect : login</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Auth = connect(</span><br><span class="line">  <span class="comment">//引入AuthReducer的字段给Auth的UI组件作为参数</span></span><br><span class="line">  (state) =&gt; state.AuthReducer,</span><br><span class="line">  <span class="comment">// 拿到getUserData的actionCreater</span></span><br><span class="line">  &#123; login, getUserData &#125;</span><br><span class="line">)(Auth)</span><br></pre></td></tr></table></figure><h3 id="config-js-设置全局拦截器"><a href="#config-js-设置全局拦截器" class="headerlink" title="config.js 设置全局拦截器"></a>config.js 设置全局拦截器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置全局拦截器的config.js,在根组件页面index.js页面引入</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Toast &#125; <span class="keyword">from</span> <span class="string">'antd-mobile'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加请求拦截器</span></span><br><span class="line">axios.interceptors.request.use(<span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 在发送请求之前做些什么</span></span><br><span class="line">  Toast.loading(<span class="string">'请求中'</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 对请求错误做些什么</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加响应拦截器</span></span><br><span class="line">axios.interceptors.response.use(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 对响应数据做点什么</span></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    Toast.hide()</span><br><span class="line">  &#125;, <span class="number">5000</span>);</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 对响应错误做点什么</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="https://i.loli.net/2017/11/14/5a0a32dfd3da7.png" alt="Jietu20171112-111033"></p><h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/choteewang/BLOG-NOTE/tree/master/Demos/axios+redux_demo" target="_blank" rel="external">https://github.com/choteewang/BLOG-NOTE/tree/master/Demos/axios+redux_demo</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前置知识-axios-API&quot;&gt;&lt;a href=&quot;#前置知识-axios-API&quot; class=&quot;headerlink&quot; title=&quot;前置知识 axios API&quot;&gt;&lt;/a&gt;前置知识 axios API&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.k
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redux 4:关于combineReducers生成的数据结构</title>
    <link href="http://yoursite.com/2017/11/14/%E5%85%B3%E4%BA%8EcombineReducers%E7%94%9F%E6%88%90%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    <id>http://yoursite.com/2017/11/14/关于combineReducers生成的数据结构/</id>
    <published>2017-11-13T23:33:50.000Z</published>
    <updated>2017-11-13T23:38:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>reducer太多后,要将所有reducer合成为一个,使用combineReducers方法<br><a id="more"></a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myReducer.js</span></span><br><span class="line"><span class="keyword">const</span> INCREASE = <span class="string">'increase'</span></span><br><span class="line"><span class="keyword">const</span> DECREASE = <span class="string">'decrease'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducer = <span class="function">(<span class="params">state  = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increase'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrease'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: INCREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onDecrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: DECREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncreaseAsync = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      dispatch(onIncrease())</span><br><span class="line">    &#125;,<span class="number">3000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Auth.reducer.js</span></span><br><span class="line"><span class="comment">// 权限登录的reducer与action creater</span></span><br><span class="line"><span class="comment">// isAuth代表是否登录</span></span><br><span class="line"><span class="keyword">const</span> LOGIN = <span class="string">'LOGIN'</span></span><br><span class="line"><span class="keyword">const</span> LOGOUT = <span class="string">'LOGOUT'</span></span><br><span class="line"><span class="comment">//reducer</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AuthReducer = <span class="function">(<span class="params">state = &#123; isAuth: <span class="literal">false</span>, user: <span class="string">'choteewang'</span> &#125;, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> LOGIN:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    <span class="keyword">case</span> LOGOUT:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//action creater</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> login = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGIN &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> logout = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGOUT &#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reducers.js</span></span><br><span class="line"><span class="comment">// 利用combineReducers合并两个Reducer</span></span><br><span class="line"><span class="comment">// 变为store中的state对象包裹2个reducer定义的state小对象的数据结构&#123;counter:&#123;&#125;,AutuReducer:&#123;&#125;&#125;</span></span><br><span class="line"><span class="comment">// 这里要注意改键名,防止之前使用小state的组件访问根组件state时key名发生错误</span></span><br><span class="line"><span class="comment">// 所以最佳实践是reducer要起名要有语义</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> combineReducers(&#123;<span class="attr">counter</span>:reducer, <span class="attr">AuthReducer</span>:AuthReducer&#125;)</span><br></pre></td></tr></table></figure><p><code>根组件挂载store后拿到的store.getState()</code> 可以清晰的看到数据结构<br><img src="https://i.loli.net/2017/11/14/5a0a2b3033179.png" alt="Jietu20171112-080243"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;reducer太多后,要将所有reducer合成为一个,使用combineReducers方法&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redux 3:react-redux继续改造Redux数据流</title>
    <link href="http://yoursite.com/2017/11/13/react-redux%E7%BB%A7%E7%BB%AD%E6%94%B9%E9%80%A0redux%E6%95%B0%E6%8D%AE%E6%B5%81/"/>
    <id>http://yoursite.com/2017/11/13/react-redux继续改造redux数据流/</id>
    <published>2017-11-13T14:23:52.000Z</published>
    <updated>2017-11-13T23:46:18.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>React-Redux 将所有组件分成两大类：UI 组件（presentational component）和容器组件（container component）。</p><h3 id="UI-组件"><a href="#UI-组件" class="headerlink" title="UI 组件"></a>UI 组件</h3><ul><li>只负责 UI 的呈现，不带有任何业务逻辑</li><li>没有状态（即不使用this.state这个变量）</li><li>所有数据都由参数（this.props）提供</li><li>不使用任何 Redux 的 API<h3 id="容器组件"><a href="#容器组件" class="headerlink" title="容器组件"></a>容器组件</h3></li><li>负责管理数据和业务逻辑，不负责 UI 的呈现</li><li>带有内部状态</li><li>使用 Redux 的 API</li></ul><p>UI 组件负责 UI 的呈现，容器组件负责管理数据和逻辑。<br>将组件拆分成下面的结构：外面是一个容器组件，里面包了一个UI 组件。前者负责与外部的通信，将数据传给后者，由后者渲染出视图。<br>React-Redux 规定，所有的 UI 组件都由用户提供，容器组件则是由 React-Redux 自动生成。也就是说，用户负责视觉层，状态管理则是全部交给它。</p><p><code>下面是将已模块化拆分的,支持异步的redux数据流, 继续改造为react-redux的代码</code><br><a id="more"></a></p><h2 id="CODE"><a href="#CODE" class="headerlink" title="CODE"></a>CODE</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//myRedux.js 代码保持不变</span></span><br><span class="line"><span class="keyword">const</span> INCREASE = <span class="string">'increase'</span></span><br><span class="line"><span class="keyword">const</span> DECREASE = <span class="string">'decrease'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increase'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrease'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: INCREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onDecrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: DECREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncreaseAsync = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      dispatch(onIncrease())</span><br><span class="line">    &#125;,<span class="number">3000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.js 根节点挂载处</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="comment">// applyMiddleware用来处理异步中间件thunk,compose用来将chrome插件与react-thunk按固定顺序连接起来</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore , applyMiddleware ,compose &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="comment">// 为了在根组件页面定义store并传入,需要将reducer引入</span></span><br><span class="line"><span class="keyword">import</span> &#123; reducer &#125; <span class="keyword">from</span> <span class="string">'./myRedux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//chrome插件redux-devtools github文档规定的插件声明方式</span></span><br><span class="line"><span class="keyword">const</span> composeEnhancers = <span class="built_in">window</span>.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose;</span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer,composeEnhancers(applyMiddleware(thunk)))</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除subcribe和listener,把ReactDOM.renden重写</span></span><br><span class="line"><span class="comment">//const unsubscribe = store.subscribe(listener)</span></span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  <span class="comment">//根组件外套一层Provider传入Store</span></span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;App/&gt;</span><br><span class="line">  &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root'));</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//App.js, UI组件定义处 与 包裹UI的容器组件生成处</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; from <span class="string">'react'</span>;</span><br><span class="line"><span class="comment">// 引入react-redux的connect函数</span></span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; from <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="comment">// 引入所有Action Creator</span></span><br><span class="line"><span class="keyword">import</span> &#123; onIncrease, onDecrease, onIncreaseAsync &#125; from <span class="string">'./myRedux'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//UI组件,只用来做数据展示和分发,将来可以抽离出去</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppUI</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;&#123;this.props.count&#125;&lt;/h1&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"increase"</span> onClick=&#123;<span class="keyword">this</span>.props.onIncrease&#125; /&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"decrease"</span> onClick=&#123;<span class="keyword">this</span>.props.onDecrease&#125; /&gt;</span><br><span class="line">        &#123;&lt;input type=<span class="string">"button"</span> value=<span class="string">"increaseAsync"</span> onClick=&#123;<span class="keyword">this</span>.props.onIncreaseAsync&#125; /&gt;&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//mapStateToProps是一个函数,返回一个对象,key对应UI组件上的参数名称,"值"应该是state或算出state的方法的调用</span></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = (state) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    count: state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//mapDispatchToProps是一个对象,key对应UI组件对应的参数名称,"值"对应传入的actionCreater</span></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = &#123;</span><br><span class="line">  onIncrease, onDecrease, onIncreaseAsync</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//用connect函数生成包裹UI组件的容器组件</span></span><br><span class="line"><span class="keyword">const</span> App = connect(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapDispatchToProps</span><br><span class="line">)(AppUI)</span><br><span class="line">export <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2017/11/13/5a099fedeaa9e.png" alt="Jietu20171111-033033_iutjibikf"></p><h2 id="REFERENCE"><a href="#REFERENCE" class="headerlink" title="REFERENCE"></a>REFERENCE</h2><p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_three_react-redux.html" target="_blank" rel="external">阮一峰 Redux 3</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;TODO&quot;&gt;&lt;a href=&quot;#TODO&quot; class=&quot;headerlink&quot; title=&quot;TODO&quot;&gt;&lt;/a&gt;TODO&lt;/h2&gt;&lt;p&gt;React-Redux 将所有组件分成两大类：UI 组件（presentational component）和容器组件（container component）。&lt;/p&gt;
&lt;h3 id=&quot;UI-组件&quot;&gt;&lt;a href=&quot;#UI-组件&quot; class=&quot;headerlink&quot; title=&quot;UI 组件&quot;&gt;&lt;/a&gt;UI 组件&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;只负责 UI 的呈现，不带有任何业务逻辑&lt;/li&gt;
&lt;li&gt;没有状态（即不使用this.state这个变量）&lt;/li&gt;
&lt;li&gt;所有数据都由参数（this.props）提供&lt;/li&gt;
&lt;li&gt;不使用任何 Redux 的 API&lt;h3 id=&quot;容器组件&quot;&gt;&lt;a href=&quot;#容器组件&quot; class=&quot;headerlink&quot; title=&quot;容器组件&quot;&gt;&lt;/a&gt;容器组件&lt;/h3&gt;&lt;/li&gt;
&lt;li&gt;负责管理数据和业务逻辑，不负责 UI 的呈现&lt;/li&gt;
&lt;li&gt;带有内部状态&lt;/li&gt;
&lt;li&gt;使用 Redux 的 API&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;UI 组件负责 UI 的呈现，容器组件负责管理数据和逻辑。&lt;br&gt;将组件拆分成下面的结构：外面是一个容器组件，里面包了一个UI 组件。前者负责与外部的通信，将数据传给后者，由后者渲染出视图。&lt;br&gt;React-Redux 规定，所有的 UI 组件都由用户提供，容器组件则是由 React-Redux 自动生成。也就是说，用户负责视觉层，状态管理则是全部交给它。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;下面是将已模块化拆分的,支持异步的redux数据流, 继续改造为react-redux的代码&lt;/code&gt;&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redux 2:Redux模块的抽离,Action Creator,异步支持的实现(redux-thunk)</title>
    <link href="http://yoursite.com/2017/11/13/Redux-2-Redux%E6%A8%A1%E5%9D%97%E7%9A%84%E6%8A%BD%E7%A6%BB-Action-Creator-%E5%BC%82%E6%AD%A5%E6%94%AF%E6%8C%81%E7%9A%84%E5%AE%9E%E7%8E%B0-redux-thunk/"/>
    <id>http://yoursite.com/2017/11/13/Redux-2-Redux模块的抽离-Action-Creator-异步支持的实现-redux-thunk/</id>
    <published>2017-11-13T13:23:52.000Z</published>
    <updated>2017-11-13T23:45:36.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p><a href="./redux的实现原理(发布订阅模式,闭包">上一篇redux的总结</a>.md)中,写了一个小的Counter Demo, 但是代码耦合度太高, 在复杂项目中组织代码难度增加, 且无法进行异步redux操作, 这篇总结中, 将代码以模块化思想解耦合, 并让redux可以支持异步操作.</p><p>需要用到redux-thunk这个库,这个库的作用是让store.dispatch接受以函数作为参数,从而从函数参数中拿到dispatch与getState执行异步操作, 最底层的原理可以移步阮一峰博客redux第二篇,这里只做代码实现,和详细注释<br><a id="more"></a></p><h2 id="CODE"><a href="#CODE" class="headerlink" title="CODE"></a>CODE</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Index.js : 根组件挂载处</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="comment">// 引入redux-thunk,使dispatch可以接受一个函数作为参数,从而支持applyMiddleware的中间件处理</span></span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="comment">// 引入自己抽离的actionCreater与reducer模块</span></span><br><span class="line"><span class="keyword">import</span> &#123; onIncrease, onDecrease, onIncreaseAsync,reducer &#125; <span class="keyword">from</span> <span class="string">'./myRedux'</span>;</span><br><span class="line"><span class="comment">// 在根组件的挂载处挂载store与reducer,actionCreater控制整个app的redux数据流</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer,applyMiddleware(thunk))</span><br><span class="line"><span class="keyword">const</span> unsubscribe = store.subscribe(listener)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listener</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;App</span><br><span class="line">      <span class="comment">//将store和actionCreater传入组件内部</span></span><br><span class="line">      store=&#123;store&#125;</span><br><span class="line">      onIncrease=&#123;onIncrease&#125;</span><br><span class="line">      onDecrease=&#123;onDecrease&#125;</span><br><span class="line">      onIncreaseAsync=&#123;onIncreaseAsync&#125;</span><br><span class="line">    &gt;</span><br><span class="line">    &lt;<span class="regexp">/App&gt;,</span></span><br><span class="line"><span class="regexp">    document.getElementById('root'));</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">listener()</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.js : UI组件定义处</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="comment">// App就是上篇文章的Counter,不同的是它是一个UI组件,只负责UI的展示和数据流的分派</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// store与ActionCreater从根组件挂载处index.js处拿到</span></span><br><span class="line">    <span class="keyword">const</span> store = <span class="keyword">this</span>.props.store</span><br><span class="line">    <span class="keyword">const</span> onIncrease = <span class="keyword">this</span>.props.onIncrease</span><br><span class="line">    <span class="keyword">const</span> onDecrease = <span class="keyword">this</span>.props.onDecrease</span><br><span class="line">    <span class="keyword">const</span> onIncreaseAsync = <span class="keyword">this</span>.props.onIncreaseAsync</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;&#123;store.getState()&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">        &lt;input type="button" value="increase" onClick=&#123;() =&gt; &#123; store.dispatch(onIncrease()) &#125;&#125; /</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"decrease"</span> onClick=&#123;() =&gt; &#123; store.dispatch(onDecrease()) &#125;&#125; /&gt;</span><br><span class="line">        &#123;<span class="comment">/* 添加异步操作UI */</span>&#125;</span><br><span class="line">        &#123;&lt;input type=<span class="string">"button"</span> value=<span class="string">"increaseAsync"</span> onClick=&#123;() =&gt; &#123; store.dispatch(onIncreaseAsync()) &#125;&#125; /&gt;&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">export default App;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myRedux.js</span></span><br><span class="line"><span class="comment">// 将actionCreater与reducer抽离成一个单独的js模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义action.type对应的常量,防止后期频繁修改</span></span><br><span class="line"><span class="keyword">const</span> INCREASE = <span class="string">'increase'</span></span><br><span class="line"><span class="keyword">const</span> DECREASE = <span class="string">'decrease'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increase'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrease'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为了不频繁写action,创建actionCreater方法,自动生成action</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: INCREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onDecrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: DECREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// redux异步的解决方案:写出返回函数的actionCreator，使用reduxThunk中间件改造dispatch使函数可以作为其参数。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义异步的actionCreater,返回一个函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncreaseAsync = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 这里return出的方法参数是dispatch与getState,后续applyMiddleWare方法会将store.dispatch与store.getState传入</span></span><br><span class="line">  <span class="comment">// 这里return出的方法是一个中间件方法,applyMiddleWare会在这个方法执行之前发一个action,执行之后再发一个action,从而实现异步处理.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      dispatch(onIncrease())</span><br><span class="line">    &#125;,<span class="number">3000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2017/11/13/5a099c902645b.png" alt="Jietu20171111-033033"></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_two_async_operations.html" target="_blank" rel="external">阮一峰 redux(2)</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;TODO&quot;&gt;&lt;a href=&quot;#TODO&quot; class=&quot;headerlink&quot; title=&quot;TODO&quot;&gt;&lt;/a&gt;TODO&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;./redux的实现原理(发布订阅模式,闭包&quot;&gt;上一篇redux的总结&lt;/a&gt;.md)中,写了一个小的Counter Demo, 但是代码耦合度太高, 在复杂项目中组织代码难度增加, 且无法进行异步redux操作, 这篇总结中, 将代码以模块化思想解耦合, 并让redux可以支持异步操作.&lt;/p&gt;
&lt;p&gt;需要用到redux-thunk这个库,这个库的作用是让store.dispatch接受以函数作为参数,从而从函数参数中拿到dispatch与getState执行异步操作, 最底层的原理可以移步阮一峰博客redux第二篇,这里只做代码实现,和详细注释&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redux 1: Redux的实现原理(发布订阅模式,闭包)</title>
    <link href="http://yoursite.com/2017/11/13/redux%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F-%E9%97%AD%E5%8C%85/"/>
    <id>http://yoursite.com/2017/11/13/redux的实现原理-发布订阅模式-闭包/</id>
    <published>2017-11-13T12:57:01.000Z</published>
    <updated>2017-11-13T23:46:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前置知识-发布订阅者模式"><a href="#前置知识-发布订阅者模式" class="headerlink" title="前置知识:发布订阅者模式"></a>前置知识:发布订阅者模式</h2><p><a href="https://www.cnblogs.com/tugenhua0707/p/4687947.html" target="_blank" rel="external">发布订阅者模式_阅读</a></p><h2 id="createStore的实现-闭包-发布订阅模式"><a href="#createStore的实现-闭包-发布订阅模式" class="headerlink" title="createStore的实现,闭包,发布订阅模式"></a>createStore的实现,闭包,发布订阅模式</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createStore = <span class="function">(<span class="params">reducer</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 闭包内要操作的数据,state是数据,listeners是发布订阅模式的订阅数组</span></span><br><span class="line">  <span class="keyword">let</span> state;</span><br><span class="line">  <span class="keyword">let</span> listeners = [];</span><br><span class="line">  <span class="comment">// 通过getState返回state的值</span></span><br><span class="line">  <span class="keyword">const</span> getState = <span class="function"><span class="params">()</span> =&gt;</span> state;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//通过dispatch的参数接收action对象</span></span><br><span class="line">  <span class="keyword">const</span> dispatch = <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="comment">// 将action对象传入reducer更新state</span></span><br><span class="line">    state = reducer(state, action);</span><br><span class="line">    <span class="comment">// 一旦state被更新,订阅数组中的所有listener方法被执行</span></span><br><span class="line">    listeners.forEach(<span class="function"><span class="params">listener</span> =&gt;</span> listener());</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 通过subscribe的参数接收listener方法</span></span><br><span class="line">  <span class="keyword">const</span> subscribe = <span class="function">(<span class="params">listener</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="comment">// 将listner方法放入订阅数组listeners</span></span><br><span class="line">    listeners.push(listener);</span><br><span class="line">    <span class="comment">// 同时return一个方法形成闭包,这个方法用来从订阅数组listeners中删除掉listener方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      listeners = listeners.filter(<span class="function"><span class="params">l</span> =&gt;</span> l !== listener);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 执行一次dispatch,形成最初的state数据</span></span><br><span class="line">  dispatch(&#123;&#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 将getState, dispatch, subscribe方法向外return,形成闭包</span></span><br><span class="line">  <span class="keyword">return</span> &#123; getState, dispatch, subscribe &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="最基础的Redux数据流"><a href="#最基础的Redux数据流" class="headerlink" title="最基础的Redux数据流"></a>最基础的Redux数据流</h2><p><img src="https://i.loli.net/2017/11/13/5a099379e0660.png" alt="Jietu20171110-094632"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React from <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM from <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="comment">// 从redux中拿到createStore函数</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; from <span class="string">"redux"</span>;</span><br><span class="line"><span class="comment">// ui组件,只有props从外界接收数据并展示,让redux帮我们处理state数据的传递</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;&#123;this.props.count&#125;&lt;/h1&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"Increase"</span> onClick=&#123;<span class="keyword">this</span>.props.onIncrease&#125; /&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"Decrease"</span> onClick=&#123;<span class="keyword">this</span>.props.onDecrease&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reducer,在createStore形成的闭包内部处理state的过滤器,</span></span><br><span class="line"><span class="comment">// 在createStore形成的闭包内部 使用state=reducer(state,action)实现,return的值重新赋值给state</span></span><br><span class="line"><span class="keyword">const</span> reducer = (state = <span class="number">0</span>, action) =&gt; &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increase'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrease'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// store是createStore闭包的返回值,是一个对象,结构是&#123;getState,dispatch,subscribe&#125;,</span></span><br><span class="line"><span class="comment">// createStore通过参数传入的reducer形成state的生成规则</span></span><br><span class="line"><span class="comment">// createStore方法还可以接受第二个参数，表示整个应用的state的初始状态,会覆盖reducer函数中的默认初始值</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer)</span><br><span class="line"><span class="comment">// 通过store.subscribe(listener)方法拿到的listener函数进行订阅发布者模式监听,只要state的值变化,订阅数组listenrs中的所有listener方法就会被执行</span></span><br><span class="line"><span class="keyword">const</span> unsubscribe = store.subscribe(listener)</span><br><span class="line"><span class="comment">// store.subscribe的返回值是一个方法unsubscribe(),可以从订阅数组listeners中移除listener方法,取消监听</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//这是subscribe调用的listener方法,state的值改变后会被调用,内部让其自动执行渲染函数更新UI组件Counter</span></span><br><span class="line"><span class="function">function <span class="title">listener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;Counter</span><br><span class="line">      <span class="comment">// 新生成的state值可以通过store.getState()方法得到闭包快照</span></span><br><span class="line">      count=&#123;store.getState()&#125;</span><br><span class="line">      <span class="comment">// 通过store.dispatch(action)方法拿到action对象传入reducer参数更新state值,state=reducer(state,action)</span></span><br><span class="line">      <span class="comment">// action 是一个对象。其中的type属性是必须的，表示 Action 的名称。其他属性可以自由设置</span></span><br><span class="line">      onIncrease=&#123;() =&gt; &#123; store.dispatch(&#123; type: <span class="string">'increase'</span> &#125;) &#125;&#125;</span><br><span class="line">      onDecrease=&#123;() =&gt; &#123; store.dispatch(&#123; type: <span class="string">'decrease'</span> &#125;) &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">    &lt;/Counter&gt;,</span><br><span class="line">    document.getElementById(<span class="string">'root'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 首次进入页面先渲染一次页面</span></span><br><span class="line">listener()</span><br></pre></td></tr></table></figure><p><img src="https://ooo.0o0.ooo/2017/11/13/5a0993bd51d99.png" alt="Jietu20171110-082736"></p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html" target="_blank" rel="external">阮一峰 redux (1)</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前置知识-发布订阅者模式&quot;&gt;&lt;a href=&quot;#前置知识-发布订阅者模式&quot; class=&quot;headerlink&quot; title=&quot;前置知识:发布订阅者模式&quot;&gt;&lt;/a&gt;前置知识:发布订阅者模式&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.cnblogs.com/tugenhua0707/p/4687947.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;发布订阅者模式_阅读&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;createStore的实现-闭包-发布订阅模式&quot;&gt;&lt;a href=&quot;#createStore的实现-闭包-发布订阅模式&quot; class=&quot;headerlink&quot; title=&quot;createStore的实现,闭包,发布订阅模式&quot;&gt;&lt;/a&gt;createStore的实现,闭包,发布订阅模式&lt;/h2&gt;&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; createStore = &lt;span class=&quot;function&quot;&gt;(&lt;span class=&quot;params&quot;&gt;reducer&lt;/span&gt;) =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 闭包内要操作的数据,state是数据,listeners是发布订阅模式的订阅数组&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; state;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; listeners = [];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 通过getState返回state的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; getState = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; =&amp;gt;&lt;/span&gt; state;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//通过dispatch的参数接收action对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; dispatch = &lt;span class=&quot;function&quot;&gt;(&lt;span class=&quot;params&quot;&gt;action&lt;/span&gt;) =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	 &lt;span class=&quot;comment&quot;&gt;// 将action对象传入reducer更新state&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    state = reducer(state, action);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 一旦state被更新,订阅数组中的所有listener方法被执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listeners.forEach(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;listener&lt;/span&gt; =&amp;gt;&lt;/span&gt; listener());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 通过subscribe的参数接收listener方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; subscribe = &lt;span class=&quot;function&quot;&gt;(&lt;span class=&quot;params&quot;&gt;listener&lt;/span&gt;) =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	 &lt;span class=&quot;comment&quot;&gt;// 将listner方法放入订阅数组listeners&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    listeners.push(listener);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 同时return一个方法形成闭包,这个方法用来从订阅数组listeners中删除掉listener方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      listeners = listeners.filter(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;l&lt;/span&gt; =&amp;gt;&lt;/span&gt; l !== listener);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 执行一次dispatch,形成最初的state数据&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  dispatch(&amp;#123;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 将getState, dispatch, subscribe方法向外return,形成闭包&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &amp;#123; getState, dispatch, subscribe &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>gulp构建 es6运行在browser端 自动化工作流</title>
    <link href="http://yoursite.com/2017/11/10/gulp%E6%9E%84%E5%BB%BAes6%E8%BF%90%E8%A1%8C%E5%9C%A8browser%E7%AB%AF%E7%9A%84work%20flow/"/>
    <id>http://yoursite.com/2017/11/10/gulp构建es6运行在browser端的work flow/</id>
    <published>2017-11-10T14:23:52.000Z</published>
    <updated>2017-11-13T23:56:41.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="gulp构建-es6运行在browser端-自动化工作流"><a href="#gulp构建-es6运行在browser端-自动化工作流" class="headerlink" title="gulp构建 es6运行在browser端 自动化工作流"></a>gulp构建 es6运行在browser端 自动化工作流</h1><h3 id="用来做什么"><a href="#用来做什么" class="headerlink" title="用来做什么?"></a>用来做什么?</h3><p>1.支持监视前端页面js,css,ejs模板文件热更新,babel语法自动转换,自动刷新浏览器页面,</p><p>2.支持后台静态资源的处理,js文件的压缩打包,更新静态css与ejs模板文件,也可以在express端构建逻辑mock数据</p><hr><h3 id="项目自动化构建思路"><a href="#项目自动化构建思路" class="headerlink" title="项目自动化构建思路"></a>项目自动化构建思路</h3><p><img src="https://ooo.0o0.ooo/2017/11/14/5a0a30c88f806.png" alt="1"><br><a id="more"></a></p><h3 id="自动化构建逻辑"><a href="#自动化构建逻辑" class="headerlink" title="自动化构建逻辑"></a>自动化构建逻辑</h3><ol><li>若app文件夹(前端静. 态页面)资源发生改变 -&gt;</li><li>调用browser.js脚本 -&gt;</li><li>browser.js运行script脚本 -&gt;</li><li>将新的js文件打包后写入server目录public目录下 -&gt;</li><li>此行为触发server.js监听到服务端js静态资源文件被修改 -&gt;</li><li>执行服务器重启重新渲染页面 -&gt;</li><li>前台看到浏览器热更新<h3 id="构建目录结构-安装服务端脚手架工具"><a href="#构建目录结构-安装服务端脚手架工具" class="headerlink" title="构建目录结构,安装服务端脚手架工具"></a>构建目录结构,安装服务端脚手架工具</h3></li><li>创建项目目录 <code>app</code>(放置静态页面资源),<code>server</code>(用express脚手架初始化,将来放入热更新后的静态资源),<code>tasks</code>放置所有上述过程的脚本文件</li><li>初始化服务端express<pre><code>`npm install -g express-generator`  //安装express脚手架`express -e .` //使用express脚手架命令,初始化脚手架,-e代表使用ejs模板引擎</code></pre></li><li>在根目录创建 .babelrc文件,此为babel转码器</li><li>在根目录创建<code>gulpfile.js</code>, 若用es6语法写gulpfile文件就创建<code>gulpfile.babel.js</code></li></ol><hr><h2 id="gulp工作流代码构建流程"><a href="#gulp工作流代码构建流程" class="headerlink" title="gulp工作流代码构建流程"></a>gulp工作流代码构建流程</h2><h3 id="args-js-–处理命令行参数"><a href="#args-js-–处理命令行参数" class="headerlink" title="args.js –处理命令行参数"></a>args.js –处理命令行参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> yargs <span class="keyword">from</span> <span class="string">'yargs'</span>; <span class="comment">//处理命令行参数的包</span></span><br><span class="line"><span class="comment">//区分开发环境和线上环境</span></span><br><span class="line"><span class="keyword">const</span> args = yargs  </span><br><span class="line">  <span class="comment">//提取--production参数</span></span><br><span class="line">  .option(<span class="string">'production'</span>,&#123; </span><br><span class="line">    boolean:<span class="literal">true</span>,<span class="comment">//选项是布尔类型</span></span><br><span class="line">    <span class="keyword">default</span>:<span class="literal">false</span>,<span class="comment">//默认是false</span></span><br><span class="line">    describe:<span class="string">'min all scripts'</span> <span class="comment">//只是给人看的描述</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//用来监听文件改变的选项</span></span><br><span class="line">  .option(<span class="string">'watch'</span>,&#123;</span><br><span class="line">    boolean:<span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">default</span>:<span class="literal">false</span>,</span><br><span class="line">    describe:<span class="string">'watch all files'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//要不要输出命令行详细监视的日志</span></span><br><span class="line">  .option(<span class="string">'verbose'</span>,&#123;</span><br><span class="line">    boolean:<span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">default</span>:<span class="literal">false</span>,</span><br><span class="line">    describe:<span class="string">'log'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//强制生成sourcemaps映射</span></span><br><span class="line">  .option(<span class="string">'sourcemaps'</span>,&#123;</span><br><span class="line">    describe:<span class="string">'force the creation of sroucemaps'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//端口号</span></span><br><span class="line">  .option(<span class="string">'port'</span>,&#123;</span><br><span class="line">    string:<span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">default</span>:<span class="number">8080</span>,</span><br><span class="line">    describe:<span class="string">'server port'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//表示把输入的命令以字符串的方式进行解析</span></span><br><span class="line">  .argv</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> args;</span><br></pre></td></tr></table></figure><h3 id="script-js-–处理js"><a href="#script-js-–处理js" class="headerlink" title="script.js –处理js"></a>script.js –处理js</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>; <span class="comment">//gulp语句中做if判断</span></span><br><span class="line"><span class="keyword">import</span> concat <span class="keyword">from</span> <span class="string">'gulp-concat'</span>; <span class="comment">//gulp中处理文件拼接</span></span><br><span class="line"><span class="keyword">import</span> webpack <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpWebpack <span class="keyword">from</span> <span class="string">'webpack-stream'</span>; <span class="comment">//支持webpack在gulp stream中的功能</span></span><br><span class="line"><span class="keyword">import</span> named <span class="keyword">from</span> <span class="string">'vinyl-named'</span>; <span class="comment">//保证webpack生成的文件名能够和原文件对上</span></span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">'gulp-livereload'</span>; <span class="comment">//浏览器热更新</span></span><br><span class="line"><span class="keyword">import</span> plumber <span class="keyword">from</span> <span class="string">'gulp-plumber'</span>; <span class="comment">//处理文件信息流</span></span><br><span class="line"><span class="keyword">import</span> rename <span class="keyword">from</span> <span class="string">'gulp-rename'</span>; <span class="comment">//对文件重命名</span></span><br><span class="line"><span class="keyword">import</span> uglify <span class="keyword">from</span> <span class="string">'gulp-uglify'</span>; <span class="comment">//压缩js</span></span><br><span class="line"><span class="keyword">import</span> &#123;log, colors&#125; <span class="keyword">from</span> <span class="string">'gulp-util'</span>; <span class="comment">//命令行工具包,log与色彩输出</span></span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>; <span class="comment">//刚自己写的对命令行参数进行解析的包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了集中处理项目js文件抛出异常引起gulp流出现问题,需用plumber统一处理错误</span></span><br><span class="line">gulp.task(<span class="string">'scripts'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> gulp</span><br><span class="line">    .src([<span class="string">'app/js/index.js'</span>])</span><br><span class="line">    .pipe(plumber(&#123;<span class="attr">errorHandle</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;&#125;))</span><br><span class="line">    .pipe(named())</span><br><span class="line">    .pipe(gulpWebpack(&#123;</span><br><span class="line">      <span class="built_in">module</span>: &#123;</span><br><span class="line">        loaders: [</span><br><span class="line">          &#123;</span><br><span class="line">            test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">            loader: <span class="string">'babel-loader'</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;), <span class="literal">null</span>, (err, stats) =&gt; &#123;</span><br><span class="line">      log(<span class="string">`Finished '<span class="subst">$&#123;colors.cyan(<span class="string">'scripts'</span>)&#125;</span>'`</span>, stats.toString(&#123;<span class="attr">chunks</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">//gulp处理完的js指定写入路径,api:gulp.dest</span></span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server/public/js'</span>))</span><br><span class="line">    <span class="comment">//js文件重命名为cp.min.js,还没压缩,只是复制一份</span></span><br><span class="line">    .pipe(rename(&#123;<span class="attr">basename</span>: <span class="string">'cp'</span>, <span class="attr">extname</span>: <span class="string">'.min.js'</span>&#125;))</span><br><span class="line">    <span class="comment">// 压缩</span></span><br><span class="line">    .pipe(uglify(&#123;</span><br><span class="line">      compress: &#123;</span><br><span class="line">        properties: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      output: &#123;</span><br><span class="line">        <span class="string">'quote_keys'</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="comment">// 把压缩后的文件放入服务器目录</span></span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server/public/js'</span>))</span><br><span class="line">    <span class="comment">// 使用gulpif监视命令行传入的参数,若有--watch,则执行热更新</span></span><br><span class="line">    .pipe(gulpif(args.watch, livereload()))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="pages-js-–处理后台页面模板"><a href="#pages-js-–处理后台页面模板" class="headerlink" title="pages.js –处理后台页面模板"></a>pages.js –处理后台页面模板</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">'gulp-livereload'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'pages'</span>,()=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'app/**/*.ejs'</span>)</span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server'</span>)) <span class="comment">//文件被写入的路径是以所给的相对路径根据所给的目标目录计算而来。类似的，相对路径也可以根据所给的 base 来计算。这里实际写到的路径是server下的/**/*.ejs,即server/views/*.ejs</span></span><br><span class="line">    .pipe(gulpif(args.watch,livereload()))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="css-js-–处理css"><a href="#css-js-–处理css" class="headerlink" title="css.js –处理css"></a>css.js –处理css</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">'gulp-livereload'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'css'</span>,()=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'app/**/*.css'</span>)</span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server/public'</span>))</span><br><span class="line">    <span class="comment">//文件被写入的路径是以所给的相对路径根据所给的目标目录计算而来。类似的，相对路径也可以根据所给的 base 来计算。这里实际写到的路径是server下的/**/*.css,即server/public/css/*.css</span></span><br><span class="line">    .pipe(gulpif(args.watch,livereload()))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="server-js-–处理服务端热重启"><a href="#server-js-–处理服务端热重启" class="headerlink" title="server.js –处理服务端热重启"></a>server.js –处理服务端热重启</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> liveserver <span class="keyword">from</span> <span class="string">'gulp-live-server'</span>; <span class="comment">//启动gulp服务器的包</span></span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'serve'</span>,(cb)=&gt;&#123;</span><br><span class="line">  <span class="comment">//如果没在监听,直接运行回调函数</span></span><br><span class="line">  <span class="keyword">if</span>(!args.watch) <span class="keyword">return</span> cb(); </span><br><span class="line">  <span class="comment">//启动express脚手架默认的服务器脚本</span></span><br><span class="line">  <span class="keyword">const</span> server = liveserver.new([<span class="string">'--harmony'</span>,<span class="string">'server/bin/www'</span>]); </span><br><span class="line">  server.start();</span><br><span class="line">  <span class="comment">//监听server目录下的js文件和ejs模板文件,通知服务器哪些文件改变了</span></span><br><span class="line">  gulp.watch([<span class="string">'server/public/**/*.js'</span>,<span class="string">'server/views/**/*.ejs'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line">    server.notify.apply(server,[file]);</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//监视服务器路由及入口文件的改变,进行服务器重启</span></span><br><span class="line">  gulp.watch([<span class="string">'server/routes/**/*.js'</span>,<span class="string">'server/app.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    server.start.bind(server)()</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="browser-js-–监视前端文件改变-触发热更新"><a href="#browser-js-–监视前端文件改变-触发热更新" class="headerlink" title="browser.js –监视前端文件改变,触发热更新"></a>browser.js –监视前端文件改变,触发热更新</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> gutil <span class="keyword">from</span> <span class="string">'gulp-util'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'browser'</span>,(cb)=&gt;&#123;</span><br><span class="line">  <span class="keyword">if</span>(!args.watch) <span class="keyword">return</span> cb();<span class="comment">//若没监听,则直接执行回调</span></span><br><span class="line">  gulp.watch(<span class="string">'app/**/*.js'</span>,[<span class="string">'scripts'</span>]);<span class="comment">//若js文件发生改变,则调用刚才创建的scripts脚本</span></span><br><span class="line">  gulp.watch(<span class="string">'app/**/*.ejs'</span>,[<span class="string">'pages'</span>]); <span class="comment">//同上</span></span><br><span class="line">  gulp.watch(<span class="string">'app/**/*.css'</span>,[<span class="string">'css'</span>]); <span class="comment">//同上</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="clean-js-–处理服务器清除旧文件"><a href="#clean-js-–处理服务器清除旧文件" class="headerlink" title="clean.js –处理服务器清除旧文件"></a>clean.js –处理服务器清除旧文件</h3><p>每次服务器监听到静态资源文件的改变, 会触发重启, 用新的静态资源去render页面,此时需要删除旧的静态资源文件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> del <span class="keyword">from</span> <span class="string">'del'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"><span class="comment">//清除服务端的静态资源文件和模板文件</span></span><br><span class="line">gulp.task(<span class="string">'clean'</span>,()=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> del([<span class="string">'server/public'</span>,<span class="string">'server/views'</span>])</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h3 id="build-js-–处理所有gulp文件运行关联顺序"><a href="#build-js-–处理所有gulp文件运行关联顺序" class="headerlink" title="build.js –处理所有gulp文件运行关联顺序"></a>build.js –处理所有gulp文件运行关联顺序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpSequence <span class="keyword">from</span> <span class="string">'gulp-sequence'</span>; <span class="comment">//处理文件关联关系和先后顺序</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//先clean,再css,再pages,再编译js,最后一个数组说明数组里的任务都放在前面四个任务执行过一次之后再执行,且serve端更新一定 在 browser静态资源改变之后 </span></span><br><span class="line">gulp.task(<span class="string">'build'</span>,gulpSequence(<span class="string">'clean'</span>,<span class="string">'css'</span>,<span class="string">'pages'</span>,<span class="string">'scripts'</span>,[<span class="string">'browser'</span>,<span class="string">'serve'</span>]));</span><br></pre></td></tr></table></figure><h3 id="default-js-–gulp工作流默认入口"><a href="#default-js-–gulp工作流默认入口" class="headerlink" title="default.js –gulp工作流默认入口"></a>default.js –gulp工作流默认入口</h3><p>gulp在无命令行参数时会优先运行defalut.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line">gulp.task(<span class="string">'default'</span>,[<span class="string">'build'</span>]);</span><br></pre></td></tr></table></figure></p><h3 id="gulpfile-babel-js-–gulp程序入口"><a href="#gulpfile-babel-js-–gulp程序入口" class="headerlink" title="gulpfile.babel.js –gulp程序入口"></a>gulpfile.babel.js –gulp程序入口</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requireDir <span class="keyword">from</span> <span class="string">'require-dir'</span>;<span class="comment">//需要运行某一文件夹的gulp任务</span></span><br><span class="line">requireDir(<span class="string">'./tasks'</span>); <span class="comment">//放入tasks目录</span></span><br></pre></td></tr></table></figure><h3 id="编辑-babelrc"><a href="#编辑-babelrc" class="headerlink" title="编辑.babelrc"></a>编辑.babelrc</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>:[<span class="string">"env"</span>,<span class="string">"stage-0"</span>],</span><br><span class="line">  <span class="attr">"plugins"</span>:[<span class="string">"transform-decorators-legacy"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="给express脚手架添加热更新中间件"><a href="#给express脚手架添加热更新中间件" class="headerlink" title="给express脚手架添加热更新中间件"></a>给express脚手架添加热更新中间件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在处理路由前,express优先处理静态资源,若在这个static方法定义的目录中没有找到req.url对应的静态资源,则调用Next()方法传入下一个中间件,最终会传递到路由中间件上</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"><span class="comment">//一定要再静态资源设置之后使用热更新中间件,此插件的安装要再最外层项目目录下的依赖安装,而不是server目录的依赖</span></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'connect-livereload'</span>)());</span><br></pre></td></tr></table></figure><h3 id="gulp程序启动"><a href="#gulp程序启动" class="headerlink" title="gulp程序启动"></a>gulp程序启动</h3><p><code>gulp --watch</code><br>在app/public/js下写一个简单的js,再在app/public/css下写一个chotee.css,例如</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chotee</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'chotee 啊,成功!'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ct1 = <span class="keyword">new</span> Chotee</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.innerHTML = ct1.name;</span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: pink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在app/views/目录下的index.ejs模板中引入<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/css/chotee.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  hello chotee</span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/index.js"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>打开浏览器访问localhost:3000端口(express脚手架默认端口), 看到<br><img src="https://i.loli.net/2017/11/14/5a0a30b96f6c1.png" alt="2"></p><p>成功! 此时再去修改js文件,模板文件,热更新文件,成功</p><h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址:"></a>源码地址:</h2><p><a href="https://github.com/choteewang/gulp-es6-work-flow" target="_blank" rel="external">https://github.com/choteewang/gulp-es6-work-flow</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;gulp构建-es6运行在browser端-自动化工作流&quot;&gt;&lt;a href=&quot;#gulp构建-es6运行在browser端-自动化工作流&quot; class=&quot;headerlink&quot; title=&quot;gulp构建 es6运行在browser端 自动化工作流&quot;&gt;&lt;/a&gt;gulp构建 es6运行在browser端 自动化工作流&lt;/h1&gt;&lt;h3 id=&quot;用来做什么&quot;&gt;&lt;a href=&quot;#用来做什么&quot; class=&quot;headerlink&quot; title=&quot;用来做什么?&quot;&gt;&lt;/a&gt;用来做什么?&lt;/h3&gt;&lt;p&gt;1.支持监视前端页面js,css,ejs模板文件热更新,babel语法自动转换,自动刷新浏览器页面,&lt;/p&gt;
&lt;p&gt;2.支持后台静态资源的处理,js文件的压缩打包,更新静态css与ejs模板文件,也可以在express端构建逻辑mock数据&lt;/p&gt;
&lt;hr&gt;
&lt;h3 id=&quot;项目自动化构建思路&quot;&gt;&lt;a href=&quot;#项目自动化构建思路&quot; class=&quot;headerlink&quot; title=&quot;项目自动化构建思路&quot;&gt;&lt;/a&gt;项目自动化构建思路&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://ooo.0o0.ooo/2017/11/14/5a0a30c88f806.png&quot; alt=&quot;1&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
</feed>
