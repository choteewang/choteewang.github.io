<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>choteewang</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-03-20T09:19:56.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>choteewang@qq.com</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>基于Vue,Hotcss+Px2rem自适应设计,Webpack+Npm script自动化构建的jd-finance web app</title>
    <link href="http://yoursite.com/2018/03/20/vue-jd/"/>
    <id>http://yoursite.com/2018/03/20/vue-jd/</id>
    <published>2018-03-20T09:15:55.000Z</published>
    <updated>2018-03-20T09:19:56.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="A-jd-finance-web-app-based-on-Vue-hotcss-px2rem"><a href="#A-jd-finance-web-app-based-on-Vue-hotcss-px2rem" class="headerlink" title="A jd-finance web app based on Vue, hotcss + px2rem"></a>A jd-finance web app based on Vue, hotcss + px2rem</h1><h3 id="Tech"><a href="#Tech" class="headerlink" title="Tech"></a>Tech</h3><ul><li>Vue 2.5+</li><li>Vue-router </li><li>sass</li><li>css-modules</li><li>hotcss</li><li>px2rem</li><li>full-ES6-syntax-cover</li><li>eslint</li><li>vue-awesome-swiper</li><li>webpack </li><li>npm scirpts</li></ul><h3 id="自适应方案设计"><a href="#自适应方案设计" class="headerlink" title="自适应方案设计"></a>自适应方案设计</h3><ul><li>利用<code>hotcss</code>动态调整<code>meta</code>标签和<code>dpr</code>, 动态设定<code>html</code>标签的<code>font-size</code>(<code>Rem布局实现</code>)</li><li>利用<code>px2rem-loader</code>在自动化构建时自动转换<code>scss</code>的css尺寸</li><li>一份代码, 所有移动设备动态适配</li></ul><p>详情请移步我的技术博客: <a href="https://choteewang.github.io/2018/03/20/vue-jd%E8%87%AA%E9%80%82%E5%BA%94%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/" target="_blank" rel="noopener">记一次vue项目的自适应方案设计 hotcss + px2rem </a></p><h3 id="自动化构建"><a href="#自动化构建" class="headerlink" title="自动化构建"></a>自动化构建</h3><blockquote><p>使用<code>webpack</code>与<code>npm script</code>进行自动化构建, 手写所有代码</p></blockquote><ul><li>处理<code>vue</code>,<code>js</code>,<code>css</code>,<code>scss</code></li><li>处理图片,开启<code>Base64</code></li><li>自动清理<code>dist</code>目录</li><li>热重载</li><li>提取<code>vendors</code>与<code>manifest</code></li><li><code>Js-Uglify</code></li><li><code>Css-Minify</code></li><li>区分<code>开发环境</code>和<code>生产环境</code></li><li><code>生产环境</code>提取css文件</li><li><code>开发环境</code>开启<code>js-SourceMap</code></li><li><code>开发环境</code>开启<code>css-SourceMap</code></li><li><code>eslint</code></li></ul><h3 id="css模块化"><a href="#css模块化" class="headerlink" title="css模块化"></a>css模块化</h3><p>使用css模块化, 对公用模板组件的css进行抽象, 后续开发完全继承于已抽象的css模块</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">import</span> <span class="string">'layout'</span>;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">mixin</span> btn(<span class="variable">$size</span>:<span class="number">14px</span>,<span class="variable">$color</span>:<span class="number">#fff</span>,<span class="variable">$bgcolor</span>:<span class="number">#F04752</span>,<span class="variable">$padding</span>:<span class="number">5px</span>,<span class="variable">$radius</span>:<span class="number">5px</span>) &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="variable">$padding</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="variable">$bgcolor</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="variable">$radius</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="variable">$bgcolor</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="variable">$size</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="variable">$color</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">mixin</span> list(<span class="variable">$direction</span>:column) &#123;</span><br><span class="line">  @<span class="keyword">include</span> flex(<span class="variable">$direction</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">mixin</span> panel(<span class="variable">$bgcolor</span>:<span class="number">#fff</span>,<span class="variable">$padding</span>:<span class="number">0</span>,<span class="variable">$margin</span>:<span class="number">20px</span> 0,<span class="variable">$height</span>:<span class="number">112px</span>,<span class="variable">$txtPadding</span>:<span class="number">0</span> 32px,<span class="variable">$color</span>:<span class="number">#333</span>,<span class="variable">$fontSize</span>:<span class="number">32px</span>) &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="variable">$bgcolor</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="variable">$padding</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="variable">$margin</span>;</span><br><span class="line">  &gt; <span class="selector-tag">h4</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="variable">$height</span>;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="variable">$height</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="variable">$txtPadding</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">700</span>;</span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">color</span>: <span class="variable">$color</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="variable">$fontSize</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="vue组件模块化"><a href="#vue组件模块化" class="headerlink" title="vue组件模块化"></a>vue组件模块化</h3><p>抽象了<code>slider</code>, <code>btn</code>, <code>panel</code> 三个js组件模块, 后续所有组件开发继承于已抽象组件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">// slider.vue</span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">section</span> <span class="attr">:class</span>=<span class="string">"cname"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">swiper</span> <span class="attr">:options</span>=<span class="string">"options"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">swiper-slide</span> <span class="attr">v-for</span>=<span class="string">"item in items"</span> <span class="attr">:key</span>=<span class="string">"item.href"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">"&#123;name:item.href&#125;"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">"item.src"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">swiper-slide</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"swiper-pagination"</span> <span class="attr">v-if</span>=<span class="string">"options.pagination"</span> <span class="attr">slot</span>=<span class="string">"pagination"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">swiper</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> &#123; swiper, swiperSlide &#125; <span class="keyword">from</span> <span class="string">'vue-awesome-swiper'</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">  components: &#123;</span></span><br><span class="line"><span class="undefined">    swiper,</span></span><br><span class="line"><span class="undefined">    swiperSlide</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined">  props: &#123;</span></span><br><span class="line"><span class="undefined">    cname: &#123;</span></span><br><span class="line"><span class="javascript">      type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">      <span class="keyword">default</span>: <span class="string">''</span></span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    options: &#123;</span></span><br><span class="line"><span class="javascript">      type: <span class="built_in">Object</span>,</span></span><br><span class="line"><span class="javascript">      <span class="keyword">default</span>() &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="undefined">          autoplay: &#123;</span></span><br><span class="line"><span class="undefined">            delay: 3000,</span></span><br><span class="line"><span class="javascript">            disableOnInteraction: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">            stopOnLastSlide: <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">          &#125;,</span></span><br><span class="line"><span class="javascript">          loop: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">          disableOnInteraction: <span class="literal">false</span>,</span></span><br><span class="line"><span class="undefined">          pagination: &#123;</span></span><br><span class="line"><span class="javascript">            el: <span class="string">'.swiper-pagination'</span></span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    items: &#123;</span></span><br><span class="line"><span class="javascript">      type: <span class="built_in">Array</span>,</span></span><br><span class="line"><span class="javascript">      <span class="keyword">default</span>() &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> []</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">"scss"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">@<span class="keyword">import</span> <span class="string">'~swiper/dist/css/swiper.css'</span>;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// panel.vue</span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">section</span> <span class="attr">:class</span>=<span class="string">"[panelClass,cname]"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>-&#123;&#123;title&#125;&#125;-<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">  props: &#123;</span></span><br><span class="line"><span class="undefined">    cname: &#123;</span></span><br><span class="line"><span class="javascript">      type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">      <span class="keyword">default</span>: <span class="string">''</span></span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    title: &#123;</span></span><br><span class="line"><span class="javascript">      type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">      <span class="keyword">default</span>: <span class="string">''</span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined">  data() &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">      panelClass: <span class="string">'panel'</span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">"scss"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">@<span class="keyword">import</span> <span class="string">'../../css/element'</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.panel</span> &#123;</span></span><br><span class="line"><span class="css">  @<span class="keyword">include</span> panel;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="展示"><a href="#展示" class="headerlink" title="展示"></a>展示</h3><p><img src="https://i.loli.net/2018/03/20/5ab0cfc0b90e3.gif" alt="1"></p><p><img src="https://i.loli.net/2018/03/20/5ab0cfc16c581.gif" alt="2"></p><p><img src="https://i.loli.net/2018/03/20/5ab0cfc352d89.gif" alt="3"></p><p><img src="https://i.loli.net/2018/03/20/5ab0cfc14ecd8.gif" alt="4"></p><p><img src="https://i.loli.net/2018/03/20/5ab0cfc3b4594.gif" alt="5"></p><h3 id="github"><a href="#github" class="headerlink" title="github:"></a>github:</h3><p><a href="https://github.com/choteewang/vue-jd" target="_blank" rel="noopener">https://github.com/choteewang/vue-jd</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;A-jd-finance-web-app-based-on-Vue-hotcss-px2rem&quot;&gt;&lt;a href=&quot;#A-jd-finance-web-app-based-on-Vue-hotcss-px2rem&quot; class=&quot;headerlink&quot; title
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>hotcss + px2rem 实现 vue 项目的自适应方案设计 </title>
    <link href="http://yoursite.com/2018/03/20/vue-jd%E8%87%AA%E9%80%82%E5%BA%94%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/"/>
    <id>http://yoursite.com/2018/03/20/vue-jd自适应方案设计/</id>
    <published>2018-03-20T09:05:45.000Z</published>
    <updated>2018-03-20T12:06:18.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="自适应方案设计"><a href="#自适应方案设计" class="headerlink" title="自适应方案设计"></a>自适应方案设计</h2><p>做到一份代码, 构建出的app适配各种设备, 根据设备的屏幕尺寸, 自动缩放所有css尺寸, 让所有设备的浏览体验基本接近</p><h3 id="核心实现原理"><a href="#核心实现原理" class="headerlink" title="核心实现原理:"></a>核心实现原理:</h3><ul><li><code>hotcss</code>利用<code>viewport</code>和<code>设备像素比(dpr)</code>调整html标签的<code>font-size</code>(Rem基准像素)</li><li>使用<code>px2rem-loader</code>实现<code>px</code>向<code>rem</code>的转化</li></ul><h3 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h3><p><img src="https://i.loli.net/2018/03/20/5ab0cfc3b4594.gif" alt="https://i.loli.net/2018/03/20/5ab0cfc3b4594.gif"></p><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><blockquote><p><code>css像素</code>, <code>逻辑像素</code>, <code>设备像素</code>, <code>物理像素</code>, <code>设备像素比</code><br><a href="https://github.com/jawil/blog/issues/21" target="_blank" rel="noopener">https://github.com/jawil/blog/issues/21</a></p></blockquote><ul><li><code>css像素</code> 就是 <code>设备独立像素(dip)</code></li><li><code>设备像素</code> : <code>设备像素</code> 就是 <code>物理像素</code> 若在retina屏幕上的<code>设备像素比</code>=<code>2</code>, 则显示1px<code>css像素</code>需要2个<code>物理像素</code>, 显示宽高都是1px(<code>css像素</code>)的方块需要2*2个(<code>设备像素</code>)</li><li><code>设备像素比(dpr)</code>: <ul><li>广义定义: <code>设备像素</code>(<code>物理像素</code>) / <code>设备独立像素(dip)</code>(<code>css像素</code>) , </li><li>同义定义: <code>屏幕横向设备像素</code> / <code>理想视口的宽</code></li><li>获取方式: <code>window.devicePixelRatio</code></li><li>与<code>initial-scale</code>的关系: 互为倒数</li></ul></li></ul><p><img src="https://i.loli.net/2018/03/20/5ab0ceccad75e.jpg" alt="15213620087815"></p><blockquote><p>viewport</p></blockquote><p>viewport分三类: <code>layout viewport</code>, <code>visual viewport</code>, <code>ideal viewport</code></p><ul><li><code>layout viewport</code><br><img src="https://i.loli.net/2018/03/20/5ab0ceccc9890.jpg" alt="15213628251435"></li></ul><p>这个<code>layout viewport</code>的宽度可以通过<code>document.documentElement.clientWidth</code> 来获取。</p><ul><li><code>ideal viewport</code> 与 <code>visual viewport</code><br>在<code>meta</code>标签的<code>user-scalable=no</code>时,<code>ideal viewport</code>就是<code>visual viewport</code>, 宽度是屏幕宽度<code>window.innerWidth</code><br><img src="https://i.loli.net/2018/03/20/5ab0ceccd2587.jpg" alt="15213632335178"></li></ul><p><code>meta</code> 标签的<code>width=device-width</code>其实就是将<code>ideal-viewport</code>的宽度赋值给了<code>layout viewport</code><br><img src="https://i.loli.net/2018/03/20/5ab0ceccdc066.jpg" alt="15213640815087"></p><h3 id="核心工作原理"><a href="#核心工作原理" class="headerlink" title="核心工作原理"></a>核心工作原理</h3><blockquote><p><code>hotcss</code>利用<code>viewport</code>和<code>设备像素比(dpr)</code>调整基准像素</p></blockquote><p><a href="https://github.com/imochen/hotcss" target="_blank" rel="noopener">hotcss github地址</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// hotcss打包方式</span></span><br><span class="line">entry: &#123;</span><br><span class="line">  app: [<span class="string">'./app/js/main.js'</span>, <span class="string">'./app/js/hotcss.js'</span>],</span><br><span class="line">  vendor: [<span class="string">'vue'</span>, <span class="string">'vue-router'</span>, <span class="string">'vue-awesome-swiper'</span>]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><ul><li>rem</li></ul><p><code>设计稿fontSize基准值(remUnit)</code>/<code>设计稿物理像素宽度</code> = <code>当前设备html标签fontSize值(所求)</code>/当前设备<code>物理像素宽度</code></p><p><img src="https://i.loli.net/2018/03/20/5ab0ceccd1164.jpg" alt="15213642316299"></p><p>对于上图的解释: </p><ul><li>左面是<code>设计稿</code>, 右面是<code>设备</code></li><li><code>设计稿物理像素宽度</code>是 320px(<code>css像素</code>丈量下的<code>ideal port</code>宽度) * 2(<code>dpr</code>) = 640(<code>物理像素</code>)</li><li>若此时适配到了一个<code>ideal port</code>宽度为375px,<code>dpr</code>=3的设备</li><li>则<code>设备物理像素宽度</code> = 375px(<code>css像素</code>丈量下的<code>ideal port</code>宽度) * 3(<code>dpr</code>) = 1125(<code>物理像素</code>)</li><li>与<code>rem</code>关系, <code>remUnit</code>(设计稿html标签fontSize基准值)/ <code>设备html标签fontSize值</code> = <code>设计稿物理像素宽度</code> / <code>设备物理像素宽度</code></li></ul><p><strong>若此时左面设计稿的<code>html</code>标签的<code>font-size</code>是40px, 则hotcss应将右面设计稿的<code>html</code>标签的<code>font-size</code>计算为:</strong><br><strong><code>(375 * 3) / (320 * 2) * 40 = 70.3125</code>, 从而达到等比缩放的效果</strong></p><blockquote><p>利用px2rem自动转换css单位</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">  loader: <span class="string">'vue-loader'</span>,</span><br><span class="line">  options: &#123;</span><br><span class="line">    loaders: &#123;</span><br><span class="line">      <span class="comment">// npm install px2rem-loader</span></span><br><span class="line">      <span class="comment">// 叹号分隔loader, 从右向左加载</span></span><br><span class="line">      <span class="comment">// 开启px2rem, npm install px2rem-loader</span></span><br><span class="line">      <span class="comment">// remUnit = 75(在设计稿中html字体的大小, 也可理解为在原设计稿中1rem=多少像素)</span></span><br><span class="line">      <span class="comment">// 设计稿fontSize基准值(remUnit)/设计稿物理像素宽度 = 当前设备html标签fontSize值(所求)/当前设备物理像素宽度(媒体查询适配)</span></span><br><span class="line">      <span class="comment">// Precision = 8 转换小数精度</span></span><br><span class="line">      css: <span class="string">'vue-style-loader!css-loader!px2rem-loader?remUnit=40&amp;remPreceision=8'</span>,</span><br><span class="line">      scss: <span class="string">'vue-style-loader!css-loader!px2rem-loader?remUnit=40&amp;remPrecision=8!sass-loader'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>配置了<code>px2rem</code>后, 再写一个<code>80px</code>的css会被转化为<code>1.06666667rem</code>, 满足8位小数(Precision = 8), 且 1.06666667rem * 75(<code>remUnit</code>) = 80px</p></li><li><p>注意, 我们只需关心原始设计图的css尺寸开发, <code>hotcss</code>会根据不同设备的<code>dpr</code>与<code>ideal viewport</code>宽度来创建meta标签(将<code>initial-scale</code>设置为<code>dpr</code>的倒数), 同时设置html标签的<code>fontSize</code></p></li></ul><h3 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h3><p>这里主要拣一些在踩坑过程中容易出现混淆的细节详细说说</p><blockquote><p>关于webpack配置里remUnit的含义</p></blockquote><p><code>scss: &#39;vue-style-loader!css-loader!px2rem-loader?remUnit=40&amp;remPrecision=8!sass-loader&#39;</code></p><p>webpack中这个配置中声明了<code>px2rem-loader</code>的一个<code>option</code>选项<code>remUnit</code>的值赋值为40px, 但是如何理解这个40px? 这个值设成别的值行不行? </p><p><code>remUnit</code>本身是指<strong>设计稿</strong>的<code>html</code>标签的<code>font-size</code>属性值, 假设这个值设为40px, 其代表了在以设计稿为基准以<code>rem</code>布局书写css时, 每1rem代表了40px, 若此时有一个<code>div</code>的<code>font-size</code>的css书写是80px, <code>px2rem</code>会将其转化为2rem. 若此时再将<code>remUnit</code>在<code>webpack</code>中的配置改为<code>80</code>, 则重新构建后<code>div</code>的<code>font-size</code>变为<strong>1rem</strong></p><p>看起来这个<code>remUnit</code> 的设置并不会影响我们的界面展示, 因为根据书写css的尺寸是固定的, <code>rem尺寸</code> = <code>css尺寸</code> / <code>remUnit</code>, 不论我们写多少, <code>px2rem</code>都会调整为显示效果一样的rem尺寸. 但若是再加上<code>hotcss</code>呢? </p><blockquote><p>试一下随便改几个<code>remUnit</code>的尺寸, 配合<code>hotcss</code>就知道不行了. 若是熟悉了本篇博客上面写的基础知识, 再去看<code>hotcss</code>源码就可得到答案.</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hotcss 源码</span></span><br><span class="line">hotcss.px2rem = <span class="function"><span class="keyword">function</span>(<span class="params">px, designWidth</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//预判你将会在JS中用到尺寸，特提供一个方法助你在JS中将px转为rem。就是这么贴心。</span></span><br><span class="line">  <span class="keyword">if</span> (!designWidth) &#123;</span><br><span class="line">    <span class="comment">//如果你在JS中大量用到此方法，建议直接定义 hotcss.designWidth 来定义设计图尺寸;</span></span><br><span class="line">    <span class="comment">//否则可以在第二个参数告诉我你的设计图是多大。</span></span><br><span class="line">    designWidth = <span class="built_in">parseInt</span>(hotcss.designWidth, <span class="number">10</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">parseInt</span>(px, <span class="number">10</span>) * <span class="number">320</span> / designWidth / <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line">hotcss.mresize = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//对，这个就是核心方法了，给HTML设置font-size。</span></span><br><span class="line">  <span class="keyword">var</span> innerWidth =</span><br><span class="line">    <span class="built_in">document</span>.documentElement.getBoundingClientRect().width ||</span><br><span class="line">    <span class="built_in">window</span>.innerWidth</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hotcss.maxWidth &amp;&amp; innerWidth / hotcss.dpr &gt; hotcss.maxWidth) &#123;</span><br><span class="line">    innerWidth = hotcss.maxWidth * hotcss.dpr</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!innerWidth) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">document</span>.documentElement.style.fontSize = innerWidth * <span class="number">20</span> / <span class="number">320</span> + <span class="string">'px'</span></span><br><span class="line"></span><br><span class="line">  hotcss.callback &amp;&amp; hotcss.callback()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hotcss.mresize()</span><br><span class="line"><span class="comment">//直接调用一次</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.addEventListener(</span><br><span class="line">  <span class="string">'resize'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    clearTimeout(hotcss.tid)</span><br><span class="line">    hotcss.tid = setTimeout(hotcss.mresize, <span class="number">33</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="literal">false</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">//绑定resize的时候调用</span></span><br></pre></td></tr></table></figure><p><strong>通过读这段源码, 结合本篇博客开篇所介绍的基础知识, 我们可以得知其中原理: hotcss的作者将320px的设计图的rem基准定为了20px,其他设备不同屏幕宽度的设备页面的基准字号其实也随之而定了, 比如你的设计稿是iphone手机, dpr是2, 设计稿宽度是640px, 那么hotcss给html设置的<code>font-size</code>就是40px.</strong></p><p><strong>从rem自适应的原理上来说, 经px2rem转换之后, css中的rem单位都已经定下来了, 不会随着页面的变化而更改, 所以只有等比的设置不同屏幕的基准font-size, 才能达到一套代码全部屏幕自适应的需求, hotcss通过监听<code>window.resize</code>事件, 根据当前设备的<code>ideal port</code>宽度和<code>dpr</code>的值, 动态给页面的html标签设置基准font-size</strong></p><p><strong>回到我们抛出的问题, webpack中px2rem中remUnit值的设置, 其实相当于<code>在项目原始设计稿的标准下, html标签中的基准font-size会被hotcss转化为的数值</code>, 若以我的项目举例, 我的设计稿是640px的, 所以这里webpack中的remUnit必须设为40px</strong></p><p>至此, 很详细的说了这次自适应设计的原理, 整个处理webpack构建和设计自适应的过程是对自己处理问题能力的一个提升. </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;自适应方案设计&quot;&gt;&lt;a href=&quot;#自适应方案设计&quot; class=&quot;headerlink&quot; title=&quot;自适应方案设计&quot;&gt;&lt;/a&gt;自适应方案设计&lt;/h2&gt;&lt;p&gt;做到一份代码, 构建出的app适配各种设备, 根据设备的屏幕尺寸, 自动缩放所有css尺寸, 让所有
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>正反馈系列: Webpack (二)</title>
    <link href="http://yoursite.com/2018/03/16/webpack02/"/>
    <id>http://yoursite.com/2018/03/16/webpack02/</id>
    <published>2018-03-16T01:53:16.000Z</published>
    <updated>2018-03-20T03:40:32.000Z</updated>
    
    <content type="html"><![CDATA[<p>上一篇博客总结了<code>webpack</code>的基本配置, 处理js, css, 代码分割, 懒加载, tree-shaking等方法, 这篇博客继续总结资源处理, 第三方js库处理, html相关, devServer相关等知识.</p><h2 id="图片处理"><a href="#图片处理" class="headerlink" title="图片处理"></a>图片处理</h2><h3 id="场景与技术"><a href="#场景与技术" class="headerlink" title="场景与技术"></a>场景与技术</h3><ul><li>CSS中引入的图片 <code>file-loader</code></li><li>自动合成的雪碧图 <code>postcss-sprites</code></li><li>压缩图片 <code>img-loader</code></li><li>Base64编码 <code>url-loader</code></li></ul><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">      use: ExtractTextWebpackPlugin.extract(</span><br><span class="line">        &#123;</span><br><span class="line">          fallback: &#123;</span><br><span class="line">            loader: <span class="string">'style-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              singleton: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          use: [</span><br><span class="line">            &#123;</span><br><span class="line">              loader: <span class="string">'css-loader'</span>,</span><br><span class="line">              options: &#123;</span><br><span class="line">                importLoaders: <span class="number">2</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              loader: <span class="string">'postcss-loader'</span>,</span><br><span class="line">              options: &#123;</span><br><span class="line">                ident: <span class="string">'postcss'</span>,</span><br><span class="line">                plugins: [</span><br><span class="line">                  <span class="comment">// CSS 雪碧图</span></span><br><span class="line">                  <span class="built_in">require</span>(<span class="string">'postcss-sprites'</span>)(&#123;</span><br><span class="line">                    spritePath: <span class="string">'dist/assets/imgs/sprites'</span>,</span><br><span class="line">                    <span class="comment">// 只对形如'border@2x.png'类似的文件名起效</span></span><br><span class="line">                    retina: <span class="literal">true</span></span><br><span class="line">                  &#125;),</span><br><span class="line">                  <span class="built_in">require</span>(<span class="string">'postcss-cssnext'</span>)()</span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              loader: <span class="string">'less-loader'</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.(png|jpg|jpeg|gif)$/</span>,</span><br><span class="line">      use: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// url-loader和file-loader在图片处理时唯一的区别是url-loader可以设limit转Base64</span></span><br><span class="line">          <span class="comment">// 所以可以用url-loader代替file-loader</span></span><br><span class="line">          loader: <span class="string">'url-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            <span class="comment">// ext代表后缀名</span></span><br><span class="line">            name: <span class="string">'[name]-[hash:5].[ext]'</span>,</span><br><span class="line">            limit: <span class="number">1000</span>,</span><br><span class="line">            <span class="comment">// publicPath: 静态资源引用地址</span></span><br><span class="line">            <span class="comment">// 覆盖output中的publicPath设置</span></span><br><span class="line">            <span class="comment">// 若服务为httpServer, 设置为'/'则指向了网站根目录,相当于开启一个绝对路径</span></span><br><span class="line">            <span class="comment">/* 一些publicPath示例</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">                publicPath: "https://cdn.example.com/assets/", // CDN（总是 HTTPS 协议）</span></span><br><span class="line"><span class="comment">                publicPath: "//cdn.example.com/assets/", // CDN (协议相同)</span></span><br><span class="line"><span class="comment">                publicPath: "/assets/", // 相对于服务(server-relative)</span></span><br><span class="line"><span class="comment">                publicPath: "assets/", // 相对于 HTML 页面</span></span><br><span class="line"><span class="comment">                publicPath: "../assets/", // 相对于 HTML 页面</span></span><br><span class="line"><span class="comment">                publicPath: "", // 相对于 HTML 页面（目录相同）</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            publicPath: <span class="string">'/'</span>,</span><br><span class="line">            <span class="comment">// outputPath: 构建文件输出地址</span></span><br><span class="line">            <span class="comment">// 相对output.path的相对路径,以'/'结尾表示文件夹</span></span><br><span class="line">            outputPath: <span class="string">'assets/imgs/'</span>,</span><br><span class="line">            <span class="comment">// 会模拟源代码的目录结构生成对应的相对文件结构, 方便css等相对路径的引用</span></span><br><span class="line">            <span class="comment">// useRelativePath: true</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'img-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            pngquant: &#123;</span><br><span class="line">              quality: <span class="number">80</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="字体文件处理"><a href="#字体文件处理" class="headerlink" title="字体文件处理"></a>字体文件处理</h2><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><blockquote><p>方法同图片文件处理: 即不涉及Base64编码时使用<code>file-loader</code>,否则使用<code>url-loader</code></p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.(eot|woff2?|ttf|svg)$/</span>,</span><br><span class="line">  use: [</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'url-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        name: <span class="string">'[name]-[hash:5].[ext]'</span>,</span><br><span class="line">        <span class="comment">// 转为 baseurl 的前提</span></span><br><span class="line">        limit: <span class="number">5000</span>,</span><br><span class="line">        publicPath: <span class="string">''</span>,</span><br><span class="line">        outputPath: <span class="string">'dist/'</span>,</span><br><span class="line">        useRelativePath: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="处理第三方JS库"><a href="#处理第三方JS库" class="headerlink" title="处理第三方JS库"></a>处理第三方JS库</h2><h3 id="场景和方法"><a href="#场景和方法" class="headerlink" title="场景和方法"></a>场景和方法</h3><ul><li>远程cdn库用script标签链html中: <code>script</code>标签在html页面中引入, <code>window</code>全局引入, 所有模块皆可使用</li><li>npm install的库注入模块中: <code>webpack.providePlugin</code>,  <code>imports-loader</code></li><li>本地目录下的js文件注入模块中: <code>resolve</code>属性配置<code>alias</code>后, <code>webpack.providePlugin</code>或<code>imports-loader</code>引入`</li></ul><h3 id="webpack-providePlugin"><a href="#webpack-providePlugin" class="headerlink" title="webpack.providePlugin"></a>webpack.providePlugin</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 若本地目录下的js文件需引入模块则配置resolve, npm仓库不需配置</span></span><br><span class="line">  <span class="comment">// 配置alias后也可用imports-loader导入</span></span><br><span class="line">  resolve: &#123;</span><br><span class="line">    alias: &#123;</span><br><span class="line">      <span class="comment">// jquery 别名，告诉webpack jquery = src/libs/jquery.min.js</span></span><br><span class="line">      <span class="comment">// 这里加$号的原因是需匹配具体文件,而不是文件夹</span></span><br><span class="line">      <span class="comment">// $号前的jquery字符串对应ProvidePlugin中的'jquery'</span></span><br><span class="line">      jquery$: path.resolve(__dirname, <span class="string">'src/libs/jquery.min.js'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// 将jquery注入到每一个模块中</span></span><br><span class="line">    <span class="keyword">new</span> webpack.ProvidePlugin(&#123;</span><br><span class="line">      $: <span class="string">'jquery'</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="imports-loader"><a href="#imports-loader" class="headerlink" title="imports-loader"></a>imports-loader</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">&#123;</span><br><span class="line">  test: path.resolve(__dirname, <span class="string">'src/app.js'</span>),</span><br><span class="line">  use: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 使用 imports-loader 注入</span></span><br><span class="line">      loader: <span class="string">'imports-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        $: <span class="string">'jquery'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HTML-in-Webpack"><a href="#HTML-in-Webpack" class="headerlink" title="HTML in Webpack"></a>HTML in Webpack</h2><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><ul><li>自动生成html, 引入bundle: <code>HtmlWebpackPlugin</code></li><li>html中img标签用src引入图片: <code>html-loader</code></li><li>直接在src中用require方式引用: <code>require</code>语法</li><li>将提取的manifest公共代码通过script标签引入, <code>htmlWebpackInlineChunkPlugin</code></li></ul><h3 id="自动生成html-htmlWebpackPlugin"><a href="#自动生成html-htmlWebpackPlugin" class="headerlink" title="自动生成html, htmlWebpackPlugin"></a>自动生成html, htmlWebpackPlugin</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">plugins: [</span><br><span class="line">  <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">    <span class="comment">// 可指定目录'dist/index.html'</span></span><br><span class="line">    filename: <span class="string">'index.html'</span>,</span><br><span class="line">    template: <span class="string">'./index.html'</span>,</span><br><span class="line">    minify: &#123;</span><br><span class="line">      collapseWhitespace: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 选择插入哪些entry生成的bundle</span></span><br><span class="line">    <span class="comment">// chunks: ['app','app2']</span></span><br><span class="line">    <span class="comment">// 选择是否插入生成的bundle</span></span><br><span class="line">    <span class="comment">// false时可以手动在html页面内引入</span></span><br><span class="line">    <span class="comment">// inject: true</span></span><br><span class="line">  &#125;),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="html中img标签用src引入图片-html-loader"><a href="#html中img标签用src引入图片-html-loader" class="headerlink" title="html中img标签用src引入图片, html-loader"></a>html中img标签用src引入图片, html-loader</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.html$/</span>,</span><br><span class="line">      use: [</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'html-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">          attrs: [<span class="string">'img:src'</span>, <span class="string">'img:data-src'</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="直接在src中用require方式引用"><a href="#直接在src中用require方式引用" class="headerlink" title="直接在src中用require方式引用"></a>直接在src中用require方式引用</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"$&#123;require('./assets/img.png')&#125;"</span>/&gt;</span></span><br></pre></td></tr></table></figure><h3 id="将提取的manifest公共代码通过script标签引入-htmlWebpackInlineChunkPlugin"><a href="#将提取的manifest公共代码通过script标签引入-htmlWebpackInlineChunkPlugin" class="headerlink" title="将提取的manifest公共代码通过script标签引入, htmlWebpackInlineChunkPlugin"></a>将提取的manifest公共代码通过script标签引入, htmlWebpackInlineChunkPlugin</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">  name: <span class="string">'manifest'</span></span><br><span class="line">&#125;),</span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="keyword">new</span> HtmlInlinkChunkPlugin(&#123;</span><br><span class="line">  <span class="comment">// 注意若在htmlWebpackPlugin中配置了chunks属性, 需将'manifest'加入数组</span></span><br><span class="line">  inlineChunks: [<span class="string">'manifest'</span>]</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure><h2 id="开发服务器"><a href="#开发服务器" class="headerlink" title="开发服务器"></a>开发服务器</h2><h3 id="三种方式"><a href="#三种方式" class="headerlink" title="三种方式"></a>三种方式</h3><p><code>webpack-watch-mode</code>, 只监视文件,无服务器<br><code>webpack-dev-server</code><br><code>express + webpack-dev-middleware</code> 灵活的配置服务, 比如<code>koa</code>替换<code>express</code></p><h3 id="清除webpack代码-cleanWebpackPlugin"><a href="#清除webpack代码-cleanWebpackPlugin" class="headerlink" title="清除webpack代码, cleanWebpackPlugin"></a>清除webpack代码, cleanWebpackPlugin</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="comment">// 数组中是需要清除的路径</span></span><br><span class="line"><span class="keyword">new</span> CleanWebpackPlugin([<span class="string">'dist'</span>])</span><br></pre></td></tr></table></figure><h3 id="webpack-dev-server"><a href="#webpack-dev-server" class="headerlink" title="webpack-dev-server"></a>webpack-dev-server</h3><h4 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h4><ul><li>live-reloading</li><li>打包文件写入内存</li><li>路径重定向</li><li>https</li><li>浏览器中显示编译错误</li><li>接口代理</li><li>模块热更新</li></ul><h4 id="npm-scripts-启动"><a href="#npm-scripts-启动" class="headerlink" title="npm scripts 启动"></a>npm scripts 启动</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// package.json</span><br><span class="line">"scripts": &#123;</span><br><span class="line">  // 通过命令行形式直接运行webpack-dev-server会找不到</span><br><span class="line">  // 因为该命令入口在/node_modules/.bin目录下</span><br><span class="line">  "server": "webpack-dev-server --open"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="H5-history-api-rewrite-historyApiFallback"><a href="#H5-history-api-rewrite-historyApiFallback" class="headerlink" title="H5 history api rewrite, historyApiFallback"></a>H5 history api rewrite, historyApiFallback</h4><blockquote><p>作用: 当使用 <code>HTML5 History AP</code>I 时，任意的 404 响应都可能需要被替代为 index.html<br>也可以配置rewrites进一步配置, 防止用户在浏览器栏输入地址并刷新时跳转到不存在的404页面</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 头部不用import devServer</span></span><br><span class="line">devServer: &#123;</span><br><span class="line">  <span class="comment">// liveReloading是自动的, 不用参数配置</span></span><br><span class="line">  <span class="comment">// 本地服务端口号</span></span><br><span class="line">  port: <span class="number">9001</span>,</span><br><span class="line">  <span class="comment">// HTML5 histroy API rewrite</span></span><br><span class="line">  <span class="comment">// 简单版使用 'historyApiFallback: true'</span></span><br><span class="line">  <span class="comment">// 之后在浏览器访问一个不存在的地址时不会报404,会停留在index.html</span></span><br><span class="line">  <span class="comment">// historyApiFallback: true</span></span><br><span class="line">  historyApiFallback: &#123;</span><br><span class="line">    rewrites: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 来自什么样的路径</span></span><br><span class="line">        <span class="keyword">from</span>: <span class="regexp">/^\/([a-zA-Z0-9]+\/?)([a-zA-Z0-9]+)/</span>,</span><br><span class="line">        <span class="comment">// 跳转到哪里</span></span><br><span class="line">        <span class="comment">// context拿到正则捕获组</span></span><br><span class="line">        to: <span class="function"><span class="keyword">function</span> (<span class="params">context</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">'/'</span> + context.match[<span class="number">1</span>] + context.match[<span class="number">2</span>] + <span class="string">'.html'</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h4><blockquote><p>Proxy 内部集成 <code>http-proxy-middleware</code></p></blockquote><ul><li><code>target</code>: 指定代理服务器地址</li><li><code>changeOrigin</code>: 改变源到url, 设置为true时可以请求vitual host站点, 默认false记得设为true</li><li><code>headers</code>: 给http增加请求头</li><li><code>logLevel</code>: 在控制台或terminal中显示代理信息, 帮助调试</li><li><code>pathRewrite</code>: 可以用简短的地址代替长地址请求</li></ul><blockquote><p>例: 请求新浪微博接口 <code>https://m.weibo.cn/api/comments/show?id=4193586758833502&amp;page=1</code><br>在js文件中用jquery请求我们自己定义的短路径’/comments/show’</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在自己开发的js中写入下述代码</span></span><br><span class="line"><span class="comment">// '/comments/show' 是我们自己定义的缩短路径</span></span><br><span class="line">$.get(<span class="string">'/comments/show'</span>, &#123;</span><br><span class="line">  id: <span class="string">'4193586758833502'</span>,</span><br><span class="line">  page: <span class="number">1</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">devServer: &#123;</span><br><span class="line">  port: <span class="number">9001</span>,</span><br><span class="line">  proxy: &#123;</span><br><span class="line">    <span class="comment">// 需要被代理的路径开头</span></span><br><span class="line">    <span class="string">'/'</span>: &#123;</span><br><span class="line">      <span class="comment">// 指定代理服务器地址</span></span><br><span class="line">      target: <span class="string">'https://m.weibo.cn'</span>,</span><br><span class="line">      <span class="comment">// 设置为true时可以请求vitual host站点, 默认false, 需要设置为true</span></span><br><span class="line">      changeOrigin: <span class="literal">true</span>,</span><br><span class="line">      <span class="comment">// 在控制台或terminal中显示代理信息, 帮助调试</span></span><br><span class="line">      logLevel: <span class="string">'debug'</span>,</span><br><span class="line">      <span class="comment">// 用简短的地址替换长地址请求</span></span><br><span class="line">      pathRewrite: &#123;</span><br><span class="line">        <span class="string">'^/comments'</span>: <span class="string">'/api/comments'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 给http协议增加请求头</span></span><br><span class="line">      headers: &#123;</span><br><span class="line">        <span class="string">'Cookie'</span>: <span class="string">'_T_WM=044532f80b8fabc6dc347fd417c33202; ALF=1517569014; SUBP=0033WrSXqPxfM725Ws9jqgMF55529P9D9WhQljxrwvAfCCZa_p.u8pB.5JpX5K-hUgL.Fo2cS0qRehBcSKM2dJLoI7HpqJ8XwBtt; SCF=AkQsXaaTywl0RziwnumQ0tVE_xW5udcpoGP43q7eb2tFW9lXRc4bVNOn9N5m_ZKwFc-Q2r4Hz5oMBAbVJuhI1uk.; SUB=_2A253SLARDeRhGedI7FQZ8CrKzjuIHXVUstBZrDV6PUJbktANLUXEkW1NVtAHXD7nHQtwFntsDZsmqj2nB17cClnd; SUHB=0k1zt1ckxYq3c6; H5_INDEX_TITLE=qbaty; H5_INDEX=0_all; WEIBOCN_FROM=1110006030; M_WEIBOCN_PARAMS=oid%3D4193586758833502%26luicode%3D20000061%26lfid%3D4193594443440569%26uicode%3D20000061%26fid%3D4193586758833502'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="模块热更新-MHR-Module-Hot-Reloading"><a href="#模块热更新-MHR-Module-Hot-Reloading" class="headerlink" title="模块热更新 MHR(Module Hot Reloading)"></a>模块热更新 MHR(Module Hot Reloading)</h4><blockquote><p>与liveReloading的区别: </p></blockquote><ul><li>不重新刷新浏览器更新前端代码</li><li>可以保持应用数据状态</li><li>节省时间, 样式调试更快</li></ul><blockquote><p>所需工具和方法</p></blockquote><ul><li><code>devServer.hot: true</code> 即可使用</li><li><code>webpack.HotModuleReplacementPlugin</code> 必须使用</li><li><code>webpack.NamedModulesPlugin</code> 启用HMR时, 如果想看到模块相对路径, 需使用</li></ul><blockquote><p>配置</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">devServer: &#123;</span><br><span class="line">  hot: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// 使全局无论如何不通过刷新页面实现热更新</span></span><br><span class="line">  hotOnly: <span class="literal">true</span></span><br><span class="line">&#125;,</span><br><span class="line">plugins: [</span><br><span class="line">  <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">  <span class="keyword">new</span> webpack.NamedModulesPlugin(),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><blockquote><p>注意: HMR更新的是内存中的代码, 所以若css用<code>ExtractTextWebpackPlugin</code>提取过的话, 无法进行热更新<br>解决方法是改为<code>style-loader</code>注入的方式<br>关于<code>NamedModulesPlugin</code>的具体效果, 移步<a href="https://doc.webpack-china.org/guides/caching/#%E6%A8%A1%E5%9D%97%E6%A0%87%E8%AF%86%E7%AC%A6-module-identifiers-" target="_blank" rel="noopener">webpack官中文档</a></p></blockquote><h2 id="Source-Map"><a href="#Source-Map" class="headerlink" title="Source Map"></a>Source Map</h2><h3 id="方式"><a href="#方式" class="headerlink" title="方式"></a>方式</h3><blockquote><p>JS Source Map</p></blockquote><ul><li><code>devtool</code></li><li><code>webpack.SourceMapDevToolPlugin</code></li><li><code>webpack.EvalSourceMapDevToolPlugin</code></li></ul><blockquote><p>CSS Source Map<br>将下列属性设置为true即可</p></blockquote><ul><li><code>style-loader.option.sourceMap</code></li><li><code>css-loader.option.sourceMap</code> </li><li><code>less-loader.option.sourceMap</code></li><li><code>sass-loader.option.sourceMap</code></li></ul><h3 id="devtool-取值"><a href="#devtool-取值" class="headerlink" title="devtool 取值"></a>devtool 取值</h3><blockquote><p>Development</p></blockquote><ul><li><code>eval</code></li><li><code>eval-source-map</code></li><li><code>cheap-eval-source-map</code></li><li><code>cheap-module-eval-source-map</code> 建议在开发环境使用</li></ul><blockquote><p>Production</p></blockquote><ul><li><code>source-map</code></li><li><code>hidden-source-map</code></li><li><code>nosource-source-map</code></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  devtool: <span class="string">'cheap-module-eval-source-map'</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CSS-Source-Map-设置"><a href="#CSS-Source-Map-设置" class="headerlink" title="CSS Source Map 设置"></a>CSS Source Map 设置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">  use: [</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'style-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        <span class="comment">// 必须去掉singleton属性才可以正确开启css-sourcemap</span></span><br><span class="line">        <span class="comment">// singleton: true</span></span><br><span class="line">        sourceMap: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'css-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        importLoaders: <span class="number">2</span>,</span><br><span class="line">        sourceMap: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'postcss-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        ident: <span class="string">'postcss'</span>,</span><br><span class="line">        sourceMap: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'less-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        sourceMap: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="设置-EsLint"><a href="#设置-EsLint" class="headerlink" title="设置 EsLint"></a>设置 EsLint</h2><h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><ul><li><code>eslint</code></li><li><code>eslint-loader</code></li><li><code>eslint-plugin-html</code>: 当在html中以script标签引入js时开启eslint</li><li><code>eslint-friendly-formatter</code> 开启更友好的eslint提示</li></ul><h3 id="方式-1"><a href="#方式-1" class="headerlink" title="方式"></a>方式</h3><ul><li>在<code>webpack.config.js</code>中开启<code>eslint-loader</code></li><li>在<code>.eslintrc</code>或<code>package.json</code>中的<code>eslintConfig</code>属性中设置相关选项</li></ul><h3 id="eslint规范"><a href="#eslint规范" class="headerlink" title="eslint规范"></a>eslint规范</h3><blockquote><p>JavaScript Standard Style (<a href="https://standardjs.com/" target="_blank" rel="noopener">https://standardjs.com/</a>)</p></blockquote><ul><li><code>eslint-config-standard</code></li><li><code>eslint-plugin-promise</code></li><li><code>eslint-plugin-standard</code></li><li><code>eslint-plugin-import</code></li><li><code>eslint-plugin-node</code></li><li><code>eslint-config-xxx</code></li></ul><h3 id="eslint-loader等配置"><a href="#eslint-loader等配置" class="headerlink" title="eslint-loader等配置"></a>eslint-loader等配置</h3><blockquote><p>eslint-loader</p></blockquote><ul><li><code>options.failOnWarning</code>: 若Warning则不通过编译</li><li><code>options.failOnError</code>: 若Error则不通过编译</li><li><code>options.formatter</code>: 设置第三方友好代码提示的选项, 可用<code>eslint-friendly-formatter</code></li><li><code>options.outputReport</code>: 输出一个代码格式检查的报告</li></ul><blockquote><p><code>devServer.overlay</code><br>配置此选项可让eslint在浏览器中输出</p></blockquote><h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install eslint eslint-loader eslint-plugin-html eslint-friendly-formatter --save-dev</span><br><span class="line">npm install eslint-config-standard eslint-plugin-promise eslint-plugin-node eslint-plugin-import eslint-plugin-standard --save-dev</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">devServer: &#123;</span><br><span class="line">  overlay: <span class="literal">true</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      include: [path.resolve(__dirname, <span class="string">'src'</span>)],</span><br><span class="line">      exclude: [path.resolve(__dirname, <span class="string">'src/libs'</span>)],</span><br><span class="line">      use: [</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            presets: [<span class="string">'env'</span>]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'eslint-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            <span class="comment">// 设置第三方友好代码提示的选项, 可用`eslint-friendly-formatter`</span></span><br><span class="line">            formatter: <span class="built_in">require</span>(<span class="string">'eslint-friendly-formatter'</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .eslintrc</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  root: <span class="literal">true</span>,</span><br><span class="line">  extends: <span class="string">'standard'</span>,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// eslint-plugin-html插件</span></span><br><span class="line">    <span class="string">'html'</span></span><br><span class="line">  ],</span><br><span class="line">  env: &#123;</span><br><span class="line">    browser: <span class="literal">true</span>,</span><br><span class="line">    node: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 允许的全局变量</span></span><br><span class="line">  globals: &#123;</span><br><span class="line">    $: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 覆盖extends标准的规则</span></span><br><span class="line">  rules: &#123;</span><br><span class="line">    <span class="string">'indent'</span>: [<span class="string">'error'</span>, <span class="number">4</span>],</span><br><span class="line">    <span class="string">'eol-last'</span>: [<span class="string">'error'</span>, <span class="string">'never'</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Resolve"><a href="#Resolve" class="headerlink" title="Resolve"></a>Resolve</h2><h3 id="resolve-alias"><a href="#resolve-alias" class="headerlink" title="resolve.alias"></a>resolve.alias</h3><blockquote><p>可以在<code>import</code>时启用别名替换</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">alias: &#123;</span><br><span class="line">  Utilities: path.resolve(__dirname, <span class="string">'src/utilities/'</span>),</span><br><span class="line">  Templates: path.resolve(__dirname, <span class="string">'src/templates/'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 设置前: import Utility from '../../utilities/utility';</span></span><br><span class="line"><span class="comment">// 设置后: import Utility from 'Utilities/utility';</span></span><br></pre></td></tr></table></figure><h3 id="resolve-extensions"><a href="#resolve-extensions" class="headerlink" title="resolve.extensions"></a>resolve.extensions</h3><blockquote><p>可以在<code>import</code>时忽略的扩展名</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">resolve: &#123;</span><br><span class="line">  extensions: [<span class="string">".js"</span>, <span class="string">".vue"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="区分开发环境和生产环境"><a href="#区分开发环境和生产环境" class="headerlink" title="区分开发环境和生产环境"></a>区分开发环境和生产环境</h2><blockquote><p>开发环境需要(对应<code>webpack.dev.conf.js</code>):</p></blockquote><ul><li>模块热更新</li><li>sourceMap</li><li>接口代理</li><li>代码规范检查</li></ul><blockquote><p>生产环境需要(对应<code>webpack.prod.conf.js</code>): </p></blockquote><ul><li>提取公用代码</li><li>压缩混淆</li><li>文件压缩或Base64编码</li><li>Tree-Shaking</li></ul><blockquote><p>共同点(对应<code>webpack.common.conf.js</code>)</p></blockquote><ul><li>同样的入口</li><li>同样的代码处理(loader处理)</li><li>同样的解析配置</li></ul><h3 id="方法-1"><a href="#方法-1" class="headerlink" title="方法"></a>方法</h3><ul><li>用<code>webpack.DefinePlugin</code>设置常量</li><li>进阶: <code>webpack-merge</code> 拼接webpack配置</li></ul><h3 id="webpack-DefinePlugin"><a href="#webpack-DefinePlugin" class="headerlink" title="webpack.DefinePlugin"></a>webpack.DefinePlugin</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">const</span> ExtractTextPlugin = <span class="built_in">require</span>(<span class="string">"extract-text-webpack-plugin"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">env</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        loader: env === PRODUCTION ? ExtractTextPlugin.extract(&#123;</span><br><span class="line">          use: <span class="string">'css-loader'</span>,</span><br><span class="line">          fallback: <span class="string">'style-loader'</span></span><br><span class="line">        &#125;) : <span class="string">'style-loader!css-loader'</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// 此插件用来定义全局变量</span></span><br><span class="line">    <span class="keyword">new</span> webpack.DefinePlugin(&#123;</span><br><span class="line">      <span class="comment">// 因为插件直接进行文本替换,要保留原始引号,两种方法是:</span></span><br><span class="line">      <span class="comment">// 1. '"production"'</span></span><br><span class="line">      <span class="comment">// 2. JSON.stringify('production')</span></span><br><span class="line">      PRODUCTION: <span class="built_in">JSON</span>.stringify(<span class="string">'production'</span>),</span><br><span class="line">      DEV: <span class="built_in">JSON</span>.stringify(<span class="string">'development'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="webpack-merge配置"><a href="#webpack-merge配置" class="headerlink" title="webpack-merge配置"></a>webpack-merge配置</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// package.json</span><br><span class="line">"scripts": &#123;</span><br><span class="line">  "server": "webpack-dev-server --env development --open --config build/webpack.common.conf.js",</span><br><span class="line">  "build": "webpack --env production --config build/webpack.common.conf.js",</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.common.conf.js</span></span><br><span class="line"><span class="keyword">const</span> productionConfig = <span class="built_in">require</span>(<span class="string">'./webpack.prod.conf'</span>)</span><br><span class="line"><span class="keyword">const</span> developmentConfig = <span class="built_in">require</span>(<span class="string">'./webpack.dev.conf'</span>)</span><br><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>)</span><br><span class="line"><span class="comment">// 生成提取css文件的Plugin</span></span><br><span class="line"><span class="keyword">const</span> extractLess = <span class="keyword">new</span> ExtractTextWebpackPlugin(&#123;</span><br><span class="line">  filename: <span class="string">'css/[name]-bundle-[hash:5].css'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 这里的参数env是npm scripts --env 传入的字符串</span></span><br><span class="line"><span class="keyword">const</span> generateConfig = <span class="function"><span class="params">env</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 设置js需要的scriptloader</span></span><br><span class="line">  <span class="keyword">const</span> scriptLoader = [</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'babel-loader'</span></span><br><span class="line">    &#125;</span><br><span class="line">  ].concat(env === <span class="string">'production'</span> ? [] : [</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'eslint-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        formatter: <span class="built_in">require</span>(<span class="string">'eslint-friendly-formatter'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ])</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 设置css需要的cssLoaders</span></span><br><span class="line">  <span class="keyword">const</span> cssLoaders = [</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'css-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        importLoaders: <span class="number">2</span>,</span><br><span class="line">        <span class="comment">// 若是dev环境则关闭sourceMap</span></span><br><span class="line">        sourceMap: env === <span class="string">'development'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'postcss-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        ident: <span class="string">'postcss'</span>,</span><br><span class="line">        <span class="comment">// 若是dev环境则关闭sourceMap</span></span><br><span class="line">        sourceMap: env === <span class="string">'development'</span>,</span><br><span class="line">        plugins: [</span><br><span class="line">          <span class="built_in">require</span>(<span class="string">'postcss-cssnext'</span>)()</span><br><span class="line">        ].concat(</span><br><span class="line">          <span class="comment">// 若是生产环境,加载post-css雪碧图功能</span></span><br><span class="line">          env === <span class="string">'production'</span></span><br><span class="line">            ? <span class="built_in">require</span>(<span class="string">'postcss-sprites'</span>)(&#123;</span><br><span class="line">              spritePath: <span class="string">'dist/assets/imgs/sprites'</span>,</span><br><span class="line">              retina: <span class="literal">true</span></span><br><span class="line">            &#125;)</span><br><span class="line">            : []</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">'less-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        <span class="comment">// 若是dev环境则关闭sourceMap</span></span><br><span class="line">        sourceMap: env === <span class="string">'development'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// style-loader若是prod环境需提取,dev环境直接使用style-loader</span></span><br><span class="line">  <span class="keyword">const</span> styleLoader = env === <span class="string">'production'</span></span><br><span class="line">    ? extractLess.extract(&#123;</span><br><span class="line">      fallback: <span class="string">'style-loader'</span>,</span><br><span class="line">      use: cssLoaders</span><br><span class="line">    &#125;)</span><br><span class="line">    : [&#123;</span><br><span class="line">      loader: <span class="string">'style-loader'</span></span><br><span class="line">    &#125;].concat(cssLoaders)</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 针对file-loader的配置</span></span><br><span class="line">  <span class="comment">// fileLoader根据img和font文件的不同设置不同的outputPath</span></span><br><span class="line">  <span class="keyword">const</span> fileLoader = <span class="function"><span class="params">path</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果是dev环境,使用file-loader,若是prod环境,使用url-loader开启Base64编码</span></span><br><span class="line">    <span class="keyword">return</span> env === <span class="string">'development'</span></span><br><span class="line">      ? [&#123;</span><br><span class="line">        loader: <span class="string">'file-loader'</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          name: <span class="string">'[name]-[hash:5].[ext]'</span>,</span><br><span class="line">          outputPath: path</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">      : [&#123;</span><br><span class="line">        loader: <span class="string">'url-loader'</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          name: <span class="string">'[name]-[hash:5].[ext]'</span>,</span><br><span class="line">          limit: <span class="number">1000</span>,</span><br><span class="line">          outputPath: path</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,&#123;</span><br><span class="line">        loader: <span class="string">'img-loader'</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          pngquant: &#123;</span><br><span class="line">            quality: <span class="number">80</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回配置对象, 在各自rules的use字段载入上述定义的loader</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    entry,</span><br><span class="line">    output,</span><br><span class="line">    resolve,</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">      rules: [</span><br><span class="line">        &#123;</span><br><span class="line">          test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">          include: [path.resolve(__dirname, <span class="string">'../src'</span>)],</span><br><span class="line">          exclude: [path.resolve(__dirname, <span class="string">'../src/libs'</span>)],</span><br><span class="line">          use: scriptLoader</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">          use: styleLoader(<span class="string">'assets/imgs/'</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          test: <span class="regexp">/\.(png|jpg|jpeg|gif)$/</span>,</span><br><span class="line">          use: fileLoader</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          test: <span class="regexp">/\.(eot|woff2?|ttf|svg)$/</span>,</span><br><span class="line">          use: fileLoader(<span class="string">'assets/fonts/'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="comment">// 提取less</span></span><br><span class="line">      extractLess,</span><br><span class="line">      <span class="comment">// 自动生成html, 引入bundle</span></span><br><span class="line">      <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">        filename: <span class="string">'index.html'</span>,</span><br><span class="line">        template: <span class="string">'./index.html'</span>,</span><br><span class="line">        minify: &#123;</span><br><span class="line">          collapseWhitespace: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="comment">// 将本地的jquery文件注入到每一个模块中</span></span><br><span class="line">      <span class="keyword">new</span> webpack.ProvidePlugin(&#123;</span><br><span class="line">        $: <span class="string">'jquery'</span></span><br><span class="line">      &#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里的参数env是npm scripts --env 传入的字符串</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">env</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// config根据传入的env变量赋值为对应的prod配置或dev配置</span></span><br><span class="line">  <span class="keyword">let</span> config = env === <span class="string">'production'</span></span><br><span class="line">    ? productionConfig</span><br><span class="line">    : developmentConfig</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> merge(generateConfig(env), config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.dev.conf.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  devtool: <span class="string">'cheap-module-source-map'</span>,</span><br><span class="line">  devServer,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// 引入devServer相关plugins</span></span><br><span class="line">    <span class="comment">// 热更新</span></span><br><span class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">    <span class="comment">// 启用热更新时显示模块相对路径</span></span><br><span class="line">    <span class="keyword">new</span> webpack.NamedModulesPlugin(),</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.prod.conf.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// CSS Tree Shaking</span></span><br><span class="line">    <span class="keyword">new</span> PurifyWebpack(&#123;</span><br><span class="line">      paths: glob.sync([</span><br><span class="line">        <span class="string">'./*.html'</span>,</span><br><span class="line">        <span class="string">'./src/*.js'</span></span><br><span class="line">      ])</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">// 提取manifest</span></span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      name: <span class="string">'manifest'</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">// 将manifest以script标签形式放入html中</span></span><br><span class="line">    <span class="keyword">new</span> HtmlInlinkChunkPlugin(&#123;</span><br><span class="line">      inlineChunks: [<span class="string">'manifest'</span>]</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">// JS Tree Shaking</span></span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.UglifyJsPlugin(),</span><br><span class="line">    <span class="comment">// 打包前 clean dist 目录</span></span><br><span class="line">    <span class="keyword">new</span> CleanWebpackPlugin(path.resolve(__dirname, <span class="string">'../dist'</span>)),</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="优化打包速度"><a href="#优化打包速度" class="headerlink" title="优化打包速度"></a>优化打包速度</h2><blockquote><p>分开vender和app</p></blockquote><ul><li><code>DllPlugin</code>: 通过打包第三包库会生成map(映射关系),供业务代码引用</li><li><code>DllReferencePlugin</code></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.dll.conf.js</span></span><br><span class="line"><span class="comment">// 所有vendor库代码打包配置</span></span><br><span class="line"><span class="comment">// 在生产环境构建中运行一次即可 webpack --config webpack.dll.conf.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    vue: [<span class="string">'vue'</span>, <span class="string">'vue-router'</span>],</span><br><span class="line">    ui: [<span class="string">'element-ui'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.join(__dirname, <span class="string">'../src/dll/'</span>),</span><br><span class="line">    filename: <span class="string">'[name].dll.js'</span>,</span><br><span class="line">    <span class="comment">// 定义第三方库的引用名, 若不配置此项, 则vendor都以全局变量引入</span></span><br><span class="line">    library: <span class="string">'[name]'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// `DllPlugin`: 通过打包第三包库会生成map(映射关系),供业务代码引用</span></span><br><span class="line">    <span class="keyword">new</span> webpack.DllPlugin(&#123;</span><br><span class="line">      <span class="comment">// 这里选择的输出其实是map的输出地址, map是json文件</span></span><br><span class="line">      path: path.join(__dirname, <span class="string">'../src/dll/'</span>, <span class="string">'[name]-manifest.json'</span>),</span><br><span class="line">      name: <span class="string">'[name]'</span></span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.UglifyJsPlugin()</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2018/03/16/5aab232642fad.jpg" alt=""></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.prod.conf.js</span></span><br><span class="line">plugins: [</span><br><span class="line">plugins: [</span><br><span class="line">  <span class="comment">// 用DllReferencePlugin将刚才生成的map文件引入</span></span><br><span class="line">  <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">    manifest: <span class="built_in">require</span>(<span class="string">'../src/dll/ui-manifest.json'</span>)</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">    manifest: <span class="built_in">require</span>(<span class="string">'../src/dll/vue-manifest.json'</span>)</span><br><span class="line">  &#125;),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><blockquote><p>平行处理压缩混淆</p></blockquote><ul><li><code>UglifyJsPlugin</code><ul><li><code>parallel: true</code>: 平行线程处理</li><li><code>cache: true</code>: 利用缓存</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.dev.conf.js</span></span><br><span class="line">plugins: [</span><br><span class="line">  <span class="keyword">new</span> UglifyJsPlugin(&#123;</span><br><span class="line">    parallel: <span class="literal">true</span>,</span><br><span class="line">    cache: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure><blockquote><p>平行处理文件loaders处理</p></blockquote><ul><li><code>HappyPack</code><ul><li><code>HappyPack.ThreadPool</code>: 共享文件loaders处理线程池</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.base.conf.js</span></span><br><span class="line"><span class="keyword">const</span> HappyPack = <span class="built_in">require</span>(<span class="string">'happypack'</span>)</span><br><span class="line"><span class="keyword">const</span> vueLoaderConfig = <span class="built_in">require</span>(<span class="string">'./vue-loader.conf'</span>)</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">      <span class="comment">// id与plugins中HappyPack实例中的id相对应, </span></span><br><span class="line">      <span class="comment">// 将options传给plugins中的happyPack实例即可, 不用在此引入</span></span><br><span class="line">      loader: <span class="string">'happypack/loader?id=vue'</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;,</span><br><span class="line">plugins: [</span><br><span class="line">  <span class="keyword">new</span> HappyPack(&#123;</span><br><span class="line">    id: <span class="string">'vue'</span>,</span><br><span class="line">    loaders: [&#123;</span><br><span class="line">      loader: <span class="string">'vue-loader'</span>,</span><br><span class="line">      option: <span class="built_in">require</span>(<span class="string">'./vue-loader.conf'</span>)</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure><blockquote><p>babel-loader</p></blockquote><ul><li><code>options.cacheDirecotry</code>: 开启缓存</li><li><code>include</code> &amp; <code>exclude</code>: 尽可能规定使用babel范围</li></ul><blockquote><p>其他因素</p></blockquote><ul><li>减少<code>resolve</code></li><li>上线去除<code>sourcemap</code></li><li><code>cache-loader</code>: 将所有loader结果缓存</li><li>升级<code>node</code>与<code>webpack</code></li></ul><h2 id="长缓存优化"><a href="#长缓存优化" class="headerlink" title="长缓存优化"></a>长缓存优化</h2><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>当版本更新时, 使用户的浏览器只下载更新过的模块, 其他模块由于hash值的不变不用用户再次下载</p><h3 id="方法-2"><a href="#方法-2" class="headerlink" title="方法"></a>方法</h3><ul><li>提取<code>vender</code></li><li><code>hash</code> -&gt; <code>chunkHash</code></li><li>提取 <code>webpack runtime 与 manifest</code> </li><li>使用 <code>NamedChunksPlugin</code>: 使Chunk的<code>id</code>以<code>name</code>命名, 不再分配打包顺序数字</li><li>使用 <code>NamedModule是Plugin</code>: 使Module的<code>id</code>以<code>相对路径</code>命名, 不再分配打包顺序数字</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">'./src/foo'</span>,</span><br><span class="line">    vendor: [<span class="string">'react'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    <span class="comment">// 以[chunkhash]代替[hash]</span></span><br><span class="line">    filename: <span class="string">'[name].[chunkhash].js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.NamedChunksPlugin(),</span><br><span class="line">    <span class="keyword">new</span> webpack.NamedModulesPlugin(),</span><br><span class="line">    <span class="comment">// 提取公用代码, 此例中为react库的代码</span></span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      name: <span class="string">'vendor'</span>,</span><br><span class="line">      minChunks: <span class="literal">Infinity</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">// 提取manifest与runtime</span></span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      name: <span class="string">'manifest'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="webpack多页面应用"><a href="#webpack多页面应用" class="headerlink" title="webpack多页面应用"></a>webpack多页面应用</h2><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul><li>多入口 entry</li><li>多页面 html</li><li>每个页面不同的 chunk (js, css)</li><li>每个页面需要不同的webpack参数</li></ul><h3 id="多配置"><a href="#多配置" class="headerlink" title="多配置"></a>多配置</h3><blockquote><p>方法:</p></blockquote><ul><li><code>parallel-webpack</code>: 并行处理没有关联的多份配置(比如同时打包10个页面)</li></ul><blockquote><p>优点:</p></blockquote><ul><li>可以使用<code>parallel-webpack</code>来提高打包速度</li><li>配置更加独立, 灵活</li></ul><blockquote><p>缺点:</p></blockquote><ul><li>不能多页面之间共享代码, 不能使用长缓存, 用户加载效率低</li></ul><blockquote><p>配置:</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多页面多配置的parallel-webpack并行打包多页面的优化</span></span><br><span class="line"><span class="comment">// npm install parallel-webpack --save-dev</span></span><br><span class="line"><span class="comment">// node_modules/parallel-webpack/bin/run.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> baseConfig = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    react: [<span class="string">'react'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'js/[name].[chunkhash].js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: ExtractTextWebpack.extract(&#123;</span><br><span class="line">          fallback: <span class="string">'style-loader'</span>,</span><br><span class="line">          use: <span class="string">'css-loader'</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> ExtractTextWebpack(&#123;</span><br><span class="line">      filename: <span class="string">'css/[name].[hash].css'</span></span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> CleanWebpack(path.resolve(__dirname, <span class="string">'dist'</span>)),</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      name: <span class="string">'react'</span>,</span><br><span class="line">      minChunks: <span class="literal">Infinity</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 每个页面的配置生成函数</span></span><br><span class="line"><span class="keyword">const</span> generatePage = <span class="function"><span class="keyword">function</span> (<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">                                 title = <span class="string">''</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 entry = <span class="string">''</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 template = <span class="string">'./src/index.html'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 name = <span class="string">''</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 chunks = []</span></span></span><br><span class="line"><span class="function"><span class="params">                               &#125; = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    entry,</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">        chunks,</span><br><span class="line">        template,</span><br><span class="line">        filename: name + <span class="string">'.html'</span></span><br><span class="line">      &#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成每个页面的配置数组</span></span><br><span class="line"><span class="keyword">const</span> pages = [</span><br><span class="line">  generatePage(&#123;</span><br><span class="line">    title: <span class="string">'page A'</span>,</span><br><span class="line">    entry: &#123;</span><br><span class="line">      a: <span class="string">'./src/pages/a'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    name: <span class="string">'a'</span>,</span><br><span class="line">    chunks: [<span class="string">'react'</span>, <span class="string">'a'</span>]</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  generatePage(&#123;</span><br><span class="line">    title: <span class="string">'page B'</span>,</span><br><span class="line">    entry: &#123;</span><br><span class="line">      b: <span class="string">'./src/pages/b'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    name: <span class="string">'b'</span>,</span><br><span class="line">    chunks: [<span class="string">'react'</span>, <span class="string">'b'</span>]</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  generatePage(&#123;</span><br><span class="line">    title: <span class="string">'page C'</span>,</span><br><span class="line">    entry: &#123;</span><br><span class="line">      c: <span class="string">'./src/pages/c'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    name: <span class="string">'c'</span>,</span><br><span class="line">    chunks: [<span class="string">'react'</span>, <span class="string">'c'</span>]</span><br><span class="line">  &#125;)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块返回一个配置数组, 每一项都是每个页面的单独配置和baseConfig的一个合并</span></span><br><span class="line"><span class="built_in">module</span>.exports = pages.map(<span class="function"><span class="params">page</span> =&gt;</span> merge(baseConfig, page))</span><br></pre></td></tr></table></figure><h3 id="单配置-共享配置"><a href="#单配置-共享配置" class="headerlink" title="单配置(共享配置)"></a>单配置(共享配置)</h3><blockquote><p>优点:</p></blockquote><ul><li>可以共享各个 <code>entry</code> 之间的公用代码</li></ul><blockquote><p>缺点: </p></blockquote><ul><li>打包速度比较慢</li><li>输出的内容比较复杂</li></ul><blockquote><p>配置: </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> baseConfig = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    react: [<span class="string">'react'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'js/[name].[chunkhash].js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: ExtractTextWebpack.extract(&#123;</span><br><span class="line">          fallback: <span class="string">'style-loader'</span>,</span><br><span class="line">          use: <span class="string">'css-loader'</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> ExtractTextWebpack(&#123;</span><br><span class="line">      filename: <span class="string">'css/[name].[hash].css'</span></span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> CleanWebpack(path.resolve(__dirname, <span class="string">'dist'</span>)),</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      name: <span class="string">'react'</span>,</span><br><span class="line">      minChunks: <span class="literal">Infinity</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> generatePage = <span class="function"><span class="keyword">function</span> (<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">                                 title = <span class="string">''</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 entry = <span class="string">''</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 template = <span class="string">'./src/index.html'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 name = <span class="string">''</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 chunks = []</span></span></span><br><span class="line"><span class="function"><span class="params">                               &#125; = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    entry,</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">        chunks,</span><br><span class="line">        template,</span><br><span class="line">        title,</span><br><span class="line">        filename: name + <span class="string">'.html'</span></span><br><span class="line">      &#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pages = [</span><br><span class="line">  generatePage(&#123;</span><br><span class="line">    title: <span class="string">'page A'</span>,</span><br><span class="line">    entry: &#123;</span><br><span class="line">      a: <span class="string">'./src/pages/a'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    name: <span class="string">'a'</span>,</span><br><span class="line">    chunks: [<span class="string">'react'</span>, <span class="string">'a'</span>]</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  generatePage(&#123;</span><br><span class="line">    title: <span class="string">'page B'</span>,</span><br><span class="line">    entry: &#123;</span><br><span class="line">      b: <span class="string">'./src/pages/b'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    name: <span class="string">'b'</span>,</span><br><span class="line">    chunks: [<span class="string">'react'</span>, <span class="string">'b'</span>]</span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  generatePage(&#123;</span><br><span class="line">    title: <span class="string">'page C'</span>,</span><br><span class="line">    entry: &#123;</span><br><span class="line">      c: <span class="string">'./src/pages/c'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    name: <span class="string">'c'</span>,</span><br><span class="line">    chunks: [<span class="string">'react'</span>, <span class="string">'c'</span>]</span><br><span class="line">  &#125;)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多页面单配置</span></span><br><span class="line"><span class="built_in">module</span>.exports = merge([baseConfig].concat(pages))</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;上一篇博客总结了&lt;code&gt;webpack&lt;/code&gt;的基本配置, 处理js, css, 代码分割, 懒加载, tree-shaking等方法, 这篇博客继续总结资源处理, 第三方js库处理, html相关, devServer相关等知识.&lt;/p&gt;
&lt;h2 id=&quot;图片处
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>正反馈系列: Webpack (一)</title>
    <link href="http://yoursite.com/2018/03/07/webpack01/"/>
    <id>http://yoursite.com/2018/03/07/webpack01/</id>
    <published>2018-03-07T14:14:28.000Z</published>
    <updated>2018-03-20T08:59:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>看了Webpack官方文档, 力求有些产出, 此篇文章将学习所得知识总结记录, 力求得到学习的正反馈</p><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="全局npm安装路径"><a href="#全局npm安装路径" class="headerlink" title="全局npm安装路径"></a>全局npm安装路径</h3><p><code>/usr/local/lib/node_modules</code></p><h3 id="nvm管理的Node中npm安装路径"><a href="#nvm管理的Node中npm安装路径" class="headerlink" title="nvm管理的Node中npm安装路径"></a>nvm管理的Node中npm安装路径</h3><p><code>/Users/choteewang/.nvm/versions/node/@Node使用版本号(v8.9.4)/lib/node_modules</code></p><h3 id="UMD-规范"><a href="#UMD-规范" class="headerlink" title="UMD 规范"></a>UMD 规范</h3><p>UMD规范: 先检查模块是否是AMD(requireJS), 再检查是否是commonJS(node), 若都不是, 输出一个全局变量</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">root, factory</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd) &#123;</span><br><span class="line">    define([], factory);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> exports === <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="built_in">module</span>.exports = factory();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Browswer globals (root is window)</span></span><br><span class="line">    root .returnExports = factory();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Just return a value to define the module export.</span></span><br><span class="line">  <span class="comment">// This example returns an object, but the module </span></span><br><span class="line">  <span class="comment">// can return a function as the exported value.</span></span><br><span class="line">  <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="webpack-cli-命令"><a href="#webpack-cli-命令" class="headerlink" title="webpack cli 命令"></a>webpack cli 命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 显示进度, 带颜色, 显示详细信息</span><br><span class="line">webpack --progress --color --display-reasons</span><br></pre></td></tr></table></figure><h3 id="package-json中的browserslist字段"><a href="#package-json中的browserslist字段" class="headerlink" title="package.json中的browserslist字段"></a>package.json中的browserslist字段</h3><p>在package.json中定义的brwoserslist后, 所有webpack配置中需要兼容浏览器的polyfill规则都会以此字段为标准进行垫片</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// package.json</span><br><span class="line">"browserslist": [</span><br><span class="line">  "&gt;= 1%",</span><br><span class="line">  <span class="string">"last 2 versions"</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="chunk-Bundle-Module-分别是什么"><a href="#chunk-Bundle-Module-分别是什么" class="headerlink" title="chunk, Bundle, Module 分别是什么?"></a>chunk, Bundle, Module 分别是什么?</h3><ul><li><code>Chunk</code> 是指webpack由代码分割出来的代码块, 出现在webpack打包的过程中, 最终被打进bundle里</li><li><code>bundle</code> 是webpack打包出的文件</li><li><code>module</code> 是开发中的单个模块, import和require进来的模块</li></ul><h2 id="编译ES6"><a href="#编译ES6" class="headerlink" title="编译ES6"></a>编译ES6</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install babel-loader babel-core babel-preset-env --save-dev</span><br></pre></td></tr></table></figure><h3 id="webpack-config-js"><a href="#webpack-config-js" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: <span class="string">'./app.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">'[name].[hash:8].js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        exclude: <span class="string">'/node_modules/'</span>,</span><br><span class="line">        use: <span class="string">'babel-loader'</span></span><br><span class="line">        <span class="comment">// 若在.babelrc中已经配置了, 下面内容不用配置i</span></span><br><span class="line">        options: &#123;</span><br><span class="line">          preset: [<span class="string">'env'</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="安装Babel-loader"><a href="#安装Babel-loader" class="headerlink" title="安装Babel-loader"></a>安装Babel-loader</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 最新webpack</span><br><span class="line">npm install @babel/preset-env --save-dev</span><br><span class="line">// 普通webpack</span><br><span class="line">npm install babel-preset-env --save-dev</span><br><span class="line">// 使用见下面.babelrc节</span><br></pre></td></tr></table></figure><h3 id="Babel-Polyfill-与-Babel-Runtime-Transform-区别"><a href="#Babel-Polyfill-与-Babel-Runtime-Transform-区别" class="headerlink" title="Babel Polyfill 与 Babel Runtime Transform 区别"></a>Babel Polyfill 与 Babel Runtime Transform 区别</h3><p><code>Babel Polyfill</code>是全局垫片, 会引入全局污染, 为开发应用(比如开发一个网站)准备</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install babel-polyfill --save</span><br><span class="line">// 在整个应用入口处</span><br><span class="line">import <span class="string">'babel-polyfill'</span></span><br></pre></td></tr></table></figure><p>相对的, <code>Babel-Runtime Transform</code>是局部垫片, 为开发框架(比如开发一个组件库等需要别人引用的代码)准备, 不会引入全局污染</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 对应上面babelloader的安装版本, 安装命令略有不同</span><br><span class="line">npm install @babel/runtime --save</span><br><span class="line">npm install @babel/plugin-transform-runtime --save-dev</span><br><span class="line"></span><br><span class="line">npm install babel-plugin-transform-runtime --save-dev</span><br><span class="line">npm install babel-runtime --save</span><br><span class="line">// 配置需在.babelrc中配置</span><br></pre></td></tr></table></figure><h3 id="babelrc"><a href="#babelrc" class="headerlink" title=".babelrc"></a>.babelrc</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">"@babel/preset-env"</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        // targets属性可以指定构建目标是browsers或node之类</span><br><span class="line">        "targets": &#123;</span><br><span class="line">          "browsers": [</span><br><span class="line">            <span class="string">"last 2 versions"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ],</span><br><span class="line">  "plugins": ["@babel/transform-runtime"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="提取公共代码-CommonsChunkPlugin"><a href="#提取公共代码-CommonsChunkPlugin" class="headerlink" title="提取公共代码 CommonsChunkPlugin"></a>提取公共代码 CommonsChunkPlugin</h2><h3 id="目的和方法"><a href="#目的和方法" class="headerlink" title="目的和方法"></a>目的和方法</h3><p>减少代码冗余, 提高加载速度, 减少重复代码的下载, 增高代码复用率</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(options)</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    <span class="string">'pageA'</span>: <span class="string">'./src/pageA'</span>,</span><br><span class="line">    <span class="string">'pageB'</span>: <span class="string">'./src/pageB'</span>,</span><br><span class="line">    <span class="string">'vendor'</span>: [<span class="string">'lodash'</span>, <span class="string">'jquery'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'./dist'</span>),</span><br><span class="line">    filename: <span class="string">'[name].bundle.js'</span>,</span><br><span class="line">    chunkFilename: <span class="string">'[name].chunk.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 提取公共代码</span></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// 通过指定 entry 配置中未用到的名称'manifest',将 webpack 样板(boilerplate)和 manifest 提取出来</span></span><br><span class="line">    <span class="comment">// 提取公共代码只有在多entry时才有效</span></span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      names: [<span class="string">'vendor'</span>, <span class="string">'manifest'</span>],</span><br><span class="line">      <span class="comment">// 在传入  公共chunk(commons chunk) 之前所需要包含的最少数量的 chunks 。</span></span><br><span class="line">      <span class="comment">// 数量必须大于等于2，或者少于等于 chunks的数量</span></span><br><span class="line">      <span class="comment">// 传入 `Infinity` 会马上生成 公共chunk，但里面没有模块。</span></span><br><span class="line">      <span class="comment">// (随着 entry chunk 越来越多，</span></span><br><span class="line">      <span class="comment">// 这个配置保证没其它的模块会打包进 vendor chunk)</span></span><br><span class="line">      <span class="comment">// 你可以传入一个 `function` ，以添加定制的逻辑（默认是 chunk 的数量）</span></span><br><span class="line">      minChunks: <span class="literal">Infinity</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="代码分割-和-懒加载"><a href="#代码分割-和-懒加载" class="headerlink" title="代码分割 和 懒加载"></a>代码分割 和 懒加载</h2><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>分离业务代码和第三方依赖, 分离业务代码和业务公共代码和第三方依赖, 分离首次加载和访问后加载的代码</p><h3 id="webpack-config-js-1"><a href="#webpack-config-js-1" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    <span class="string">'pageA'</span>: <span class="string">'./src/pageA'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'./dist'</span>),</span><br><span class="line">    publicPath: <span class="string">'./dist/'</span>,</span><br><span class="line">    filename: <span class="string">'[name].bundle.js'</span>,</span><br><span class="line">    chunkFilename: <span class="string">'[name].chunk.js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="方法1-Dynamic-Import-Magic-Comment"><a href="#方法1-Dynamic-Import-Magic-Comment" class="headerlink" title="方法1: Dynamic Import, Magic Comment"></a>方法1: Dynamic Import, Magic Comment</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> page = <span class="string">'subpageA'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (page === <span class="string">'subpageA'</span>) &#123;</span><br><span class="line">  <span class="comment">// magicComment的值决定了打包出的bundle的name</span></span><br><span class="line">  <span class="keyword">import</span>(<span class="comment">/* webpackChunkName:'subpageA' */</span><span class="string">'./subPageA'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">subPageA</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(subPageA)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (page === <span class="string">'subPageB'</span>) &#123;</span><br><span class="line">  <span class="keyword">import</span>(<span class="comment">/* webpackChunkName:'subpageB' */</span><span class="string">'./subPageB'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">subPageB</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(subPageB)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="string">'pageA'</span></span><br></pre></td></tr></table></figure><h3 id="方法2-require-ensure-require-include"><a href="#方法2-require-ensure-require-include" class="headerlink" title="方法2: require.ensure(), require.include()"></a>方法2: require.ensure(), require.include()</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pageA.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用 require.include 将 subPageA 与 subPageB 都依赖的moduleA引入</span></span><br><span class="line"><span class="comment">// moduleA的代码不会再在subPageA与subPageB中各打包一份,而会打包在pageA的代码中</span></span><br><span class="line"><span class="comment">// 这里不用commonChunkPlugin的原因是webpack配置为单entry,其不起作用</span></span><br><span class="line"><span class="built_in">require</span>.include(<span class="string">'./moduleA'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> page = <span class="string">'subPageA'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (page === <span class="string">'subPageA'</span>) &#123;</span><br><span class="line">  <span class="comment">// 实现懒加载的require.ensure方法</span></span><br><span class="line">  <span class="built_in">require</span>.ensure([<span class="comment">/* 这里是依赖项数组, 本来可以写'./moduleA' */</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> subPageA = <span class="built_in">require</span>(<span class="string">'./subPageA'</span>)</span><br><span class="line">  &#125;, <span class="string">'subPageA'</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (page === <span class="string">'subPageB'</span>) &#123;</span><br><span class="line">  <span class="built_in">require</span>.ensure([<span class="comment">/* 这里是依赖项数组, 本来可以写'./moduleA' */</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> subPageB = <span class="built_in">require</span>(<span class="string">'./subPageB'</span>)</span><br><span class="line">  &#125;, <span class="string">'subPageB'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>.ensure([], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line">  _.join([<span class="string">'1'</span>, <span class="string">'2'</span>], <span class="string">'3'</span>)</span><br><span class="line">&#125;, <span class="string">'vendor'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="string">'pageA'</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2018/03/07/5a9ff39de8c6b.jpg" alt=""></p><h3 id="提取多entry中的共同异步模块"><a href="#提取多entry中的共同异步模块" class="headerlink" title="提取多entry中的共同异步模块"></a>提取多entry中的共同异步模块</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    <span class="string">'pageA'</span>: <span class="string">'./src/pageA'</span>,</span><br><span class="line">    <span class="string">'pageB'</span>: <span class="string">'./src/pageB'</span>,</span><br><span class="line">    <span class="string">'vendor'</span>: [<span class="string">'lodash'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'./dist'</span>),</span><br><span class="line">    publicPath: <span class="string">'./dist/'</span>,</span><br><span class="line">    filename: <span class="string">'[name].bundle.js'</span>,</span><br><span class="line">    chunkFilename: <span class="string">'[name].chunk.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// 提取异步模块，如果好几个模块是异步加载的</span></span><br><span class="line">    <span class="comment">// 就提取这些异步加载的模块之间的公共代码</span></span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      <span class="comment">// 异步模块名称</span></span><br><span class="line">      <span class="keyword">async</span>: <span class="string">'async-common'</span>,</span><br><span class="line">      <span class="comment">// 在子代subPageA与subPageB中找</span></span><br><span class="line">      children: <span class="literal">true</span>,</span><br><span class="line">      minChunks: <span class="number">2</span></span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单独打包 vendor 和 webpack runtime(manifest)</span></span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      names: [<span class="string">'vendor'</span>, <span class="string">'manifest'</span>],</span><br><span class="line">      minChunks: <span class="literal">Infinity</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pageA.js/pageB.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步模块subPageA与subPageB都依赖于./moduleA, moduleA会被打入async-common中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> page = <span class="string">'subpageA/B'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (page === <span class="string">'subpageA'</span>) &#123;</span><br><span class="line">  <span class="keyword">import</span>(<span class="comment">/* webpackChunkName:'subpageA' */</span><span class="string">'./subPageA'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">subPageA</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(subPageA)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (page === <span class="string">'subPageB'</span>) &#123;</span><br><span class="line">  <span class="keyword">import</span>(<span class="comment">/* webpackChunkName:'subpageB' */</span><span class="string">'./subPageB'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">subPageB</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(subPageB)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="string">'pageA/B'</span></span><br></pre></td></tr></table></figure><h2 id="处理-CSS"><a href="#处理-CSS" class="headerlink" title="处理 CSS"></a>处理 CSS</h2><h3 id="行为"><a href="#行为" class="headerlink" title="行为"></a>行为</h3><ul><li><code>style-loader</code> 在html中创建style标签</li><li><code>css-loader</code> 使js中可以import css, 压缩css</li><li><code>css-loader/url</code> 用file-loader替换掉css-loader, 可以创建link标签引入一个构建的css文件, 由于会生成多个link标签引起多次http请求, 不推荐</li><li><code>css-loader/useable</code> 可以将import出的css赋值给一个变量, 这个变量有<code>use</code>与<code>unuse</code>方法, 控制css的插入与不插入</li></ul><h3 id="配置Sass-less-CSS-Modules"><a href="#配置Sass-less-CSS-Modules" class="headerlink" title="配置Sass, less, CSS-Modules"></a>配置Sass, less, CSS-Modules</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install less-loader less --save-dev</span><br><span class="line">npm install sass-loader node-sass --save-dev</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: <span class="string">'./src/app.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    publicPath: <span class="string">'./dist/'</span>,</span><br><span class="line">    filename: <span class="string">'[name].bundle.js'</span>,</span><br><span class="line">    <span class="comment">// 动态打包文件名输出规则</span></span><br><span class="line">    chunkFilename: <span class="string">'[name].bundle.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'style-loader'</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="comment">// 后面的loader先use</span></span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'css-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              <span class="comment">// 开启css压缩</span></span><br><span class="line">              minimize: <span class="literal">true</span>,</span><br><span class="line">              <span class="comment">// CSS Module</span></span><br><span class="line">              modules: <span class="literal">true</span>,</span><br><span class="line">              <span class="comment">// CSS module 打包出来的class名规则</span></span><br><span class="line">              <span class="comment">// local代表类名</span></span><br><span class="line">              localIdentName: <span class="string">'[path][name]_[local]_[hash:base64:5]'</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'less-loader'</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="提取样式文件-ExtractTextWebpackPlugin"><a href="#提取样式文件-ExtractTextWebpackPlugin" class="headerlink" title="提取样式文件, ExtractTextWebpackPlugin"></a>提取样式文件, ExtractTextWebpackPlugin</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: <span class="string">'./src/app.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    publicPath: <span class="string">'./dist/'</span>,</span><br><span class="line">    filename: <span class="string">'[name].bundle.js'</span>,</span><br><span class="line">    <span class="comment">// 动态打包文件名输出规则</span></span><br><span class="line">    chunkFilename: <span class="string">'[name].bundle.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">        use: ExtractTextWebpackPlugin.extract(&#123;</span><br><span class="line">          <span class="comment">// fallback定义没有被提取的css要如何处理</span></span><br><span class="line">          fallback: &#123;</span><br><span class="line">            loader: <span class="string">'style-loader'</span></span><br><span class="line">          &#125;,</span><br><span class="line">          use: [</span><br><span class="line">            &#123;</span><br><span class="line">              loader: <span class="string">'css-loader'</span>,</span><br><span class="line">              options: &#123;</span><br><span class="line">                <span class="comment">// CSS Module</span></span><br><span class="line">                modules: <span class="literal">true</span>,</span><br><span class="line">                <span class="comment">// CSS module 打包出来的class名规则</span></span><br><span class="line">                <span class="comment">// local代表类名</span></span><br><span class="line">                localIdentName: <span class="string">'[path][name]_[local]_[hash:base64:5]'</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              loader: <span class="string">'less-loader'</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// 提取 css 到指定的文件</span></span><br><span class="line">    <span class="keyword">new</span> ExtractTextWebpackPlugin(&#123;</span><br><span class="line">      <span class="comment">// 指定文件名</span></span><br><span class="line">      filename: <span class="string">'[name].min.css'</span>,</span><br><span class="line">      <span class="comment">// 动态加载的样式不放在提取出的文件中(放在js模块代码中,按照上面的fallback属性在style标签中输出)</span></span><br><span class="line">      allChunks: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PostCss"><a href="#PostCss" class="headerlink" title="PostCss"></a>PostCss</h3><p><strong>A tool for transforming CSS with JavaScript</strong></p><ul><li><code>autoprefixer</code> 加前缀</li><li><code>CSS-nano</code> css压缩</li><li><code>CSS-next</code> 使用未来的css语法, CSS变量, 自定义选择器, 动态计算</li><li><code>postcss-import</code></li><li><code>postcss-url</code></li><li><code>postcss-assets</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install postcss postcss-loader autofrefixer cssnano postcss-cssnext --save-dev</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// postcss-loader插入位置在less-loader与css-loader之间</span></span><br><span class="line">  loader: <span class="string">'postcss-loader'</span>,</span><br><span class="line">  options: &#123;</span><br><span class="line">    <span class="comment">// 表明下面plugins属性引入的插件是给postcss使用的</span></span><br><span class="line">    ident: <span class="string">'postcss'</span>,</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="comment">// 自动加浏览器前缀</span></span><br><span class="line">      <span class="built_in">require</span>(<span class="string">'autoprefixer'</span>)(),</span><br><span class="line">      <span class="comment">// 使用未来的css</span></span><br><span class="line">      <span class="comment">// require('postcss-cssnext')()</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h2 id="Tree-Shaking-去除冗余代码"><a href="#Tree-Shaking-去除冗余代码" class="headerlink" title="Tree Shaking (去除冗余代码)"></a>Tree Shaking (去除冗余代码)</h2><h3 id="场景-1"><a href="#场景-1" class="headerlink" title="场景"></a>场景</h3><ul><li>常规优化</li><li>引入第三方库的某一个功能, 只用这一个功能, 其他代码都是冗余的</li></ul><h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><ul><li><code>js-tree-shaking</code> webpack.optimize.uglifyJS</li><li><code>css-tree-shaking</code> Purifycss-webpack</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// glob-all 加载多路径工具</span><br><span class="line">npm install purifycss-webpack glob-all --save-dev</span><br></pre></td></tr></table></figure><h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">var</span> Webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">var</span> PurifyCSS = <span class="built_in">require</span>(<span class="string">'purifycss-webpack'</span>)</span><br><span class="line"><span class="comment">// glob-all 加载多路径工具</span></span><br><span class="line"><span class="keyword">var</span> glob = <span class="built_in">require</span>(<span class="string">'glob-all'</span>)</span><br><span class="line"><span class="keyword">var</span> ExtractTextWebpackPlugin = <span class="built_in">require</span>(<span class="string">'extract-text-webpack-plugin'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: <span class="string">'./src/app.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    publicPath: <span class="string">'./dist/'</span>,</span><br><span class="line">    filename: <span class="string">'[name].bundle.js'</span>,</span><br><span class="line">    chunkFilename: <span class="string">'[name].bundle.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">        use: ExtractTextWebpackPlugin.extract(&#123;</span><br><span class="line">          fallback: &#123;</span><br><span class="line">            loader: <span class="string">'style-loader'</span>,</span><br><span class="line">            options: &#123;<span class="attr">singleton</span>: <span class="literal">true</span>&#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          use: [</span><br><span class="line">            &#123;</span><br><span class="line">              loader: <span class="string">'css-loader'</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              loader: <span class="string">'less-loader'</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> ExtractTextWebpackPlugin(&#123;</span><br><span class="line">      filename: <span class="string">'[name].min.css'</span>,</span><br><span class="line">      allChunks: <span class="literal">false</span></span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CSS Tree shaking</span></span><br><span class="line">    <span class="comment">// 必须在ExtractTextWebpackPlugin的后面</span></span><br><span class="line">    <span class="comment">// 无法与CSS-Modules一起使用</span></span><br><span class="line">    <span class="keyword">new</span> PurifyCSS(&#123;</span><br><span class="line">      <span class="comment">// glob-all 加载多路径工具</span></span><br><span class="line">      paths: glob.sync([</span><br><span class="line">        path.join(__dirname, <span class="string">'./*.html'</span>),</span><br><span class="line">        path.join(__dirname, <span class="string">'./src/*.js'</span>)</span><br><span class="line">      ])</span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JS Tree shaking</span></span><br><span class="line">    <span class="keyword">new</span> Webpack.optimize.UglifyJsPlugin()</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;看了Webpack官方文档, 力求有些产出, 此篇文章将学习所得知识总结记录, 力求得到学习的正反馈&lt;/p&gt;
&lt;h2 id=&quot;前置知识&quot;&gt;&lt;a href=&quot;#前置知识&quot; class=&quot;headerlink&quot; title=&quot;前置知识&quot;&gt;&lt;/a&gt;前置知识&lt;/h2&gt;&lt;h3 id=
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>vue 2.5+ 外卖 webapp</title>
    <link href="http://yoursite.com/2018/01/27/vue2-5-%E5%A4%96%E5%8D%96app/"/>
    <id>http://yoursite.com/2018/01/27/vue2-5-外卖app/</id>
    <published>2018-01-27T09:16:18.000Z</published>
    <updated>2018-01-31T09:53:14.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="vue-2-5-外卖-webapp"><a href="#vue-2-5-外卖-webapp" class="headerlink" title="vue 2.5+ 外卖 webapp"></a>vue 2.5+ 外卖 webapp</h1><h3 id="presentation"><a href="#presentation" class="headerlink" title="presentation"></a>presentation</h3><p><img src="https://i.loli.net/2018/01/27/5a6c4030d5043.gif" alt="pre1"><br><img src="https://i.loli.net/2018/01/27/5a6c42ac6c4bb.gif" alt="pre2"><br><img src="https://i.loli.net/2018/01/27/5a6c42a8e08a0.gif" alt="3"><br><img src="https://i.loli.net/2018/01/27/5a6c42a88b9af.gif" alt="4"><br><img src="https://i.loli.net/2018/01/27/5a6c42a864868.gif" alt="5"></p><h3 id="tech"><a href="#tech" class="headerlink" title="tech"></a>tech</h3><ul><li>Vue 2.5+</li><li>Vue-router 3.0+</li><li>Full-ES6-Syntax-Cover</li><li>stylus css预处理器</li><li>axios</li><li>better-scroll</li><li>eslint</li><li>移动端flex布局, inline-block布局, css-sticky-footer</li><li>media query 实现移动端1px边框和背景图片切换</li></ul><h2 id="High-Light"><a href="#High-Light" class="headerlink" title="High Light"></a>High Light</h2><h3 id="两侧同步滚动-算法实现"><a href="#两侧同步滚动-算法实现" class="headerlink" title="两侧同步滚动,算法实现"></a>两侧同步滚动,算法实现</h3><h4 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h4><p><img src="https://i.loli.net/2018/01/27/5a6c42ac6c4bb.gif" alt="pre2"></p><h4 id="goods-vue中的code"><a href="#goods-vue中的code" class="headerlink" title="goods.vue中的code"></a>goods.vue中的code</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"menu-wrapper"</span> <span class="attr">ref</span>=<span class="string">"menuWrapper"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(item,index) in goods"</span> <span class="attr">:key</span>=<span class="string">"index"</span> <span class="attr">class</span>=<span class="string">"menu-item"</span> <span class="attr">:class</span>=<span class="string">"&#123; current : currentIndex === index &#125;"</span> @<span class="attr">click</span>=<span class="string">"selectMenu(index,$event)"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"foods-wrapper"</span> <span class="attr">ref</span>=<span class="string">"foodsWrapper"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(item,index) in goods"</span> <span class="attr">:key</span>=<span class="string">"index"</span> <span class="attr">class</span>=<span class="string">"food-list"</span> <span class="attr">ref</span>=<span class="string">"foodList"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">data() &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// 存放所有dom高度的数组</span></span><br><span class="line">    listHeight: [],</span><br><span class="line">    <span class="comment">// 存放</span></span><br><span class="line">    scrollY: <span class="number">0</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;,</span><br><span class="line">created() &#123;</span><br><span class="line">  axios.get(<span class="string">'/api/goods'</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (res.data.errno === ERR_OK) &#123;</span><br><span class="line">      <span class="keyword">this</span>.goods = res.data.data;</span><br><span class="line">      <span class="comment">// 先让this.goods更新template中的dom后,iscroll才能准确计算出dom高度,dom的更新在vue中是异步的,所以在nextTick异步更新后再用iScroll算高度</span></span><br><span class="line">      <span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>._initScroll();</span><br><span class="line">        <span class="keyword">this</span>._calculateHeight();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">  _initScroll() &#123;</span><br><span class="line">    <span class="comment">// 用BScroll初始化左侧栏</span></span><br><span class="line">    <span class="keyword">this</span>.menuScroll = <span class="keyword">new</span> BScroll(<span class="keyword">this</span>.$refs.menuWrapper, &#123;</span><br><span class="line">      click: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 用BScroll初始化右侧栏</span></span><br><span class="line">    <span class="keyword">this</span>.foodScroll = <span class="keyword">new</span> BScroll(<span class="keyword">this</span>.$refs.foodsWrapper, &#123;</span><br><span class="line">      click: <span class="literal">true</span>,</span><br><span class="line">      probeType: <span class="number">3</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 右侧栏滚动时实时返回y值</span></span><br><span class="line">    <span class="keyword">this</span>.foodScroll.on(<span class="string">'scroll'</span>, pos =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.scrollY = <span class="built_in">Math</span>.abs(<span class="built_in">Math</span>.round(pos.y));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 将 ref为foodList li标签 累加高度 组成数组</span></span><br><span class="line">  _calculateHeight() &#123;</span><br><span class="line">    <span class="keyword">const</span> listHeight = <span class="keyword">this</span>.listHeight;</span><br><span class="line">    <span class="keyword">const</span> foodList = <span class="keyword">this</span>.$refs.foodList;</span><br><span class="line">    <span class="keyword">var</span> height = <span class="number">0</span>;</span><br><span class="line">    listHeight.push(height);</span><br><span class="line">    foodList.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">v</span>) </span>&#123;</span><br><span class="line">      height += v.clientHeight;</span><br><span class="line">      listHeight.push(height);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 左侧li点击时传入index,滚动到index对应的右侧menu</span></span><br><span class="line">  selectMenu(index) &#123;</span><br><span class="line">    <span class="keyword">const</span> el = <span class="keyword">this</span>.$refs.foodList[index];</span><br><span class="line">    <span class="comment">// BScorll库方法Bscroll.ScrollToElement(el,time)</span></span><br><span class="line">    <span class="keyword">this</span>.foodScroll.scrollToElement(el, <span class="number">300</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">computed: &#123;</span><br><span class="line">    <span class="comment">// 根据 外层容器foodsWrapper的scrollTop值 所处于 listHeight数组 的区间,来返回当前左侧栏被选中的index</span></span><br><span class="line">    currentIndex() &#123;</span><br><span class="line">      <span class="keyword">let</span> scrollY = <span class="keyword">this</span>.scrollY;</span><br><span class="line">      <span class="keyword">const</span> listHeight = <span class="keyword">this</span>.listHeight;</span><br><span class="line">      <span class="keyword">const</span> length = listHeight.length;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> top = listHeight[i];</span><br><span class="line">        <span class="keyword">const</span> bottom = listHeight[i + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (!bottom || (scrollY &gt;= top &amp;&amp; scrollY &lt; bottom)) &#123;</span><br><span class="line">          <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure><h3 id="购物车-数据流实现"><a href="#购物车-数据流实现" class="headerlink" title="购物车 - 数据流实现"></a>购物车 - 数据流实现</h3><p><img src="https://i.loli.net/2018/01/27/5a6c34653fb80.png" alt="vue-sell购物车"></p><h3 id="购物小球-数据结构实现"><a href="#购物小球-数据结构实现" class="headerlink" title="购物小球 - 数据结构实现"></a>购物小球 - 数据结构实现</h3><h4 id="效果演示-1"><a href="#效果演示-1" class="headerlink" title="效果演示"></a>效果演示</h4><p><img src="https://i.loli.net/2018/01/27/5a6c4030d5043.gif" alt="pre1"></p><h4 id="事件派发数据流"><a href="#事件派发数据流" class="headerlink" title="事件派发数据流"></a>事件派发数据流</h4><p><img src="https://i.loli.net/2018/01/27/5a6c3467ed132.png" alt="vue-sell小球缓落动画"></p><h4 id="shopcart中的数据结构"><a href="#shopcart中的数据结构" class="headerlink" title="shopcart中的数据结构"></a>shopcart中的数据结构</h4><p>shopcart中采用一个<code>balls</code>数组用来沟通<code>cartcontrol.vue</code>传递的<code>event.target</code>的dom元素与动画小球dom元素的联系</p><p><img src="https://i.loli.net/2018/01/27/5a6c34694efe5.jpg" alt=""></p><h4 id="shopcart-vue中的code"><a href="#shopcart-vue中的code" class="headerlink" title="shopcart.vue中的code"></a>shopcart.vue中的code</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ball-container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">transition</span> <span class="attr">name</span>=<span class="string">"drop"</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">v-for</span>=<span class="string">"(ball,index) in balls"</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">:key</span>=<span class="string">"index"</span> </span></span><br><span class="line"><span class="tag">    @<span class="attr">before-enter</span>=<span class="string">"beforeDrop"</span> </span></span><br><span class="line"><span class="tag">    @<span class="attr">enter</span>=<span class="string">"dropping"</span> </span></span><br><span class="line"><span class="tag">    @<span class="attr">after-enter</span>=<span class="string">"endDropping"</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ball-outer"</span> <span class="attr">v-show</span>=<span class="string">"ball.show"</span> <span class="attr">:num</span>=<span class="string">"ball.num"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ball-inner"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      balls: [</span><br><span class="line">        &#123;</span><br><span class="line">          num: <span class="number">1</span>,</span><br><span class="line">          show: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          num: <span class="number">2</span>,</span><br><span class="line">          show: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          num: <span class="number">3</span>,</span><br><span class="line">          show: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          num: <span class="number">4</span>,</span><br><span class="line">          show: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          num: <span class="number">5</span>,</span><br><span class="line">          show: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    对goods页面调用的$refs.shopcart.drop(el)做反应,开始小球掉落</span></span><br><span class="line"><span class="comment">    找到this.balls中第一个ball.show == false的项</span></span><br><span class="line"><span class="comment">    将此项开始的show置为true,el属性设置为传入的el-dom</span></span><br><span class="line"><span class="comment">    开始掉落此球</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    drop(el) &#123;</span><br><span class="line">      <span class="keyword">let</span> ballSelected = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">const</span> truth = <span class="keyword">this</span>.balls.some(<span class="function"><span class="keyword">function</span>(<span class="params">ball</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ball.show === <span class="literal">false</span>) &#123;</span><br><span class="line">          ballSelected = ball;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (truth) &#123;</span><br><span class="line">        ballSelected.el = el;</span><br><span class="line">        ballSelected.show = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    beforeDrop(el) &#123;</span><br><span class="line">      <span class="comment">// Start通过绑定自定义属性拿到event.target,改进了原版算法</span></span><br><span class="line">      <span class="keyword">const</span> elNum = <span class="built_in">parseInt</span>(el.getAttribute(<span class="string">'num'</span>));</span><br><span class="line">      <span class="keyword">let</span> ballEl = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">this</span>.balls.some(<span class="function"><span class="keyword">function</span>(<span class="params">ball</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ball.num === elNum) &#123;</span><br><span class="line">          ballEl = ball.el;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// End通过绑定自定义属性拿到event.target,改进了原版算法</span></span><br><span class="line">      <span class="keyword">let</span> rect = ballEl.getBoundingClientRect();</span><br><span class="line">      <span class="keyword">let</span> x = rect.left - <span class="number">22</span>;</span><br><span class="line">      <span class="keyword">let</span> y = -(<span class="built_in">window</span>.innerHeight - rect.top - <span class="number">42</span>);</span><br><span class="line">      el.style.display = <span class="string">'block'</span>;</span><br><span class="line">      el.style.webkitTransform = <span class="string">`translate3d(0,<span class="subst">$&#123;y&#125;</span>px,0)`</span>;</span><br><span class="line">      el.style.transform = <span class="string">`translate3d(0,<span class="subst">$&#123;y&#125;</span>px,0)`</span>;</span><br><span class="line">      <span class="keyword">let</span> inner = el.firstElementChild;</span><br><span class="line">      inner.style.webkitTransform = <span class="string">`translate3d(<span class="subst">$&#123;x&#125;</span>px,0,0)`</span>;</span><br><span class="line">      inner.style.transform = <span class="string">`translate3d(<span class="subst">$&#123;x&#125;</span>px,0,0)`</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    dropping(el, done) &#123;</span><br><span class="line">      <span class="comment">// 强制浏览器重绘</span></span><br><span class="line">      <span class="comment">/* eslint-disable no-unused-vars */</span></span><br><span class="line">      <span class="keyword">let</span> rf = el.offsetHeight;</span><br><span class="line">      <span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        el.style.webkitTransform = <span class="string">'translate3d(0,0,0)'</span>;</span><br><span class="line">        el.style.transform = <span class="string">'translate3d(0,0,0)'</span>;</span><br><span class="line">        <span class="keyword">let</span> inner = el.firstElementChild;</span><br><span class="line">        inner.style.webkitTransform = <span class="string">'translate3d(0,0,0)'</span>;</span><br><span class="line">        inner.style.transform = <span class="string">'translate3d(0,0,0)'</span>;</span><br><span class="line">        el.addEventListener(<span class="string">'transitionend'</span>, done);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    endDropping(el) &#123;</span><br><span class="line">      <span class="comment">// Start通过绑定自定义属性拿到el,改进了原版算法</span></span><br><span class="line">      <span class="keyword">const</span> elNum = <span class="built_in">parseInt</span>(el.getAttribute(<span class="string">'num'</span>));</span><br><span class="line">      <span class="keyword">this</span>.balls.some(<span class="function"><span class="keyword">function</span>(<span class="params">ball</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ball.num === elNum) &#123;</span><br><span class="line">          ball.show = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">      el.style.display = <span class="string">'none'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// End通过绑定自定义属性拿到el,改进了原版算法</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 外层负责纵向y轴位移</span></span><br><span class="line">.ball-container</span><br><span class="line">  .ball-outer</span><br><span class="line">    <span class="attribute">position</span> fixed</span><br><span class="line">    <span class="attribute">left</span> <span class="number">32px</span></span><br><span class="line">    <span class="attribute">bottom</span> <span class="number">32px</span></span><br><span class="line">    <span class="attribute">z-index</span> <span class="number">200</span></span><br><span class="line">    <span class="attribute">transition</span> all <span class="number">0.4s</span> cubic-bezier(<span class="number">0.17</span>, -<span class="number">0.34</span>, <span class="number">0.75</span>, <span class="number">0.46</span>)</span><br><span class="line">    <span class="comment">// 内层负责横向x轴位移</span></span><br><span class="line">    .ball-inner</span><br><span class="line">      <span class="attribute">width</span> <span class="number">16px</span></span><br><span class="line">      <span class="attribute">height</span> <span class="number">16px</span></span><br><span class="line">      <span class="attribute">border-radius</span> <span class="number">50%</span></span><br><span class="line">      <span class="attribute">background</span> rgb(<span class="number">0</span>, <span class="number">160</span>, <span class="number">220</span>)</span><br><span class="line">      <span class="attribute">transition</span> all <span class="number">0.4s</span></span><br></pre></td></tr></table></figure><h3 id="根据scroll时动态获取的y轴偏移值设置back按钮的位置和颜色"><a href="#根据scroll时动态获取的y轴偏移值设置back按钮的位置和颜色" class="headerlink" title="根据scroll时动态获取的y轴偏移值设置back按钮的位置和颜色"></a>根据scroll时动态获取的y轴偏移值设置back按钮的位置和颜色</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// food.vue</span></span><br><span class="line">show() &#123;</span><br><span class="line">  <span class="keyword">this</span>.showFlag = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// 每次打开food页面默认显示所有有评论的评价</span></span><br><span class="line">  <span class="keyword">this</span>.selectType = ALL;</span><br><span class="line">  <span class="keyword">this</span>.onlyContent = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// 每次打开food页面初始化betterScroll</span></span><br><span class="line">  <span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.scroll) &#123;</span><br><span class="line">      <span class="keyword">this</span>.scroll = <span class="keyword">new</span> BScroll(<span class="keyword">this</span>.$refs.foodWrapper, &#123;</span><br><span class="line">        click: <span class="literal">true</span>,</span><br><span class="line">        probeType: <span class="number">3</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.scroll.refresh();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 每次进入food页面时,先定义一次back元素位置</span></span><br><span class="line">    <span class="keyword">let</span> transform = <span class="built_in">window</span>.getComputedStyle(</span><br><span class="line">      <span class="keyword">this</span>.$refs.foodWrapper.firstElementChild,</span><br><span class="line">      <span class="literal">null</span></span><br><span class="line">    ).transform;</span><br><span class="line">    <span class="comment">//截取字符串,找到被滚动的.food-content元素的y偏移量</span></span><br><span class="line">    <span class="comment">//这个值相当于translateY的值</span></span><br><span class="line">    <span class="comment">//console.log(transform); // matrix(1, 0, 0, 1, 0, -55.7028)</span></span><br><span class="line">    <span class="keyword">if</span> (transform.indexOf(<span class="string">'-'</span>) === <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.$refs.back.style.transform = <span class="string">`translate3d(0,0,0)`</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      transform = transform.slice(transform.indexOf(<span class="string">'-'</span>) + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">this</span>.$refs.back.style.transform = <span class="string">`translate3d(0,<span class="subst">$&#123;transform&#125;</span>px,0)`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据scroll时动态获取的y轴偏移值设置back按钮的位置和颜色</span></span><br><span class="line">    <span class="keyword">this</span>.scroll.on(<span class="string">'scroll'</span>, pos =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (pos.y &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> transform = <span class="built_in">window</span>.getComputedStyle(</span><br><span class="line">          <span class="keyword">this</span>.$refs.foodWrapper.firstElementChild,</span><br><span class="line">          <span class="literal">null</span></span><br><span class="line">        ).transform;</span><br><span class="line">        <span class="built_in">console</span>.log(transform); <span class="comment">//</span></span><br><span class="line">        <span class="keyword">this</span>.$refs.back.style.transform = <span class="string">`translate3d(0,<span class="subst">$&#123;-pos.y&#125;</span>px,0)`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> style = <span class="keyword">this</span>.$refs.back.firstElementChild.style;</span><br><span class="line">      style.color = pos.y &lt; -<span class="built_in">window</span>.innerWidth + <span class="number">30</span> ? <span class="string">'#000'</span> : <span class="string">'#fff'</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h3 id="seller-vue页面的页面dom初始化"><a href="#seller-vue页面的页面dom初始化" class="headerlink" title="seller.vue页面的页面dom初始化"></a>seller.vue页面的页面dom初始化</h3><p>在<code>seller.vue</code>初始化BScroll中遇到的问题,页面必须拿到<code>seller</code>才能初始化dom</p><p><code>seller</code>是在app.vue中发ajax请求异步得到后通过<code>v-bind</code>传入<code>seller.vue</code>中的</p><p>在刷新页面时要使用<code>watch</code>监视传递的<code>seller</code>异步获取完成</p><p>在切换路由时<code>app.vue</code>不会进行ajax请求,但vue实例的生命周期会重新加载一次, 所以会在<code>created</code>或<code>mounted</code>里再写入初始化<code>BScroll</code>代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// seller.vue</span></span><br><span class="line">props: &#123;</span><br><span class="line">  seller: &#123;</span><br><span class="line">    type: <span class="built_in">Object</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">created() &#123;</span><br><span class="line">  <span class="keyword">this</span>.$nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 若刷新,触发顺序1</span></span><br><span class="line">    <span class="comment">// 在不刷新只切换路由时由于app.vue不再触发ajax请求只触发此步</span></span><br><span class="line">    <span class="comment">// console.log('created initScroll'); </span></span><br><span class="line">    <span class="keyword">this</span>._initScroll();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br><span class="line">watch: &#123;</span><br><span class="line">  seller: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 若刷新,触发顺序2,因为app.vue的ajax是异步请求</span></span><br><span class="line">    <span class="comment">//console.log('watch initScroll'); </span></span><br><span class="line">    <span class="keyword">this</span>._initScroll();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">  _initScroll() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(); <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.scroll) &#123;</span><br><span class="line">      <span class="keyword">this</span>.scroll = <span class="keyword">new</span> BScroll(<span class="keyword">this</span>.$refs.sellerWrapper, &#123;</span><br><span class="line">        click: <span class="literal">true</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.scroll.refresh();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h2 id="Tips-amp-Util"><a href="#Tips-amp-Util" class="headerlink" title="Tips &amp; Util"></a>Tips &amp; Util</h2><h3 id="视网膜屏1px边框实现"><a href="#视网膜屏1px边框实现" class="headerlink" title="视网膜屏1px边框实现"></a>视网膜屏1px边框实现</h3><p>前置知识:<a href="http://www.zhangxinxu.com/wordpress/2012/08/window-devicepixelratio/" target="_blank" rel="noopener">设备像素比devicePixelRatio简单介绍</a></p><p>移动端的1px边框到了视网膜屏因为要乘以像素比,所以实际大小要几倍大于1px(比如iphone6的像素比是2,则2*1px=2px)</p><p>因此, 1px边框可以由<code>after伪类</code>加上,然后用<code>@media</code>根据不同的像素比查询来缩放<code>after伪类</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个mixin加给要添加伪类的父类</span></span><br><span class="line"><span class="function"><span class="title">border-1px</span><span class="params">(<span class="variable">$color</span>)</span></span></span><br><span class="line">   <span class="attribute">position</span>: relative</span><br><span class="line">   &amp;::after</span><br><span class="line">     <span class="attribute">position</span>: absolute</span><br><span class="line">     <span class="attribute">left</span>: <span class="number">0</span></span><br><span class="line">     <span class="attribute">bottom</span>: <span class="number">0</span></span><br><span class="line">     <span class="attribute">width</span>: <span class="number">100%</span></span><br><span class="line">     <span class="attribute">content</span>:<span class="string">''</span></span><br><span class="line">     <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="variable">$color</span></span><br></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@media (min-device-pixel-ratio : <span class="number">1.5</span>),(-webkit-min-device-pixel-ratio : <span class="number">1.5</span>)</span><br><span class="line">  <span class="comment">/* 1.5*7 ~= 1 */</span></span><br><span class="line">  .<span class="attribute">border</span>-<span class="number">1px</span></span><br><span class="line">    &amp;::after</span><br><span class="line">      <span class="attribute">transform</span>: scaleY(<span class="number">0.7</span>)</span><br><span class="line">      -webkit-<span class="attribute">transform</span>: scaleY(<span class="number">0.7</span>)</span><br><span class="line"></span><br><span class="line">@media (min-device-pixel-ratio : <span class="number">2.0</span>),(-webkit-min-device-pixel-ratio : <span class="number">2.0</span>)</span><br><span class="line">  <span class="comment">/* 2.0*5 = 1 */</span></span><br><span class="line">  .<span class="attribute">border</span>-<span class="number">1px</span></span><br><span class="line">    &amp;::after</span><br><span class="line">      <span class="attribute">transform</span>: scaleY(<span class="number">0.5</span>)</span><br><span class="line">      -webkit-<span class="attribute">transform</span>: scaleY(<span class="number">0.5</span>)</span><br></pre></td></tr></table></figure><h3 id="根据不同的设备像素比应用不同图片"><a href="#根据不同的设备像素比应用不同图片" class="headerlink" title="根据不同的设备像素比应用不同图片"></a>根据不同的设备像素比应用不同图片</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">bg-image</span><span class="params">(<span class="variable">$url</span>)</span></span></span><br><span class="line">  <span class="attribute">background-image</span>: url(<span class="variable">$url</span> + <span class="string">'@2x.png'</span>)</span><br><span class="line"></span><br><span class="line">  @media (-webkit-min-device-pixel-ratio: <span class="number">3</span>), (min-device-pixel-ratio: <span class="number">3</span>)</span><br><span class="line">    <span class="attribute">background-image</span>: url(<span class="variable">$url</span> + <span class="string">'@3x.png'</span>)</span><br></pre></td></tr></table></figure><h3 id="多行文本的垂直居中"><a href="#多行文本的垂直居中" class="headerlink" title="多行文本的垂直居中"></a>多行文本的垂直居中</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.menu-wrapper</span><br><span class="line">    <span class="attribute">display</span> table</span><br><span class="line">    .text</span><br><span class="line">    <span class="attribute">display</span> table-cell</span><br><span class="line">    <span class="attribute">vertical-align</span> middle</span><br></pre></td></tr></table></figure><h3 id="背景模糊-iPhone独占"><a href="#背景模糊-iPhone独占" class="headerlink" title="背景模糊(iPhone独占)"></a>背景模糊(iPhone独占)</h3><p><code>backdrop-filter blur(10px)</code></p><h3 id="padding-margin-百分比实现高度自适应"><a href="#padding-margin-百分比实现高度自适应" class="headerlink" title="padding,margin 百分比实现高度自适应"></a>padding,margin 百分比实现高度自适应</h3><p>当margin/padding取形式为百分比的值时，无论是left/right，还是top/bottom，都是以父元素的width为参照物的</p><p>自适应设备宽度的方形图片</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.image-header</span><br><span class="line">  <span class="attribute">position</span> relative</span><br><span class="line">  <span class="attribute">width</span> <span class="number">100%</span></span><br><span class="line">  <span class="attribute">height</span> <span class="number">0</span></span><br><span class="line">  <span class="comment">// padding设置100%时按宽度计算</span></span><br><span class="line">  <span class="attribute">padding-top</span> <span class="number">100%</span></span><br><span class="line">  img</span><br><span class="line">    <span class="comment">// 图像设置position:absolute的原因是父元素height是0</span></span><br><span class="line">    <span class="attribute">position</span> absolute</span><br><span class="line">    <span class="attribute">top</span> <span class="number">0</span></span><br><span class="line">    <span class="attribute">left</span> <span class="number">0</span></span><br><span class="line">    <span class="attribute">width</span> <span class="number">100%</span></span><br><span class="line">    <span class="attribute">height</span> <span class="number">100%</span></span><br></pre></td></tr></table></figure><h3 id="inline-block布局代替float布局"><a href="#inline-block布局代替float布局" class="headerlink" title="inline-block布局代替float布局"></a>inline-block布局代替float布局</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.father</span><br><span class="line">    <span class="comment">// 父元素设置字体为0避免son1与son2的html代码换行造成的空格</span></span><br><span class="line">    <span class="attribute">font-size</span> <span class="number">0</span></span><br><span class="line">    .son1</span><br><span class="line">        <span class="attribute">display</span> inline-block</span><br><span class="line">        <span class="attribute">vertical-align</span> top</span><br><span class="line">        <span class="attribute">margin-right</span> <span class="number">8px</span></span><br><span class="line">    .son2</span><br><span class="line">        <span class="attribute">display</span> inline-block</span><br><span class="line">        <span class="attribute">vertical-align</span> top</span><br></pre></td></tr></table></figure><h3 id="css-sticky-footer"><a href="#css-sticky-footer" class="headerlink" title="css-sticky-footer"></a>css-sticky-footer</h3><p>永远固定在底端的footer,在内容高度不足时依然固定在底端</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"body"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"footer"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.body</span><br><span class="line">    <span class="attribute">display</span> flex</span><br><span class="line">    <span class="attribute">min-height</span> <span class="number">100%</span></span><br><span class="line">    .<span class="attribute">content</span></span><br><span class="line">    <span class="attribute">flex</span> <span class="number">1</span></span><br><span class="line">    .footer</span><br><span class="line">    <span class="attribute">height</span> <span class="number">50px</span></span><br></pre></td></tr></table></figure><h3 id="格式化日期的工具方法"><a href="#格式化日期的工具方法" class="headerlink" title="格式化日期的工具方法"></a>格式化日期的工具方法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">formatDate</span>(<span class="params">timestamp, formatType</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> str = formatType <span class="comment">// YYYY-MM-DD HH:mm</span></span><br><span class="line">  <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>(timestamp)</span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/(Y+)/</span>.test(str)) &#123;</span><br><span class="line">    str = str.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, date.getFullYear().toString().slice(<span class="number">4</span> - <span class="built_in">RegExp</span>.$<span class="number">1.</span>length))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> transObj = &#123;</span><br><span class="line">    <span class="string">'M+'</span>: date.getMonth() + <span class="number">1</span>,</span><br><span class="line">    <span class="string">'D+'</span>: date.getDate(),</span><br><span class="line">    <span class="string">'H+'</span>: date.getHours(),</span><br><span class="line">    <span class="string">'m+'</span>: date.getMinutes()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> transObj) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`(<span class="subst">$&#123;key&#125;</span>)`</span>).test(str)) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = transObj[key].toString()</span><br><span class="line">      str = str.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, padLeftZero(value))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 补0函数,传入12-&gt;12,传入2-&gt;02</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">padLeftZero</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="string">'00'</span>+value).slice(value.length)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> str</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LocalStorage"><a href="#LocalStorage" class="headerlink" title="LocalStorage"></a>LocalStorage</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">saveToLocalStorage</span>(<span class="params">id, key, value</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// __seller__可替换为其他命名空间名</span></span><br><span class="line">  <span class="keyword">let</span> seller = <span class="built_in">JSON</span>.parse(<span class="built_in">window</span>.localStorage.getItem(<span class="string">'__seller__'</span>))</span><br><span class="line">  <span class="keyword">if</span> (!seller) &#123;</span><br><span class="line">    seller = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!seller[id]) &#123;</span><br><span class="line">    seller[id] = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  seller[id][key] = value</span><br><span class="line">  <span class="built_in">window</span>.localStorage.setItem(<span class="string">'__seller__'</span>, <span class="built_in">JSON</span>.stringify(seller))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">readFromLocalStorage</span>(<span class="params">id, key, def</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// __seller__可替换为其他命名空间名</span></span><br><span class="line">  <span class="keyword">const</span> seller = <span class="built_in">JSON</span>.parse(<span class="built_in">window</span>.localStorage.getItem(<span class="string">'__seller__'</span>))</span><br><span class="line">  <span class="keyword">if</span> (!seller) &#123;</span><br><span class="line">    <span class="keyword">return</span> def</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!seller[id]) &#123;</span><br><span class="line">    <span class="keyword">return</span> def</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> seller[id][key] || def</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="queryString-to-Object"><a href="#queryString-to-Object" class="headerlink" title="queryString to Object"></a>queryString to Object</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">urlSerialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> search = <span class="built_in">window</span>.location.search</span><br><span class="line">  <span class="comment">// ?id=123&amp;a=b</span></span><br><span class="line">  <span class="keyword">const</span> regExp = <span class="regexp">/[?&amp;][^?&amp;]+=[^?&amp;]+/g</span></span><br><span class="line">  <span class="keyword">const</span> matches = search.match(regExp)</span><br><span class="line">  <span class="comment">// ['?id=123','&amp;a=b']</span></span><br><span class="line">  <span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (matches) &#123;</span><br><span class="line">    matches.forEach(<span class="function">(<span class="params">match</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> tempArr = match.slice(<span class="number">1</span>).split(<span class="string">'='</span>)</span><br><span class="line">      <span class="keyword">const</span> key = <span class="built_in">decodeURIComponent</span>(tempArr[<span class="number">0</span>])</span><br><span class="line">      <span class="keyword">const</span> value = <span class="built_in">decodeURIComponent</span>(tempArr[<span class="number">1</span>])</span><br><span class="line">      obj[key] = value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h3><p><a href="https://github.com/choteewang/vue-sell" target="_blank" rel="noopener">https://github.com/choteewang/vue-sell</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;vue-2-5-外卖-webapp&quot;&gt;&lt;a href=&quot;#vue-2-5-外卖-webapp&quot; class=&quot;headerlink&quot; title=&quot;vue 2.5+ 外卖 webapp&quot;&gt;&lt;/a&gt;vue 2.5+ 外卖 webapp&lt;/h1&gt;&lt;h3 id=&quot;pre
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>自定义事件的应用: 在全局拖放对象中添加自定义事件</title>
    <link href="http://yoursite.com/2018/01/04/%E5%B0%81%E8%A3%85%E6%8B%96%E6%94%BE%E5%AF%B9%E8%B1%A1-%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6/"/>
    <id>http://yoursite.com/2018/01/04/封装拖放对象-自定义事件/</id>
    <published>2018-01-04T02:24:17.000Z</published>
    <updated>2018-01-04T02:24:47.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="做什么"><a href="#做什么" class="headerlink" title="做什么"></a>做什么</h3><p>之前两篇博客讲述了观察者模式实现自定义事件的思维步骤, 但自定义事件还未真正用到实际DOM操作中, 我们的最终目的是真正使用<code>观察者模式</code>与<code>DOM操作</code>融合, 实现一个自定义事件.</p><p>这篇博客先来封装一个全局拖放对象, 作为自定义事件的场景, 然后再在这个场景下添加自定义事件</p><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><ul><li><a href="https://choteewang.github.io/2017/12/20/17-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3javaScript%E7%BB%A7%E6%89%BF/" target="_blank" rel="noopener">深入理解javaScript继承机制</a></li><li><a href="https://choteewang.github.io/2017/12/23/javascript-%E4%B8%8E-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" target="_blank" rel="noopener">javascript 与 “发布/订阅(观察者)模式”</a></li><li><a href="https://choteewang.github.io/2018/01/04/javascript%E4%B8%8E%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F2/" target="_blank" rel="noopener">javascript 与 ‘发布订阅(观察者)模式’ 2: 自定义事件</a></li></ul><h3 id="鼠标拖尾"><a href="#鼠标拖尾" class="headerlink" title="鼠标拖尾"></a>鼠标拖尾</h3><p>拖放的基本概念: 创建一个绝对定位的元素，使其可以用鼠标移动, 先从最简单的<code>鼠标拖尾</code>开始</p><p><img src="https://i.loli.net/2018/01/04/5a4d9021a03f1.jpg" alt=""></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&lt;div id="myDiv" style="background:red;width:100px;height:100px;position:absolute"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">"mousemove"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> myDiv = <span class="built_in">document</span>.getElementById(<span class="string">"myDiv"</span>);</span><br><span class="line">  myDiv.style.left = event.clientX + <span class="string">"px"</span>;</span><br><span class="line">  myDiv.style.top = event.clientY + <span class="string">"px"</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="封装拖放对象"><a href="#封装拖放对象" class="headerlink" title="封装拖放对象"></a>封装拖放对象</h3><p>由于<code>mousedown</code>,<code>mousemove</code>,<code>mouseup</code>全是冒泡的,所以可以封装一个全局拖放对象,注册在<code>document</code>对象上,用来管理界面的所有拖放功能,初始代码如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&lt;div id="myDiv" style="background:red;width:100px;height:100px;position:absolute" class="draggable"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="keyword">var</span> DragDrop = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//单例模式</span></span><br><span class="line">  <span class="keyword">var</span> dragging = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleEvent</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> target = event.target</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (event.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"mousedown"</span>:</span><br><span class="line">        <span class="keyword">if</span> (target.className.indexOf(<span class="string">"draggable"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">          dragging = target;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"mousemove"</span>:</span><br><span class="line">        <span class="keyword">if</span> (dragging !== <span class="literal">null</span>) &#123;</span><br><span class="line">          dragging.style.left = event.clientX + <span class="string">"px"</span>;</span><br><span class="line">          dragging.style.top = event.clientY + <span class="string">"px"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"mouseup"</span>:</span><br><span class="line">        dragging = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    enable: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">"mousedown"</span>, handleEvent);</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">"mousemove"</span>, handleEvent);</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">"mouseup"</span>, handleEvent);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    disable: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">document</span>.removeEventListener(<span class="string">"mousedown"</span>, handleEvent);</span><br><span class="line">      <span class="built_in">document</span>.removeEventListener(<span class="string">"mousemove"</span>, handleEvent);</span><br><span class="line">      <span class="built_in">document</span>.removeEventListener(<span class="string">"mouseup"</span>, handleEvent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;();</span><br><span class="line">DragDrop.enable()</span><br></pre></td></tr></table></figure><blockquote><p>上述代码先用一个闭包return出<code>DragDrop</code>对象,这个对象有两个方法<code>DragDrop.enable</code>与<code>DragDrop.disable()</code>,分别向外暴露注册在<code>document</code>对象上的全局鼠标事件接口.<br>在闭包内部,使用一个单例<code>dragging</code>,在<code>mousedown</code>时,将<code>event.target</code>赋值给<code>dragging</code>从而在<code>mousemove</code>的过程中改变<code>dragging</code>也就是<code>event.target</code>对象的位置,在<code>mouseup</code>时将<code>dragging</code>置空,使<code>mousemove</code>事件不再影响<code>dragging</code></p></blockquote><h3 id="修改拖放时的鼠标位置"><a href="#修改拖放时的鼠标位置" class="headerlink" title="修改拖放时的鼠标位置"></a>修改拖放时的鼠标位置</h3><p>之前的代码有一个小bug,如图:</p><blockquote><p><code>mousemove</code>发生之前</p></blockquote><p><img src="https://i.loli.net/2018/01/04/5a4d9021c078a.jpg" alt=""></p><blockquote><p><code>mousemove</code>发生之后</p></blockquote><p><img src="https://i.loli.net/2018/01/04/5a4d9021c0da2.jpg" alt=""></p><blockquote><p>产生此问题的原因是在<code>mousemove</code>发生后,直接将<code>event.clientX</code>与<code>event.clientY</code>赋值给了<code>div</code>的<code>left</code>和<code>top</code><br>解决方法如下图所示,计算出<code>event.clientX-element.offsetLeft</code>与<code>event.clientY-element.offsetTop</code>这两个定值(在mousemove的过程中不会改变,所以是定值),并从<code>element</code>的<code>left</code>与<code>top</code>中减去即可</p></blockquote><p> <img src="https://i.loli.net/2018/01/04/5a4d9021ccb55.jpg" alt=""></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&lt;div id="myDiv" style="background:red;width:100px;height:100px;position:absolute" class="draggable"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="keyword">var</span> DragDrop = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//单例模式</span></span><br><span class="line">  <span class="keyword">var</span> dragging = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> distanceX = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> distanceY = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleEvent</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> target = event.target</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (event.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"mousedown"</span>:</span><br><span class="line">        <span class="keyword">if</span> (target.className.indexOf(<span class="string">"draggable"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">          dragging = target;</span><br><span class="line">          distanceX = event.clientX - dragging.offsetLeft;</span><br><span class="line">          distanceY = event.clientY - dragging.offsetTop;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"mousemove"</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dragging !== <span class="literal">null</span>) &#123;</span><br><span class="line">          dragging.style.left = (event.clientX - distanceX) + <span class="string">"px"</span>;</span><br><span class="line">          dragging.style.top = (event.clientY - distanceY) + <span class="string">"px"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"mouseup"</span>:</span><br><span class="line">        dragging = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    enable: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">"mousedown"</span>, handleEvent);</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">"mousemove"</span>, handleEvent);</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">"mouseup"</span>, handleEvent);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    disable: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">document</span>.removeEventListener(<span class="string">"mousedown"</span>, handleEvent);</span><br><span class="line">      <span class="built_in">document</span>.removeEventListener(<span class="string">"mousemove"</span>, handleEvent);</span><br><span class="line">      <span class="built_in">document</span>.removeEventListener(<span class="string">"mouseup"</span>, handleEvent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;();</span><br><span class="line">DragDrop.enable()</span><br></pre></td></tr></table></figure><h3 id="添加自定义事件"><a href="#添加自定义事件" class="headerlink" title="添加自定义事件"></a>添加自定义事件</h3><p>之前, 我们封装了一个全局拖放对象, 但它只是能”拖”, 还不能有真正的功能让其和拖动功能交互, 用之前总结的<code>自定义事件</code>来完善功能.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PubEvent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.listener = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PubEvent.prototype = &#123;</span><br><span class="line">  <span class="keyword">constructor</span>: PubEvent,</span><br><span class="line">  addListener: function (key, listenerFuction) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">this</span>.listener)[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.listener[key] = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.listener[key].push(listenerFuction)</span><br><span class="line">  &#125;,</span><br><span class="line">  trigger: <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!event.target) &#123;</span><br><span class="line">      event.target = <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.listener[event.type] <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> listener = <span class="keyword">this</span>.listener[event.type]</span><br><span class="line">      listener.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">        v(event);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  removeListener: <span class="function"><span class="keyword">function</span> (<span class="params">key, listenerFuction</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> listenerKey = <span class="keyword">this</span>.listener[key]</span><br><span class="line">    <span class="keyword">if</span> (!listenerKey) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!listenerFuction) &#123;</span><br><span class="line">      listenerKey = []</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      listenerKey.some(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (v === listenerFuction) &#123;</span><br><span class="line">          listenerKey.splice(i, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&lt;div id="myDiv" style="background:red;width:100px;height:100px;position:absolute" class="draggable"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="keyword">var</span> DragDrop = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> dragdrop = <span class="keyword">new</span> PubEvent();</span><br><span class="line">  <span class="comment">//单例模式</span></span><br><span class="line">  <span class="keyword">var</span> dragging = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> distanceX = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> distanceY = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleEvent</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> target = event.target</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (event.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"mousedown"</span>:</span><br><span class="line">        <span class="keyword">if</span> (target.className.indexOf(<span class="string">"draggable"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">          dragging = target;</span><br><span class="line">          distanceX = event.clientX - dragging.offsetLeft;</span><br><span class="line">          distanceY = event.clientY - dragging.offsetTop;</span><br><span class="line">          dragdrop.trigger(&#123;</span><br><span class="line">            type: <span class="string">"dragstart"</span>,</span><br><span class="line">            target: dragging</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"mousemove"</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dragging !== <span class="literal">null</span>) &#123;</span><br><span class="line">          dragging.style.left = (event.clientX - distanceX) + <span class="string">"px"</span>;</span><br><span class="line">          dragging.style.top = (event.clientY - distanceY) + <span class="string">"px"</span>;</span><br><span class="line">          dragdrop.trigger(&#123;</span><br><span class="line">            type: <span class="string">"drag"</span>,</span><br><span class="line">            target: dragging,</span><br><span class="line">            x: event.clientX - distanceX,</span><br><span class="line">            y: event.clientY - distanceY</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">"mouseup"</span>:</span><br><span class="line">        </span><br><span class="line">        dragdrop.trigger(&#123;</span><br><span class="line">          type: <span class="string">"end"</span>,</span><br><span class="line">          target: dragging</span><br><span class="line">        &#125;)</span><br><span class="line">        dragging = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  dragdrop.enable = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">"mousedown"</span>, handleEvent);</span><br><span class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">"mousemove"</span>, handleEvent);</span><br><span class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">"mouseup"</span>, handleEvent);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dragdrop.disable = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.removeEventListener(<span class="string">"mousedown"</span>, handleEvent);</span><br><span class="line">    <span class="built_in">document</span>.removeEventListener(<span class="string">"mousemove"</span>, handleEvent);</span><br><span class="line">    <span class="built_in">document</span>.removeEventListener(<span class="string">"mouseup"</span>, handleEvent);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> dragdrop</span><br><span class="line">&#125;();</span><br><span class="line">DragDrop.enable()</span><br></pre></td></tr></table></figure><blockquote><p>注册<code>dragstart</code>,<code>drag</code>,<code>dragend</code>自定义事件</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&lt;div id="myDiv" style="background:red;width:100px;height:100px;position:absolute" class="draggable"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="comment">//&lt;div id="status" style="width:600px;height:600px;background-color:pink;overflow:hidden;"&gt;&lt;/div&gt;</span></span><br><span class="line">DragDrop.addListener(<span class="string">'dragstart'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> status = <span class="built_in">document</span>.getElementById(<span class="string">'status'</span>);</span><br><span class="line">  status.innerHTML = <span class="string">"drag start "</span> + event.target.id</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">DragDrop.addListener(<span class="string">'drag'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> status = <span class="built_in">document</span>.getElementById(<span class="string">'status'</span>);</span><br><span class="line">  status.innerHTML += <span class="string">"&lt;br&gt;drag move "</span> + event.target.id + <span class="string">" to ("</span> + event.x + <span class="string">" , "</span> + event.y + <span class="string">")"</span></span><br><span class="line">&#125;)</span><br><span class="line">DragDrop.addListener(<span class="string">'dragend'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> status = <span class="built_in">document</span>.getElementById(<span class="string">'status'</span>);</span><br><span class="line">  status.innerHTML += <span class="string">"&lt;br&gt;drag drop "</span> + event.target.id</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2018/01/04/5a4d902219154.jpg" alt=""></p><p>至此,我们事先了三个自定义事件<code>dragstart</code>,<code>drag</code>,<code>dragend</code>,它们分别在拖放行为的不同阶段向<code>div</code>中输出拖放动作的详细信息. 这只是个简单的例子, 添加自定义事件可以使对象更健壮, 可以在网络应用中处理复杂的拖放功能.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;做什么&quot;&gt;&lt;a href=&quot;#做什么&quot; class=&quot;headerlink&quot; title=&quot;做什么&quot;&gt;&lt;/a&gt;做什么&lt;/h3&gt;&lt;p&gt;之前两篇博客讲述了观察者模式实现自定义事件的思维步骤, 但自定义事件还未真正用到实际DOM操作中, 我们的最终目的是真正使用&lt;cod
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>javascript 与 &#39;发布订阅(观察者)模式&#39; vol.2 : 自定义事件</title>
    <link href="http://yoursite.com/2018/01/04/javascript%E4%B8%8E%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F2/"/>
    <id>http://yoursite.com/2018/01/04/javascript与发布订阅模式2/</id>
    <published>2018-01-04T00:29:28.000Z</published>
    <updated>2018-01-04T01:13:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>上次的<a href="https://choteewang.github.io/2017/12/23/javascript-%E4%B8%8E-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" target="_blank" rel="noopener">博客</a>里写了发布订阅模式的实现, 这次的目的是用发布订阅模式实现一个自定义事件</p><h3 id="之前的代码"><a href="#之前的代码" class="headerlink" title="之前的代码"></a>之前的代码</h3><p>这里放上上篇博客: <a href="https://choteewang.github.io/2017/12/23/javascript-%E4%B8%8E-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" target="_blank" rel="noopener">javascript 与 “发布订阅(观察者)模式”</a> 中最后总结的代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pubEvent = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> listener = &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> addListener = <span class="function"><span class="keyword">function</span> (<span class="params">key, listenerFuction</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!listener[key]) &#123;</span><br><span class="line">      listener[key] = []</span><br><span class="line">    &#125;</span><br><span class="line">    listener[key].push(listenerFuction)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> trigger = <span class="function"><span class="keyword">function</span> (<span class="params">key, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!listener[key] || listener[key].length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    listener[key].forEach(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">      v.call(<span class="literal">null</span>, &#123; key, ...args &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> removeListener = <span class="function"><span class="keyword">function</span> (<span class="params">key, fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> listenerKey = listener[key]</span><br><span class="line">    <span class="keyword">if</span> (!listenerKey) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!fn) &#123;</span><br><span class="line">      listenerKey = []</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      listenerKey.some(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (v === fn) &#123;</span><br><span class="line">          listenerKey.splice(i, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    addListener,</span><br><span class="line">    trigger,</span><br><span class="line">    removeListener</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>我们上次将上述代码作为了一个<code>全局工具对象</code>, 用闭包的方式向外return出一个对象接口, 操纵比包内的数据. 若要使用这个<code>全局工具对象</code>, 可以如此调用:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册事件</span></span><br><span class="line">pubEvent.addListener(<span class="string">'countAdd'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'dv'</span>).innerHTML = data.count</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 触发事件</span></span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>).addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  count++</span><br><span class="line">  <span class="comment">// 触发"countAdd"事件</span></span><br><span class="line">  pubEvent.trigger(<span class="string">'countAdd'</span>, &#123;</span><br><span class="line">    count</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>但这样的调用方式和原生js事件还有些差异, 原生js的事件的注册对象应是<code>元素element</code>,数据应由<code>事件参数对象event</code>传递, 为了兼容各种浏览器, 我们今天将之前的ES6代码改为ES5表现, 再利用之前总结的<code>javascript寄生组合式继承</code>知识, 打造<code>自定义事件</code></p><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><ul><li><a href="https://choteewang.github.io/2017/12/20/17-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3javaScript%E7%BB%A7%E6%89%BF/" target="_blank" rel="noopener">深入理解javaScript继承机制</a></li><li><a href="https://choteewang.github.io/2017/12/23/javascript-%E4%B8%8E-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" target="_blank" rel="noopener">javascript 与 “发布/订阅(观察者)模式”</a></li></ul><h3 id="CODE"><a href="#CODE" class="headerlink" title="CODE"></a>CODE</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 改造为构造函数和原型,使其可以被继承</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PubEvent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.listener = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PubEvent.prototype = &#123;</span><br><span class="line">  <span class="keyword">constructor</span>: PubEvent,</span><br><span class="line">  addListener: function (key, listenerFuction) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">this</span>.listener)[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.listener[key] = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.listener[key].push(listenerFuction)</span><br><span class="line">  &#125;,</span><br><span class="line">  trigger: <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!event.target) &#123;</span><br><span class="line">      event.target = <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.listener[event.type] <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> listener = <span class="keyword">this</span>.listener[event.type]</span><br><span class="line">      listener.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">        v(event);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  removeListener: <span class="function"><span class="keyword">function</span> (<span class="params">key, listenerFuction</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> listenerKey = <span class="keyword">this</span>.listener[key]</span><br><span class="line">    <span class="keyword">if</span> (!listenerKey) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!listenerFuction) &#123;</span><br><span class="line">      listenerKey = []</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      listenerKey.some(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (v === listenerFuction) &#123;</span><br><span class="line">          listenerKey.splice(i, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> abc = <span class="keyword">new</span> PubEvent()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> handler = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(event.message); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abc.addListener(<span class="string">'click'</span>,handler)</span><br><span class="line">abc.trigger(&#123;<span class="attr">type</span>:<span class="string">'click'</span>,<span class="attr">message</span>:<span class="string">'this is a click'</span>&#125;) <span class="comment">//this is a click</span></span><br><span class="line">abc.removeListener(<span class="string">'click'</span>,handler)</span><br><span class="line">abc.trigger(&#123;<span class="attr">type</span>:<span class="string">'click'</span>,<span class="attr">message</span>:<span class="string">'this is a click'</span>&#125;) <span class="comment">//无输出</span></span><br></pre></td></tr></table></figure><blockquote><p>初级调用</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> abc = <span class="keyword">new</span> PubEvent()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> handler = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(event.message); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abc.addListener(<span class="string">'click'</span>,handler)</span><br><span class="line">abc.trigger(&#123;<span class="attr">type</span>:<span class="string">'click'</span>,<span class="attr">message</span>:<span class="string">'this is a click'</span>&#125;) <span class="comment">//this is a click</span></span><br><span class="line">abc.removeListener(<span class="string">'click'</span>,handler)</span><br><span class="line">abc.trigger(&#123;<span class="attr">type</span>:<span class="string">'click'</span>,<span class="attr">message</span>:<span class="string">'this is a click'</span>&#125;) <span class="comment">//无输出</span></span><br></pre></td></tr></table></figure><h3 id="结合寄生组合继承"><a href="#结合寄生组合继承" class="headerlink" title="结合寄生组合继承"></a>结合寄生组合继承</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">object</span>(<span class="params">o</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">F</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">  F.prototype = o;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> F();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inheritPrototype</span>(<span class="params">subType, superType</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prototype = object(superType.prototype); </span><br><span class="line">  prototype.constructor = subType; </span><br><span class="line">  subType.prototype = prototype; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Shoes</span>(<span class="params">model, size</span>) </span>&#123;</span><br><span class="line">  PubEvent.call(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>.model = model;</span><br><span class="line">  <span class="keyword">this</span>.size = size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inheritPrototype(Shoes, PubEvent);</span><br><span class="line"></span><br><span class="line">Shoes.prototype.say = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.trigger(&#123;</span><br><span class="line">    type: <span class="string">"message"</span>,</span><br><span class="line">    message: message</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleMessage</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"model is "</span>+ event.target.model + <span class="string">" size is "</span> + event.target.size + <span class="string">" message is "</span> + event.message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> aj3 = <span class="keyword">new</span> Shoes(<span class="string">"aj3"</span>, <span class="number">42</span>);</span><br><span class="line">aj3.addListener(<span class="string">"message"</span>, handleMessage);</span><br><span class="line">aj3.say(<span class="string">"which is chotee\'s favorite"</span>); <span class="comment">//model is aj3 size is 42 message is which is chotee's favorite</span></span><br></pre></td></tr></table></figure><p>在上面的例子里, 使用寄生组合继承使<code>Shoes</code>的原型继承自<code>PubEvent</code>的原型, 在<code>Shoes</code>构造函数内部使用借用构造函数继承了<code>PubEvent</code>构造函数内的<code>listener</code>对象,使<code>Shoes</code>的实例<code>shoes</code>可以触发自己订阅的事件<code>message</code>.</p><p>在数据流方面,<code>say</code>方法把<code>message</code>字符串传递给调用<code>trigger</code>时内部包装的<code>event</code>对象,这个对象在<code>trigger</code>方法执行时将<code>event</code>对象传递给实例放在<code>this.listener</code>对象中的订阅方法<code>handleMessage</code>并立即调用.所以在订阅的方法中可以显示<code>trigger</code>时传递的数据</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;上次的&lt;a href=&quot;https://choteewang.github.io/2017/12/23/javascript-%E4%B8%8E-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>javascript 与 &quot;发布/订阅(观察者)模式&quot;</title>
    <link href="http://yoursite.com/2017/12/23/javascript-%E4%B8%8E-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    <id>http://yoursite.com/2017/12/23/javascript-与-发布订阅设计模式/</id>
    <published>2017-12-23T13:05:44.000Z</published>
    <updated>2017-12-23T13:11:43.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="发布-订阅-观察者-模式"><a href="#发布-订阅-观察者-模式" class="headerlink" title="发布/订阅(观察者)模式"></a>发布/订阅(观察者)模式</h3><p><code>发布/订阅模式</code>又称<code>观察者模式</code>,是一种<code>设计模式</code>, 它定义了对象间的一种一对多的关系，让多个观察者对象同时监听某一个主题对象，当一个对象发生改变时，所有依赖于它的对象都将得到通知。</p><p>js中<code>事件</code>的实现方式是<code>发布/订阅</code>模式, <code>redux</code>的实现原理也依赖了<code>发布/订阅</code>模式. </p><p>其实伪代码看过不少次了, 决定自己动手写一下. 此篇blog作为学习的<code>正反馈</code>. </p><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><blockquote><p><code>sneakersMerchant</code>卖<code>篮球鞋</code>,<br><code>chotee</code>觉得可以,收藏了<code>sneakersMerchant</code>.<br><code>wang</code>觉得ok,也收藏了<code>sneakersMerchant</code>.<br><code>sneakersMerchant</code>一上新(<code>trigger</code>),就会通知所有收藏的用户们(<code>listener</code>)</p></blockquote><p>数据模型抽象如下</p><ul><li><code>发布者</code>: <code>商家</code>,Obj</li><li><code>listener</code>: <code>收藏的用户们</code>,Array</li></ul><h3 id="实现基本功能"><a href="#实现基本功能" class="headerlink" title="实现基本功能"></a>实现基本功能</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sneakersMerchant = &#123; <span class="comment">//publisher</span></span><br><span class="line">  listener: [], <span class="comment">//订阅者方法数组</span></span><br><span class="line">  addListener(listenerFuction) &#123; </span><br><span class="line">    <span class="keyword">this</span>.listener.push(listenerFuction)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//trigger发生时,将listener数组中的每个方法用publisher的上下文和trigger的参数调用</span></span><br><span class="line">  trigger(...args) &#123; </span><br><span class="line">    <span class="keyword">this</span>.listener.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">v,i</span>) </span>&#123;</span><br><span class="line">      v.apply(<span class="keyword">this</span>,args)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> chotee = &#123; <span class="comment">//listener1</span></span><br><span class="line">  listen(model,size) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`chotee看到了颜色是<span class="subst">$&#123;model&#125;</span>`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`chotee看到了尺寸是<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wang = &#123; <span class="comment">//listener2</span></span><br><span class="line">  listen(model,size) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`wang看到了颜色是<span class="subst">$&#123;model&#125;</span>`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`wang看到了尺寸是<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sneakersMerchant.addListener(chotee.listen)</span><br><span class="line">sneakersMerchant.addListener(wang.listen)</span><br><span class="line">sneakersMerchant.trigger(<span class="string">'aj3'</span>,<span class="string">'42'</span>)</span><br></pre></td></tr></table></figure><blockquote><p>输出结果:<br>chotee看到了颜色是aj3<br>chotee看到了尺寸是42<br>wang看到了颜色是aj3<br>wang看到了尺寸是42</p></blockquote><h3 id="实现按key名订阅"><a href="#实现按key名订阅" class="headerlink" title="实现按key名订阅"></a>实现按key名订阅</h3><blockquote><p>至此,我们已经实现了一个基本功能,当<code>sneakersMerchant</code>有鞋发布时,每个<code>listener</code>都会被推送<br>但是,比如<code>chotee</code>只喜欢<code>model</code>型号是”aj3”的球鞋,<code>wang</code>只喜欢<code>model</code>型号是”aj11”的球鞋,所以需要改进一个可以按<code>key</code>订阅的功能</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sneakersMerchant = &#123; <span class="comment">//publisher</span></span><br><span class="line">  listener: [], <span class="comment">//订阅者方法数组</span></span><br><span class="line">  addListener(key,listenerFuction) &#123;</span><br><span class="line">    <span class="comment">// 如果listener数组中不存在key项,设置key项为一个空数组</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.listener[key])&#123;</span><br><span class="line">      <span class="keyword">this</span>.listener[key] = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果有key项,给key项数组添加一个listener </span></span><br><span class="line">    <span class="keyword">this</span>.listener[key].push(listenerFuction)</span><br><span class="line">  &#125;,</span><br><span class="line">  trigger(key, ...args) &#123;</span><br><span class="line">    <span class="comment">//如果listener数组中不存在key项或key项的数组为空,返回</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.listener[key]||<span class="keyword">this</span>.listener[key].length===<span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果有key项, 调用key项中的方法,这时可以传入key</span></span><br><span class="line">    <span class="keyword">this</span>.listener[key].forEach(<span class="function"><span class="keyword">function</span> (<span class="params">v,i</span>) </span>&#123;</span><br><span class="line">      v.call(<span class="keyword">this</span>,key, ...args)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> chotee = &#123; <span class="comment">//listener1</span></span><br><span class="line">  listen(model,size) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`chotee看到了颜色是<span class="subst">$&#123;model&#125;</span>`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`chotee看到了尺寸是<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wang = &#123; <span class="comment">//listener2</span></span><br><span class="line">  listen(model,size) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`wang看到了颜色是<span class="subst">$&#123;model&#125;</span>`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`wang看到了尺寸是<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sneakersMerchant.addListener(<span class="string">'aj3'</span>,chotee.listen)</span><br><span class="line">sneakersMerchant.addListener(<span class="string">'aj11'</span>,wang.listen)</span><br><span class="line">sneakersMerchant.trigger(<span class="string">'aj3'</span>,<span class="string">'42'</span>)</span><br><span class="line"><span class="comment">// chotee看到了颜色是aj3</span></span><br><span class="line"><span class="comment">// chotee看到了尺寸是42</span></span><br><span class="line">sneakersMerchant.trigger(<span class="string">'aj11'</span>,<span class="string">'44'</span>)</span><br><span class="line"><span class="comment">// wang看到了颜色是aj11</span></span><br><span class="line"><span class="comment">// wang看到了尺寸是44</span></span><br></pre></td></tr></table></figure><h3 id="封装-注入"><a href="#封装-注入" class="headerlink" title="封装,注入"></a>封装,注入</h3><blockquote><p>我们注意到其实sneakersMerchant中的逻辑与<code>卖球鞋</code>本身没有直接联系, 事实上它代表了所有的<code>发布/订阅</code>逻辑, 不仅可以<code>卖球鞋</code>,还可以<code>卖切糕</code>,可以扩展到任何对象上, 让被扩展的对象拥有<code>发布/订阅</code>逻辑和功能呢,实现<code>注入(injection)</code><br>所以,我们对代码进行改造和封装,将刚才的<code>sneakerMerchant</code>更名为<code>pub_sub_util</code>,并定义一个<code>pub_sub_injection</code>函数,用来对任何对象传入<code>pub_sub_util</code>的逻辑,进行功能注入</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pub_sub_util = &#123; </span><br><span class="line">  listener: [], </span><br><span class="line">  addListener(key,listenerFuction) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.listener[key])&#123;</span><br><span class="line">      <span class="keyword">this</span>.listener[key] = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.listener[key].push(listenerFuction)</span><br><span class="line">  &#125;,</span><br><span class="line">  trigger(key, ...args) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.listener[key]||<span class="keyword">this</span>.listener[key].length===<span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.listener[key].forEach(<span class="function"><span class="keyword">function</span> (<span class="params">v,i</span>) </span>&#123;</span><br><span class="line">      v.call(<span class="keyword">this</span>,key, ...args)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 定义工具函数,进行 发布/订阅 功能注入</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pub_sub_injection</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">in</span> pub_sub_util)&#123;</span><br><span class="line">    obj[key] = pub_sub_util[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj <span class="comment">// for 链式调用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//给任意对象调用工具函数,注入发布/订阅功能</span></span><br><span class="line"><span class="keyword">let</span> sneakersMerchant = &#123;&#125;</span><br><span class="line">sneakersMerchant = pub_sub_injection(sneakersMerchant)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> chotee = &#123; <span class="comment">//listener1</span></span><br><span class="line">  listen(model,size) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`chotee看到了颜色是<span class="subst">$&#123;model&#125;</span>`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`chotee看到了尺寸是<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wang = &#123; <span class="comment">//listener2</span></span><br><span class="line">  listen(model,size) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`wang看到了颜色是<span class="subst">$&#123;model&#125;</span>`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`wang看到了尺寸是<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sneakersMerchant.addListener(<span class="string">'aj3'</span>,chotee.listen)</span><br><span class="line">sneakersMerchant.addListener(<span class="string">'aj11'</span>,wang.listen)</span><br><span class="line">sneakersMerchant.trigger(<span class="string">'aj3'</span>,<span class="string">'42'</span>)</span><br><span class="line"><span class="comment">// chotee看到了颜色是aj3</span></span><br><span class="line"><span class="comment">// chotee看到了尺寸是42</span></span><br><span class="line">sneakersMerchant.trigger(<span class="string">'aj11'</span>,<span class="string">'44'</span>)</span><br><span class="line"><span class="comment">//wang看到了颜色是aj11</span></span><br><span class="line"><span class="comment">//wang看到了尺寸是44</span></span><br></pre></td></tr></table></figure><h3 id="如何退订"><a href="#如何退订" class="headerlink" title="如何退订?"></a>如何退订?</h3><blockquote><p><code>chotee</code>从<code>sneakersMerchant</code>那里买到了莆田货, 于是要退订订阅, 总会发生这样的事, 于是要给工具对象中加一个<code>removeListener</code>方法</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pub_sub_util = &#123;</span><br><span class="line">  listener: [],</span><br><span class="line">  addListener(key, listenerFuction) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.listener[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.listener[key] = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.listener[key].push(listenerFuction)</span><br><span class="line">  &#125;,</span><br><span class="line">  trigger(key, ...args) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.listener[key] || <span class="keyword">this</span>.listener[key].length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.listener[key].forEach(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">      v.call(<span class="keyword">this</span>, key, ...args)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//增加退订功能</span></span><br><span class="line">  removeListener(key, fn) &#123;</span><br><span class="line">    <span class="keyword">let</span> listenerKey = <span class="keyword">this</span>.listener[key]</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果listener数组中还没有key项,返回</span></span><br><span class="line">    <span class="keyword">if</span> (!listenerKey) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果没传第二个参数,意思是要删除整个key项</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!fn) &#123;</span><br><span class="line">      listenerKey = []</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 删除listener数组key项中对应的函数</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      listenerKey.some(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(v===fn)&#123;</span><br><span class="line">          listenerKey.splice(i,<span class="number">1</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 定义工具函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pub_sub_injection</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> pub_sub_util) &#123;</span><br><span class="line">    obj[key] = pub_sub_util[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj <span class="comment">// for 链式调用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//给任意对象调用工具函数,注入发布/订阅功能</span></span><br><span class="line"><span class="keyword">let</span> sneakersMerchant = &#123;&#125;</span><br><span class="line">sneakersMerchant = pub_sub_injection(sneakersMerchant)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> chotee = &#123; <span class="comment">//listener1</span></span><br><span class="line">  listen(model, size) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`chotee看到了颜色是<span class="subst">$&#123;model&#125;</span>`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`chotee看到了尺寸是<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wang = &#123; <span class="comment">//listener2</span></span><br><span class="line">  listen(model, size) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`wang看到了颜色是<span class="subst">$&#123;model&#125;</span>`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`wang看到了尺寸是<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">sneakersMerchant.addListener(<span class="string">'aj3'</span>, chotee.listen)</span><br><span class="line">sneakersMerchant.addListener(<span class="string">'aj11'</span>, wang.listen)</span><br><span class="line">sneakersMerchant.trigger(<span class="string">'aj3'</span>, <span class="string">'42'</span>)</span><br><span class="line"><span class="comment">// chotee看到了颜色是aj3</span></span><br><span class="line"><span class="comment">// chotee看到了尺寸是42</span></span><br><span class="line">sneakersMerchant.trigger(<span class="string">'aj11'</span>, <span class="string">'44'</span>)</span><br><span class="line"><span class="comment">//wang看到了颜色是aj11</span></span><br><span class="line"><span class="comment">//wang看到了尺寸是44</span></span><br><span class="line">sneakersMerchant.removelistener(<span class="string">'aj3'</span>, chotee.listen)</span><br><span class="line">sneakersMerchant.trigger(<span class="string">'aj3'</span>, <span class="string">'42'</span>)</span><br><span class="line"><span class="comment">//什么都没发生</span></span><br></pre></td></tr></table></figure><h3 id="全局事件对象"><a href="#全局事件对象" class="headerlink" title="全局事件对象"></a>全局事件对象</h3><blockquote><p>至此,我们已经完成了大部分<code>发布/订阅</code>的功能,但为了让我们的代码更有<code>bigger</code>,我们应该向更优秀的代码组织方式靠拢</p><p>虽然现在经过我们<code>注入</code>的对象上,已经具备了自己的<code>发布/订阅</code>逻辑,但这还不够好.<br>更好的方式是用<code>闭包</code>来创建一个<code>全局事件对象</code>,这个对象,对外暴露<code>发布/订阅</code>逻辑的<code>接口</code>,这些<code>接口</code>用来操作<code>闭包</code>中的<code>listener</code>数据<br>改造后的代码如下:</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pubEvent = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> listener = &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> addListener = <span class="function"><span class="keyword">function</span> (<span class="params">key, listenerFuction</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!listener[key]) &#123;</span><br><span class="line">      listener[key] = []</span><br><span class="line">    &#125;</span><br><span class="line">    listener[key].push(listenerFuction)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> trigger = <span class="function"><span class="keyword">function</span> (<span class="params">key, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!listener[key] || listener[key].length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    listener[key].forEach(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">      v.call(<span class="literal">null</span>, &#123; key, ...args &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> removeListener = <span class="function"><span class="keyword">function</span> (<span class="params">key, fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> listenerKey = listener[key]</span><br><span class="line">    <span class="keyword">if</span> (!listenerKey) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!fn) &#123;</span><br><span class="line">      listenerKey = []</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      listenerKey.some(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (v === fn) &#123;</span><br><span class="line">          listenerKey.splice(i, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    addListener,</span><br><span class="line">    trigger,</span><br><span class="line">    removeListener</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> chotee = &#123; <span class="comment">//listener1</span></span><br><span class="line">  listen(&#123; key, size &#125;) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`chotee看到了颜色是<span class="subst">$&#123;key&#125;</span>`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`chotee看到了尺寸是<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wang = &#123; <span class="comment">//listener2</span></span><br><span class="line">  listen(&#123; key, size &#125;) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`wang看到了颜色是<span class="subst">$&#123;key&#125;</span>`</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`wang看到了尺寸是<span class="subst">$&#123;size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pubEvent.addListener(<span class="string">'aj3'</span>, chotee.listen)</span><br><span class="line">pubEvent.addListener(<span class="string">'aj11'</span>, wang.listen)</span><br><span class="line">pubEvent.trigger(<span class="string">'aj3'</span>, &#123;<span class="attr">size</span>:<span class="number">42</span>&#125;)</span><br><span class="line"><span class="comment">// chotee看到了颜色是aj3</span></span><br><span class="line"><span class="comment">// chotee看到了尺寸是42</span></span><br><span class="line">pubEvent.trigger(<span class="string">'aj11'</span>, &#123;<span class="attr">size</span>:<span class="number">44</span>&#125;)</span><br><span class="line"><span class="comment">//wang看到了颜色是aj11</span></span><br><span class="line"><span class="comment">//wang看到了尺寸是44</span></span><br><span class="line">pubEvent.removeListener(<span class="string">'aj3'</span>, chotee.listen)</span><br><span class="line">pubEvent.trigger(<span class="string">'aj3'</span>, <span class="string">'42'</span>)</span><br><span class="line"><span class="comment">//什么都没发生</span></span><br></pre></td></tr></table></figure><h3 id="模块通信"><a href="#模块通信" class="headerlink" title="模块通信"></a>模块通信</h3><blockquote><p>为了更深刻的理解,参数是如何从<code>publisher</code>传递给<code>listener</code>的, 我们来做一个小案例<br>比如页面上有一个按钮,每次点击此按钮后,div中显示此按钮被点击的次数</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn"</span>&gt;</span>点我加1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"dv"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- polyfill here --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- pubEvent.js中放入我们自己写的代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"pubEvent.js"</span>&gt;</span><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"click.js"</span>&gt;</span><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"show.js"</span>&gt;</span><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// click.js</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(count); <span class="comment">// </span></span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>).addEventListener(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    count++</span><br><span class="line">    <span class="comment">// 触发"countAdd"自定义事件</span></span><br><span class="line">    pubEvent.trigger(<span class="string">'countAdd'</span>,&#123;count&#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// show.js</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 注册"countAdd"事件</span></span><br><span class="line">  pubEvent.addListener(<span class="string">'countAdd'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'dv'</span>).innerHTML = data.count</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2017/12/23/5a3e54dd0e967.jpg" alt=""></p><blockquote><p><code>count</code>本来是<code>click.js</code>闭包中的私有变量,通过<code>pubEvent.trigger(&#39;countAdd&#39;,{count})</code>传递入<code>trigger</code>的函数体内,<code>trigger</code>的函数体内又调用了<code>listener</code>中的回调函数,回调函数通过<code>data</code>对象接收<code>count</code>和<code>key</code>的值.再在回调函数中向页面进行输出</p><p>最后我们抽离出<code>pubEvent.js</code>,可以在平时的工作学习中作为全局<code>发布/订阅工具函数</code>使用</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pubEvent = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> listener = &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> addListener = <span class="function"><span class="keyword">function</span> (<span class="params">key, listenerFuction</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!listener[key]) &#123;</span><br><span class="line">      listener[key] = []</span><br><span class="line">    &#125;</span><br><span class="line">    listener[key].push(listenerFuction)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> trigger = <span class="function"><span class="keyword">function</span> (<span class="params">key, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!listener[key] || listener[key].length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    listener[key].forEach(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">      v.call(<span class="literal">null</span>, &#123; key, ...args &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> removeListener = <span class="function"><span class="keyword">function</span> (<span class="params">key, fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> listenerKey = listener[key]</span><br><span class="line">    <span class="keyword">if</span> (!listenerKey) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!fn) &#123;</span><br><span class="line">      listenerKey = []</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      listenerKey.some(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (v === fn) &#123;</span><br><span class="line">          listenerKey.splice(i, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    addListener,</span><br><span class="line">    trigger,</span><br><span class="line">    removeListener</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;发布-订阅-观察者-模式&quot;&gt;&lt;a href=&quot;#发布-订阅-观察者-模式&quot; class=&quot;headerlink&quot; title=&quot;发布/订阅(观察者)模式&quot;&gt;&lt;/a&gt;发布/订阅(观察者)模式&lt;/h3&gt;&lt;p&gt;&lt;code&gt;发布/订阅模式&lt;/code&gt;又称&lt;code&gt;观察
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Vuex 03 : 代码拆分 &amp; mapAnything</title>
    <link href="http://yoursite.com/2017/12/06/12-Vuex-03/"/>
    <id>http://yoursite.com/2017/12/06/12-Vuex-03/</id>
    <published>2017-12-06T08:06:45.000Z</published>
    <updated>2018-01-28T00:59:10.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="mapActions-mapGetters-mapMutations"><a href="#mapActions-mapGetters-mapMutations" class="headerlink" title="mapActions,mapGetters,mapMutations"></a>mapActions,mapGetters,mapMutations</h3><p>map系列函数能帮我们用更简洁的语法将store.actions,mutations,getters绑定到组件中, 是很好的语法糖. 这里以<code>mapGetters</code>举例,剩下剩下两个也是一个套路.</p><p><code>mapGetters</code> 辅助函数仅仅是将 store 中的 getter 映射到局部计算属性, 可以向方法中传一个数组：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mapGetters &#125; <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  computed: &#123;</span><br><span class="line">  <span class="comment">// 使用对象展开运算符将 getter 混入 computed 对象中</span></span><br><span class="line">    ...mapGetters([</span><br><span class="line">      <span class="string">'doneTodosCount'</span>,</span><br><span class="line">      <span class="string">'anotherGetter'</span>,</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    ])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果你想将一个 getter 属性另取一个名字，使用对象形式：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mapGetters(&#123;</span><br><span class="line">  <span class="comment">// 映射 `this.doneCount` 为 `store.getters.doneTodosCount`</span></span><br><span class="line">  doneCount: <span class="string">'doneTodosCount'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>回到本例,我们可以修改代码为</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">computed: &#123;</span><br><span class="line">  ...mapGetters([<span class="string">"oddOrEven"</span>])</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">  ...mapActions([<span class="string">"increment"</span>, <span class="string">"decrement"</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="文件拆分"><a href="#文件拆分" class="headerlink" title="文件拆分"></a>文件拆分</h3><p>接下来将文件拆分:</p><ol><li>将所有与store相关的方法移到store.js中, </li><li>将Counter组件提出称为单文件组件Counter.vue</li><li>将store.js与Counter.vue一起import进入口文件index.js,并在入口的根实例中绑定store</li></ol><p>测试一下,完成! 下面是分文件的完整代码</p><h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><hr><h3 id="store-js"><a href="#store-js" class="headerlink" title="store.js"></a>store.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用常量替代字符串</span></span><br><span class="line"><span class="keyword">const</span> INCREMENT = <span class="string">'INCREMENT'</span></span><br><span class="line"><span class="keyword">const</span> DECREMENT = <span class="string">'DECREMENT'</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  count: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getters = &#123;</span><br><span class="line">  <span class="comment">// getter方法的第一个参数是state,第二个参数是getters对象</span></span><br><span class="line">  oddOrEven(state) &#123;</span><br><span class="line">    <span class="keyword">return</span> state.count % <span class="number">2</span> === <span class="number">0</span> ? <span class="string">'even'</span> : <span class="string">'odd'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">  <span class="comment">// ES6计算属性写法,来命名函数名,payload是组件内部提交的&#123;type:string,step:string&#125;的对象</span></span><br><span class="line">  [INCREMENT](state, payload) &#123;</span><br><span class="line">    state.count += payload.step</span><br><span class="line">  &#125;,</span><br><span class="line">  [DECREMENT](state, payload) &#123;</span><br><span class="line">    state.count -= payload.step</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">  <span class="comment">// 用action将mutation包一层,把触发mutation的逻辑写在action中</span></span><br><span class="line">  increment(&#123; commit &#125;) &#123;</span><br><span class="line">    <span class="comment">// 对象风格提交方式提交mutation, 与Redux统一</span></span><br><span class="line">    commit(&#123; <span class="attr">type</span>: INCREMENT, <span class="attr">step</span>: <span class="number">1</span> &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// action可以是异步的,可以用Promise包装</span></span><br><span class="line">  decrement(&#123; commit &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        commit(&#123; <span class="attr">type</span>: DECREMENT, <span class="attr">step</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        resolve()</span><br><span class="line">      &#125;, <span class="number">3000</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state,</span><br><span class="line">  getters,</span><br><span class="line">  mutations,</span><br><span class="line">  actions</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="Counter-vue"><a href="#Counter-vue" class="headerlink" title="Counter.vue"></a>Counter.vue</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;&#123;&#123; $store.state.count &#125;&#125; is &#123;&#123; oddOrEven &#125;&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;button v-on:click="increment"&gt; + &lt;/</span>button&gt;</span><br><span class="line">    &lt;button v-on:click=<span class="string">"decrement"</span>&gt; - (Async) &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">import Vue from "vue";</span></span><br><span class="line"><span class="regexp">import &#123; mapActions, mapGetters &#125; from "vuex";</span></span><br><span class="line"><span class="regexp">export default Vue.component("Counter", &#123;</span></span><br><span class="line"><span class="regexp">  computed: &#123;</span></span><br><span class="line"><span class="regexp">    ...mapGetters(["oddOrEven"])</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  methods: &#123;</span></span><br><span class="line"><span class="regexp">    ...mapActions(["increment", "decrement"])</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br></pre></td></tr></table></figure><h3 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Counter <span class="keyword">from</span> <span class="string">'./Counter'</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'./store'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  store,</span><br><span class="line">  template: <span class="string">'&lt;Counter/&gt;'</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h3><p>至此, 我们已经完成了一个具备大多数Vuex功能的counter, 当然Vuex可以做的事比这个例子更多, 比如Module模块分割和路径管理等. 但都是在这个基础上进行改动的. 相信看文档与实际项目结合,接受的会很快</p><p>其实Flux架构的大体思路都差不多, 单向数据流, 视图触发<code>dispatch</code>一个<code>action</code>, 从而修改<code>store</code>中的<code>state</code>, View层监视到<code>state</code>的修改从而更新数据触发渲染. 不管是Vuex还是Redux都是一个套路. 希望从这几篇blog的总结中, 我自己可以有收获!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;mapActions-mapGetters-mapMutations&quot;&gt;&lt;a href=&quot;#mapActions-mapGetters-mapMutations&quot; class=&quot;headerlink&quot; title=&quot;mapActions,mapGetters,ma
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Vuex 02 : 基于Getter, Mutation, Action,继续改造Demo</title>
    <link href="http://yoursite.com/2017/12/06/11-vuex-02/"/>
    <id>http://yoursite.com/2017/12/06/11-vuex-02/</id>
    <published>2017-12-06T00:25:08.000Z</published>
    <updated>2018-01-27T22:33:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>经过上篇的旅程, 已经可以做出一个有Vuex基本功能的Counter了. 为了让Counter的逻辑更完善, 今天引入Getter, Mutation, Action 来继续优化代码</p><h3 id="Getter"><a href="#Getter" class="headerlink" title="Getter"></a>Getter</h3><p>Vuex 允许我们在 store 中定义“getter”（可以认为是 store 的计算属性）。就像计算属性一样，getter 的返回值会根据它的依赖被缓存起来，且只有当它的依赖值发生了改变才会被重新计算。</p><p>在本例中,将count是奇书还是偶数的逻辑写在getter中.</p><p>Getter接收<code>state</code>作为第一个参数,</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getters:&#123;</span><br><span class="line">  <span class="comment">// getter方法的第一个参数是state,第二个参数是getters对象</span></span><br><span class="line">  oddOrEven(state)&#123;</span><br><span class="line">    <span class="keyword">return</span> state.count % <span class="number">2</span> === <span class="number">0</span> ? <span class="string">'even'</span> : <span class="string">'odd'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在组件内部的写法,这里getter会暴露为Store.getters对象, 同时getter也接收getters对象本身作为第二个参数, 这样可以接受其他getter</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">computed:&#123;</span><br><span class="line">  count()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$store.state.count</span><br><span class="line">  &#125;,</span><br><span class="line">  oddOrEven()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$store.getters.oddOrEven</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Mutation"><a href="#Mutation" class="headerlink" title="Mutation"></a>Mutation</h3><p>在Vuex里,提交状态需要用到<code>mutation</code>与<code>action</code>,<code>action</code>更像在mutation外面包了一层, 类似Redux中的<code>action creater</code>产生<code>action</code>一样, 在Vuex里, <code>mutation</code>只保留最原始的逻辑, 操作state中的数据, 其他commit mutation的逻辑和异步操作交给<code>action</code>去处理.</p><p>所以,异步和其他逻辑处理交给<code>action</code>,所以<code>mutation</code>必须是同步的</p><p><code>mutation</code>的类型最好用常量去代替, 这点也与Redux等Flux架构相统一, 可以使用ES6的计算属性优化常量作为函数名的写法.</p><p>提交mutation的唯一方式是<code>store.commit(mutation)</code>,这里可以在<code>commit mutation</code>时附加提交数据<code>payload</code>,习惯写成对象的提交方式如<code>{type:INCREMENT,step:1}</code>,这个对象在store定义时的<code>mutation</code>方法中是第二个参数, 写成<code>payload</code>是很好的社区规范.这里用step来定义 counter 加减的跨度</p><p>总结一下,如下改写mutation:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> INCREMENT = <span class="string">'INCREMENT'</span></span><br><span class="line"><span class="keyword">const</span> DECREMENT = <span class="string">'DECREMENT'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">mutations:&#123;</span><br><span class="line">  <span class="comment">// ES6计算属性写法,来命名函数名,payload是组件内部提交的&#123;type:string,step:string&#125;的对象</span></span><br><span class="line">  [INCREMENT](state,payload)&#123;</span><br><span class="line">    state.count += payload.step</span><br><span class="line">  &#125;,</span><br><span class="line">  [DECREMENT](state,payload)&#123;</span><br><span class="line">    state.count -= payload.step</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在组件内提交时</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.$store.commit(&#123;<span class="attr">type</span>:INCREMENT,<span class="attr">step</span>:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure><h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h3><p><code>action</code>是在<code>mutation</code>外包的一层方法, 用来定义触发<code>commit mutation</code>的逻辑, 更主要的是异步逻辑.</p><p>Action 函数接受一个与 store 实例具有相同方法和属性的 context 对象，因此你可以调用 <code>context.commit</code> 提交一个 mutation，或者通过 <code>context.state</code> 和 <code>context.getters</code> 来获取 state 和 getters</p><p>实践中，我们会经常用到 ES6的解构赋值来简化代码（特别是我们需要调用 <code>commit</code> 很多次的时候</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">actions: &#123;</span><br><span class="line">  increment (&#123; commit &#125;) &#123;</span><br><span class="line">    commit(<span class="string">'increment'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Action 通过 store.dispatch 方法触发：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">store.dispatch(<span class="string">'increment'</span>)</span><br></pre></td></tr></table></figure><p>Action 通常是异步的，那么如何知道 action 什么时候结束呢？更重要的是，我们如何才能组合多个 action，以处理更加复杂的异步流程？</p><p>首先，你需要明白 <code>store.dispatch</code> 可以处理被触发的 action 的处理函数返回的 Promise，并且 <code>store.dispatch</code> 仍旧返回 Promise：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">actions: &#123;</span><br><span class="line">  actionA (&#123; commit &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        commit(<span class="string">'someMutation'</span>)</span><br><span class="line">        resolve()</span><br><span class="line">      &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以现在在dispatch时可以:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">store.dispatch(<span class="string">'actionA'</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>在另一个action内也可以:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">actions: &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  actionB (&#123; dispatch, commit &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> dispatch(<span class="string">'actionA'</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      commit(<span class="string">'someOtherMutation'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回到本例,将提交mutation的逻辑全部移入action,将做减法的逻辑改成异步,1秒以后执行,代码如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store配置内</span></span><br><span class="line">actions:&#123;</span><br><span class="line">    <span class="comment">// 用action将mutation包一层,把触发mutation的逻辑写在action中</span></span><br><span class="line">    [INCREMENT](&#123;commit&#125;)&#123;</span><br><span class="line">      <span class="comment">// 对象风格提交方式提交mutation, 与Redux统一</span></span><br><span class="line">      commit(&#123;<span class="attr">type</span>:INCREMENT,<span class="attr">step</span>:<span class="number">1</span>&#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// action可以是异步的,可以用Promise包装</span></span><br><span class="line">    [DECREMENT](&#123;commit&#125;)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          commit(&#123;<span class="attr">type</span>:DECREMENT,<span class="attr">step</span>:<span class="number">1</span>&#125;)</span><br><span class="line">          resolve()</span><br><span class="line">        &#125;, <span class="number">3000</span>);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 组件methods内</span></span><br><span class="line">methods:&#123;</span><br><span class="line">  increment()&#123;</span><br><span class="line">    <span class="keyword">this</span>.$store.dispatch(INCREMENT) </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//store.dispatch可以处理被触发的action的处理函数返回的promiste,dispatch仍旧返回Promise</span></span><br><span class="line">  decrement()&#123;</span><br><span class="line">    <span class="keyword">this</span>.$store.dispatch(DECREMENT).then(<span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="built_in">console</span>.log(<span class="string">'Async deduct works!'</span>)&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h3><p><img src="https://i.loli.net/2017/12/06/5a27a4aade6b2.jpg" alt=""></p><h3 id="全部代码"><a href="#全部代码" class="headerlink" title="全部代码"></a>全部代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用常量替代字符串</span></span><br><span class="line"><span class="keyword">const</span> INCREMENT = <span class="string">'INCREMENT'</span></span><br><span class="line"><span class="keyword">const</span> DECREMENT = <span class="string">'DECREMENT'</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state:&#123;</span><br><span class="line">    count:<span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  getters:&#123;</span><br><span class="line">    <span class="comment">// getter方法的第一个参数是state,第二个参数是getters对象</span></span><br><span class="line">    oddOrEven(state)&#123;</span><br><span class="line">      <span class="keyword">return</span> state.count % <span class="number">2</span> === <span class="number">0</span> ? <span class="string">'even'</span> : <span class="string">'odd'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations:&#123;</span><br><span class="line">    <span class="comment">// ES6计算属性写法,来命名函数名,payload是组件内部提交的&#123;type:string,step:string&#125;的对象</span></span><br><span class="line">    [INCREMENT](state,payload)&#123;</span><br><span class="line">      state.count += payload.step</span><br><span class="line">    &#125;,</span><br><span class="line">    [DECREMENT](state,payload)&#123;</span><br><span class="line">      state.count -= payload.step</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  actions:&#123;</span><br><span class="line">    <span class="comment">// 用action将mutation包一层,把触发mutation的逻辑写在action中</span></span><br><span class="line">    [INCREMENT](&#123;commit&#125;)&#123;</span><br><span class="line">      <span class="comment">// 对象风格提交方式提交mutation, 与Redux统一</span></span><br><span class="line">      commit(&#123;<span class="attr">type</span>:INCREMENT,<span class="attr">step</span>:<span class="number">1</span>&#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// action可以是异步的,可以用Promise包装</span></span><br><span class="line">    [DECREMENT](&#123;commit&#125;)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          commit(&#123;<span class="attr">type</span>:DECREMENT,<span class="attr">step</span>:<span class="number">1</span>&#125;)</span><br><span class="line">          resolve()</span><br><span class="line">        &#125;, <span class="number">3000</span>);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Counter = &#123;</span><br><span class="line">  template:<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;&#123;&#123; count &#125;&#125; is &#123;&#123; oddOrEven &#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;button v-on:click="increment"&gt; + &lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;button v-on:click="decrement"&gt; - (Async) &lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  computed:&#123;</span><br><span class="line">    count()&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.$store.state.count</span><br><span class="line">    &#125;,</span><br><span class="line">    oddOrEven()&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.$store.getters.oddOrEven</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    increment()&#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.dispatch(INCREMENT) </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//store.dispatch可以处理被触发的action的处理函数返回的promiste,dispatch仍旧返回Promise</span></span><br><span class="line">    decrement()&#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.dispatch(DECREMENT).then(<span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="built_in">console</span>.log(<span class="string">'Async deduct works!'</span>)&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  store,</span><br><span class="line">  template: <span class="string">'&lt;Counter/&gt;'</span>,</span><br><span class="line">  components: &#123; Counter &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>现在, 我们已经完成了一个符合Vuex规范的Counter, 其可以完美的运行和异步处理数据, 下一次将会对代码进行拆分解耦, 并在组件内部优化action与getter的部署代码</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;经过上篇的旅程, 已经可以做出一个有Vuex基本功能的Counter了. 为了让Counter的逻辑更完善, 今天引入Getter, Mutation, Action 来继续优化代码&lt;/p&gt;
&lt;h3 id=&quot;Getter&quot;&gt;&lt;a href=&quot;#Getter&quot; class=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Vuex 01 : 入门</title>
    <link href="http://yoursite.com/2017/12/05/10-vuex-01/"/>
    <id>http://yoursite.com/2017/12/05/10-vuex-01/</id>
    <published>2017-12-05T00:18:36.000Z</published>
    <updated>2018-01-27T22:35:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>因为之前学习了Redux, 这次学Vuex就快速多了, 总的来说思路是一样的, 都是用闭包实现了对一些数据的维护, 再用从闭包return出去的方法操作这些数据, 或获得此时闭包数据的snapshot. </p><h3 id="Vuex-安装"><a href="#Vuex-安装" class="headerlink" title="Vuex 安装"></a>Vuex 安装</h3><p>在一个模块化的打包系统中，您必须显式地通过 <code>Vue.use()</code> 来安装 Vuex：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br></pre></td></tr></table></figure><p>当使用script标签引入时, 不需要以上过程.</p><h3 id="什么是状态管理-单向数据流的意义"><a href="#什么是状态管理-单向数据流的意义" class="headerlink" title="什么是状态管理? 单向数据流的意义"></a>什么是状态管理? 单向数据流的意义</h3><p><img src="https://i.loli.net/2017/12/05/5a25e7c210411.jpg" alt=""></p><p>状态自管理应用包含以下几个部分：</p><ul><li><strong>state</strong>，驱动应用的数据源；</li><li><strong>view</strong>，以声明方式将 <strong>state</strong> 映射到视图；</li><li><strong>actions</strong>，响应在 <strong>view</strong> 上的用户输入导致的状态变化。</li></ul><p>简单来说, 就是app维护一个State库, 将很多组件需要共同使用的状态存储在这个库中, 上图的动作可以分解为几个步骤.</p><ol><li><p>需要使用到其中状态数据的组件, 通过<code>State</code>向其传递的<code>props</code>向<code>View</code>层展示数据, </p></li><li><p>在View层操作数据之后, 通过<code>dispatch</code>相应的<code>action</code>修改<code>state</code>中维护的闭包数据,</p></li><li><p>闭包中的数据改变后, 在<code>dispatch</code>方法中, 操作数据得到个更新后的<code>State</code>后, 调用<code>listener</code>数组中的方法, 通知<code>View</code>层更新数据, 这里回到步骤1, <code>View</code>层再次请求<code>State</code>向其传递的<code>props</code></p></li></ol><p>与<strong>后台API接口</strong>结合后, 用vuex官网更形象更具体的图来描述这个过程</p><p><img src="https://i.loli.net/2017/12/06/5a27396e59fd9.png" alt=""></p><h3 id="Vuex-Counter-最初形态"><a href="#Vuex-Counter-最初形态" class="headerlink" title="Vuex Counter 最初形态"></a>Vuex Counter 最初形态</h3><p>具体上简单的代码来实现以下刚才说的东西</p><p>我们采用vue-cli构建,首先来写一个最简单的vue计数器</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Counter = &#123;</span><br><span class="line">  template:<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;&#123;&#123; count &#125;&#125; is &#123;&#123; oddOrEven &#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;button v-on:click="Increase"&gt; + &lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;button v-on:click="Decrease"&gt; - (Async) &lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  data()&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      count:<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed:&#123;</span><br><span class="line">    oddOrEven()&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.count % <span class="number">2</span> === <span class="number">0</span> ? <span class="string">'even'</span> : <span class="string">'odd'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    Increase()&#123;</span><br><span class="line">      <span class="keyword">this</span>.count ++</span><br><span class="line">    &#125;,</span><br><span class="line">    Decrease()&#123;</span><br><span class="line">      <span class="keyword">this</span>.count--</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  template: <span class="string">'&lt;Counter/&gt;'</span>,</span><br><span class="line">  components: &#123; Counter &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2017/12/06/5a27396e6a067.jpg" alt=""></p><p>此时的计数器是完全没有应用状态管理技术的, 虽然引入了vuex.js, 但没有使用, 计数的count完全来自组件内部的data对象.下面要一步步的把他改造成应用状态管理vuex的组件</p><h3 id="创建store-在组件内部引入store-state和store-commit-实现最简单的vuex功能"><a href="#创建store-在组件内部引入store-state和store-commit-实现最简单的vuex功能" class="headerlink" title="创建store,在组件内部引入store.state和store.commit,实现最简单的vuex功能"></a>创建store,在组件内部引入store.state和store.commit,实现最简单的vuex功能</h3><p><code>store</code>就是一个仓库, 是一个容器, 是一个闭包, <code>store</code>中维护者组件中需要的<code>state</code>数据, 和触发这些数据更改的方法</p><p><code>store</code>的存储状态应该是响应式的, 所以最佳实践是<code>store.state</code>中的状态数据通过计算属性返回</p><p>在Vue组件中, 不能直接改变<code>store.state</code>, 只能<code>store.commit(相应的mutation)</code>来改变数据</p><p><code>mutations</code>对象中的键对应的是函数, 其第一个参数是<code>state</code>,在组件内部的<code>methods</code>中,可以在方法内部调用<code>store.commit(mutation)</code>来对应触发<code>store</code>中定义的<code>mutation</code>, 从而修改<code>store.state</code>中的数据</p><p><code>mutation</code>有点像<code>Redux</code>中的<code>action</code>, 不带异步的<code>action</code>, 但不是<code>action creater</code>, 在Vuex中, 有<code>Action</code>更像Redux中的<code>action creater</code>, 这个会在后面进行讨论</p><p>下面把之前的Counter代码修改一下, 让它具备基本的Vuex功能</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span>;</span><br><span class="line"><span class="comment">// 在构建中使用Vuex中间件</span></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state:&#123;</span><br><span class="line">    count:<span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations:&#123;</span><br><span class="line">    <span class="comment">// mutation的第一个参数对应store.state</span></span><br><span class="line">    increment(state)&#123;</span><br><span class="line">      state.count++</span><br><span class="line">      <span class="comment">// this.state.count++</span></span><br><span class="line">    &#125;,</span><br><span class="line">    decrement(state)&#123;</span><br><span class="line">      state.count--</span><br><span class="line">      <span class="comment">// this.state.count--</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Counter = &#123;</span><br><span class="line">  template:<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;&#123;&#123; count &#125;&#125; is &#123;&#123; oddOrEven &#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;button v-on:click="increment"&gt; + &lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;button v-on:click="decrement"&gt; - (Async) &lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  computed:&#123;</span><br><span class="line">    count()&#123;</span><br><span class="line">      <span class="comment">// 由于要保证store.state数据的响应式, 用计算属性返回state中的数据值</span></span><br><span class="line">      <span class="keyword">return</span> store.state.count</span><br><span class="line">    &#125;,</span><br><span class="line">    oddOrEven()&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.count % <span class="number">2</span> === <span class="number">0</span> ? <span class="string">'even'</span> : <span class="string">'odd'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    increment()&#123;</span><br><span class="line">      <span class="comment">// store.commit('对应的mutation名称'),这是提交mutation的方法</span></span><br><span class="line">      store.commit(<span class="string">'increment'</span>) </span><br><span class="line">    &#125;,</span><br><span class="line">    decrement()&#123;</span><br><span class="line">      store.commit(<span class="string">'decrement'</span>) </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  template: <span class="string">'&lt;Counter/&gt;'</span>,</span><br><span class="line">  components: &#123; Counter &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="根组件注入store-mapState辅助函数生成计算属性"><a href="#根组件注入store-mapState辅助函数生成计算属性" class="headerlink" title="根组件注入store, mapState辅助函数生成计算属性"></a>根组件注入store, mapState辅助函数生成计算属性</h3><p>继续改进代码.Vuex 通过 <code>store</code> 选项，提供了一种机制将状态从根组件“注入”到每一个子组件中（需调用 <code>Vue.use(Vuex)</code>）：</p><p>通过在根实例中注册 <code>store</code> 选项，该 <code>store</code> 实例会注入到根组件下的所有子组件中，且子组件能通过 <code>this.$store</code>访问到。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span>;</span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state:&#123;</span><br><span class="line">    count:<span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations:&#123;</span><br><span class="line">    increment(state)&#123;</span><br><span class="line">      state.count++</span><br><span class="line">      <span class="comment">// this.state.count++</span></span><br><span class="line">    &#125;,</span><br><span class="line">    decrement(state)&#123;</span><br><span class="line">      state.count--</span><br><span class="line">      <span class="comment">// this.state.count--</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Counter = &#123;</span><br><span class="line">  template:<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;&#123;&#123; count &#125;&#125; is &#123;&#123; oddOrEven &#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;button v-on:click="increment"&gt; + &lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;button v-on:click="decrement"&gt; - (Async) &lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  computed:&#123;</span><br><span class="line">    count()&#123;</span><br><span class="line">      <span class="comment">// 这里因为根组件注入了store, 可以访问到this.$store对象了.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.$store.state.count</span><br><span class="line">    &#125;,</span><br><span class="line">    oddOrEven()&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.count % <span class="number">2</span> === <span class="number">0</span> ? <span class="string">'even'</span> : <span class="string">'odd'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    increment()&#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">'increment'</span>) </span><br><span class="line">    &#125;,</span><br><span class="line">    decrement()&#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">'decrement'</span>) </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  <span class="comment">// 根组件处注入store, 子组件全部可以访问store中的状态数据</span></span><br><span class="line">  store,</span><br><span class="line">  template: <span class="string">'&lt;Counter/&gt;'</span>,</span><br><span class="line">  components: &#123; Counter &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>下面,我们加入<code>mapState</code>,这个函数可以辅助生成计算属性,若映射的计算属性与state的子节点名称相同时,也可以传一个字符串数组</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">computed: mapState([</span><br><span class="line">  <span class="comment">// 映射 this.count 为 store.state.count</span></span><br><span class="line">  <span class="string">'count'</span></span><br><span class="line">])</span><br></pre></td></tr></table></figure><p>由于处于学习阶段, 下面的代码是展开版的<code>mapState</code>,虽然<code>this.state.count</code>与<code>store.state.count</code>的节点名都叫<code>count</code>,但像下面这样写还兼容了计算属性<code>oddOrEven</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Vuex, &#123; mapState &#125; <span class="keyword">from</span> <span class="string">'vuex'</span>;</span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    count: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment(state) &#123;</span><br><span class="line">      state.count++</span><br><span class="line">      <span class="comment">// this.state.count++</span></span><br><span class="line">    &#125;,</span><br><span class="line">    decrement(state) &#123;</span><br><span class="line">      state.count--</span><br><span class="line">      <span class="comment">// this.state.count-- </span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Counter = &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;&#123;&#123; count &#125;&#125; is &#123;&#123; oddOrEven &#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;button v-on:click="increment"&gt; + &lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;button v-on:click="decrement"&gt; - (Async) &lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  computed: mapState(&#123;</span><br><span class="line">    count: <span class="function"><span class="params">state</span> =&gt;</span> state.count,</span><br><span class="line">    oddOrEven(state) &#123;</span><br><span class="line">      <span class="keyword">return</span> state.count % <span class="number">2</span> === <span class="number">0</span> ? <span class="string">'even'</span> : <span class="string">'odd'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;),</span><br><span class="line">  methods: &#123;</span><br><span class="line">    increment() &#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">'increment'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    decrement() &#123;</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">'decrement'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  store,</span><br><span class="line">  template: <span class="string">'&lt;Counter/&gt;'</span>,</span><br><span class="line">  components: &#123; Counter &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>至此, 根组件已经注入了在状态仓库<code>store</code>, <code>this.$store</code>在Vue组件内部可访问, 组件和视图间的数据传递和更新用Vuex实现.</p><p>下一篇, 主要说说关于<code>computed</code>属性中的<code>Getter</code>与和methods中的<code>Mutation</code>的改造.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;因为之前学习了Redux, 这次学Vuex就快速多了, 总的来说思路是一样的, 都是用闭包实现了对一些数据的维护, 再用从闭包return出去的方法操作这些数据, 或获得此时闭包数据的snapshot. &lt;/p&gt;
&lt;h3 id=&quot;Vuex-安装&quot;&gt;&lt;a href=&quot;#Vue
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>React高阶组件(1):Intro</title>
    <link href="http://yoursite.com/2017/11/20/9-React%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B61%20:%20Intro/"/>
    <id>http://yoursite.com/2017/11/20/9-React高阶组件1 : Intro/</id>
    <published>2017-11-20T00:03:53.000Z</published>
    <updated>2017-11-20T08:43:02.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="引子-高阶函数"><a href="#引子-高阶函数" class="headerlink" title="引子,高阶函数"></a>引子,高阶函数</h3><p>收函数作为输入，或者输出另一个函数的一类函数，被称作高阶函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'hello chotee'</span>)  </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrapped</span>(<span class="params"> fn </span>) </span>&#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'wrapped'</span>)</span><br><span class="line">    fn()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">hello = wrapped(hello)</span><br><span class="line"></span><br><span class="line">hello() <span class="comment">// wrapped hello chotee</span></span><br></pre></td></tr></table></figure><p>容易出现混淆的一点是: 虽然在hello = wrapped(hello) 这句话执行之后, hello这个变量指向的函数发生了变化, 但传入wrapped闭包内部的hello却仍然是最初定义的hello, 并没有被改写. </p><p>原因是进入wrapped内部执行后, 形参fn重新指向了最初hello定义时所指向的地址, 且wrapped运行完成后由于闭包形成, 这个地址不会被释放. 所以虽然hello重新被赋值, 但传入的函数在闭包内部却不会随着赋值操作发生改变.</p><h3 id="简单的React高阶组件"><a href="#简单的React高阶组件" class="headerlink" title="简单的React高阶组件"></a>简单的React高阶组件</h3><p>高阶组件的定义类似高阶函数, 它描述的便是接受React组件作为输入，输出一个新的React组件的组件。</p><p>实现一个withHeader的高阶组件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 普通React组件Hello</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;这是Hello组件&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 定义一个包裹函数,参数是传入的'要被包裹的组件',return一个'包裹着参数组件的高阶组件'</span></span><br><span class="line"><span class="regexp">function withHeader(Component) &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    class HOC extends React.Component &#123;</span></span><br><span class="line"><span class="regexp">      render() &#123;</span></span><br><span class="line"><span class="regexp">        return (</span></span><br><span class="line"><span class="regexp">          &lt;div&gt;</span></span><br><span class="line"><span class="regexp">            &lt;h1&gt;wrapped Header&lt;/</span>h1&gt;</span><br><span class="line">            &lt;Component &#123;...this.props&#125;&gt;<span class="xml"><span class="tag">&lt;/<span class="name">Component</span>&gt;</span></span></span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 被withHeader包裹后的组件高阶组件HelloWithHeader</span></span><br><span class="line"><span class="regexp">const HelloWithHeader = withHeader(Hello)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">ReactDOM.render(</span></span><br><span class="line"><span class="regexp">  &lt;div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;HelloWithHeader&gt;&lt;/</span>HelloWithHeader&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root'));</span></span><br></pre></td></tr></table></figure><ul><li>渲染结果</li></ul><p><img src="https://i.loli.net/2017/11/20/5a12442bbf77d.png" alt="Jietu20171120-105321"></p><ul><li>dom结构<br><img src="https://i.loli.net/2017/11/20/5a124442cdf6c.png" alt="Jietu20171120-105501"></li></ul><h3 id="关于上述代码的对象展开语法的注意点"><a href="#关于上述代码的对象展开语法的注意点" class="headerlink" title="关于上述代码的对象展开语法的注意点"></a>关于上述代码的对象展开语法的注意点</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;WrappedComponent &#123;...this.props&#125;/&gt;</span><br><span class="line"><span class="comment">// is equivalent to</span></span><br><span class="line">React.createElement(WrappedComponent, <span class="keyword">this</span>.props, <span class="literal">null</span>)</span><br></pre></td></tr></table></figure><h3 id="ES7-装饰器写法"><a href="#ES7-装饰器写法" class="headerlink" title="ES7 装饰器写法"></a>ES7 装饰器写法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里省略了和上面例子一模一样的withHeader函数的定义代码</span></span><br><span class="line"></span><br><span class="line">@withHeader <span class="comment">// @ withHeader 等同于写了 Hello = withHeader(Hello)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;这是Hello组件&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">ReactDOM.render(</span></span><br><span class="line"><span class="regexp">  &lt;div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;Hello&gt;&lt;/</span>Hello&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root')); /</span><span class="regexp">/得到与上面同样结果</span></span><br></pre></td></tr></table></figure><h3 id="柯里化-组件参数"><a href="#柯里化-组件参数" class="headerlink" title="柯里化,组件参数"></a>柯里化,组件参数</h3><blockquote><p>柯里化 Curry<br>概念: 只传递函数的一部分参数来调用它,让它返回一个函数去处理剩下的参数<br>函数签名:func(params)(otherParams)<br>应用: 在React里,通过柯里化,通过传入不同的参数得到不同的高阶组件</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需求:在刚才的例子里, 在h1标签里输出传入的参数title,以这个需求改造withHeader</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withHeader</span>(<span class="params">title</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">Component</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="class"><span class="keyword">class</span> <span class="title">HOC</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">        render() &#123;</span><br><span class="line">          <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">              &lt;h1&gt;&#123;<span class="string">`包裹的是一个名字叫<span class="subst">$&#123;title&#125;</span>的组件`</span>&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">              &lt;Component &#123;...this.props&#125;&gt;&lt;/</span>Component&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          )</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 注意这里为了区分特意传入了小写'h'开头的'hello'参数</span></span><br><span class="line"><span class="regexp">@withHeader('hello')</span></span><br><span class="line"><span class="regexp">class Hello extends React.Component &#123;</span></span><br><span class="line"><span class="regexp">  render() &#123;</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;这是Hello组件&lt;/</span>div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Hello&gt;<span class="xml"><span class="tag">&lt;/<span class="name">Hello</span>&gt;</span></span></span><br><span class="line">  &lt;<span class="regexp">/div&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root'))</span></span><br></pre></td></tr></table></figure><ul><li><p>渲染结果<br><img src="https://i.loli.net/2017/11/20/5a12502b3ffe1.png" alt="Jietu20171120-114530"></p></li><li><p>使用ES6写法可以更加简洁</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> withHeader = <span class="function">(<span class="params">title</span>) =&gt;</span> (Component) =&gt; (</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">HOC</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;h1&gt;&#123;<span class="string">`包裹的是一个名字叫<span class="subst">$&#123;title&#125;</span>的组件`</span>&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Component &#123;...this.props&#125;&gt;&lt;/</span>Component&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;)</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="属性代理"><a href="#属性代理" class="headerlink" title="属性代理"></a>属性代理</h3><p>高阶组件有两种常见的使用方式,第一种是属性代理,第二种是反向继承,直接上属性代理的示例代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将被包裹组件的props和新生成的props一起传递给被包裹的组件,称之为属性代理</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withHeader</span>(<span class="params">Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HOC</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">      render() &#123;</span><br><span class="line">        <span class="keyword">const</span> newProps = &#123;</span><br><span class="line">          test : <span class="string">'HOC'</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;h1&gt;wrapped Header&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Component &#123;...newProps &#125; &#123;...this.props&#125; &gt;&lt;/</span>Component&gt;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">@withHeader</span></span><br><span class="line"><span class="regexp">class Hello extends React.Component &#123;</span></span><br><span class="line"><span class="regexp">  render() &#123;</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;这是Hello组件&lt;/</span>div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Hello&gt;<span class="xml"><span class="tag">&lt;/<span class="name">Hello</span>&gt;</span></span></span><br><span class="line">  &lt;<span class="regexp">/div&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root'))</span></span><br></pre></td></tr></table></figure><h3 id="反向继承"><a href="#反向继承" class="headerlink" title="反向继承"></a>反向继承</h3><p>这种方式返回的React组件继承了被传入的组件，所以它能够访问到的区域、权限更多，相比属性代理方式，它更像打入组织内部，对其进行修改。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">withHeader</span>(<span class="params">Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HOC</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">      componentDidMount() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'这是高阶组件额外的生命周期'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      render() &#123;</span><br><span class="line">        <span class="comment">// super([arguments]),调用父类的构造函数</span></span><br><span class="line">        <span class="comment">// super.xxx,调用父类上的xxx方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.render() </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@withHeader</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;这是Hello组件&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">ReactDOM.render(</span></span><br><span class="line"><span class="regexp">  &lt;div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;Hello&gt;&lt;/</span>Hello&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root'))</span></span><br></pre></td></tr></table></figure><h3 id="REFERENCE"><a href="#REFERENCE" class="headerlink" title="REFERENCE"></a>REFERENCE</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/28138664" target="_blank" rel="noopener">深入浅出React高阶组件</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;引子-高阶函数&quot;&gt;&lt;a href=&quot;#引子-高阶函数&quot; class=&quot;headerlink&quot; title=&quot;引子,高阶函数&quot;&gt;&lt;/a&gt;引子,高阶函数&lt;/h3&gt;&lt;p&gt;收函数作为输入，或者输出另一个函数的一类函数，被称作高阶函数&lt;/p&gt;
&lt;figure class=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>由 &quot;对象深拷贝&quot; 引发的思考</title>
    <link href="http://yoursite.com/2017/11/15/8-%E7%94%B1%22%E5%AF%B9%E8%B1%A1%E6%B7%B1%E6%8B%B7%E8%B4%9D%22%E5%BC%95%E5%8F%91%E7%9A%84%E5%B0%9D%E8%AF%95/"/>
    <id>http://yoursite.com/2017/11/15/8-由&quot;对象深拷贝&quot;引发的尝试/</id>
    <published>2017-11-15T00:03:53.000Z</published>
    <updated>2017-11-20T02:13:44.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="今天做什么"><a href="#今天做什么" class="headerlink" title="今天做什么?"></a>今天做什么?</h3><p>今天在用到<code>Object.assign</code>方法时,发现这个方法进行的是对象的浅拷贝. 借此契机复习一下浅拷贝与深拷贝的知识, 解决一些实际问题.</p><h3 id="Object-assign"><a href="#Object-assign" class="headerlink" title="Object.assign"></a>Object.assign</h3><p>  首先说下<code>Object.assign</code>方法,这是一个es6方法, 可以用来合并对象,直接上代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">  a: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> b = &#123;</span><br><span class="line">  a: <span class="number">2</span>,</span><br><span class="line">  b: &#123;</span><br><span class="line">    a: <span class="number">1</span>,</span><br><span class="line">    b: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> c = <span class="built_in">Object</span>.assign(a, b)</span><br><span class="line"><span class="built_in">console</span>.log(c) <span class="comment">// &#123; a:2,b:&#123;a:1,b:2&#125; &#125;</span></span><br></pre></td></tr></table></figure><p>但是在上述代码下面再加一行,将b对象b属性中a的值由1改成3,再打印c的值,得:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b.b.a = <span class="number">3</span></span><br><span class="line"><span class="built_in">console</span>.log(c) <span class="comment">// &#123; a:2,b:&#123;a:3,b:2&#125; &#125;</span></span><br></pre></td></tr></table></figure><p>可见,Object.assign中的拷贝,是浅拷贝. </p><h3 id="什么是浅拷贝"><a href="#什么是浅拷贝" class="headerlink" title="什么是浅拷贝?"></a>什么是浅拷贝?</h3><p>即在给对象赋值时 (比如本例中<code>Object.assign</code>方法要给对象c的b属性赋值为<code>b.b</code>的值<code>{a:1,b:2}</code>) , </p><p>只将另一个对象 (本例中的<code>b.b</code>)在内存栈中的引用传递了过去,并没有在堆中开辟新的空间用来存储一个新的对象<code>c.b</code>的值),</p><p>所以在后面例子中当<code>b.b</code>中的属性a改变时, 由于<code>c.b</code>与<code>b.b</code>指向了堆中的同一个地址, 导致<code>c.b.a</code>也发生了改变.</p><h3 id="什么是深拷贝"><a href="#什么是深拷贝" class="headerlink" title="什么是深拷贝?"></a>什么是深拷贝?</h3><p>给对象赋值时,在堆中开辟新的空间用来存储对象的数据,形成新的地址传给栈,将要赋的值复制过来放在新的空间中. 这就是深拷贝</p><h3 id="浅拷贝的代码实现"><a href="#浅拷贝的代码实现" class="headerlink" title="浅拷贝的代码实现"></a>浅拷贝的代码实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123; <span class="attr">a</span>:<span class="number">1</span>, <span class="attr">arr</span>: [<span class="number">2</span>,<span class="number">3</span>] &#125;;</span><br><span class="line"><span class="keyword">var</span> shallowObj = shallowCopy(obj); <span class="comment">// &#123;a:1,arr[2:3]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shallowCopy</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="keyword">if</span> (obj.hasOwnProperty(prop)) &#123;</span><br><span class="line">      result[prop] = obj[prop];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shallowObj.arr[<span class="number">1</span>] = <span class="number">5</span>;</span><br><span class="line">obj.arr[<span class="number">1</span>]   <span class="comment">// = 5</span></span><br></pre></td></tr></table></figure><p>浅复制只会将对象的各个属性进行依次复制，并不会进行递归复制，而 JavaScript 存储对象都是存地址的，所以浅复制会导致 obj.arr 和 shallowObj.arr 指向同一块内存地址，大概的示意图如下。</p><p><img src="https://pic4.zhimg.com/50/v2-39761dfd012733879e0d100ec260a5d7_hd.jpg" alt="enter image description here"></p><p>而深复制则不同，它不仅将原对象的各个属性逐个复制出去，而且将原对象各个属性所包含的对象也依次采用深复制的方法递归复制到新对象上。这就不会存在上面 obj 和 shallowObj 的 arr 属性指向同一个对象的问题。</p><p><img src="https://pic1.zhimg.com/50/6604224933c95787764d941432a1f968_hd.jpg" alt="enter image description here"></p><h3 id="深拷贝的代码实现"><a href="#深拷贝的代码实现" class="headerlink" title="深拷贝的代码实现"></a>深拷贝的代码实现</h3><p>简单的说就是”遇到复制对象就递归,一直到拷贝值,才进行拷贝”,因为进行对象属性的赋值运算时,会在堆内自动开辟空间存储值,从而实现深拷贝</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123; <span class="attr">a</span>:<span class="number">1</span>, <span class="attr">arr</span>: [<span class="number">2</span>,<span class="number">3</span>] &#125;;</span><br><span class="line"><span class="keyword">var</span> deepObj = deepCopy(obj);</span><br><span class="line"></span><br><span class="line">deepObj.arr[<span class="number">1</span>] = <span class="number">5</span>;</span><br><span class="line">obj.arr[<span class="number">1</span>]   <span class="comment">// = 3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deepCopy</span>(<span class="params">obj, start</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  start = start || &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> obj) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj.hasOwnProperty(i)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (obj[i] <span class="keyword">instanceof</span> <span class="built_in">Function</span>) &#123;</span><br><span class="line">        start[i] = obj[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj[i] <span class="keyword">instanceof</span> <span class="built_in">Object</span>) &#123;</span><br><span class="line">        start[i] = (obj[i] <span class="keyword">instanceof</span> <span class="built_in">Array</span>) ? []:&#123;&#125;</span><br><span class="line">        deepCopy(obj[i], start[i])</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        start[i] = obj[i]</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> start</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="一道面试题"><a href="#一道面试题" class="headerlink" title="一道面试题"></a>一道面试题</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj1 = &#123;</span><br><span class="line">  a: <span class="number">1</span>,</span><br><span class="line">  b: &#123;</span><br><span class="line">    a: <span class="number">22</span>,</span><br><span class="line">    b: <span class="number">33</span>,</span><br><span class="line">    c: <span class="number">44</span></span><br><span class="line">  &#125;,</span><br><span class="line">  c: <span class="number">55</span>,</span><br><span class="line">  d: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  e: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj2 = &#123;</span><br><span class="line">  a: <span class="number">2</span>,</span><br><span class="line">  b: &#123;</span><br><span class="line">    a: <span class="number">33</span>,</span><br><span class="line">    c: &#123;</span><br><span class="line">      a: <span class="number">44</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  e: [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写一个方法,合并对象obj1,与obj2,要求输出</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   a: 2,</span></span><br><span class="line"><span class="comment">//   b: &#123;</span></span><br><span class="line"><span class="comment">//     a: 33,</span></span><br><span class="line"><span class="comment">//     b: 33,</span></span><br><span class="line"><span class="comment">//     c: &#123;</span></span><br><span class="line"><span class="comment">//       a: 44</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">//   c: 55,</span></span><br><span class="line"><span class="comment">//   d: function () &#123;</span></span><br><span class="line"><span class="comment">//     return false</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line"><span class="comment">//   e: [1, 3, 5, 4, 5]</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure><p>上面这个面试题,比深拷贝复杂一点, 仔细分析需求, 发现在要拷贝的属性与原对象属性重名,且类型一样时,需要保留原对象属性的未修改字段,那么需要对前面的算法做一些修改</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeObj</span>(<span class="params">obj, start</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  start = start || &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> obj) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj.hasOwnProperty(i)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (obj[i] <span class="keyword">instanceof</span> <span class="built_in">Function</span>) &#123;</span><br><span class="line">        start[i] = obj[i]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj[i] <span class="keyword">instanceof</span> <span class="built_in">Object</span>) &#123;</span><br><span class="line"></span><br><span class="line">        start[i] = (obj[i] <span class="keyword">instanceof</span> <span class="built_in">Array</span>) ?</span><br><span class="line">          <span class="comment">/* 如果原对象的[i]属性也是数组,则将原对象[i]属性对</span></span><br><span class="line"><span class="comment">          应的数组传入,否则传入一个空数组 */</span></span><br><span class="line">          ((start[i] <span class="keyword">instanceof</span> <span class="built_in">Array</span>) ? start[i] : []) :</span><br><span class="line">          <span class="comment">/* 如果原对象的[i]属性也是对象,则将原对象[i]属性</span></span><br><span class="line"><span class="comment">          对应的对象传入,否则传入一个空对象 */</span></span><br><span class="line">          ((start[i] <span class="keyword">instanceof</span> <span class="built_in">Object</span>) ? start[i] : &#123;&#125;)</span><br><span class="line">        deepCopy(obj[i], start[i])</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        start[i] = obj[i]</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(mergeObj(obj1,obj2))</span><br></pre></td></tr></table></figure><h3 id="黑科技JSON直接进行深拷贝对象"><a href="#黑科技JSON直接进行深拷贝对象" class="headerlink" title="黑科技JSON直接进行深拷贝对象"></a>黑科技JSON直接进行深拷贝对象</h3><p>其实不涉及复杂的需求时,将一个对象深拷贝最简单的方式是用JSON.stringify直接转为字符串,然后用JSON.parse直接创建一个字面量对象<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  a: <span class="number">2</span>,</span><br><span class="line">  b: &#123;</span><br><span class="line">    a: <span class="number">1</span>,</span><br><span class="line">    b: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(obj)))</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;今天做什么&quot;&gt;&lt;a href=&quot;#今天做什么&quot; class=&quot;headerlink&quot; title=&quot;今天做什么?&quot;&gt;&lt;/a&gt;今天做什么?&lt;/h3&gt;&lt;p&gt;今天在用到&lt;code&gt;Object.assign&lt;/code&gt;方法时,发现这个方法进行的是对象的浅拷贝. 借此契
      
    
    </summary>
    
    
      <category term="算法" scheme="http://yoursite.com/tags/%E7%AE%97%E6%B3%95/"/>
    
      <category term="面试" scheme="http://yoursite.com/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Redux 6: React Router 4 + Redux 数据流 模拟注册登录</title>
    <link href="http://yoursite.com/2017/11/14/7-React%20Router%204%20+%20Redux%20%E6%95%B0%E6%8D%AE%E6%B5%81%20%E6%A8%A1%E6%8B%9F%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95/"/>
    <id>http://yoursite.com/2017/11/14/7-React Router 4 + Redux 数据流 模拟注册登录/</id>
    <published>2017-11-14T00:03:53.000Z</published>
    <updated>2017-12-20T03:56:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="BEFORE"><a href="#BEFORE" class="headerlink" title="BEFORE"></a>BEFORE</h2><p>在Redux学习的三篇学习笔记之后,加上React-Router 4的学习,模拟了一个注册登录+计数器的Redux数据流</p><h2 id="CODE"><a href="#CODE" class="headerlink" title="CODE"></a>CODE</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js Provider,路由,根组件挂载处</span></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;BrowserRouter&gt;</span><br><span class="line">      &#123;<span class="comment">/* Switch:命中第一个路由后不再继续跳转 */</span>&#125;</span><br><span class="line">      &lt;Switch&gt;</span><br><span class="line">        &#123;<span class="comment">/* Route匹配路由跳转路径与组件间的关系,exact开启精确匹配,不再继续向下查找 */</span>&#125;</span><br><span class="line">        &lt;Route path='/login' exact component=&#123;Auth&#125;&gt;&lt;/Route&gt;</span><br><span class="line">        &lt;Route path='/dashboard' component=&#123;DashBoard&#125;&gt;&lt;/Route&gt;</span><br><span class="line">        &#123;<span class="comment">/* Redirect发起重定向 */</span>&#125;</span><br><span class="line">        &lt;Redirect to='/dashboard'&gt;&lt;/Redirect&gt;</span><br><span class="line">      &lt;/Switch&gt;</span><br><span class="line">    &lt;/BrowserRouter&gt;</span><br><span class="line">  &lt;/Provider&gt;,</span><br><span class="line">  document.getElementById(<span class="string">'root'</span>));</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Auth.redux.js</span></span><br><span class="line"><span class="comment">// 权限登录的reducer与action creater</span></span><br><span class="line"><span class="comment">// isAuth代表是否登录</span></span><br><span class="line"><span class="keyword">const</span> LOGIN = <span class="string">'LOGIN'</span></span><br><span class="line"><span class="keyword">const</span> LOGOUT = <span class="string">'LOGOUT'</span></span><br><span class="line"><span class="comment">//reducer</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AuthReducer = <span class="function">(<span class="params">state = &#123; isAuth: <span class="literal">false</span>, user: <span class="string">'choteewang'</span> &#125;, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> LOGIN:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    <span class="keyword">case</span> LOGOUT:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//action creater</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> login = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGIN &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> logout = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGOUT &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//myRedux.js</span></span><br><span class="line"><span class="keyword">const</span> INCREASE = <span class="string">'increase'</span></span><br><span class="line"><span class="keyword">const</span> DECREASE = <span class="string">'decrease'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducer = <span class="function">(<span class="params">state  = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increase'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrease'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: INCREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onDecrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: DECREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncreaseAsync = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      dispatch(onIncrease())</span><br><span class="line">    &#125;,<span class="number">3000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//reducer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; reducer &#125; <span class="keyword">from</span> <span class="string">'./myRedux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthReducer &#125; <span class="keyword">from</span> <span class="string">'./Auth.redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="comment">// 利用combineReducers合并两个Reducer</span></span><br><span class="line"><span class="comment">// 变为store中的state对象包裹2个reducer定义的state小对象的数据结构&#123;counter:&#123;&#125;,AutuReducer:&#123;&#125;&#125;</span></span><br><span class="line"><span class="comment">// 这里要注意改键名,防止之前使用小state的组件访问根组件state时key名发生错误</span></span><br><span class="line"><span class="comment">// 所以最佳实践是reducer要起名要有语义</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> combineReducers(&#123;<span class="attr">counter</span>:reducer, <span class="attr">AuthReducer</span>:AuthReducer&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Auth.js</span></span><br><span class="line"><span class="keyword">import</span> React from <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; from <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123;login&#125; from <span class="string">'./Auth.redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Redirect&#125; from <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">  render()&#123;</span><br><span class="line">    const redirect = &lt;Redirect to='/dashboard'&gt;&lt;/Redirect&gt;</span><br><span class="line">    <span class="keyword">const</span> login = (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h3&gt;您没登录,请登录&lt;/h3&gt;</span><br><span class="line">        &lt;button onClick=&#123;this.props.login&#125;&gt;点我模拟登录&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 若登录了,则跳转到dashboard页面,若没登录,显示登录页面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.isAuth ? redirect : login</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> Auth = connect(</span><br><span class="line">  (state) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      isAuth:state.AuthReducer.isAuth,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;login&#125;</span><br><span class="line">)(Auth)</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dashboard.js</span></span><br><span class="line"><span class="keyword">import</span> React from <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; from <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123;login&#125; from <span class="string">'./Auth.redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Redirect&#125; from <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">  render()&#123;</span><br><span class="line">    const redirect = &lt;Redirect to='/dashboard'&gt;&lt;/Redirect&gt;</span><br><span class="line">    <span class="keyword">const</span> login = (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h3&gt;您没登录,请登录&lt;/h3&gt;</span><br><span class="line">        &lt;button onClick=&#123;this.props.login&#125;&gt;点我模拟登录&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 若登录了,则跳转到dashboard页面,若没登录,显示登录页面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.isAuth ? redirect : login</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> Auth = connect(</span><br><span class="line">  (state) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      isAuth:state.AuthReducer.isAuth,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;login&#125;</span><br><span class="line">)(Auth)</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.js</span></span><br><span class="line"><span class="keyword">import</span> React from <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; from <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123;login&#125; from <span class="string">'./Auth.redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Redirect&#125; from <span class="string">'react-router-dom'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">  render()&#123;</span><br><span class="line">    const redirect = &lt;Redirect to='/dashboard'&gt;&lt;/Redirect&gt;</span><br><span class="line">    <span class="keyword">const</span> login = (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h3&gt;您没登录,请登录&lt;/h3&gt;</span><br><span class="line">        &lt;button onClick=&#123;this.props.login&#125;&gt;点我模拟登录&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 若登录了,则跳转到dashboard页面,若没登录,显示登录页面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.isAuth ? redirect : login</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> Auth = connect(</span><br><span class="line">  (state) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      isAuth:state.AuthReducer.isAuth,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;login&#125;</span><br><span class="line">)(Auth)</span><br></pre></td></tr></table></figure><h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="https://i.loli.net/2017/11/14/5a0a34278b587.png" alt="Jietu20171112-085631"></p><p><img src="https://i.loli.net/2017/11/14/5a0a343ce1d95.png" alt="Jietu20171112-085643"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;BEFORE&quot;&gt;&lt;a href=&quot;#BEFORE&quot; class=&quot;headerlink&quot; title=&quot;BEFORE&quot;&gt;&lt;/a&gt;BEFORE&lt;/h2&gt;&lt;p&gt;在Redux学习的三篇学习笔记之后,加上React-Router 4的学习,模拟了一个注册登录+计数器的R
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redux 5: 使用axios 配合redux 实现 异步请求的Redux数据流</title>
    <link href="http://yoursite.com/2017/11/14/6-%E4%BD%BF%E7%94%A8axios%E9%85%8D%E5%90%88Redux%E5%AE%9E%E7%8E%B0%20%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E5%90%8E%E5%8F%B0%E6%95%B0%E6%8D%AE%E7%9A%84Redux%E6%95%B0%E6%8D%AE%E6%B5%81/"/>
    <id>http://yoursite.com/2017/11/14/6-使用axios配合Redux实现 异步请求后台数据的Redux数据流/</id>
    <published>2017-11-14T00:02:52.000Z</published>
    <updated>2017-12-20T03:56:54.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前置知识-axios-API"><a href="#前置知识-axios-API" class="headerlink" title="前置知识 axios API"></a>前置知识 axios API</h2><p><a href="https://www.kancloud.cn/yunye/axios/234845" target="_blank" rel="noopener">axios API</a></p><h2 id="CODE"><a href="#CODE" class="headerlink" title="CODE"></a>CODE</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Express Server Code</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建express服务</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line">app.get(<span class="string">'/data'</span>,(req,res) =&gt; &#123;</span><br><span class="line">  res.json(&#123;<span class="attr">hobby</span>:<span class="string">"basketball"</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3001</span>,() =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'chotee server'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="package-json-配置proxy字段-解决跨域问题"><a href="#package-json-配置proxy字段-解决跨域问题" class="headerlink" title="package.json 配置proxy字段,解决跨域问题"></a>package.json 配置proxy字段,解决跨域问题</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"proxy":"http://localhost:3001"</span><br></pre></td></tr></table></figure><h3 id="Auth-redux-js"><a href="#Auth-redux-js" class="headerlink" title="Auth.redux.js"></a>Auth.redux.js</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 权限登录的AuthReducer与action creater</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="keyword">const</span> LOGIN = <span class="string">'LOGIN'</span></span><br><span class="line"><span class="keyword">const</span> LOGOUT = <span class="string">'LOGOUT'</span></span><br><span class="line"><span class="keyword">const</span> GETUSERDATA = <span class="string">'GETUSERDATA'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//initState</span></span><br><span class="line"><span class="keyword">const</span> initState = &#123;</span><br><span class="line">  name: <span class="string">'choteewang'</span>,</span><br><span class="line">  isAuth: <span class="literal">false</span>,</span><br><span class="line">  hobby: <span class="string">'football'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//reducer</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AuthReducer = <span class="function">(<span class="params">state = initState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> LOGIN:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    <span class="keyword">case</span> LOGOUT:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="keyword">case</span> GETUSERDATA:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">hobby</span>: action.payload &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//action creater</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增支持异步请求的action creater, 返回一个函数,函数参数是store.dispatch与store.getState</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getUserData = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 在return出的函数内进行异步请求</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    axios.get(<span class="string">'/data'</span>).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(res)</span><br><span class="line">      <span class="comment">// res是axios的响应数据,格式见下面图</span></span><br><span class="line">      <span class="keyword">if</span> (res.status === <span class="number">200</span>) &#123;</span><br><span class="line">        dispatch(getuserdataAsync(res.data.hobby))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getuserdataAsync = <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="attr">type</span>: GETUSERDATA, <span class="attr">payload</span>: data&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> login = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGIN &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> logout = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGOUT &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2017/11/14/5a0a3b5b0874e.png" alt="Jietu20171114-083933"></p><h3 id="Auth-js-对应路由-login"><a href="#Auth-js-对应路由-login" class="headerlink" title="Auth.js 对应路由/login"></a>Auth.js 对应路由/login</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123; login, getUserData &#125; <span class="keyword">from</span> <span class="string">'./Auth.redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Redirect &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="comment">// 组件mount完成后发起异步请求,这里的getUserData是经过react-thunk中间件处理的action creater</span></span><br><span class="line">    <span class="keyword">this</span>.props.getUserData()</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> redirect = <span class="xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">'/dashboard'</span>&gt;</span><span class="tag">&lt;/<span class="name">Redirect</span>&gt;</span></span></span><br><span class="line">    <span class="keyword">const</span> login = (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;p&gt;&#123;<span class="string">`我叫<span class="subst">$&#123;<span class="keyword">this</span>.props.name&#125;</span>,我的爱好是<span class="subst">$&#123;<span class="keyword">this</span>.props.hobby&#125;</span>`</span>&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">        &lt;h3&gt;您没登录,请登录&lt;/</span>h3&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="keyword">this</span>.props.login&#125;&gt;点我模拟登录&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 若登录了,则跳转到dashboard页面,若没登录,显示登录页面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.isAuth ? redirect : login</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Auth = connect(</span><br><span class="line">  <span class="comment">//引入AuthReducer的字段给Auth的UI组件作为参数</span></span><br><span class="line">  (state) =&gt; state.AuthReducer,</span><br><span class="line">  <span class="comment">// 拿到getUserData的actionCreater</span></span><br><span class="line">  &#123; login, getUserData &#125;</span><br><span class="line">)(Auth)</span><br></pre></td></tr></table></figure><h3 id="config-js-设置全局拦截器"><a href="#config-js-设置全局拦截器" class="headerlink" title="config.js 设置全局拦截器"></a>config.js 设置全局拦截器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置全局拦截器的config.js,在根组件页面index.js页面引入</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Toast &#125; <span class="keyword">from</span> <span class="string">'antd-mobile'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加请求拦截器</span></span><br><span class="line">axios.interceptors.request.use(<span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 在发送请求之前做些什么</span></span><br><span class="line">  Toast.loading(<span class="string">'请求中'</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 对请求错误做些什么</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加响应拦截器</span></span><br><span class="line">axios.interceptors.response.use(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 对响应数据做点什么</span></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    Toast.hide()</span><br><span class="line">  &#125;, <span class="number">5000</span>);</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 对响应错误做点什么</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="https://i.loli.net/2017/11/14/5a0a32dfd3da7.png" alt="Jietu20171112-111033"></p><h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/choteewang/BLOG-NOTE/tree/master/Demos/axios+redux_demo" target="_blank" rel="noopener">https://github.com/choteewang/BLOG-NOTE/tree/master/Demos/axios+redux_demo</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前置知识-axios-API&quot;&gt;&lt;a href=&quot;#前置知识-axios-API&quot; class=&quot;headerlink&quot; title=&quot;前置知识 axios API&quot;&gt;&lt;/a&gt;前置知识 axios API&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.k
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redux 4 :关于combineReducers生成的数据结构</title>
    <link href="http://yoursite.com/2017/11/14/5-%E5%85%B3%E4%BA%8EcombineReducers%E7%94%9F%E6%88%90%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    <id>http://yoursite.com/2017/11/14/5-关于combineReducers生成的数据结构/</id>
    <published>2017-11-13T23:33:50.000Z</published>
    <updated>2017-12-20T03:56:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>reducer太多后,要将所有reducer合成为一个,使用combineReducers方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myReducer.js</span></span><br><span class="line"><span class="keyword">const</span> INCREASE = <span class="string">'increase'</span></span><br><span class="line"><span class="keyword">const</span> DECREASE = <span class="string">'decrease'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducer = <span class="function">(<span class="params">state  = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increase'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrease'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: INCREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onDecrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: DECREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncreaseAsync = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      dispatch(onIncrease())</span><br><span class="line">    &#125;,<span class="number">3000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Auth.reducer.js</span></span><br><span class="line"><span class="comment">// 权限登录的reducer与action creater</span></span><br><span class="line"><span class="comment">// isAuth代表是否登录</span></span><br><span class="line"><span class="keyword">const</span> LOGIN = <span class="string">'LOGIN'</span></span><br><span class="line"><span class="keyword">const</span> LOGOUT = <span class="string">'LOGOUT'</span></span><br><span class="line"><span class="comment">//reducer</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AuthReducer = <span class="function">(<span class="params">state = &#123; isAuth: <span class="literal">false</span>, user: <span class="string">'choteewang'</span> &#125;, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> LOGIN:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    <span class="keyword">case</span> LOGOUT:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">isAuth</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//action creater</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> login = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGIN &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> logout = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: LOGOUT &#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reducers.js</span></span><br><span class="line"><span class="comment">// 利用combineReducers合并两个Reducer</span></span><br><span class="line"><span class="comment">// 变为store中的state对象包裹2个reducer定义的state小对象的数据结构&#123;counter:&#123;&#125;,AutuReducer:&#123;&#125;&#125;</span></span><br><span class="line"><span class="comment">// 这里要注意改键名,防止之前使用小state的组件访问根组件state时key名发生错误</span></span><br><span class="line"><span class="comment">// 所以最佳实践是reducer要起名要有语义</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> combineReducers(&#123;<span class="attr">counter</span>:reducer, <span class="attr">AuthReducer</span>:AuthReducer&#125;)</span><br></pre></td></tr></table></figure><p><code>根组件挂载store后拿到的store.getState()</code> 可以清晰的看到数据结构<br><img src="https://i.loli.net/2017/11/14/5a0a2b3033179.png" alt="Jietu20171112-080243"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;reducer太多后,要将所有reducer合成为一个,使用combineReducers方法&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redux 3: react-redux继续改造Redux数据流</title>
    <link href="http://yoursite.com/2017/11/13/4-react-redux%E7%BB%A7%E7%BB%AD%E6%94%B9%E9%80%A0redux%E6%95%B0%E6%8D%AE%E6%B5%81/"/>
    <id>http://yoursite.com/2017/11/13/4-react-redux继续改造redux数据流/</id>
    <published>2017-11-13T14:23:52.000Z</published>
    <updated>2017-12-20T03:57:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>React-Redux 将所有组件分成两大类：UI 组件（presentational component）和容器组件（container component）。</p><h3 id="UI-组件"><a href="#UI-组件" class="headerlink" title="UI 组件"></a>UI 组件</h3><ul><li>只负责 UI 的呈现，不带有任何业务逻辑</li><li>没有状态（即不使用this.state这个变量）</li><li>所有数据都由参数（this.props）提供</li><li>不使用任何 Redux 的 API<h3 id="容器组件"><a href="#容器组件" class="headerlink" title="容器组件"></a>容器组件</h3></li><li>负责管理数据和业务逻辑，不负责 UI 的呈现</li><li>带有内部状态</li><li>使用 Redux 的 API</li></ul><p>UI 组件负责 UI 的呈现，容器组件负责管理数据和逻辑。<br>将组件拆分成下面的结构：外面是一个容器组件，里面包了一个UI 组件。前者负责与外部的通信，将数据传给后者，由后者渲染出视图。<br>React-Redux 规定，所有的 UI 组件都由用户提供，容器组件则是由 React-Redux 自动生成。也就是说，用户负责视觉层，状态管理则是全部交给它。</p><p><code>下面是将已模块化拆分的,支持异步的redux数据流, 继续改造为react-redux的代码</code></p><h2 id="CODE"><a href="#CODE" class="headerlink" title="CODE"></a>CODE</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//myRedux.js 代码保持不变</span></span><br><span class="line"><span class="keyword">const</span> INCREASE = <span class="string">'increase'</span></span><br><span class="line"><span class="keyword">const</span> DECREASE = <span class="string">'decrease'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increase'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrease'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: INCREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onDecrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: DECREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncreaseAsync = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      dispatch(onIncrease())</span><br><span class="line">    &#125;,<span class="number">3000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.js 根节点挂载处</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="comment">// applyMiddleware用来处理异步中间件thunk,compose用来将chrome插件与react-thunk按固定顺序连接起来</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore , applyMiddleware ,compose &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="comment">// 为了在根组件页面定义store并传入,需要将reducer引入</span></span><br><span class="line"><span class="keyword">import</span> &#123; reducer &#125; <span class="keyword">from</span> <span class="string">'./myRedux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//chrome插件redux-devtools github文档规定的插件声明方式</span></span><br><span class="line"><span class="keyword">const</span> composeEnhancers = <span class="built_in">window</span>.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose;</span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer,composeEnhancers(applyMiddleware(thunk)))</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除subcribe和listener,把ReactDOM.renden重写</span></span><br><span class="line"><span class="comment">//const unsubscribe = store.subscribe(listener)</span></span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  <span class="comment">//根组件外套一层Provider传入Store</span></span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;App/&gt;</span><br><span class="line">  &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root'));</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//App.js, UI组件定义处 与 包裹UI的容器组件生成处</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; from <span class="string">'react'</span>;</span><br><span class="line"><span class="comment">// 引入react-redux的connect函数</span></span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; from <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="comment">// 引入所有Action Creator</span></span><br><span class="line"><span class="keyword">import</span> &#123; onIncrease, onDecrease, onIncreaseAsync &#125; from <span class="string">'./myRedux'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//UI组件,只用来做数据展示和分发,将来可以抽离出去</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppUI</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;&#123;this.props.count&#125;&lt;/h1&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"increase"</span> onClick=&#123;<span class="keyword">this</span>.props.onIncrease&#125; /&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"decrease"</span> onClick=&#123;<span class="keyword">this</span>.props.onDecrease&#125; /&gt;</span><br><span class="line">        &#123;&lt;input type=<span class="string">"button"</span> value=<span class="string">"increaseAsync"</span> onClick=&#123;<span class="keyword">this</span>.props.onIncreaseAsync&#125; /&gt;&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//mapStateToProps是一个函数,返回一个对象,key对应UI组件上的参数名称,"值"应该是state或算出state的方法的调用</span></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = (state) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    count: state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//mapDispatchToProps是一个对象,key对应UI组件对应的参数名称,"值"对应传入的actionCreater</span></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = &#123;</span><br><span class="line">  onIncrease, onDecrease, onIncreaseAsync</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//用connect函数生成包裹UI组件的容器组件</span></span><br><span class="line"><span class="keyword">const</span> App = connect(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapDispatchToProps</span><br><span class="line">)(AppUI)</span><br><span class="line">export <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2017/11/13/5a099fedeaa9e.png" alt="Jietu20171111-033033_iutjibikf"></p><h2 id="REFERENCE"><a href="#REFERENCE" class="headerlink" title="REFERENCE"></a>REFERENCE</h2><p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_three_react-redux.html" target="_blank" rel="noopener">阮一峰 Redux 3</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;TODO&quot;&gt;&lt;a href=&quot;#TODO&quot; class=&quot;headerlink&quot; title=&quot;TODO&quot;&gt;&lt;/a&gt;TODO&lt;/h2&gt;&lt;p&gt;React-Redux 将所有组件分成两大类：UI 组件（presentational component）和容器组件（co
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redux 2: Redux模块的抽离,Action Creator,异步支持的实现(redux-thunk)</title>
    <link href="http://yoursite.com/2017/11/13/3-Redux-2-Redux%E6%A8%A1%E5%9D%97%E7%9A%84%E6%8A%BD%E7%A6%BB-Action-Creator-%E5%BC%82%E6%AD%A5%E6%94%AF%E6%8C%81%E7%9A%84%E5%AE%9E%E7%8E%B0-redux-thunk/"/>
    <id>http://yoursite.com/2017/11/13/3-Redux-2-Redux模块的抽离-Action-Creator-异步支持的实现-redux-thunk/</id>
    <published>2017-11-13T13:23:52.000Z</published>
    <updated>2017-12-20T03:57:03.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p><a href="./redux的实现原理(发布订阅模式,闭包">上一篇redux的总结</a>.md)中,写了一个小的Counter Demo, 但是代码耦合度太高, 在复杂项目中组织代码难度增加, 且无法进行异步redux操作, 这篇总结中, 将代码以模块化思想解耦合, 并让redux可以支持异步操作.</p><p>需要用到redux-thunk这个库,这个库的作用是让store.dispatch接受以函数作为参数,从而从函数参数中拿到dispatch与getState执行异步操作, 最底层的原理可以移步阮一峰博客redux第二篇,这里只做代码实现,和详细注释</p><h2 id="CODE"><a href="#CODE" class="headerlink" title="CODE"></a>CODE</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Index.js : 根组件挂载处</span></span><br><span class="line"><span class="keyword">import</span> App from <span class="string">'./App'</span>;</span><br><span class="line"><span class="keyword">import</span> React from <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM from <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="comment">// 引入redux-thunk,使dispatch可以接受一个函数作为参数,从而支持applyMiddleware的中间件处理</span></span><br><span class="line"><span class="keyword">import</span> thunk from <span class="string">'redux-thunk'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; from <span class="string">'redux'</span></span><br><span class="line"><span class="comment">// 引入自己抽离的actionCreater与reducer模块</span></span><br><span class="line"><span class="keyword">import</span> &#123; onIncrease, onDecrease, onIncreaseAsync,reducer &#125; from <span class="string">'./myRedux'</span>;</span><br><span class="line"><span class="comment">// 在根组件的挂载处挂载store与reducer,actionCreater控制整个app的redux数据流</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer,applyMiddleware(thunk))</span><br><span class="line"><span class="keyword">const</span> unsubscribe = store.subscribe(listener)</span><br><span class="line"></span><br><span class="line"><span class="function">function <span class="title">listener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;App</span><br><span class="line">      <span class="comment">//将store和actionCreater传入组件内部</span></span><br><span class="line">      store=&#123;store&#125;</span><br><span class="line">      onIncrease=&#123;onIncrease&#125;</span><br><span class="line">      onDecrease=&#123;onDecrease&#125;</span><br><span class="line">      onIncreaseAsync=&#123;onIncreaseAsync&#125;</span><br><span class="line">    &gt;</span><br><span class="line">    &lt;/App&gt;,</span><br><span class="line">    document.getElementById(<span class="string">'root'</span>));</span><br><span class="line">&#125;</span><br><span class="line">listener()</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.js : UI组件定义处</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; from <span class="string">'react'</span>;</span><br><span class="line"><span class="comment">// App就是上篇文章的Counter,不同的是它是一个UI组件,只负责UI的展示和数据流的分派</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// store与ActionCreater从根组件挂载处index.js处拿到</span></span><br><span class="line">    <span class="keyword">const</span> store = <span class="keyword">this</span>.props.store</span><br><span class="line">    <span class="keyword">const</span> onIncrease = <span class="keyword">this</span>.props.onIncrease</span><br><span class="line">    <span class="keyword">const</span> onDecrease = <span class="keyword">this</span>.props.onDecrease</span><br><span class="line">    <span class="keyword">const</span> onIncreaseAsync = <span class="keyword">this</span>.props.onIncreaseAsync</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;&#123;store.getState()&#125;&lt;/h1&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"increase"</span> onClick=&#123;() =&gt; &#123; store.dispatch(onIncrease()) &#125;&#125; /&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"decrease"</span> onClick=&#123;() =&gt; &#123; store.dispatch(onDecrease()) &#125;&#125; /&gt;</span><br><span class="line">        &#123;<span class="comment">/* 添加异步操作UI */</span>&#125;</span><br><span class="line">        &#123;&lt;input type=<span class="string">"button"</span> value=<span class="string">"increaseAsync"</span> onClick=&#123;() =&gt; &#123; store.dispatch(onIncreaseAsync()) &#125;&#125; /&gt;&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">export <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myRedux.js</span></span><br><span class="line"><span class="comment">// 将actionCreater与reducer抽离成一个单独的js模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义action.type对应的常量,防止后期频繁修改</span></span><br><span class="line"><span class="keyword">const</span> INCREASE = <span class="string">'increase'</span></span><br><span class="line"><span class="keyword">const</span> DECREASE = <span class="string">'decrease'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increase'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrease'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为了不频繁写action,创建actionCreater方法,自动生成action</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: INCREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onDecrease = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">type</span>: DECREASE &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// redux异步的解决方案:写出返回函数的actionCreator，使用reduxThunk中间件改造dispatch使函数可以作为其参数。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义异步的actionCreater,返回一个函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onIncreaseAsync = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 这里return出的方法参数是dispatch与getState,后续applyMiddleWare方法会将store.dispatch与store.getState传入</span></span><br><span class="line">  <span class="comment">// 这里return出的方法是一个中间件方法,applyMiddleWare会在这个方法执行之前发一个action,执行之后再发一个action,从而实现异步处理.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      dispatch(onIncrease())</span><br><span class="line">    &#125;,<span class="number">3000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2017/11/13/5a099c902645b.png" alt="Jietu20171111-033033"></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_two_async_operations.html" target="_blank" rel="noopener">阮一峰 redux(2)</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;TODO&quot;&gt;&lt;a href=&quot;#TODO&quot; class=&quot;headerlink&quot; title=&quot;TODO&quot;&gt;&lt;/a&gt;TODO&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;./redux的实现原理(发布订阅模式,闭包&quot;&gt;上一篇redux的总结&lt;/a&gt;.md)中,写了一个小的Co
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Redux 1: Redux的实现原理(发布订阅模式,闭包)</title>
    <link href="http://yoursite.com/2017/11/13/2-redux%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F-%E9%97%AD%E5%8C%85/"/>
    <id>http://yoursite.com/2017/11/13/2-redux的实现原理-发布订阅模式-闭包/</id>
    <published>2017-11-13T12:57:01.000Z</published>
    <updated>2017-12-20T03:57:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前置知识-发布订阅者模式"><a href="#前置知识-发布订阅者模式" class="headerlink" title="前置知识:发布订阅者模式"></a>前置知识:发布订阅者模式</h2><p><a href="https://www.cnblogs.com/tugenhua0707/p/4687947.html" target="_blank" rel="noopener">发布订阅者模式_阅读</a></p><h2 id="createStore的实现-闭包-发布订阅模式"><a href="#createStore的实现-闭包-发布订阅模式" class="headerlink" title="createStore的实现,闭包,发布订阅模式"></a>createStore的实现,闭包,发布订阅模式</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createStore = <span class="function">(<span class="params">reducer</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 闭包内要操作的数据,state是数据,listeners是发布订阅模式的订阅数组</span></span><br><span class="line">  <span class="keyword">let</span> state;</span><br><span class="line">  <span class="keyword">let</span> listeners = [];</span><br><span class="line">  <span class="comment">// 通过getState返回state的值</span></span><br><span class="line">  <span class="keyword">const</span> getState = <span class="function"><span class="params">()</span> =&gt;</span> state;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//通过dispatch的参数接收action对象</span></span><br><span class="line">  <span class="keyword">const</span> dispatch = <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="comment">// 将action对象传入reducer更新state</span></span><br><span class="line">    state = reducer(state, action);</span><br><span class="line">    <span class="comment">// 一旦state被更新,订阅数组中的所有listener方法被执行</span></span><br><span class="line">    listeners.forEach(<span class="function"><span class="params">listener</span> =&gt;</span> listener());</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 通过subscribe的参数接收listener方法</span></span><br><span class="line">  <span class="keyword">const</span> subscribe = <span class="function">(<span class="params">listener</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="comment">// 将listner方法放入订阅数组listeners</span></span><br><span class="line">    listeners.push(listener);</span><br><span class="line">    <span class="comment">// 同时return一个方法形成闭包,这个方法用来从订阅数组listeners中删除掉listener方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      listeners = listeners.filter(<span class="function"><span class="params">l</span> =&gt;</span> l !== listener);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 执行一次dispatch,形成最初的state数据</span></span><br><span class="line">  dispatch(&#123;&#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 将getState, dispatch, subscribe方法向外return,形成闭包</span></span><br><span class="line">  <span class="keyword">return</span> &#123; getState, dispatch, subscribe &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="最基础的Redux数据流"><a href="#最基础的Redux数据流" class="headerlink" title="最基础的Redux数据流"></a>最基础的Redux数据流</h2><p><img src="https://i.loli.net/2017/11/13/5a099379e0660.png" alt="Jietu20171110-094632"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React from <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM from <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="comment">// 从redux中拿到createStore函数</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; from <span class="string">"redux"</span>;</span><br><span class="line"><span class="comment">// ui组件,只有props从外界接收数据并展示,让redux帮我们处理state数据的传递</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;&#123;this.props.count&#125;&lt;/h1&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"Increase"</span> onClick=&#123;<span class="keyword">this</span>.props.onIncrease&#125; /&gt;</span><br><span class="line">        &lt;input type=<span class="string">"button"</span> value=<span class="string">"Decrease"</span> onClick=&#123;<span class="keyword">this</span>.props.onDecrease&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reducer,在createStore形成的闭包内部处理state的过滤器,</span></span><br><span class="line"><span class="comment">// 在createStore形成的闭包内部 使用state=reducer(state,action)实现,return的值重新赋值给state</span></span><br><span class="line"><span class="keyword">const</span> reducer = (state = <span class="number">0</span>, action) =&gt; &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increase'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrease'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// store是createStore闭包的返回值,是一个对象,结构是&#123;getState,dispatch,subscribe&#125;,</span></span><br><span class="line"><span class="comment">// createStore通过参数传入的reducer形成state的生成规则</span></span><br><span class="line"><span class="comment">// createStore方法还可以接受第二个参数，表示整个应用的state的初始状态,会覆盖reducer函数中的默认初始值</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer)</span><br><span class="line"><span class="comment">// 通过store.subscribe(listener)方法拿到的listener函数进行订阅发布者模式监听,只要state的值变化,订阅数组listenrs中的所有listener方法就会被执行</span></span><br><span class="line"><span class="keyword">const</span> unsubscribe = store.subscribe(listener)</span><br><span class="line"><span class="comment">// store.subscribe的返回值是一个方法unsubscribe(),可以从订阅数组listeners中移除listener方法,取消监听</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//这是subscribe调用的listener方法,state的值改变后会被调用,内部让其自动执行渲染函数更新UI组件Counter</span></span><br><span class="line"><span class="function">function <span class="title">listener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;Counter</span><br><span class="line">      <span class="comment">// 新生成的state值可以通过store.getState()方法得到闭包快照</span></span><br><span class="line">      count=&#123;store.getState()&#125;</span><br><span class="line">      <span class="comment">// 通过store.dispatch(action)方法拿到action对象传入reducer参数更新state值,state=reducer(state,action)</span></span><br><span class="line">      <span class="comment">// action 是一个对象。其中的type属性是必须的，表示 Action 的名称。其他属性可以自由设置</span></span><br><span class="line">      onIncrease=&#123;() =&gt; &#123; store.dispatch(&#123; type: <span class="string">'increase'</span> &#125;) &#125;&#125;</span><br><span class="line">      onDecrease=&#123;() =&gt; &#123; store.dispatch(&#123; type: <span class="string">'decrease'</span> &#125;) &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">    &lt;/Counter&gt;,</span><br><span class="line">    document.getElementById(<span class="string">'root'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 首次进入页面先渲染一次页面</span></span><br><span class="line">listener()</span><br></pre></td></tr></table></figure><p><img src="https://ooo.0o0.ooo/2017/11/13/5a0993bd51d99.png" alt="Jietu20171110-082736"></p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html" target="_blank" rel="noopener">阮一峰 redux (1)</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前置知识-发布订阅者模式&quot;&gt;&lt;a href=&quot;#前置知识-发布订阅者模式&quot; class=&quot;headerlink&quot; title=&quot;前置知识:发布订阅者模式&quot;&gt;&lt;/a&gt;前置知识:发布订阅者模式&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.cnblogs.c
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>gulp构建 es6运行在browser端 自动化工作流</title>
    <link href="http://yoursite.com/2017/11/10/1-gulp%E6%9E%84%E5%BB%BAes6%E8%BF%90%E8%A1%8C%E5%9C%A8browser%E7%AB%AF%E7%9A%84work%20flow/"/>
    <id>http://yoursite.com/2017/11/10/1-gulp构建es6运行在browser端的work flow/</id>
    <published>2017-11-10T14:23:52.000Z</published>
    <updated>2017-11-14T00:21:48.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="用来做什么"><a href="#用来做什么" class="headerlink" title="用来做什么?"></a>用来做什么?</h3><p>1.支持监视前端页面js,css,ejs模板文件热更新,babel语法自动转换,自动刷新浏览器页面,</p><p>2.支持后台静态资源的处理,js文件的压缩打包,更新静态css与ejs模板文件,也可以在express端构建逻辑mock数据</p><hr><h3 id="项目自动化构建思路"><a href="#项目自动化构建思路" class="headerlink" title="项目自动化构建思路"></a>项目自动化构建思路</h3><p><img src="https://ooo.0o0.ooo/2017/11/14/5a0a30c88f806.png" alt="1"></p><h3 id="自动化构建逻辑"><a href="#自动化构建逻辑" class="headerlink" title="自动化构建逻辑"></a>自动化构建逻辑</h3><ol><li>若app文件夹(前端静. 态页面)资源发生改变 -&gt;</li><li>调用browser.js脚本 -&gt;</li><li>browser.js运行script脚本 -&gt;</li><li>将新的js文件打包后写入server目录public目录下 -&gt;</li><li>此行为触发server.js监听到服务端js静态资源文件被修改 -&gt;</li><li>执行服务器重启重新渲染页面 -&gt;</li><li>前台看到浏览器热更新<h3 id="构建目录结构-安装服务端脚手架工具"><a href="#构建目录结构-安装服务端脚手架工具" class="headerlink" title="构建目录结构,安装服务端脚手架工具"></a>构建目录结构,安装服务端脚手架工具</h3></li><li>创建项目目录 <code>app</code>(放置静态页面资源),<code>server</code>(用express脚手架初始化,将来放入热更新后的静态资源),<code>tasks</code>放置所有上述过程的脚本文件</li><li>初始化服务端express<pre><code>`npm install -g express-generator`  //安装express脚手架`express -e .` //使用express脚手架命令,初始化脚手架,-e代表使用ejs模板引擎</code></pre></li><li>在根目录创建 .babelrc文件,此为babel转码器</li><li>在根目录创建<code>gulpfile.js</code>, 若用es6语法写gulpfile文件就创建<code>gulpfile.babel.js</code></li></ol><hr><h2 id="gulp工作流代码构建流程"><a href="#gulp工作流代码构建流程" class="headerlink" title="gulp工作流代码构建流程"></a>gulp工作流代码构建流程</h2><h3 id="args-js-–处理命令行参数"><a href="#args-js-–处理命令行参数" class="headerlink" title="args.js –处理命令行参数"></a>args.js –处理命令行参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> yargs <span class="keyword">from</span> <span class="string">'yargs'</span>; <span class="comment">//处理命令行参数的包</span></span><br><span class="line"><span class="comment">//区分开发环境和线上环境</span></span><br><span class="line"><span class="keyword">const</span> args = yargs  </span><br><span class="line">  <span class="comment">//提取--production参数</span></span><br><span class="line">  .option(<span class="string">'production'</span>,&#123; </span><br><span class="line">    boolean:<span class="literal">true</span>,<span class="comment">//选项是布尔类型</span></span><br><span class="line">    <span class="keyword">default</span>:<span class="literal">false</span>,<span class="comment">//默认是false</span></span><br><span class="line">    describe:<span class="string">'min all scripts'</span> <span class="comment">//只是给人看的描述</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//用来监听文件改变的选项</span></span><br><span class="line">  .option(<span class="string">'watch'</span>,&#123;</span><br><span class="line">    boolean:<span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">default</span>:<span class="literal">false</span>,</span><br><span class="line">    describe:<span class="string">'watch all files'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//要不要输出命令行详细监视的日志</span></span><br><span class="line">  .option(<span class="string">'verbose'</span>,&#123;</span><br><span class="line">    boolean:<span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">default</span>:<span class="literal">false</span>,</span><br><span class="line">    describe:<span class="string">'log'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//强制生成sourcemaps映射</span></span><br><span class="line">  .option(<span class="string">'sourcemaps'</span>,&#123;</span><br><span class="line">    describe:<span class="string">'force the creation of sroucemaps'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//端口号</span></span><br><span class="line">  .option(<span class="string">'port'</span>,&#123;</span><br><span class="line">    string:<span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">default</span>:<span class="number">8080</span>,</span><br><span class="line">    describe:<span class="string">'server port'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//表示把输入的命令以字符串的方式进行解析</span></span><br><span class="line">  .argv</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> args;</span><br></pre></td></tr></table></figure><h3 id="script-js-–处理js"><a href="#script-js-–处理js" class="headerlink" title="script.js –处理js"></a>script.js –处理js</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>; <span class="comment">//gulp语句中做if判断</span></span><br><span class="line"><span class="keyword">import</span> concat <span class="keyword">from</span> <span class="string">'gulp-concat'</span>; <span class="comment">//gulp中处理文件拼接</span></span><br><span class="line"><span class="keyword">import</span> webpack <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpWebpack <span class="keyword">from</span> <span class="string">'webpack-stream'</span>; <span class="comment">//支持webpack在gulp stream中的功能</span></span><br><span class="line"><span class="keyword">import</span> named <span class="keyword">from</span> <span class="string">'vinyl-named'</span>; <span class="comment">//保证webpack生成的文件名能够和原文件对上</span></span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">'gulp-livereload'</span>; <span class="comment">//浏览器热更新</span></span><br><span class="line"><span class="keyword">import</span> plumber <span class="keyword">from</span> <span class="string">'gulp-plumber'</span>; <span class="comment">//处理文件信息流</span></span><br><span class="line"><span class="keyword">import</span> rename <span class="keyword">from</span> <span class="string">'gulp-rename'</span>; <span class="comment">//对文件重命名</span></span><br><span class="line"><span class="keyword">import</span> uglify <span class="keyword">from</span> <span class="string">'gulp-uglify'</span>; <span class="comment">//压缩js</span></span><br><span class="line"><span class="keyword">import</span> &#123;log, colors&#125; <span class="keyword">from</span> <span class="string">'gulp-util'</span>; <span class="comment">//命令行工具包,log与色彩输出</span></span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>; <span class="comment">//刚自己写的对命令行参数进行解析的包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了集中处理项目js文件抛出异常引起gulp流出现问题,需用plumber统一处理错误</span></span><br><span class="line">gulp.task(<span class="string">'scripts'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> gulp</span><br><span class="line">    .src([<span class="string">'app/js/index.js'</span>])</span><br><span class="line">    .pipe(plumber(&#123;<span class="attr">errorHandle</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;&#125;))</span><br><span class="line">    .pipe(named())</span><br><span class="line">    .pipe(gulpWebpack(&#123;</span><br><span class="line">      <span class="built_in">module</span>: &#123;</span><br><span class="line">        loaders: [</span><br><span class="line">          &#123;</span><br><span class="line">            test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">            loader: <span class="string">'babel-loader'</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;), <span class="literal">null</span>, (err, stats) =&gt; &#123;</span><br><span class="line">      log(<span class="string">`Finished '<span class="subst">$&#123;colors.cyan(<span class="string">'scripts'</span>)&#125;</span>'`</span>, stats.toString(&#123;<span class="attr">chunks</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">//gulp处理完的js指定写入路径,api:gulp.dest</span></span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server/public/js'</span>))</span><br><span class="line">    <span class="comment">//js文件重命名为cp.min.js,还没压缩,只是复制一份</span></span><br><span class="line">    .pipe(rename(&#123;<span class="attr">basename</span>: <span class="string">'cp'</span>, <span class="attr">extname</span>: <span class="string">'.min.js'</span>&#125;))</span><br><span class="line">    <span class="comment">// 压缩</span></span><br><span class="line">    .pipe(uglify(&#123;</span><br><span class="line">      compress: &#123;</span><br><span class="line">        properties: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      output: &#123;</span><br><span class="line">        <span class="string">'quote_keys'</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="comment">// 把压缩后的文件放入服务器目录</span></span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server/public/js'</span>))</span><br><span class="line">    <span class="comment">// 使用gulpif监视命令行传入的参数,若有--watch,则执行热更新</span></span><br><span class="line">    .pipe(gulpif(args.watch, livereload()))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="pages-js-–处理后台页面模板"><a href="#pages-js-–处理后台页面模板" class="headerlink" title="pages.js –处理后台页面模板"></a>pages.js –处理后台页面模板</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">'gulp-livereload'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'pages'</span>,()=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'app/**/*.ejs'</span>)</span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server'</span>)) <span class="comment">//文件被写入的路径是以所给的相对路径根据所给的目标目录计算而来。类似的，相对路径也可以根据所给的 base 来计算。这里实际写到的路径是server下的/**/*.ejs,即server/views/*.ejs</span></span><br><span class="line">    .pipe(gulpif(args.watch,livereload()))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="css-js-–处理css"><a href="#css-js-–处理css" class="headerlink" title="css.js –处理css"></a>css.js –处理css</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">'gulp-livereload'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'css'</span>,()=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'app/**/*.css'</span>)</span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server/public'</span>))</span><br><span class="line">    <span class="comment">//文件被写入的路径是以所给的相对路径根据所给的目标目录计算而来。类似的，相对路径也可以根据所给的 base 来计算。这里实际写到的路径是server下的/**/*.css,即server/public/css/*.css</span></span><br><span class="line">    .pipe(gulpif(args.watch,livereload()))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="server-js-–处理服务端热重启"><a href="#server-js-–处理服务端热重启" class="headerlink" title="server.js –处理服务端热重启"></a>server.js –处理服务端热重启</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> liveserver <span class="keyword">from</span> <span class="string">'gulp-live-server'</span>; <span class="comment">//启动gulp服务器的包</span></span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'serve'</span>,(cb)=&gt;&#123;</span><br><span class="line">  <span class="comment">//如果没在监听,直接运行回调函数</span></span><br><span class="line">  <span class="keyword">if</span>(!args.watch) <span class="keyword">return</span> cb(); </span><br><span class="line">  <span class="comment">//启动express脚手架默认的服务器脚本</span></span><br><span class="line">  <span class="keyword">const</span> server = liveserver.new([<span class="string">'--harmony'</span>,<span class="string">'server/bin/www'</span>]); </span><br><span class="line">  server.start();</span><br><span class="line">  <span class="comment">//监听server目录下的js文件和ejs模板文件,通知服务器哪些文件改变了</span></span><br><span class="line">  gulp.watch([<span class="string">'server/public/**/*.js'</span>,<span class="string">'server/views/**/*.ejs'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line">    server.notify.apply(server,[file]);</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//监视服务器路由及入口文件的改变,进行服务器重启</span></span><br><span class="line">  gulp.watch([<span class="string">'server/routes/**/*.js'</span>,<span class="string">'server/app.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    server.start.bind(server)()</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="browser-js-–监视前端文件改变-触发热更新"><a href="#browser-js-–监视前端文件改变-触发热更新" class="headerlink" title="browser.js –监视前端文件改变,触发热更新"></a>browser.js –监视前端文件改变,触发热更新</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> gutil <span class="keyword">from</span> <span class="string">'gulp-util'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'browser'</span>,(cb)=&gt;&#123;</span><br><span class="line">  <span class="keyword">if</span>(!args.watch) <span class="keyword">return</span> cb();<span class="comment">//若没监听,则直接执行回调</span></span><br><span class="line">  gulp.watch(<span class="string">'app/**/*.js'</span>,[<span class="string">'scripts'</span>]);<span class="comment">//若js文件发生改变,则调用刚才创建的scripts脚本</span></span><br><span class="line">  gulp.watch(<span class="string">'app/**/*.ejs'</span>,[<span class="string">'pages'</span>]); <span class="comment">//同上</span></span><br><span class="line">  gulp.watch(<span class="string">'app/**/*.css'</span>,[<span class="string">'css'</span>]); <span class="comment">//同上</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="clean-js-–处理服务器清除旧文件"><a href="#clean-js-–处理服务器清除旧文件" class="headerlink" title="clean.js –处理服务器清除旧文件"></a>clean.js –处理服务器清除旧文件</h3><p>每次服务器监听到静态资源文件的改变, 会触发重启, 用新的静态资源去render页面,此时需要删除旧的静态资源文件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> del <span class="keyword">from</span> <span class="string">'del'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"><span class="comment">//清除服务端的静态资源文件和模板文件</span></span><br><span class="line">gulp.task(<span class="string">'clean'</span>,()=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> del([<span class="string">'server/public'</span>,<span class="string">'server/views'</span>])</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h3 id="build-js-–处理所有gulp文件运行关联顺序"><a href="#build-js-–处理所有gulp文件运行关联顺序" class="headerlink" title="build.js –处理所有gulp文件运行关联顺序"></a>build.js –处理所有gulp文件运行关联顺序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpSequence <span class="keyword">from</span> <span class="string">'gulp-sequence'</span>; <span class="comment">//处理文件关联关系和先后顺序</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//先clean,再css,再pages,再编译js,最后一个数组说明数组里的任务都放在前面四个任务执行过一次之后再执行,且serve端更新一定 在 browser静态资源改变之后 </span></span><br><span class="line">gulp.task(<span class="string">'build'</span>,gulpSequence(<span class="string">'clean'</span>,<span class="string">'css'</span>,<span class="string">'pages'</span>,<span class="string">'scripts'</span>,[<span class="string">'browser'</span>,<span class="string">'serve'</span>]));</span><br></pre></td></tr></table></figure><h3 id="default-js-–gulp工作流默认入口"><a href="#default-js-–gulp工作流默认入口" class="headerlink" title="default.js –gulp工作流默认入口"></a>default.js –gulp工作流默认入口</h3><p>gulp在无命令行参数时会优先运行defalut.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line">gulp.task(<span class="string">'default'</span>,[<span class="string">'build'</span>]);</span><br></pre></td></tr></table></figure></p><h3 id="gulpfile-babel-js-–gulp程序入口"><a href="#gulpfile-babel-js-–gulp程序入口" class="headerlink" title="gulpfile.babel.js –gulp程序入口"></a>gulpfile.babel.js –gulp程序入口</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requireDir <span class="keyword">from</span> <span class="string">'require-dir'</span>;<span class="comment">//需要运行某一文件夹的gulp任务</span></span><br><span class="line">requireDir(<span class="string">'./tasks'</span>); <span class="comment">//放入tasks目录</span></span><br></pre></td></tr></table></figure><h3 id="编辑-babelrc"><a href="#编辑-babelrc" class="headerlink" title="编辑.babelrc"></a>编辑.babelrc</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>:[<span class="string">"env"</span>,<span class="string">"stage-0"</span>],</span><br><span class="line">  <span class="attr">"plugins"</span>:[<span class="string">"transform-decorators-legacy"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="给express脚手架添加热更新中间件"><a href="#给express脚手架添加热更新中间件" class="headerlink" title="给express脚手架添加热更新中间件"></a>给express脚手架添加热更新中间件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在处理路由前,express优先处理静态资源,若在这个static方法定义的目录中没有找到req.url对应的静态资源,则调用Next()方法传入下一个中间件,最终会传递到路由中间件上</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"><span class="comment">//一定要再静态资源设置之后使用热更新中间件,此插件的安装要再最外层项目目录下的依赖安装,而不是server目录的依赖</span></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'connect-livereload'</span>)());</span><br></pre></td></tr></table></figure><h3 id="gulp程序启动"><a href="#gulp程序启动" class="headerlink" title="gulp程序启动"></a>gulp程序启动</h3><p><code>gulp --watch</code><br>在app/public/js下写一个简单的js,再在app/public/css下写一个chotee.css,例如</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chotee</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'chotee 啊,成功!'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ct1 = <span class="keyword">new</span> Chotee</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.innerHTML = ct1.name;</span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: pink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在app/views/目录下的index.ejs模板中引入<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/css/chotee.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  hello chotee</span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/index.js"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>打开浏览器访问localhost:3000端口(express脚手架默认端口), 看到<br><img src="https://i.loli.net/2017/11/14/5a0a30b96f6c1.png" alt="2"></p><p>成功! 此时再去修改js文件,模板文件,热更新文件,成功</p><h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址:"></a>源码地址:</h2><p><a href="https://github.com/choteewang/gulp-es6-work-flow" target="_blank" rel="noopener">https://github.com/choteewang/gulp-es6-work-flow</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;用来做什么&quot;&gt;&lt;a href=&quot;#用来做什么&quot; class=&quot;headerlink&quot; title=&quot;用来做什么?&quot;&gt;&lt;/a&gt;用来做什么?&lt;/h3&gt;&lt;p&gt;1.支持监视前端页面js,css,ejs模板文件热更新,babel语法自动转换,自动刷新浏览器页面,&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
  </entry>
  
</feed>
