<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> gulp构建 es6运行在browser端 自动化工作流 · choteewang</title><meta name="description" content="gulp构建 es6运行在browser端 自动化工作流 - choteewang@qq.com"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="choteewang"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">CHOTEE'S BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">LIST</a></li><li class="nav-list-item"><a href="https://github.com/choteewang" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">gulp构建 es6运行在browser端 自动化工作流</h1><div class="post-info">2017年11月10日</div><div class="post-content"><h3 id="用来做什么"><a href="#用来做什么" class="headerlink" title="用来做什么?"></a>用来做什么?</h3><p>1.支持监视前端页面js,css,ejs模板文件热更新,babel语法自动转换,自动刷新浏览器页面,</p>
<p>2.支持后台静态资源的处理,js文件的压缩打包,更新静态css与ejs模板文件,也可以在express端构建逻辑mock数据</p>
<hr>
<h3 id="项目自动化构建思路"><a href="#项目自动化构建思路" class="headerlink" title="项目自动化构建思路"></a>项目自动化构建思路</h3><p><img src="https://ooo.0o0.ooo/2017/11/14/5a0a30c88f806.png" alt="1"><br><a id="more"></a></p>
<h3 id="自动化构建逻辑"><a href="#自动化构建逻辑" class="headerlink" title="自动化构建逻辑"></a>自动化构建逻辑</h3><ol>
<li>若app文件夹(前端静. 态页面)资源发生改变 -&gt;</li>
<li>调用browser.js脚本 -&gt;</li>
<li>browser.js运行script脚本 -&gt;</li>
<li>将新的js文件打包后写入server目录public目录下 -&gt;</li>
<li>此行为触发server.js监听到服务端js静态资源文件被修改 -&gt;</li>
<li>执行服务器重启重新渲染页面 -&gt;</li>
<li>前台看到浏览器热更新<h3 id="构建目录结构-安装服务端脚手架工具"><a href="#构建目录结构-安装服务端脚手架工具" class="headerlink" title="构建目录结构,安装服务端脚手架工具"></a>构建目录结构,安装服务端脚手架工具</h3></li>
<li>创建项目目录 <code>app</code>(放置静态页面资源),<code>server</code>(用express脚手架初始化,将来放入热更新后的静态资源),<code>tasks</code>放置所有上述过程的脚本文件</li>
<li>初始化服务端express<pre><code>`npm install -g express-generator`  //安装express脚手架
`express -e .` //使用express脚手架命令,初始化脚手架,-e代表使用ejs模板引擎
</code></pre></li>
<li>在根目录创建 .babelrc文件,此为babel转码器</li>
<li>在根目录创建<code>gulpfile.js</code>, 若用es6语法写gulpfile文件就创建<code>gulpfile.babel.js</code></li>
</ol>
<hr>
<h2 id="gulp工作流代码构建流程"><a href="#gulp工作流代码构建流程" class="headerlink" title="gulp工作流代码构建流程"></a>gulp工作流代码构建流程</h2><h3 id="args-js-–处理命令行参数"><a href="#args-js-–处理命令行参数" class="headerlink" title="args.js –处理命令行参数"></a>args.js –处理命令行参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> yargs <span class="keyword">from</span> <span class="string">'yargs'</span>; <span class="comment">//处理命令行参数的包</span></span><br><span class="line"><span class="comment">//区分开发环境和线上环境</span></span><br><span class="line"><span class="keyword">const</span> args = yargs  </span><br><span class="line">  <span class="comment">//提取--production参数</span></span><br><span class="line">  .option(<span class="string">'production'</span>,&#123; </span><br><span class="line">    boolean:<span class="literal">true</span>,<span class="comment">//选项是布尔类型</span></span><br><span class="line">    <span class="keyword">default</span>:<span class="literal">false</span>,<span class="comment">//默认是false</span></span><br><span class="line">    describe:<span class="string">'min all scripts'</span> <span class="comment">//只是给人看的描述</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//用来监听文件改变的选项</span></span><br><span class="line">  .option(<span class="string">'watch'</span>,&#123;</span><br><span class="line">    boolean:<span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">default</span>:<span class="literal">false</span>,</span><br><span class="line">    describe:<span class="string">'watch all files'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//要不要输出命令行详细监视的日志</span></span><br><span class="line">  .option(<span class="string">'verbose'</span>,&#123;</span><br><span class="line">    boolean:<span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">default</span>:<span class="literal">false</span>,</span><br><span class="line">    describe:<span class="string">'log'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//强制生成sourcemaps映射</span></span><br><span class="line">  .option(<span class="string">'sourcemaps'</span>,&#123;</span><br><span class="line">    describe:<span class="string">'force the creation of sroucemaps'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//端口号</span></span><br><span class="line">  .option(<span class="string">'port'</span>,&#123;</span><br><span class="line">    string:<span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">default</span>:<span class="number">8080</span>,</span><br><span class="line">    describe:<span class="string">'server port'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//表示把输入的命令以字符串的方式进行解析</span></span><br><span class="line">  .argv</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> args;</span><br></pre></td></tr></table></figure>
<h3 id="script-js-–处理js"><a href="#script-js-–处理js" class="headerlink" title="script.js –处理js"></a>script.js –处理js</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>; <span class="comment">//gulp语句中做if判断</span></span><br><span class="line"><span class="keyword">import</span> concat <span class="keyword">from</span> <span class="string">'gulp-concat'</span>; <span class="comment">//gulp中处理文件拼接</span></span><br><span class="line"><span class="keyword">import</span> webpack <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpWebpack <span class="keyword">from</span> <span class="string">'webpack-stream'</span>; <span class="comment">//支持webpack在gulp stream中的功能</span></span><br><span class="line"><span class="keyword">import</span> named <span class="keyword">from</span> <span class="string">'vinyl-named'</span>; <span class="comment">//保证webpack生成的文件名能够和原文件对上</span></span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">'gulp-livereload'</span>; <span class="comment">//浏览器热更新</span></span><br><span class="line"><span class="keyword">import</span> plumber <span class="keyword">from</span> <span class="string">'gulp-plumber'</span>; <span class="comment">//处理文件信息流</span></span><br><span class="line"><span class="keyword">import</span> rename <span class="keyword">from</span> <span class="string">'gulp-rename'</span>; <span class="comment">//对文件重命名</span></span><br><span class="line"><span class="keyword">import</span> uglify <span class="keyword">from</span> <span class="string">'gulp-uglify'</span>; <span class="comment">//压缩js</span></span><br><span class="line"><span class="keyword">import</span> &#123;log, colors&#125; <span class="keyword">from</span> <span class="string">'gulp-util'</span>; <span class="comment">//命令行工具包,log与色彩输出</span></span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>; <span class="comment">//刚自己写的对命令行参数进行解析的包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了集中处理项目js文件抛出异常引起gulp流出现问题,需用plumber统一处理错误</span></span><br><span class="line">gulp.task(<span class="string">'scripts'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> gulp</span><br><span class="line">    .src([<span class="string">'app/js/index.js'</span>])</span><br><span class="line">    .pipe(plumber(&#123;<span class="attr">errorHandle</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;&#125;))</span><br><span class="line">    .pipe(named())</span><br><span class="line">    .pipe(gulpWebpack(&#123;</span><br><span class="line">      <span class="built_in">module</span>: &#123;</span><br><span class="line">        loaders: [</span><br><span class="line">          &#123;</span><br><span class="line">            test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">            loader: <span class="string">'babel-loader'</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;), <span class="literal">null</span>, (err, stats) =&gt; &#123;</span><br><span class="line">      log(<span class="string">`Finished '<span class="subst">$&#123;colors.cyan(<span class="string">'scripts'</span>)&#125;</span>'`</span>, stats.toString(&#123;<span class="attr">chunks</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">//gulp处理完的js指定写入路径,api:gulp.dest</span></span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server/public/js'</span>))</span><br><span class="line">    <span class="comment">//js文件重命名为cp.min.js,还没压缩,只是复制一份</span></span><br><span class="line">    .pipe(rename(&#123;<span class="attr">basename</span>: <span class="string">'cp'</span>, <span class="attr">extname</span>: <span class="string">'.min.js'</span>&#125;))</span><br><span class="line">    <span class="comment">// 压缩</span></span><br><span class="line">    .pipe(uglify(&#123;</span><br><span class="line">      compress: &#123;</span><br><span class="line">        properties: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      output: &#123;</span><br><span class="line">        <span class="string">'quote_keys'</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="comment">// 把压缩后的文件放入服务器目录</span></span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server/public/js'</span>))</span><br><span class="line">    <span class="comment">// 使用gulpif监视命令行传入的参数,若有--watch,则执行热更新</span></span><br><span class="line">    .pipe(gulpif(args.watch, livereload()))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="pages-js-–处理后台页面模板"><a href="#pages-js-–处理后台页面模板" class="headerlink" title="pages.js –处理后台页面模板"></a>pages.js –处理后台页面模板</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">'gulp-livereload'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'pages'</span>,()=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'app/**/*.ejs'</span>)</span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server'</span>)) <span class="comment">//文件被写入的路径是以所给的相对路径根据所给的目标目录计算而来。类似的，相对路径也可以根据所给的 base 来计算。这里实际写到的路径是server下的/**/*.ejs,即server/views/*.ejs</span></span><br><span class="line">    .pipe(gulpif(args.watch,livereload()))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="css-js-–处理css"><a href="#css-js-–处理css" class="headerlink" title="css.js –处理css"></a>css.js –处理css</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">'gulp-livereload'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'css'</span>,()=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'app/**/*.css'</span>)</span><br><span class="line">    .pipe(gulp.dest(<span class="string">'server/public'</span>))</span><br><span class="line">    <span class="comment">//文件被写入的路径是以所给的相对路径根据所给的目标目录计算而来。类似的，相对路径也可以根据所给的 base 来计算。这里实际写到的路径是server下的/**/*.css,即server/public/css/*.css</span></span><br><span class="line">    .pipe(gulpif(args.watch,livereload()))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="server-js-–处理服务端热重启"><a href="#server-js-–处理服务端热重启" class="headerlink" title="server.js –处理服务端热重启"></a>server.js –处理服务端热重启</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> liveserver <span class="keyword">from</span> <span class="string">'gulp-live-server'</span>; <span class="comment">//启动gulp服务器的包</span></span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'serve'</span>,(cb)=&gt;&#123;</span><br><span class="line">  <span class="comment">//如果没在监听,直接运行回调函数</span></span><br><span class="line">  <span class="keyword">if</span>(!args.watch) <span class="keyword">return</span> cb(); </span><br><span class="line">  <span class="comment">//启动express脚手架默认的服务器脚本</span></span><br><span class="line">  <span class="keyword">const</span> server = liveserver.new([<span class="string">'--harmony'</span>,<span class="string">'server/bin/www'</span>]); </span><br><span class="line">  server.start();</span><br><span class="line">  <span class="comment">//监听server目录下的js文件和ejs模板文件,通知服务器哪些文件改变了</span></span><br><span class="line">  gulp.watch([<span class="string">'server/public/**/*.js'</span>,<span class="string">'server/views/**/*.ejs'</span>],<span class="function"><span class="keyword">function</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line">    server.notify.apply(server,[file]);</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//监视服务器路由及入口文件的改变,进行服务器重启</span></span><br><span class="line">  gulp.watch([<span class="string">'server/routes/**/*.js'</span>,<span class="string">'server/app.js'</span>],<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    server.start.bind(server)()</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="browser-js-–监视前端文件改变-触发热更新"><a href="#browser-js-–监视前端文件改变-触发热更新" class="headerlink" title="browser.js –监视前端文件改变,触发热更新"></a>browser.js –监视前端文件改变,触发热更新</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpif <span class="keyword">from</span> <span class="string">'gulp-if'</span>;</span><br><span class="line"><span class="keyword">import</span> gutil <span class="keyword">from</span> <span class="string">'gulp-util'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'browser'</span>,(cb)=&gt;&#123;</span><br><span class="line">  <span class="keyword">if</span>(!args.watch) <span class="keyword">return</span> cb();<span class="comment">//若没监听,则直接执行回调</span></span><br><span class="line">  gulp.watch(<span class="string">'app/**/*.js'</span>,[<span class="string">'scripts'</span>]);<span class="comment">//若js文件发生改变,则调用刚才创建的scripts脚本</span></span><br><span class="line">  gulp.watch(<span class="string">'app/**/*.ejs'</span>,[<span class="string">'pages'</span>]); <span class="comment">//同上</span></span><br><span class="line">  gulp.watch(<span class="string">'app/**/*.css'</span>,[<span class="string">'css'</span>]); <span class="comment">//同上</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="clean-js-–处理服务器清除旧文件"><a href="#clean-js-–处理服务器清除旧文件" class="headerlink" title="clean.js –处理服务器清除旧文件"></a>clean.js –处理服务器清除旧文件</h3><p>每次服务器监听到静态资源文件的改变, 会触发重启, 用新的静态资源去render页面,此时需要删除旧的静态资源文件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> del <span class="keyword">from</span> <span class="string">'del'</span>;</span><br><span class="line"><span class="keyword">import</span> args <span class="keyword">from</span> <span class="string">'./util/args'</span>;</span><br><span class="line"><span class="comment">//清除服务端的静态资源文件和模板文件</span></span><br><span class="line">gulp.task(<span class="string">'clean'</span>,()=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> del([<span class="string">'server/public'</span>,<span class="string">'server/views'</span>])</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="build-js-–处理所有gulp文件运行关联顺序"><a href="#build-js-–处理所有gulp文件运行关联顺序" class="headerlink" title="build.js –处理所有gulp文件运行关联顺序"></a>build.js –处理所有gulp文件运行关联顺序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line"><span class="keyword">import</span> gulpSequence <span class="keyword">from</span> <span class="string">'gulp-sequence'</span>; <span class="comment">//处理文件关联关系和先后顺序</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//先clean,再css,再pages,再编译js,最后一个数组说明数组里的任务都放在前面四个任务执行过一次之后再执行,且serve端更新一定 在 browser静态资源改变之后 </span></span><br><span class="line">gulp.task(<span class="string">'build'</span>,gulpSequence(<span class="string">'clean'</span>,<span class="string">'css'</span>,<span class="string">'pages'</span>,<span class="string">'scripts'</span>,[<span class="string">'browser'</span>,<span class="string">'serve'</span>]));</span><br></pre></td></tr></table></figure>
<h3 id="default-js-–gulp工作流默认入口"><a href="#default-js-–gulp工作流默认入口" class="headerlink" title="default.js –gulp工作流默认入口"></a>default.js –gulp工作流默认入口</h3><p>gulp在无命令行参数时会优先运行defalut.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gulp <span class="keyword">from</span> <span class="string">'gulp'</span>;</span><br><span class="line">gulp.task(<span class="string">'default'</span>,[<span class="string">'build'</span>]);</span><br></pre></td></tr></table></figure></p>
<h3 id="gulpfile-babel-js-–gulp程序入口"><a href="#gulpfile-babel-js-–gulp程序入口" class="headerlink" title="gulpfile.babel.js –gulp程序入口"></a>gulpfile.babel.js –gulp程序入口</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requireDir <span class="keyword">from</span> <span class="string">'require-dir'</span>;<span class="comment">//需要运行某一文件夹的gulp任务</span></span><br><span class="line">requireDir(<span class="string">'./tasks'</span>); <span class="comment">//放入tasks目录</span></span><br></pre></td></tr></table></figure>
<h3 id="编辑-babelrc"><a href="#编辑-babelrc" class="headerlink" title="编辑.babelrc"></a>编辑.babelrc</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>:[<span class="string">"env"</span>,<span class="string">"stage-0"</span>],</span><br><span class="line">  <span class="attr">"plugins"</span>:[<span class="string">"transform-decorators-legacy"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="给express脚手架添加热更新中间件"><a href="#给express脚手架添加热更新中间件" class="headerlink" title="给express脚手架添加热更新中间件"></a>给express脚手架添加热更新中间件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在处理路由前,express优先处理静态资源,若在这个static方法定义的目录中没有找到req.url对应的静态资源,则调用Next()方法传入下一个中间件,最终会传递到路由中间件上</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"><span class="comment">//一定要再静态资源设置之后使用热更新中间件,此插件的安装要再最外层项目目录下的依赖安装,而不是server目录的依赖</span></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'connect-livereload'</span>)());</span><br></pre></td></tr></table></figure>
<h3 id="gulp程序启动"><a href="#gulp程序启动" class="headerlink" title="gulp程序启动"></a>gulp程序启动</h3><p><code>gulp --watch</code><br>在app/public/js下写一个简单的js,再在app/public/css下写一个chotee.css,例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chotee</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'chotee 啊,成功!'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ct1 = <span class="keyword">new</span> Chotee</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.innerHTML = ct1.name;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: pink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在app/views/目录下的index.ejs模板中引入<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/css/chotee.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  hello chotee</span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/index.js"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>打开浏览器访问localhost:3000端口(express脚手架默认端口), 看到<br><img src="https://i.loli.net/2017/11/14/5a0a30b96f6c1.png" alt="2"></p>
<p>成功! 此时再去修改js文件,模板文件,热更新文件,成功</p>
<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址:"></a>源码地址:</h2><p><a href="https://github.com/choteewang/gulp-es6-work-flow" target="_blank" rel="external">https://github.com/choteewang/gulp-es6-work-flow</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/11/13/2-redux的实现原理-发布订阅模式-闭包/" class="prev">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">choteewang@qq.com</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>